<?php/**********************************************************************pds_redim_cupons.class.phpGenerated by STRUCTY 2012.08.29 12:33:55.Copyright 2011 Structy, Frédéric Aebi. All rights reserved.**********************************************************************/define("PDS_REDIM_CUPONS", "pds_redim_cupons"); class pds_redim_cupons {	private $id;	private $user_id;	private $cust_sess_id;	private $order_id;	private $promotion_id;	private $coupon_code;	private $created_date;	private $user_redimed;	private $biz_redimed;	private $customer_name;  private $customer_type;	private $redimed_date;	private $rwd_deals_sel; 	private $rwd_usr_id;	private $rwd_points;		private $cup_serv_pin;	//..Variables to apply promotion to order 	private $apply_type;  private $apply_to_items;	private $is_return_cust;		private $rdc_table_id;	private $rdc_table_number;	private $rdc_server_id;	private $rdc_server_name;	private $rdc_table_status_id;	private $rdc_table_status_name;	private $rdc_party_size;	private $rdc_order_amount;  	private $rdc_order_tax; 		public function setid($pArg="0") {$this->id=$pArg;}	public function setuser_id($pArg="0") {$this->user_id=$pArg;}	public function setcust_sess_id($pArg="0") {$this->cust_sess_id=$pArg;}		public function setrdc_table_id($pArg="0") {$this->rdc_table_id=$pArg;}	public function setrdc_table_number($pArg="0") {$this->rdc_table_number=$pArg;}	public function setrdc_server_id($pArg="0") {$this->rdc_server_id=$pArg;}	public function setrdc_server_name($pArg="0") {$this->rdc_server_name=$pArg;}	public function setrdc_table_status_id($pArg="0") {$this->rdc_table_status_id=$pArg;}	public function setrdc_table_status_name($pArg="0") {$this->rdc_table_status_name=$pArg;}			public function setorder_id($pArg="0") {$this->order_id=$pArg;}	public function setpromotion_id($pArg="0") {$this->promotion_id=$pArg;}	public function setcoupon_code($pArg="0") {$this->coupon_code=$pArg;}	public function setcreated_date($pArg="0") {$this->created_date=$pArg;}	public function setuser_redimed($pArg="0") {$this->user_redimed=$pArg;}	public function setbiz_redimed($pArg="0") {$this->biz_redimed=$pArg;}	public function setcustomer_name($pArg="0") {$this->customer_name=$pArg;}	public function setcustomer_type($pArg="0") {$this->customer_type=$pArg;}		public function setapply_type($pArg="0") {$this->apply_type=$pArg;}	public function setapply_to_items($pArg="0") {$this->apply_to_items=$pArg;}	public function setis_return_cust($pArg="0") {$this->is_return_cust=$pArg;}		public function setredimed_date($pArg="0") {$this->redimed_date=$pArg;}	public function setrwd_deals_sel($pArg="0") {$this->rwd_deals_sel=$pArg;}		public function setrwd_usr_id($pArg="0") {$this->rwd_usr_id=$pArg;}	public function setrwd_points($pArg="0") {$this->rwd_points=$pArg;}		public function setcup_serv_pin($pArg="0") {$this->cup_serv_pin=$pArg;}	public function getid() {return $this->id;}	public function getuser_id() {return $this->user_id;}	public function getcust_sess_id() {return $this->cust_sess_id;}		public function getrdc_table_id() {return $this->rdc_table_id;}	public function getrdc_table_number() {return $this->rdc_table_number;}	public function getrdc_server_id() {return $this->rdc_server_id;}	public function getrdc_server_name() {return $this->rdc_server_name;}	public function getrdc_table_status_id() {return $this->rdc_table_status_id;}	public function getrdc_table_status_name() {return $this->rdc_table_status_name;}			public function getorder_id() {return $this->order_id;}	public function getpromotion_id() {return $this->promotion_id;}	public function getcoupon_code() {return $this->coupon_code;}	public function getcreated_date() {return $this->created_date;}	public function getuser_redimed() {return $this->user_redimed;}	public function getbiz_redimed() {return $this->biz_redimed;}	public function getcustomer_name() {return $this->customer_name;}	public function getcustomer_type() {return $this->customer_type;}		public function getapply_type() {return $this->apply_type;}	public function getapply_to_items() {return $this->apply_to_items;}	public function getis_return_cust() {return $this->is_return_cust;}		public function getredimed_date() {return $this->redimed_date;}	public function getrwd_deals_sel() {return $this->rwd_deals_sel;}		public function getrwd_usr_id() {return $this->rwd_usr_id;}	public function getrwd_points() {return $this->rwd_points;}		public function getcup_serv_pin() {return $this->cup_serv_pin;}	public function readObject($array = array()) {		$qry = "SELECT *".RET."FROM ".PDS_REDIM_CUPONS.RET;		$and = "WHERE".RET;		if($array['id'] != "") {			$qry .= $and."id = '".$array['id']."'".RET;			$and = "AND".RET;		}		if($array['user_id'] != "") {			$qry .= $and."user_id = '".$array['user_id']."'".RET;			$and = "AND".RET;		}				if($array['rwd_usr_id'] != "") {			$qry .= $and."rwd_usr_id = '".$array['rwd_usr_id']."'".RET;			$and = "AND".RET;		}				if($array['cust_sess_id'] != "") {			$qry .= $and."cust_sess_id = '".$array['cust_sess_id']."'".RET;			$and = "AND".RET;		}				if($array['order_id'] != "") {			$qry .= $and."order_id = '".$array['order_id']."'".RET;			$and = "AND".RET;		}		if($array['promotion_id'] != "") {			$qry .= $and."promotion_id = '".$array['promotion_id']."'".RET;			$and = "AND".RET;		}				if($array[SES_RESTAURANT] != "") {			$qry .= $and.chkPromotionInRestaurant('promotion_id',$array[SES_RESTAURANT]);			$and = "AND".RET;		} 		if($array['coupon_code'] != "") {			$qry .= $and."coupon_code LIKE '%".$array['coupon_code']."%'".RET;			$and = "AND".RET;		}		if($array['created_date'] != "") {			$qry .= $and."created_date = '".$array['created_date']."'".RET;			$and = "AND".RET;		}		if($array['user_redimed'] != "") {			$qry .= $and."user_redimed = '".$array['user_redimed']."'".RET;			$and = "AND".RET;		}		if($array['biz_redimed'] != "") {			$qry .= $and."biz_redimed = '".$array['biz_redimed']."'".RET;			$and = "AND".RET;		}				if($array['customer_name'] != "") {			$qry .= $and."customer_name like '".$array['customer_name']."'".RET;			$and = "AND".RET;		}				if($array['customer_type'] != '') {			$qry .= $and."customer_type = '".$array['customer_type']."'".RET;			$and = "AND".RET;		}						if($array['apply_type'] != "") {			$qry .= $and."apply_type like '".$array['apply_type']."'".RET;			$and = "AND".RET;		}		if($array['apply_to_items'] != "") {			$qry .= $and."apply_to_items like '".$array['apply_to_items']."'".RET;			$and = "AND".RET;		}		if($array['is_return_cust'] != "") {			$qry .= $and."is_return_cust = ".$array['is_return_cust']."".RET;			$and = "AND".RET;		}		if($array['redimed_date'] != "") {			$qry .= $and."redimed_date = '".$array['redimed_date']."'".RET;			$and = "AND".RET;		}				if($array['rwd_deals_sel'] != "") {			$qry .= $and."rwd_deals_sel = '".$array['rwd_deals_sel']."'".RET;			$and = "AND".RET;		}				if($array['cup_serv_pin'] != "") {			$qry .= $and."cup_serv_pin = ".$array['cup_serv_pin']."".RET;			$and = "AND".RET;		}				if($array['islatestOnly'] != "") {			$qry .=  "ORDER BY id DESC ";		}else{			$qry .=  "ORDER BY id ASC ";		}         $result = mysql_query($qry);         if($result){            while ($row = mysql_fetch_array($result)) {			     $record = $row;				break;//end after first record			}            if(count($record[0]) == 0) {			    return array();			} else {    			$this->setid($record['id']);    			$this->setuser_id($record['user_id']);					$this->setcust_sess_id($record['cust_sess_id']);					$this->setorder_id($record['order_id']);    			$this->setpromotion_id($record['promotion_id']);    			$this->setcoupon_code($record['coupon_code']);    			$this->setcreated_date($record['created_date']);    			$this->setuser_redimed($record['user_redimed']);    			$this->setbiz_redimed($record['biz_redimed']);					$this->setcustomer_name($record['customer_name']);					$this->setcustomer_type($record['customer_type']);					$this->setapply_type($record['apply_type']);					$this->setapply_to_items($record['apply_to_items']);					$this->setis_return_cust($record['is_return_cust']);    			$this->setredimed_date($record['redimed_date']);    			$this->setrwd_deals_sel($record['rwd_deals_sel']);										$this->setcup_serv_pin($record['cup_serv_pin']);										$this->setrwd_usr_id($record['rwd_usr_id']);					$this->setrwd_points($record['rwd_points']);					    			return true;            }		}	}	public static function readArray($array = array(), &$result_found = 0,$isArray=0){   $qry="	SELECT 		pds_redim_cupons.id, 		pds_redim_cupons.user_id, 		pds_redim_cupons.cust_sess_id, 		pds_redim_cupons.order_id, 		pds_redim_cupons.promotion_id, 		pds_redim_cupons.coupon_code, 		pds_redim_cupons.user_redimed, 		pds_redim_cupons.customer_name,		pds_redim_cupons.customer_type,		pds_redim_cupons.rwd_deals_sel, 		pds_redim_cupons.rwd_usr_id,		pds_redim_cupons.rwd_points,		pds_redim_cupons.cup_serv_pin,		pds_redim_cupons.biz_redimed, 		pds_redim_cupons.redimed_date,		pds_list_promotions.disc_aply_type,	 	tbl_table_customer_session.tbl_cust_sess_party_size   as tbl_cust_sess_party_size, 		tbl_table_customer_session.tbl_cust_sess_table_id,		tbl_dining_table.table_number,			(			SELECT (			IFNULL(SUM( od.`ord_dtl_quantity` * IF(od.`ord_dtl_discount` > 0, (od.`ord_dtl_price`-(od.`ord_dtl_price` * (od.`ord_dtl_discount`/100))),od.`ord_dtl_price`)),0) + IFNULL(SUM(op.`ord_det_opt_qty` * IF(op.`ord_det_opt_discount` > 0, (op.`ord_det_opt_price`-(op.`ord_det_opt_price` * (op.`ord_det_opt_discount`/100))),op.`ord_det_opt_price`)),0)			) AS `total`			FROM `".TBL_ORDER_DETAILS."` od			LEFT OUTER JOIN `".TBL_ORDER_DETAILS_OPTIONS."` op ON od.`ord_dtl_id` =  op.`ord_det_opt_order_detail`			WHERE od.`ord_dtl_order_id` = pds_redim_cupons.order_id		) `order_amount`, tbl_orders.order_tax,		(SELECT tbl_sts_nameFROM `tbl_table_status` WHERE `tbl_sts_id` = ( SELECT MAX(`tbl_sts_lnk_status_id`) FROM  `tbl_table_status_link` WHERE `tbl_sts_lnk_session_id`=`tbl_cust_sess_id`)) as `tbl_status`,		(SELECT CONCAT(staff_fname,' ',staff_lname) FROM `tbl_staff` where staff_member_id = (select `tbl_sts_lnk_emp_id` from `tbl_table_status_link` WHERE `tbl_sts_lnk_session_id`=`tbl_cust_sess_id` LIMIT 0,1)) as 'tbl_server' 		FROM 		pds_redim_cupons	LEFT OUTER JOIN  		tbl_table_customer_session 	ON 		tbl_table_customer_session.tbl_cust_sess_id = pds_redim_cupons.cust_sess_id 		LEFT OUTER JOIN  		tbl_dining_table 	ON 		tbl_dining_table.table_id = tbl_table_customer_session.tbl_cust_sess_table_id 			LEFT OUTER JOIN  		pds_list_promotions 	ON 		pds_list_promotions.id = pds_redim_cupons.promotion_id		LEFT OUTER JOIN  		`tbl_orders` 	ON 		 	pds_redim_cupons.order_id = `tbl_orders`.order_id WHERE  1 ".RET;		$and = "AND ".RET;		if($array['id'] != "") {			$qry .= $and."pds_redim_cupons.id = '".$array['id']."'".RET;			$and = "AND".RET;		}		if($array['user_id'] != "") {			$qry .= $and."pds_redim_cupons.user_id = '".$array['user_id']."'".RET;			$and = "AND".RET;		}				if($array['rwd_usr_id'] != "") {			$qry .= $and."rwd_usr_id = '".$array['rwd_usr_id']."'".RET;			$and = "AND".RET;		}				if(is_gt_zero_num($array['cust_sess_id'])) {			$qry .= $and."pds_redim_cupons.cust_sess_id = '".$array['cust_sess_id']."'".RET;			$and = "AND".RET;		}else{			if(is_not_empty($array['isActive'])){				$active_session = tbl_table_customer_session::getActiveSessionForAlltables();				 				if(is_gt_zero_num($array['isActive'])){					if(is_not_empty($active_session)){						 $qry .= $and."(cust_sess_id in (".$active_session.") OR (cust_sess_id = 0 AND DATE(pds_redim_cupons.created_date) = CURDATE()))".RET;					}else{						 $qry .= $and."(cust_sess_id = 0 AND DATE(pds_redim_cupons.created_date) = CURDATE())".RET;					}				}else{					if(is_not_empty($active_session)){						$qry .= $and."cust_sess_id not in (".$active_session.") ".RET;					}else{						//$qry .= $and."".RET;					}					$qry .=$and.' `biz_redimed` = 1 ';									}			}		}				if($array['order_id'] != "") {			$qry .= $and."pds_redim_cupons.order_id = '".$array['order_id']."'".RET;			$and = "AND".RET;		} 		if($array['promotion_id'] != "") {			$qry .= $and."pds_redim_cupons.promotion_id = '".$array['promotion_id']."'".RET;			$and = "AND".RET;		}				if($array[SES_RESTAURANT] != "") {			$qry .= $and.chkPromotionInRestaurant('pds_redim_cupons.promotion_id',$array[SES_RESTAURANT]);			$and = "AND".RET;		}		if($array['coupon_code'] != "") {			$qry .= $and."pds_redim_cupons.coupon_code LIKE '%".$array['coupon_code']."%'".RET;			$and = "AND".RET;		}		if($array['created_date'] != "") {			$qry .= $and."pds_redim_cupons.created_date = '".$array['created_date']."'".RET;			$and = "AND".RET;		}		if($array['user_redimed'] != "") {			$qry .= $and."pds_redim_cupons.user_redimed = '".$array['user_redimed']."'".RET;			$and = "AND".RET;		}		if($array['biz_redimed'] != "") {			$qry .= $and."pds_redim_cupons.biz_redimed = '".$array['biz_redimed']."'".RET;			$and = "AND".RET;		}				if($array['biz_not_redimed'] != "") {			$qry .= $and."pds_redim_cupons.biz_redimed=0 ".RET;			$and = "AND".RET;		}				if($array['redimed_date'] != "") {			$qry .= $and."pds_redim_cupons.redimed_date = '".$array['redimed_date']."'".RET;			$and = "AND".RET;		}				if($array['prom_title'] != "") {			$qry .= $and."pds_list_promotions.title  LIKE '%".$array['prom_title']."%'".RET;			$and = "AND".RET;		}				if($array['customer'] != "") {			$qry .= $and."(`order_customer_name` LIKE '%".$array['customer']."%' OR `pds_redim_cupons`.`customer_name` LIKE '".$array['customer']."' OR (`pds_redim_cupons`.user_id <> 0 AND `pds_redim_cupons`.user_id = (SELECT members.id FROM members INNER JOIN tbl_staff ON members.id = staff_member_id WHERE staff_fname LIKE '%".$array['customer']."%' OR staff_lname LIKE '%".$array['customer']."%' OR members.email LIKE '%".$array['customer']."%')))".RET;			$and = "AND".RET;		}				if($array['customer_name'] != "") {			$qry .= $and."`pds_redim_cupons`.`customer_name`  LIKE '".$array['customer_name']."'".RET;			$and = "AND".RET;		}				if($array['customer_type'] != "") {			$qry .= $and."`pds_redim_cupons`.`customer_type` = '".$array['customer_type']."'".RET;			$and = "AND".RET;		}				if($array['employee'] != "") {			$qry .= $and."`tbl_table_customer_session`.`tbl_cust_sess_id` in (SELECT `tbl_sts_lnk_session_id` FROM `tbl_table_status_link` WHERE `tbl_sts_lnk_emp_id`= ".$array['employee'].")".RET;			$and = "AND".RET; 			 		}				if($array['table'] != "") {			$qry .= $and."`tbl_table_customer_session`.`tbl_cust_sess_table_id` = ".$array['table']."".RET;			$and = "AND".RET;		}				if($array['apply_type'] != "") {			$qry .= $and."`pds_redim_cupons`.`apply_type` like '".$array['apply_type']."'".RET;			$and = "AND".RET;		}				if($array['apply_to_items'] != "") {			$qry .= $and."`pds_redim_cupons`.`apply_to_items` like '".$array['apply_to_items']."'".RET;			$and = "AND".RET;		}		if($array['is_return_cust'] != "") {			$qry .= $and."is_return_cust = ".$array['is_return_cust']."".RET;			$and = "AND".RET;		}					if($array['rwd_deals_sel'] != "") {			$qry .= $and."rwd_deals_sel = '".$array['rwd_deals_sel']."'".RET;			$and = "AND".RET;		}				if($array['cup_serv_pin'] != "") {			$qry .= $and."cup_serv_pin = '".$array['cup_serv_pin']."'".RET;			$and = "AND".RET;		}				if(is_not_empty($array['created_on_start']) && is_not_empty($array['created_on_end'])){			$qry .= $and.'created_date >= \''.date('Y-m-d 00:00:00',strtotime($array['created_on_start'])).'\''.RET.'AND created_date <= \''.date('Y-m-d 23:59:59',strtotime($array['created_on_end'])).'\''.RET;			$and = 'AND'.RET;		}								if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {			$qry  = $qry." ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}       if(is_not_empty($array['offset']) && is_not_empty($array['limit'])) {			$qry_with_limit  = $qry." LIMIT {$array['offset']},{$array['limit']}";		}else{     	$qry_with_limit  = $qry;    }  	//echo $qry_with_limit;				 	$result = mysql_query ($qry_with_limit);	$r1 = mysql_query($qry); 	if($r1){       	$result_found = mysql_num_rows($r1);	}			 	$class_objects = array();	if($result){			     while ($record = mysql_fetch_assoc($result)) {			//print_r($record); 			if($isArray){				//$class_objects[$class_object->getid()] = $class_object;								$class_objects[$record['id']] = $record;			}else{											$class_object = new pds_redim_cupons();				$class_object->setid($record['id']);				$class_object->setuser_id($record['user_id']);				$class_object->setcust_sess_id($record['cust_sess_id']);								$class_object->setrdc_table_number($record['table_number']);				$class_object->setrdc_table_id($record['tbl_cust_sess_table_id']);				$class_object->setrdc_server_name($record['tbl_server']);				$class_object->setrdc_table_status_name($record['tbl_status']);								$class_object->setorder_id($record['order_id']);				$class_object->setpromotion_id($record['promotion_id']);				$class_object->setcoupon_code($record['coupon_code']);				$class_object->setcreated_date($record['created_date']);				$class_object->setuser_redimed($record['user_redimed']);				$class_object->setcustomer_name($record['customer_name']);				$class_object->setcustomer_type($record['customer_type']);				if($record['disc_aply_type']=='ORDER'){					$class_object->setapply_type('complete_bill');				}else{					$class_object->setapply_type('individual_item');				}				//$class_object->setapply_type($record['apply_type']);				$class_object->setapply_to_items($record['apply_to_items']);				$class_object->setis_return_cust($record['is_return_cust']);								$class_object->setbiz_redimed($record['biz_redimed']);				$class_object->setredimed_date($record['redimed_date']);				$class_object->setrwd_deals_sel($record['rwd_deals_sel']);								$class_object->setrwd_usr_id($record['rwd_usr_id']);				$class_object->setrwd_points($record['rwd_points']);								$class_object->setcup_serv_pin($record['cup_serv_pin']);								$class_object->rdc_party_size = $record['tbl_cust_sess_party_size'];				$class_object->rdc_order_amount = $record['order_amount'];				$class_object->rdc_order_tax = $record['order_tax'];				$class_objects[$class_object->getid()] = $class_object;			 }			}		}		return $class_objects;	}	public function insert() {		if($this->getid() != '') {			$qry  = "UPDATE ".PDS_REDIM_CUPONS.RET."SET".RET.			"id = '".$this->getid()."',".RET.			"user_id = '".$this->getuser_id()."',".RET.			"cust_sess_id = '".$this->getcust_sess_id()."',".RET.			"customer_name = '".$this->getcustomer_name()."',".RET.			"customer_type = '".$this->getcustomer_type()."',".RET.						"apply_type = '".$this->getapply_type()."',".RET.			"apply_to_items = '".$this->getapply_to_items()."',".RET.			"is_return_cust = '".$this->getis_return_cust()."',".RET.						"order_id = '".$this->getorder_id()."',".RET.			"promotion_id = '".$this->getpromotion_id()."',".RET.			"coupon_code = '".$this->getcoupon_code()."',".RET.			"user_redimed = '".$this->getuser_redimed()."',".RET.			"biz_redimed = '".$this->getbiz_redimed()."',".RET.			"rwd_deals_sel = '".$this->getrwd_deals_sel()."',".RET.						"rwd_usr_id = '".$this->getrwd_usr_id()."',".RET.			"rwd_points = '".$this->getrwd_points()."',".RET.									"redimed_date = ".$this->getredimed_date()."".RET.			"WHERE id = ".$this->getid().RET;            $result = mysql_query($qry);    		if($result){             	return mysql_affected_rows();      		}		} else {			$qry  = "INSERT INTO ".PDS_REDIM_CUPONS." (".RET.                    "user_id,cust_sess_id,order_id, promotion_id, coupon_code,user_redimed,rwd_deals_sel,rwd_usr_id,rwd_points,biz_redimed,customer_name,customer_type,apply_type,apply_to_items,is_return_cust,cup_serv_pin,redimed_date".RET.                    ") VALUES (".RET.                    "'".$this->getuser_id()."',".RET.					"'".$this->getcust_sess_id()."',".RET.					"'".$this->getorder_id()."',".RET.                    "'".$this->getpromotion_id()."',".RET.                    "'".$this->getcoupon_code()."',".RET.                    "'".$this->getuser_redimed()."',".RET.                    "'".$this->getrwd_deals_sel()."',".RET.										"'".$this->getrwd_usr_id()."',".RET.										"'".$this->getrwd_points()."',".RET.																		                    "'".$this->getbiz_redimed()."',".RET.					"'".$this->getcustomer_name()."',".RET.					"'".$this->getcustomer_type()."',".RET.					"'".$this->getapply_type()."',".RET.					"'".$this->getapply_to_items()."',".RET.					"'".$this->getis_return_cust()."',".RET.					"'".$this->getcup_serv_pin()."',".RET.					"'".$this->getredimed_date()."'".RET.                    ")".RET;            $result = mysql_query($qry);			$this->setid(mysql_insert_id());		}	}	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".PDS_REDIM_CUPONS.RET;		$and = "WHERE".RET; 				if($array['id'] != "") {			$qry .= $and."id = '".$array['id']."'".RET;			$and = "AND".RET;		}		if($array['user_id'] != "") {			$qry .= $and."user_id = '".$array['user_id']."'".RET;			$and = "AND".RET;		}					if($array['rwd_usr_id'] != "") {			$qry .= $and."rwd_usr_id = '".$array['rwd_usr_id']."'".RET;			$and = "AND".RET;		}			 		if(is_gt_zero_num($array['cust_sess_id'])) {			$qry .= $and."cust_sess_id = '".$array['cust_sess_id']."'".RET;			$and = "AND".RET;		} 						if($array['order_id'] != "") {			$qry .= $and."order_id = '".$array['order_id']."'".RET;			$and = "AND".RET;		}		if($array['promotion_id'] != "") {			$qry .= $and."promotion_id = '".$array['promotion_id']."'".RET;			$and = "AND".RET;		}		if($array['coupon_code'] != "") {			$qry .= $and."coupon_code = '".$array['coupon_code']."'".RET;			$and = "AND".RET;		}		if($array['created_date'] != "") {			$qry .= $and."created_date = '".$array['created_date']."'".RET;			$and = "AND".RET;		}		if($array['user_redimed'] != "") {			$qry .= $and."user_redimed = '".$array['user_redimed']."'".RET;			$and = "AND".RET;		}		if($array['biz_redimed'] != "") {			$qry .= $and."biz_redimed = '".$array['biz_redimed']."'".RET;			$and = "AND".RET;		}				if($array['customer_name'] != "") {			$qry .= $and."customer_name = '".$array['customer_name']."'".RET;			$and = "AND".RET;		}				if($array['customer_type'] != "") {			$qry .= $and."customer_type = '".$array['customer_type']."'".RET;			$and = "AND".RET;		}				if($array['apply_type'] != "") {			$qry .= $and."apply_type like '".$array['apply_type']."'".RET;			$and = "AND".RET;		}		if($array['apply_to_items'] != "") {			$qry .= $and."apply_to_items like '".$array['apply_to_items']."'".RET;			$and = "AND".RET;		}		if($array['is_return_cust'] != "") {			$qry .= $and."is_return_cust like '".$array['is_return_cust']."'".RET;			$and = "AND".RET;		}		if($array['redimed_date'] != "") {			$qry .= $and."redimed_date = '".$array['redimed_date']."'".RET;			$and = "AND".RET;		}        if($array['rwd_deals_sel'] != "") {			$qry .= $and."rwd_deals_sel = '".$array['rwd_deals_sel']."'".RET;			$and = "AND".RET;		}		        $result = mysql_query($qry);		if($result){         	return mysql_affected_rows();  		}  		return 0;	}		public function isAlreadyThere($user_id,$promotion_id,$cust_sess_id,$customer_name='',$customer_type=CUST_TYPE_LOGIN){			$search_arr = array( 'promotion_id'=>$promotion_id,'cust_sess_id'=>$cust_sess_id);			if(is_gt_zero_num($user_id)){				$search_arr['user_id']=$user_id;			}			if(is_not_empty($customer_name)){				$search_arr['customer_name']=$customer_name;			}	 				$search_arr['customer_type'] = $customer_type;       $this->readObject($search_arr);        return $this->getid();  	}		public function isAlreadyRedimed($id,$user_redimed=0,$biz_redimed=0){      $this->readObject(array("id"=>$id));      if(is_gt_zero_num($biz_redimed)){         if(is_gt_zero_num($this->getbiz_redimed()))            return 1;      }elseif(is_gt_zero_num($user_redimed)){         if(is_gt_zero_num($this->getuser_redimed()))            return 1;      }        return 0;    }				public function create($user_id,$promotion_id,$cust_sess_id,$customer_name="",$customer_type=CUST_TYPE_LOGIN,$prom_code,$apply_type='',$apply_to_items='',$is_return_cust=0,$rwd_deals_sel='',$rwd_usr_id=0,$rwd_points=0,$cup_serv_pin=0){			//if((is_gt_zero_num($user_id)) && (is_gt_zero_num($promotion_id))&& (is_gt_zero_num($order_id))&& (is_gt_zero_num($cust_sess_id))){        if((is_gt_zero_num($promotion_id)) && (is_gt_zero_num($cust_sess_id)) && (is_gt_zero_num($user_id) || is_not_empty($customer_name))){          if(is_gt_zero_num($this->isAlreadyThere($user_id,$promotion_id,$cust_sess_id,$customer_name,$customer_type))){             return -1;          }else{              $this->setid("");             $this->setuser_id($user_id);			 $this->setcust_sess_id($cust_sess_id);			 $this->setpromotion_id($promotion_id);			 /*$this->setorder_id($order_id);*/			 $this->setuser_redimed(1); 			 $this->setcustomer_name($customer_name);			 $this->setcustomer_type($customer_type);			 			 $this->setapply_type($apply_type);			 $this->setapply_to_items($apply_to_items);			 $this->setis_return_cust($is_return_cust);			 			 $this->setrwd_deals_sel($rwd_deals_sel);			 $this->setrwd_usr_id($rwd_usr_id);			 $this->setrwd_points($rwd_points);					 			 $this->setcup_serv_pin($cup_serv_pin);	 	 			 			 $this->setcoupon_code($this->generateCuponCode($user_id,$promotion_id)); 			 $this->setredimed_date(date(DATE_FORMAT));		   	 $this->insert(); 		 	 if(is_gt_zero_num($this->getid())){			     $this->increaseCountInPromotion($this->getpromotion_id());			 }			 return $this->getid();           }         }        return 0;    }        public  function redimCupon($id,$user_redimed=0,$biz_redimed=0,$order_id=0,$table_id=0,$uid=0){			global $_lang;         if((is_gt_zero_num($id))&& (is_gt_zero_num($user_redimed) || is_gt_zero_num($biz_redimed))){             $this->readObject(array("id"=>$id));             if(!is_gt_zero_num($this->getAvaliableRedimCouponCount($this->getpromotion_id()))){                return -2;             }elseif(is_gt_zero_num($this->isAlreadyRedimed($id))){                return -1;             }else{                $this->readObject(array( "id"=>$id));			                $previouslyRedimed = 0;                if(is_gt_zero_num($this->getbiz_redimed())||is_gt_zero_num($this->getuser_redimed())){                 $previouslyRedimed = 1;                }                if(is_gt_zero_num($user_redimed)){                    $this->setuser_redimed($user_redimed);                }                if(is_gt_zero_num($biz_redimed)){                    $this->setbiz_redimed($biz_redimed);					if(is_gt_zero_num($order_id)){						$this->setorder_id($order_id);					}					/*//..Check if promotion is of reward type 					//..then add reward id and the reward points					$_rwd_det=biz_rewards::_get_rwd_id_for_prom_id($this->getpromotion_id());					if(is_gt_zero_num($_rwd_det['rwd_id'])){						$this->setrwd_deals_sel($_rwd_det['rwd_id']);						if(is_gt_zero_num($_rwd_det['rwd_point_limit'])){						   $this->setrwd_points($_rwd_det['rwd_point_limit']);						}						$this->setrwd_usr_id($this->getuser_id());					}*/                }                $this->setredimed_date("NOW()");                if(is_gt_zero_num($this->insert())){                    if(!is_gt_zero_num($previouslyRedimed)){                     	$this->increaseCountInPromotion($this->getpromotion_id());                    }					if(is_gt_zero_num($biz_redimed)){						 biz_send_alert($table_id,$this->getcustomer_name(),$order_id,$_lang[TBL_ALERTS]['customer'][ALERT_CNF_CUPON],$this->getuser_id(),ALERT_CNF_CUPON,$this->getcustomer_type());  					}                    return 1;                }             }         }        return 0;    }   function getSavedCouponCount($promotion_id){       if(is_gt_zero_num($promotion_id)){          $qry = "SELECT Count(id) FROM ".PDS_REDIM_CUPONS." WHERE `promotion_id`={$promotion_id}";      $result = mysql_query($qry);		if($result){         	return mysql_result($result,0);  		}    }   }   function  generateCuponCode($user_id,$promotion_id){      $biz_id = getBizOwnerId(getMeBusinessIdByPromotion($promotion_id));      $coupon_count = biz_zerofill($this->getSavedCouponCount($promotion_id),4);      //$user_id = elgg_zerofill($user_id,8);      //$promotion_id = elgg_zerofill($promotion_id,8);      //return "cupon_{$promotion_id}_{$biz_id}_{$user_id}_{$coupon_count}";      return "cupon_{$promotion_id}_{$biz_id}_{$user_id}_{$coupon_count}";   }   function getRedimedCuponCounts($promotion_id){      $qry = "SELECT Count(id) FROM ".PDS_REDIM_CUPONS." WHERE `promotion_id`=$promotion_id AND(`user_redimed`=1 OR `biz_redimed`=1)";      $result = mysql_query($qry);		if($result){            return mysql_result($result,0);  		}  		return 0;   }   function getAvaliableRedimCouponCount($promotion_id){     if(is_gt_zero_num($promotion_id)){          $qry = "SELECT  `allowed_cupons`-`redimed_cupons` AS `Available` FROM `pds_list_promotions` WHERE `id`=$promotion_id";     $result = mysql_query($qry);		if($result){         	return mysql_result($result,0);  		}     }     return 0;   }      function increaseCountInPromotion($promotion_id){     $qry = "UPDATE `pds_list_promotions` SET `redimed_cupons`=`redimed_cupons`+1 WHERE `id`=$promotion_id";     $result = mysql_query($qry);		if($result){         	return 1;  		}      return 0;   }      function GetInfo($id){        $record = array();        if((is_gt_zero_num($id))&&($this->readObject(array("id"=>$id)))){            $record['id']= $this->getid($record['id']);            $record['user_id']=$this->getuser_id();			$record['cust_sess_id']=$this->getcust_sess_id();			$record['order_id']=$this->getorder_id();			$record['order_info'] = tbl_orders::GetInfo($record['order_id']);            $sel_user = get_user($this->getuser_id());            if ($sel_user){              $record['user_name'] = $sel_user['full_name'];              $record['user_img'] = "";              $record['user_url']  = "";              $record['user_mail']  = $sel_user['email'];            }            $record['promotion_id']= $this->getpromotion_id();			$record['promotion'] =  get_promotion_info($record['promotion_id']); 			$record['customer_name']= $this->getcustomer_name();			$record['customer_type']= $this->getcustomer_type();						$record['rdc_table_number']= $this->getrdc_table_number();			$record['rdc_table_id']= $this->getrdc_table_id();			$record['rdc_server_name']= $this->getrdc_server_name();			$record['rdc_party_size'] = $this->rdc_party_size;			$record['rdc_order_amount']= $this->rdc_order_amount;			$record['rdc_order_tax']= $this->rdc_order_tax;			$record['rdc_tax_amt']=  ($this->rdc_order_amount *($this->rdc_order_tax/100.00)) ;			$record['rdc_gr_amt']= $record['rdc_order_tax'] + $record['rdc_order_amount'];			$record['rdc_table_status_name']= $this->getrdc_table_status_name();						$record['apply_type']= $this->getapply_type();			$record['apply_to_items']= $this->getapply_to_items();			$record['is_return_cust']= $this->getis_return_cust();			            $record['coupon_code']= $this->getcoupon_code();            $record['created_date']= $this->getcreated_date();            $record['user_redimed']= $this->getuser_redimed();            $record['biz_redimed']= $this->getbiz_redimed();            $record['redimed_date']= $this->getredimed_date();            $record['rwd_deals_sel']= $this->getrwd_deals_sel();												$record['rwd_usr_id']= $this->getrwd_usr_id();						$record['rwd_points']= $this->getrwd_points();						            //..logic to show the questions and answers            $prm_type=getCouponType($this->getpromotion_id());            //echo "{$record['coupon_code']},{$record['promotion_id']},{$record['user_id']} ";            //exit;            /*if($prm_type=="reward"){                $questAns=$this->getTheAnswers($record['coupon_code'],$record['promotion_id'],$record['user_id']);                if(is_not_empty($questAns)){                   $record['rwd_quest_ans']=$questAns;                }                //..fetch all selected deals along with it                if(is_not_empty($record['rwd_deals_sel'])){                      $prm_lst=explode(",",$record['rwd_deals_sel']);                      foreach($prm_lst as $item){                            $record['lst_rwd_deals_sel'][]=get_promotion_info($item);                      }                }            }*/            $record['is_redimed']= 0;            if(is_gt_zero_num($this->getuser_redimed())||is_gt_zero_num($this->getbiz_redimed())){             $record['is_redimed']= 1;            }        }        return $record;   }      function GetInfoByuser_promotion($user_id,$promotion_id){     if((is_gt_zero_num($user_id))&& (is_gt_zero_num($promotion_id))){      $this->readObject(array( "promotion_id"=>$promotion_id, "user_id"=>$user_id, "islatestOnly"=>1));      return $this->GetInfo($this->getid());     }     return "";   }         function listOfCoupons($promotion_id='',$customer='',$prom_title='',$offset=0,$limit=10,$url='',$sort_on='',$sort_by='',$cust_sess_id=0,$latestOnly='',$order_id=0,$customer_name='',$user_id=0,$flt_cust='',$flt_cust_type='',$isActive='',$table_id=0,$employee_id=0,$start_date='',$end_date=''){	       $info = array();     /*if(is_gt_zero_num($promotion_id) || is_gt_zero_num($user_id)){*/        $result_found = 0;			$search_text = '';		$search_arr = array( 'promotion_id'=>$promotion_id, 'prom_title'=>$prom_title,  'user_redimed'=>1, 'offset'=>$offset,'limit'=>$limit,'isActive'=>$isActive,SORT_ON=>$sort_on,SES_RESTAURANT=>$_SESSION[SES_RESTAURANT],SORT_BY=>$sort_by); 		if(is_not_empty($latestOnly)){			if(is_gt_zero_num($latestOnly)){				//..do nothing 			}else{				$search_arr['biz_redimed'] = 1;			}		}		  		if(is_gt_zero_num($table_id)){			$search_arr['table']=$table_id;			$tmpinfo = tbl_dining_table::GetInfo($table_id);			$search_text .= 'Table like "'.$tmpinfo['table_number'].'" | ';			unset($tmpinfo);		}				if(is_gt_zero_num($employee_id)){			$search_arr['employee']=$employee_id;			$tmpinfo = tbl_staff::GetInfo($employee_id);			$search_text .= 'Server like "'.$tmpinfo['staff_full_name'].'" | ';			unset($tmpinfo);		}				 if(is_not_empty($start_date) && is_not_empty($end_date)){  	$search_arr['created_on_start'] 		= $start_date;  	$search_arr['created_on_end'] 		= $end_date; 		$search_text .= 'Date range: '.$start_date.'-'.$end_date.'|&nbsp;';  } 						if(is_not_empty($flt_cust)){			$search_arr['customer']=$flt_cust;		}else{			if(is_not_empty($customer)){				$search_arr['customer']='%'.$customer.'%';				$search_text .= 'Customer like "'.$customer.'" | '; 			} 		}				if(is_not_empty($flt_cust_type)){			$search_arr['customer_type']=$flt_cust_type;		}				if(is_gt_zero_num($cust_sess_id)){			$search_arr['cust_sess_id'] = $cust_sess_id;		}		if(is_gt_zero_num($order_id)){			$search_arr['order_id'] = $order_id;		}				if(is_not_empty($customer_name)){			$search_arr['customer_name']= $customer_name;				}				if(is_not_empty($user_id)){			$search_arr['user_id']= $user_id;		}		//print_r($search_arr);		//echo "sadasdasdsa";		//exit;    $class_objects = $this->readArray($search_arr, $result_found);    $x=0; 		      foreach ($class_objects as $class_obj){      $info['coupons'][$x]= $class_obj->GetInfo($class_obj->getId());      $x++;    }  		//$result_found = $x;    $pagination_array = array();    $pagination_array['count']  = $result_found;    $pagination_array['offset'] = $offset;    $pagination_array['offset_word'] = "offset";    $pagination_array['limit']  = $limit;$url = "{$url}&promotion_id={$promotion_id}&coupon_code={$coupon_code}&user_id={$user_id}&".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}"; 			if(is_not_empty($flt_cust)){					$url .='&'.FILTER_BY_CUST.'='.$flt_cust;			} 			if(is_gt_zero_num($order_id)){					$url .='&order_id='.$order_id;			}			 			        $pagination_array['url']    = $url;							        /* $pagination_array['fields'] = array("promotion_id"=>$promotion_id,                                            "coupon_code"=>$coupon_code,                                            "user_id"=>$user_id,											SORT_ON=>$sort_on,											SORT_BY=>$sort_by); */        $info['pagination'] = biz_pagination($pagination_array,$res1,$res2);				//echo "x". $info['pagination'];		$info['result_found'] = $result_found;		$info['search_text'] = $search_text;     /*}*/      return $info;   }      //..Function to get the answers provided by the user for reward   public function getTheAnswers($rwd_cup_id,$rwd_coupon_id,$redim_user){        $output="";        //..Based on coupon code and coupon id fetch the reward        $sql = "SELECT rwd_id,rwd_is_quest_asc FROM `biz_rewards` WHERE rwd_cup_id='{$rwd_cup_id}'AND rwd_coupon_id={$rwd_coupon_id}";    	$result = mysql_query($sql);		if($result){            while ($row = mysql_fetch_assoc($result)){                if($row['rwd_is_quest_asc']){                    $q_index = 1;                    //..Now check if questions asscociated with it and fetch questions                    $sql_q = "SELECT `qst_id`,`qst_title` FROM `biz_rwd_questions` WHERE `qst_rwd_id`= {$row['rwd_id']}";                    $result_q = mysql_query($sql_q);            		if($result_q){                        while ($row_q = mysql_fetch_assoc($result_q)){                            $output.="<b>{$q_index}) {$row_q['qst_title']} </b><br>";                            //..Now we have the fetch questions fetch answers                            $sql_a = "SELECT `ans_title` FROM `biz_rwd_answers` WHERE ans_qst_id={$row_q['qst_id']} AND `ans_user_id`={$redim_user}";                            $result_a = mysql_query($sql_a);                    		if($result_a){                                while ($row_a= mysql_fetch_assoc($result_a)){                                   $output.= "Ans. &nbsp;&nbsp; {$row_a['ans_title']} <br><br>";                    	  		}                      		}                            $q_index=$q_index+1;            	  		}              		}                }	  		}  		}  		return $output;   }	 	 public static function GetFields($data){ 		$arr = array();		if(is_not_empty($data)){			$qry ='SELECT '.$data['key_field'].','.$data['value_field'].' FROM '.PDS_REDIM_CUPONS.' WHERE 1';			if(is_not_empty($data['filter_field']) && is_not_empty($data['filter_value'])){				$qry .= ' AND '.$data['filter_field'].' = \''.$data['filter_value'].'\'';						}			$res = mysql_query($qry); 			if($res){				while($row=mysql_fetch_assoc($res)){					$arr[$row[$data['key_field']]] = $row[$data['value_field']];				}			}		}		return $arr;	}//.. End of GetFields	 	 public static function promotionDetail(){	 	$sql ="SELECT 		pds_redim_cupons.id, 		pds_redim_cupons.user_id, 		pds_redim_cupons.cust_sess_id, 		pds_redim_cupons.order_id, 		pds_redim_cupons.promotion_id, 		pds_redim_cupons.coupon_code, 		pds_redim_cupons.user_redimed, 		pds_redim_cupons.customer_name,		pds_redim_cupons.customer_type,		pds_redim_cupons.rwd_deals_sel,		pds_redim_cupons.rwd_points, 		pds_redim_cupons.rwd_usr_id,		pds_redim_cupons.biz_redimed, 		pds_redim_cupons.redimed_date,		AVG(tbl_table_customer_session.tbl_cust_sess_party_size)  as tbl_cust_sess_party_size, 		tbl_table_customer_session.tbl_cust_sess_table_id,		tbl_dining_table.table_number,			(			SELECT (			IFNULL(SUM( od.`ord_dtl_quantity` * IF(od.`ord_dtl_discount` > 0, (od.`ord_dtl_price`-(od.`ord_dtl_price` * (od.`ord_dtl_discount`/100))),od.`ord_dtl_price`)),0) + IFNULL(SUM(op.`ord_det_opt_qty` * IF(op.`ord_det_opt_discount` > 0, (op.`ord_det_opt_price`-(op.`ord_det_opt_price` * (op.`ord_det_opt_discount`/100))),op.`ord_det_opt_price`)),0)			) AS `total`			FROM `".TBL_ORDER_DETAILS."` od			LEFT OUTER JOIN `".TBL_ORDER_DETAILS_OPTIONS."` op ON od.`ord_dtl_id` =  op.`ord_det_opt_order_detail`			WHERE od.`ord_dtl_order_id` = pds_redim_cupons.order_id		) `order_amount`, tbl_orders.order_tax,		(SELECT tbl_sts_nameFROM `tbl_table_status` WHERE `tbl_sts_id` = ( SELECT MAX(`tbl_sts_lnk_status_id`) FROM  `tbl_table_status_link` WHERE `tbl_sts_lnk_session_id`=`tbl_cust_sess_id`)) as `tbl_status`,		(SELECT CONCAT(staff_fname,' ',staff_lname) FROM `tbl_staff` where staff_member_id = (select `tbl_sts_lnk_emp_id` from `tbl_table_status_link` WHERE `tbl_sts_lnk_session_id`=`tbl_cust_sess_id` LIMIT 0,1)) as 'tbl_server' 		FROM 		pds_redim_cupons	INNER JOIN  		tbl_table_customer_session 	ON 		tbl_table_customer_session.tbl_cust_sess_id = pds_redim_cupons.cust_sess_id 		INNER JOIN  		tbl_dining_table 	ON 		tbl_dining_table.table_id = tbl_table_customer_session.tbl_cust_sess_table_id 			LEFT OUTER JOIN  		pds_list_promotions 	ON 		pds_list_promotions.id = pds_redim_cupons.promotion_id		LEFT OUTER JOIN  		`tbl_orders` 	ON 		 	pds_redim_cupons.order_id = `tbl_orders`.order_id WHERE ";	 } 	 	 public static  function claimPromotionForOrder($promtions,$order_id){	 	 if(is_not_empty($promtions) && is_gt_zero_num($order_id)){		 	$order_info = tbl_orders::GetInfo($order_id);			if($order_info){				$sql_prm = array();			 foreach($promtions as $promo_id){			 	 //..get prom details,			 	 $_ech_prm_det=_get_prom_specifics($promo_id);			 	 if($_ech_prm_det['disc_aply_type']=='ORDER'){				 	$_prm_type='complete_bill';				 }else{				 	$_prm_type='individual_item';				 }			 	 $sql_prm[] = '('.$order_info['order_customer_id'].', '.$order_info['order_session_id'].', '.$order_info['order_id'].', '.$promo_id.', \''.date(DATE_FORMAT).'\', 1, \''.$order_info['order_customer_name'].'\', \''.$order_info['order_customer_type'].'\', \''.$_prm_type.'\')'; 			 }			}						if (is_not_empty($sql_prm)){				/* echo 'INSERT INTO pds_redim_cupons (`user_id`, `cust_sess_id`,`order_id`,`promotion_id`,`created_date`,`user_redimed`,`customer_name`,`customer_type`,`apply_type`) VALUES '.biz_implode(',',$sql_prm).';';				 exit;*/				 return  DB::ExecNonQry('INSERT INTO pds_redim_cupons (`user_id`, `cust_sess_id`,`order_id`,`promotion_id`,`created_date`,`user_redimed`,`customer_name`,`customer_type`,`apply_type`) VALUES '.biz_implode(',',$sql_prm).';'); 			}			 		 }		 return OPERATION_FAIL;	 }}?>