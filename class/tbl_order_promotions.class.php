<?php/**********************************************************************tbl_order_promotions.class.phpGenerated by STRUCTY 2013.08.10 08:58:24.Copyright 2011 Structy, Frédéric Aebi. All rights reserved.**********************************************************************/define("TBL_ORDER_PROMOTIONS", "tbl_order_promotions"); define('ORDPROM_ID', 'ordprom_id'); define('ORDPROM_ORDER', 'ordprom_order'); define('ORDPROM_ORDER_SBMNU_DISH', 'ordprom_order_sbmnu_dish'); define('ORDPROM_PROMOTION', 'ordprom_promotion'); define('ORDPROM_DISCOUNT', 'ordprom_discount'); define('ORDPROM_START_DATE', 'ordprom_start_date'); define('ORDPROM_END_DATE', 'ordprom_end_date'); define("TBL_ORDER_PROMOTIONS_ACTIVE_DATE",  ORDPROM_START_DATE);define("TBL_ORDER_PROMOTIONS_DEACTIVE_DATE",  ORDPROM_END_DATE);$tbl_order_promotions_active_condition= " (".TBL_ORDER_PROMOTIONS_DEACTIVE_DATE." is NULL OR ".TBL_ORDER_PROMOTIONS_DEACTIVE_DATE." = 0 OR ".TBL_ORDER_PROMOTIONS_DEACTIVE_DATE." > CURDATE( )) ";class tbl_order_promotions {	private $ordprom_id;	private $ordprom_order;	private $ordprom_order_sbmnu_dish;	private $ordprom_promotion;	private $ordprom_discount;	private $ordprom_start_date;	private $ordprom_end_date;	private $tbl_order_promotions_active_date;	private $tbl_order_promotions_deactive_date;	public function setordprom_id($pArg="0") {$this->ordprom_id=$pArg;}	public function setordprom_order($pArg="0") {$this->ordprom_order=$pArg;}	public function setordprom_order_sbmnu_dish($pArg="0") {$this->ordprom_order_sbmnu_dish=$pArg;}	public function setordprom_promotion($pArg="0") {$this->ordprom_promotion=$pArg;}	public function setordprom_discount($pArg="0") {$this->ordprom_discount=$pArg;}	public function setordprom_start_date($pArg="0") {$this->ordprom_start_date=$pArg;}	public function setordprom_end_date($pArg="0") {$this->ordprom_end_date=$pArg;}	public function settbl_order_promotions_active_date($pArg="0") {$this->tbl_order_promotions_active_date=$pArg;}	public function settbl_order_promotions_deactive_date($pArg="0") {$this->tbl_order_promotions_deactive_date=$pArg;}	public function getordprom_id() {return $this->ordprom_id;}	public function getordprom_order() {return $this->ordprom_order;}	public function getordprom_order_sbmnu_dish() {return $this->ordprom_order_sbmnu_dish;}	public function getordprom_promotion() {return $this->ordprom_promotion;}	public function getordprom_discount() {return $this->ordprom_discount;}	public function getordprom_start_date() {return $this->ordprom_start_date;}	public function getordprom_end_date() {return $this->ordprom_end_date;}	public function gettbl_order_promotions_active_date($pArg="0") {return $this->tbl_order_promotions_active_date;}	public function gettbl_order_promotions_deactive_date($pArg="0") {return $this->tbl_order_promotions_deactive_date;}	public function readObject($array = array()) {		$qry = "SELECT *".RET."FROM ".TBL_ORDER_PROMOTIONS.RET;		$and = "WHERE".RET;		if($array[ORDPROM_ID] != "") {			$qry .= $and.ORDPROM_ID." = '".$array[ORDPROM_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER] != "") {			$qry .= $and.ORDPROM_ORDER." = '".$array[ORDPROM_ORDER]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER_SBMNU_DISH] != "") {			$qry .= $and.ORDPROM_ORDER_SBMNU_DISH." = '".$array[ORDPROM_ORDER_SBMNU_DISH]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT] != "") {			$qry .= $and.ORDPROM_DISCOUNT." = '".$array[ORDPROM_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_START_DATE] != "") {			$qry .= $and.ORDPROM_START_DATE." = '".$array[ORDPROM_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_END_DATE] != "") {			$qry .= $and.ORDPROM_END_DATE." = '".$array[ORDPROM_END_DATE]."'".RET;			$and = "AND".RET;		}	$result = mysql_query($qry);		if($result) {			while ($row = mysql_fetch_array($result)) {				$record = $row;				break;//end after first record			}			if(count($record[0]) == 0) {				return array();			} else {				$this->setordprom_id($record[ORDPROM_ID]);				$this->setordprom_order($record[ORDPROM_ORDER]);				$this->setordprom_order_sbmnu_dish($record[ORDPROM_ORDER_SBMNU_DISH]);				$this->setordprom_promotion($record[ORDPROM_PROMOTION]);				$this->setordprom_discount($record[ORDPROM_DISCOUNT]);				$this->setordprom_start_date($record[ORDPROM_START_DATE]);				$this->setordprom_end_date($record[ORDPROM_END_DATE]);				$this->settbl_order_promotions_active_date($record[TBL_ORDER_PROMOTIONS_ACTIVE_DATE]);				$this->settbl_order_promotions_deactive_date($record[TBL_ORDER_PROMOTIONS_DEACTIVE_DATE]);				return true;			}		}	}	public static function readArray($array = array(),&$result_found=0,$isArray=1) {		global $tbl_order_promotions_active_condition;		//$qry = "SELECT *".RET."FROM ".TBL_ORDER_PROMOTIONS.RET;		$qry = "SELECT ord_prom.*,disc.* ".RET."FROM ".TBL_ORDER_PROMOTIONS." ord_prom ".RET.				" INNER JOIN `tbl_prom_discounts` disc ON 				`tbl_prom_discounts`.`prmdisc_id`=`ord_prom`.`ordprom_discount` ";				$and = "WHERE".RET;		if($array[ORDPROM_ID] != "") {			$qry .= $and.ORDPROM_ID." = '".$array[ORDPROM_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER] != "") {			$qry .= $and.ORDPROM_ORDER." = '".$array[ORDPROM_ORDER]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER_SBMNU_DISH] != "") {			$qry .= $and.ORDPROM_ORDER_SBMNU_DISH." = '".$array[ORDPROM_ORDER_SBMNU_DISH]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT] != "") {			$qry .= $and.ORDPROM_DISCOUNT." = '".$array[ORDPROM_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_START_DATE] != "") {			$qry .= $and.ORDPROM_START_DATE." = '".$array[ORDPROM_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_END_DATE] != "") {			$qry .= $and.ORDPROM_END_DATE." = '".$array[ORDPROM_END_DATE]."'".RET;			$and = "AND".RET;		}		if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_order_promotions_active_condition;;			$and = "AND".RET;		}		if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {		$qry .=" ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;				//..check deactive date is not set or 0				if((is_not_empty($record[TBL_ORDER_PROMOTIONS_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_ORDER_PROMOTIONS_DEACTIVE_DATE]))== false)){					$isActive = 1; 				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_ORDER_PROMOTIONS_DEACTIVE_DATE]) > strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}				if($isArray){					$class_object = array();					$class_object["ordprom_id"]=$record[ORDPROM_ID];					$class_object["ordprom_order"]=$record[ORDPROM_ORDER];					$class_object["ordprom_order_sbmnu_dish"]=$record[ORDPROM_ORDER_SBMNU_DISH];					$class_object["ordprom_promotion"]=$record[ORDPROM_PROMOTION];					$class_object["ordprom_discount"]=$record[ORDPROM_DISCOUNT];					$class_object["ordprom_start_date"]=$record[ORDPROM_START_DATE];					$class_object["ordprom_end_date"]=$record[ORDPROM_END_DATE];					$class_object["isActive"]=$isActive;				}else{					$class_object = new tbl_order_promotions();					$class_object->setordprom_id($record[ORDPROM_ID]);					$class_object->setordprom_order($record[ORDPROM_ORDER]);					$class_object->setordprom_order_sbmnu_dish($record[ORDPROM_ORDER_SBMNU_DISH]);					$class_object->setordprom_promotion($record[ORDPROM_PROMOTION]);					$class_object->setordprom_discount($record[ORDPROM_DISCOUNT]);					$class_object->setordprom_start_date($record[ORDPROM_START_DATE]);					$class_object->setordprom_end_date($record[ORDPROM_END_DATE]);				}				$class_objects[$record[ORDPROM_ID]] = $class_object;			}		}		return $class_objects;	}//..End readArray	public function insert() {		if($this->getordprom_id() != '') {			$qry  = "UPDATE ".TBL_ORDER_PROMOTIONS.RET."SET".RET."			".ORDPROM_ID." = '".$this->getordprom_id()."',".RET."			".ORDPROM_ORDER." = '".$this->getordprom_order()."',".RET."			".ORDPROM_ORDER_SBMNU_DISH." = '".$this->getordprom_order_sbmnu_dish()."',".RET."			".ORDPROM_PROMOTION." = '".$this->getordprom_promotion()."',".RET."			".ORDPROM_DISCOUNT." = '".$this->getordprom_discount()."',".RET."			".ORDPROM_START_DATE." = '".$this->getordprom_start_date()."',".RET."			".ORDPROM_END_DATE." = '".$this->getordprom_end_date()."'".RET.			"WHERE ".ORDPROM_ID." = ".$this->getordprom_id().RET;			mysql_query($qry);		} else {			$qry  = "INSERT INTO ".TBL_ORDER_PROMOTIONS." (".RET.			"".ORDPROM_ORDER.", ".ORDPROM_ORDER_SBMNU_DISH.", ".ORDPROM_PROMOTION.", ".ORDPROM_DISCOUNT.", ".ORDPROM_START_DATE.", ".ORDPROM_END_DATE.RET.				") VALUES (".RET.			"'".$this->getordprom_order()."',".RET.			"'".$this->getordprom_order_sbmnu_dish()."',".RET.			"'".$this->getordprom_promotion()."',".RET.			"'".$this->getordprom_discount()."',".RET.			"'".$this->getordprom_start_date()."',".RET.			"'".$this->getordprom_end_date()."'".RET.			")".RET;			$res = mysql_query($qry);			$this->setordprom_id(mysql_insert_id());		}	}//..End Insert	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".TBL_ORDER_PROMOTIONS.RET;		$and = "WHERE".RET;		if($array[ORDPROM_ID] != "") {			$qry .= $and.ORDPROM_ID." = '".$array[ORDPROM_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER] != "") {			$qry .= $and.ORDPROM_ORDER." = '".$array[ORDPROM_ORDER]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_ORDER_SBMNU_DISH] != "") {			$qry .= $and.ORDPROM_ORDER_SBMNU_DISH." = '".$array[ORDPROM_ORDER_SBMNU_DISH]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT] != "") {			$qry .= $and.ORDPROM_DISCOUNT." = '".$array[ORDPROM_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_START_DATE] != "") {			$qry .= $and.ORDPROM_START_DATE." = '".$array[ORDPROM_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_END_DATE] != "") {			$qry .= $and.ORDPROM_END_DATE." = '".$array[ORDPROM_END_DATE]."'".RET;			$and = "AND".RET;		}		$res = mysql_query($qry);		if($res){			return OPERATION_SUCCESS;		};		return OPERATION_FAIL;	}//..End Delete	public function isAlreadyThere($ordprom_order ,$ordprom_order_sbmnu_dish ,$ordprom_promotion ,$ordprom_discount ,$ordprom_start_date ,$ordprom_end_date) {		$unique_arr = array();			//$unique_arr[ORDPROM_ID]=$ordprom_id;			//$unique_arr[ORDPROM_ORDER]=$ordprom_order;			//$unique_arr[ORDPROM_ORDER_SBMNU_DISH]=$ordprom_order_sbmnu_dish;			//$unique_arr[ORDPROM_PROMOTION]=$ordprom_promotion;			//$unique_arr[ORDPROM_DISCOUNT]=$ordprom_discount;			//$unique_arr[ORDPROM_START_DATE]=$ordprom_start_date;			//$unique_arr[ORDPROM_END_DATE]=$ordprom_end_date;		if(is_not_empty($unique_arr)){			return $this->readObject($unique_arr);		}		return false;	}//..isAlreadyThere	public function create($ordprom_order ,$ordprom_order_sbmnu_dish ,$ordprom_promotion ,$ordprom_discount ,$ordprom_start_date ,$ordprom_end_date) {		if(is_not_empty($ordprom_order)){			if($this->isAlreadyThere($ordprom_order ,$ordprom_order_sbmnu_dish ,$ordprom_promotion ,$ordprom_discount ,$ordprom_start_date ,$ordprom_end_date)){				return OPERATION_DUPLICATE;			}else{				$this->setordprom_id("");				$this->setordprom_order($ordprom_order);				$this->setordprom_order_sbmnu_dish($ordprom_order_sbmnu_dish);				$this->setordprom_promotion($ordprom_promotion);				$this->setordprom_discount($ordprom_discount);				$this->setordprom_start_date(date(DATE_FORMAT));				$this->insert();				return $this->getordprom_id();			}		}		return OPERATION_FAIL;	}//..create	public function update($ordprom_id, $ordprom_order, $ordprom_order_sbmnu_dish, $ordprom_promotion, $ordprom_discount, $ordprom_start_date, $ordprom_end_date) {		if(is_gt_zero_num($ordprom_id)){			if ($this->readObject(array(ORDPROM_ID=>$ordprom_id))){				$this->setordprom_order($ordprom_order);				$this->setordprom_order_sbmnu_dish($ordprom_order_sbmnu_dish);				$this->setordprom_promotion($ordprom_promotion);				$this->setordprom_discount($ordprom_discount);				$this->insert();				return OPERATION_SUCCESS;			}		}		return OPERATION_FAIL;	}//..update	public function activate($ordprom_id){		if(is_gt_zero_num($ordprom_id)){			if ($this->readObject(array(ORDPROM_ID=>$ordprom_id))){				$qry  = "UPDATE ".TBL_ORDER_PROMOTIONS.RET."SET".RET."			".TBL_ORDER_PROMOTIONS_DEACTIVE_DATE." = '".date(EMPTY_DATE_FORMAT)."' WHERE ".ORDPROM_ID."={$ordprom_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end activate	public function deactivate($ordprom_id){		if(is_gt_zero_num($ordprom_id)){			if ($this->readObject(array(ORDPROM_ID=>$ordprom_id))){				$qry  = "UPDATE ".TBL_ORDER_PROMOTIONS.RET."SET".RET."			".TBL_ORDER_PROMOTIONS_DEACTIVE_DATE." = '".date(DATE_FORMAT)."' WHERE ".ORDPROM_ID."={$ordprom_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end deactivate	public static function GetInfo($ordprom_id) {		$info = array();		if($ordprom_id != ""){			$obj_tbl_order_promotions = new tbl_order_promotions();			if($obj_tbl_order_promotions->readObject(array("ordprom_id"=>$ordprom_id))){				$info["ordprom_id"]=$obj_tbl_order_promotions->getordprom_id();				$info["ordprom_order"]=$obj_tbl_order_promotions->getordprom_order();				$info["ordprom_order_sbmnu_dish"]=$obj_tbl_order_promotions->getordprom_order_sbmnu_dish();				$info["ordprom_promotion"]=$obj_tbl_order_promotions->getordprom_promotion();				$info["ordprom_discount"]=$obj_tbl_order_promotions->getordprom_discount();				$info["ordprom_start_date"]=$obj_tbl_order_promotions->getordprom_start_date();				$info["ordprom_end_date"]=$obj_tbl_order_promotions->getordprom_end_date();				$info["isActive"] = 0;				//..check deactive date is not set or 0				if((is_not_empty($obj_tbl_order_promotions->gettbl_order_promotions_deactive_date())==false)  || (is_gt_zero_num(strtotime($obj_tbl_order_promotions->gettbl_order_promotions_deactive_date()))== false)){					$info["isActive"] = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($obj_tbl_order_promotions->gettbl_order_promotions_deactive_date()) > strtotime(date(DATE_FORMAT))){						$info["isActive"] = 1;					}				}			}		unset($obj_tbl_order_promotions);		return $info;		}	}//..End GetInfo	public static function GetFields($data){		global $tbl_order_promotions_active_condition;		$arr = array();		if(is_not_empty($data)){			$qry ="SELECT ".$data['key_field'].",".$data['value_field']." FROM ".TBL_ORDER_PROMOTIONS."";			if(is_gt_zero_num($data['isActive'])){				$qry .= " WHERE ".$tbl_order_promotions_active_condition;			}			$res = mysql_query($qry); 			if($res){				while($row=mysql_fetch_assoc($res)){					$arr[$row[$data['key_field']]] = $row[$data['value_field']];				}			}		}		return $arr;	}//.. End of GetFields		//..function to check if discount is applied to the order	public static function chkIfPromAlreadyApplied($order_id,$promotion_id){		$fnd=0;	//..First check if it is applied to whole order discount	$result = mysql_query("SELECT COUNT(".ORDPROM_ID.") `cnt` FROM ".TBL_ORDER_PROMOTIONS." WHERE ".ORDPROM_ORDER."={$order_id} AND ".ORDPROM_PROMOTION."={$promotion_id} AND ".ORDPROM_DISCOUNT.">0 AND ".ORDPROM_ORDER_SBMNU_DISH."=0;");	$fnd=mysql_result($result, 0); 	if($fnd){		return 1;	}else{					//..get the the order item list		$order_items=tbl_order_promotions::getOrderItems($order_id);		//..get the the order promotion item list		$ord_prom_items=tbl_order_promotions::getOrderPromotionItems($order_id,$promotion_id);		//..Check if both are same		if((is_not_empty($orde_items)) && (is_not_empty($ord_prom_items))){			if($orde_items==$ord_prom_items){				return 1;			}		}		}	return $fnd;		 }   /** * Get the order promotion items * @param integer $order_id * @param integer $promotion_id * @return string */     public static function getOrderPromotionItems($order_id,$promotion_id){			$items='';				$listof_submenu = '';		//..Get the Promotions submenu Discount 		$tmpres  = mysql_query('SELECT GROUP_CONCAT('.PRMDISC_BOGO_SBMNU.')  FROM '.TBL_PROM_DISCOUNTS.' WHERE '.PRMDISC_BOGO_SBMNU_DISH.' = 0 AND '.PRMDISC_PROMOTION.'='.$promotion_id);		if($tmpres && mysql_num_rows($tmpres)){			$listof_submenu = mysql_result($tmpres,0);		} 		unset($tmpres);				$listof_order_items = '';		if(is_not_empty($listof_submenu)){			$tmpres = mysql_query('SELECT GROUP_CONCAT('.ORDER_DTL_ID.') FROM'.TBL_ORDER_DETAILS.' WHERE '.ORDER_DTL_ORDER_ID.'='.$order_id.' AND '.ORDER_DTL_SUBMENU_DISH_ID.' IN (SELECT '.SBMNU_DISH_ID.' FROM '.TBL_SUBMENU_DISHES.' WHERE '.SBMNU_DISH_SUBMENU.' IN ('.$listof_submenu.')) ');			if($tmpres && mysql_num_rows($tmpres)){				$listof_order_items = mysql_result($tmpres,0);			} 			unset($tmpres);		}						$qry="SELECT GROUP_CONCAT(`ordprom_order_sbmnu_dish`) FROM ".TBL_ORDER_PROMOTIONS."  WHERE ".ORDPROM_ORDER."={$order_id} AND ".ORDPROM_PROMOTION."={$promotion_id} AND ".ORDPROM_DISCOUNT.">0 AND ".ORDPROM_ORDER_SBMNU_DISH.">0";		$res = mysql_query($qry); 		if($res){			$items=mysql_result($res, 0); 		}		return $items;   } 	 	 	 	  	 	    //..Get the order items   public static function getOrderItems($order_id){			$items='';		$qry='SELECT GROUP_CONCAT(`ord_dtl_id`) FROM `tbl_order_details` WHERE `ord_dtl_order_id`='.$order_id;		$res = mysql_query($qry); 		if($res){			$items=mysql_result($res, 0); 		}		return $items;   }	     }//..End tbl_order_promotions?>