<?php/**********************************************************************tbl_tip.class.phpGenerated by STRUCTY 2013.08.29 10:50:44.Copyright 2011 Structy, Frédéric Aebi. All rights reserved.**********************************************************************/define("TBL_TIP", "tbl_tip"); define('TIP_ID', 'tip_id'); define('TIP_PERCENT', 'tip_percent'); define('TIP_START_DATE', 'tip_start_date'); define('TIP_END_DATE', 'tip_end_date');define('TIP_RESTAURENT', 'tip_restaurent');define("TBL_TIP_ACTIVE_DATE",  TIP_START_DATE);define("TBL_TIP_DEACTIVE_DATE",  TIP_END_DATE);$tbl_tip_active_condition= '('.TBL_TIP_DEACTIVE_DATE.' <= NOW()) AND ('.TBL_TIP_DEACTIVE_DATE.' is NULL OR '.TBL_TIP_DEACTIVE_DATE.' = 0 OR '.TBL_TIP_DEACTIVE_DATE.' > NOW() ) ';// " (".TBL_TIP_DEACTIVE_DATE." is NULL OR ".TBL_TIP_DEACTIVE_DATE." = 0 OR ".TBL_TIP_DEACTIVE_DATE." > CURDATE( )) ";class tbl_tip {	private $tip_id;	private $tip_percent;	private $tip_start_date;	private $tip_end_date;		private $tip_restaurent;	private $tbl_tip_active_date;	private $tbl_tip_deactive_date;	public function settip_id($pArg="0") {$this->tip_id=$pArg;}	public function settip_percent($pArg="0") {$this->tip_percent=$pArg;}	public function settip_start_date($pArg="0") {$this->tip_start_date=$pArg;}	public function settip_end_date($pArg="0") {$this->tip_end_date=$pArg;}	public function settbl_tip_active_date($pArg="0") {$this->tbl_tip_active_date=$pArg;}	public function settbl_tip_deactive_date($pArg="0") {$this->tbl_tip_deactive_date=$pArg;}		public function settip_restaurent($pArg="0") {$this->tip_restaurent=$pArg;}	public function gettip_id() {return $this->tip_id;}	public function gettip_percent() {return $this->tip_percent;}	public function gettip_start_date() {return $this->tip_start_date;}	public function gettip_end_date() {return $this->tip_end_date;}	public function gettbl_tip_active_date($pArg="0") {return $this->tbl_tip_active_date;}	public function gettbl_tip_deactive_date($pArg="0") {return $this->tbl_tip_deactive_date;}	public function gettip_restaurent() {return $this->tip_restaurent;}	public function readObject($array = array()) {		$qry = "SELECT *".RET."FROM ".TBL_TIP.RET;		$and = "WHERE".RET;		if($array[TIP_ID] != "") {			$qry .= $and.TIP_ID." = '".$array[TIP_ID]."'".RET;			$and = "AND".RET;		}		if($array[TIP_PERCENT] != "") {			$qry .= $and.TIP_PERCENT." = '".$array[TIP_PERCENT]."'".RET;			$and = "AND".RET;		}		if($array[TIP_START_DATE] != "") {			$qry .= $and.TIP_START_DATE." = '".$array[TIP_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[TIP_END_DATE] != "") {			$qry .= $and.TIP_END_DATE." = '".$array[TIP_END_DATE]."'".RET;			$and = "AND".RET;		}				if($array[TIP_RESTAURENT] != "") {			$qry .= $and.TIP_RESTAURENT." = '".$array[TIP_RESTAURENT]."'".RET;			$and = "AND".RET;		}	$result = mysql_query($qry);		if($result) {			while ($row = mysql_fetch_array($result)) {				$record = $row;				break;//end after first record			}			if(count($record[0]) == 0) {				return array();			} else {				$this->settip_id($record[TIP_ID]);				$this->settip_percent($record[TIP_PERCENT]);				$this->settip_start_date($record[TIP_START_DATE]);				$this->settip_end_date($record[TIP_END_DATE]);				$this->settbl_tip_active_date($record[TBL_TIP_ACTIVE_DATE]);				$this->settbl_tip_deactive_date($record[TBL_TIP_DEACTIVE_DATE]);								$this->settip_restaurent($record[TIP_RESTAURENT]);				return true;			}		}	}	public static function readArray($array = array(),&$result_found=0,$isArray=1) {		global $tbl_tip_active_condition;		$qry = "SELECT *".RET."FROM ".TBL_TIP.RET;		$and = "WHERE".RET;		if($array[TIP_ID] != "") {			$qry .= $and.TIP_ID." = '".$array[TIP_ID]."'".RET;			$and = "AND".RET;		}		if($array[TIP_PERCENT] != "") {			$qry .= $and.TIP_PERCENT." = '".$array[TIP_PERCENT]."'".RET;			$and = "AND".RET;		}		if($array[TIP_START_DATE] != "") {			$qry .= $and.TIP_START_DATE." = '".$array[TIP_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[TIP_END_DATE] != "") {			$qry .= $and.TIP_END_DATE." = '".$array[TIP_END_DATE]."'".RET;			$and = "AND".RET;		}		if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_tip_active_condition;;			$and = "AND".RET;		}		if($array[TIP_RESTAURENT] != "") {			$qry .= $and.TIP_RESTAURENT." = '".$array[TIP_RESTAURENT]."'".RET;			$and = "AND".RET;		}		if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {		$qry .=" ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}		//echo "qry_with_limit=$qry_with_limit";		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;				//..check deactive date is not set or 0				if((is_not_empty($record[TBL_TIP_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_TIP_DEACTIVE_DATE]))== false)){					$isActive = 1; 				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_TIP_DEACTIVE_DATE]) > strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}				if($isArray){					$class_object = array();					$class_object["tip_id"]=$record[TIP_ID];					$class_object["tip_percent"]=$record[TIP_PERCENT];					$class_object["tip_start_date"]=$record[TIP_START_DATE];					$class_object["tip_end_date"]=$record[TIP_END_DATE];					$class_object["isActive"]=$isActive;					$class_object["tip_restaurent"]=$tip_restaurent;									}else{					$class_object = new tbl_tip();					$class_object->settip_id($record[TIP_ID]);					$class_object->settip_percent($record[TIP_PERCENT]);					$class_object->settip_start_date($record[TIP_START_DATE]);					$class_object->settip_end_date($record[TIP_END_DATE]);					$class_object->settip_restaurent($record[TIP_RESTAURENT]);				}				$class_objects[$record[TIP_ID]] = $class_object;			}		}		return $class_objects;	}//..End readArray	public function insert() {		if($this->gettip_id() != '') {			$qry  = "UPDATE ".TBL_TIP.RET."SET".RET."			".TIP_ID." = '".$this->gettip_id()."',".RET."			".TIP_PERCENT." = '".$this->gettip_percent()."',".RET."				".TIP_START_DATE." = '".date(DATE_FORMAT)."',".RET."			".TIP_END_DATE." = NULL".RET.			"WHERE ".TIP_ID." = ".$this->gettip_id().RET;			mysql_query($qry);		} else {			$qry  = "INSERT INTO ".TBL_TIP." (".RET.			"".TIP_PERCENT.", ".TIP_START_DATE.", ".TIP_END_DATE.", ".TIP_RESTAURENT.RET.				") VALUES (".RET.			"'".$this->gettip_percent()."',".RET.			"'".date(DATE_FORMAT)."',".RET.			"NULL,".RET.			"'".$_SESSION[SES_RESTAURANT]."'".RET.			")".RET;			//echo "$qry";			$res = mysql_query($qry);			$this->settip_id(mysql_insert_id());		}	}//..End Insert	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".TBL_TIP.RET;		$and = "WHERE".RET;		if($array[TIP_ID] != "") {			$qry .= $and.TIP_ID." IN (".$array[TIP_ID].")".RET;			$and = "AND".RET;		}		if($array[TIP_PERCENT] != "") {			$qry .= $and.TIP_PERCENT." = '".$array[TIP_PERCENT]."'".RET;			$and = "AND".RET;		}		if($array[TIP_START_DATE] != "") {			$qry .= $and.TIP_START_DATE." = '".$array[TIP_START_DATE]."'".RET;			$and = "AND".RET;		}		if($array[TIP_END_DATE] != "") {			$qry .= $and.TIP_END_DATE." = '".$array[TIP_END_DATE]."'".RET;			$and = "AND".RET;		}				if($array[TIP_RESTAURENT] != "") {			$qry .= $and.TIP_RESTAURENT." = '".$array[TIP_RESTAURENT]."'".RET;			$and = "AND".RET;		}		$res = mysql_query($qry);		if($res){			return OPERATION_SUCCESS;		};		return OPERATION_FAIL;	}//..End Delete	public function isAlreadyThere($tip_percent ,$tip_start_date ,$tip_end_date) {		$unique_arr = array();			//$unique_arr[TIP_ID]=$tip_id;			$unique_arr[TIP_PERCENT]=$tip_percent;			$unique_arr[TIP_RESTAURENT]=$_SESSION[SES_RESTAURANT];			//$unique_arr[TIP_START_DATE]=$tip_start_date;			//$unique_arr[TIP_END_DATE]=$tip_end_date;		if(is_not_empty($unique_arr)){			return $this->readObject($unique_arr);		}		return false;	}//..isAlreadyThere	public function create($tip_percent ,$tip_start_date ,$tip_end_date) {		if(is_not_empty($tip_percent)){			if($this->isAlreadyThere($tip_percent ,$tip_start_date ,$tip_end_date)){				return OPERATION_DUPLICATE;			}else{				$this->settip_id("");				$this->settip_percent($tip_percent);				$this->settip_start_date(date(DATE_FORMAT));				$this->insert();				return $this->gettip_id();			}		}		return OPERATION_FAIL;	}//..create	public function update($tip_id, $tip_percent, $tip_start_date, $tip_end_date) {		if(is_gt_zero_num($tip_id)){			if ($this->readObject(array(TIP_ID=>$tip_id))){				$this->settip_percent($tip_percent);				$this->insert();				return OPERATION_SUCCESS;			}		}		return OPERATION_FAIL;	}//..update	public function activate($tip_id){		if(is_not_empty($tip_id)){			//if ($this->readObject(array(TIP_ID=>$tip_id))){				$qry  = 'UPDATE '.TBL_TIP.RET.'SET'.RET.'			'.TBL_TIP_DEACTIVE_DATE.' = \''.date(EMPTY_DATE_FORMAT).'\' WHERE '.TIP_ID.' IN ('.$tip_id.')';				$res = mysql_query($qry);				if($res){					return 1;				}			//}		}		return 0;	}//..end activate	public function deactivate($tip_id){		if(is_not_empty($tip_id)){			//if ($this->readObject(array(TIP_ID=>$tip_id))){				$qry  = 'UPDATE '.TBL_TIP.RET.'SET'.RET.'			'.TBL_TIP_DEACTIVE_DATE.' = \''.date(DATE_FORMAT).'\' WHERE '.TIP_ID.' IN ('.$tip_id.')';				$res = mysql_query($qry);				if($res){					return 1;				}			//}		}		return 0;	}//..end deactivate	public static function GetInfo($tip_id) {		$info = array();		if($tip_id != ""){			$obj_tbl_tip = new tbl_tip();			if($obj_tbl_tip->readObject(array("tip_id"=>$tip_id))){				$info["tip_id"]=$obj_tbl_tip->gettip_id();				$info["tip_percent"]=$obj_tbl_tip->gettip_percent();				$info["tip_start_date"]=$obj_tbl_tip->gettip_start_date();				$info["tip_end_date"]=$obj_tbl_tip->gettip_end_date();				$info["isActive"] = 0;				$info["tip_restaurent"] = $tip_restaurent;				//..check deactive date is not set or 0				if((is_not_empty($obj_tbl_tip->gettbl_tip_deactive_date())==false)  || (is_gt_zero_num(strtotime($obj_tbl_tip->gettbl_tip_deactive_date()))== false)){					$info["isActive"] = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($obj_tbl_tip->gettbl_tip_deactive_date()) > strtotime(date(DATE_FORMAT))){						$info["isActive"] = 1;					}				}			}		unset($obj_tbl_tip);		return $info;		}	}//..End GetInfo	public static function GetFields($data){		global $tbl_tip_active_condition;		$arr = array();		if(is_not_empty($data)){			$qry ='SELECT '.$data['key_field'].','.$data['value_field'].' FROM '.TBL_TIP.'';			$qry .= ' WHERE '.TIP_RESTAURENT.'='.$_SESSION[SES_RESTAURANT];				if(is_gt_zero_num($data['isActive'])){				$qry .= ' AND '.$tbl_tip_active_condition;						}			//echo $qry;			$res = mysql_query($qry); 			if($res){				while($row=mysql_fetch_assoc($res)){					$arr[$row[$data['key_field']]] = $row[$data['value_field']];				}			}		}		return $arr;	}//.. End of GetFields				public static function getTipList($array = array(),&$result_found=0,$isArray=1) {		global $tbl_tip_active_condition;		//$qry = "SELECT *".RET."FROM ".TBL_TIP.RET;	  		/*$qry='SELECT `tbl_orders`.*,  `tbl_sft_id`, `tbl_sft_restaurant_id`, `tbl_sft_shift_id`, `tbl_sft_emp_id`, `tbl_sft_table_id`, `tbl_sft_period_from`, `tbl_sft_period_to`, `tb_sft_created_on`, `tb_sft_terminated_on`, `table_number`,`shift_name`, CONCAT(`staff_fname`," ",`staff_lname`) AS `employee_name` '.RET. 			' FROM '.TBL_ORDERS.' INNER JOIN 			'.TBL_TABLE_SHIFT_ASSIGNMENT.' ON `order_table_id` = `tbl_sft_table_id` '. 		' INNER JOIN  '.TBL_DINING_TABLE.' ON `table_id`=`tbl_sft_table_id` '.RET.		' INNER JOIN '.TBL_STAFF.' ON `tbl_sft_emp_id` =`staff_member_id` '.RET.		' INNER JOIN '.TBL_SHIFT.' ON `tbl_sft_shift_id` = `shift_id`';*/				$qry='SELECT SQL_NO_CACHE `order_id` , `order_table_id` ,`order_customer_name`, `order_emp_id` ,SUM(`order_tip`) `order_tip`, `order_created_on` , order_restaurant , `table_number`, (SELECT   `shift_id` FROM '.TBL_SHIFT.' WHERE shift_restaurent = '.$_SESSION[SES_RESTAURANT].' AND TIME(`order_created_on`) between shift_start_time AND shift_end_time AND (`shift_terminated_on` > NOW() OR `shift_terminated_on` is NULL OR `shift_terminated_on` = \'00-00-0000 00:00:00\' ) LIMIT 1) `shift_id` ,  CONCAT(`staff_fname`," ",`staff_lname`) AS `employee_name`,  DATE_FORMAT(`order_created_on`, "%Y-%m-%d") `order_date` '.RET.'		FROM '.TBL_ORDERS.'   		INNER JOIN  '.TBL_DINING_TABLE.' ON `table_id`=`order_table_id` '.RET.'		INNER JOIN '.TBL_STAFF.' ON `order_emp_id` =`staff_member_id` ';				if($array['type']=='table'){			$qry .=' GROUP BY  `order_table_id`,`order_date`,`shift_id` HAVING `'.TBL_ORDERS.'`.`order_restaurant`='.$_SESSION[SES_RESTAURANT];			if(is_gt_zero_num($array['table'])){				$qry .= ' AND `order_table_id`= '.$array['table'];			}					}else{			$qry .=' GROUP BY  `order_emp_id`,`order_date`,`shift_id`  HAVING `'.TBL_ORDERS.'`.`order_restaurant`='.$_SESSION[SES_RESTAURANT];			if(is_gt_zero_num($array['employee'])){				$qry .= ' AND `order_emp_id`= '.$array['employee'];			}		}		 				if(is_not_empty($array['from_date']) && is_not_empty($array['to_date'])){						$qry .= ' AND DATE('.ORDER_CREATED_ON.') BETWEEN  DATE(\''.$array['from_date'].'\') AND DATE(\''.$array['to_date'].'\') ';					} 		/*if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {					$qry .=' ORDER BY '.$array[SORT_ON].' '.$array[SORT_BY];	}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry.' LIMIT '.$array[OFFSET_TITLE].','.$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}*/		 //echo $qry;		$qry_with_limit =  $qry;		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		//echo $qry_with_limit;		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			$class_object=array();			while ($record = mysql_fetch_assoc($result)) { 			//print_r($record); echo '<hr/>'; 			if($array['type']=='table'){				if(isset($class_objects[$record['order_table_id']][$record['order_date']])==FALSE){								$class_objects[$record['order_table_id']][$record['order_date']] = $record;			 }								$class_objects[$record['order_table_id']][$record['order_date']]['shift'] [$record['shift_id']] = $record['order_tip'];  			}else{				 if(isset($class_objects[$record['order_emp_id']][$record['order_date']])==FALSE){								$class_objects[$record['order_emp_id']][$record['order_date']] = $record; 				 }								$class_objects[$record['order_emp_id']][$record['order_date']]['shift'][$record['shift_id']] = $record['order_tip'];   			}			}			unset($class_object);		}				//echo '<br/><br/><br/>'; 		 		return $class_objects;	}//..End readArray}//..End tbl_tip?>