<?php/**********************************************************************tbl_order_applied_proms.class.phpGenerated by STRUCTY 2013.10.17 10:50:25.Copyright 2011 Structy, Fré¤©ric Aebi. All rights reserved.**********************************************************************/define('TBL_ORDER_APPLIED_PROMS', 'tbl_order_applied_proms'); define('ORD_APP_PROM', 'ord_app_prom'); define('ORD_DTL_ID', 'ord_dtl_id'); define('ORD_DTL_ORDER_ID', 'ord_dtl_order_id'); define('ORD_DTL_SBMENU_DISH_ID', 'ord_dtl_sbmenu_dish_id'); define('ORD_DTL_QUANTITY', 'ord_dtl_quantity'); define('ORD_DTL_PRICE', 'ord_dtl_price'); define('ORD_DTL_DISCOUNT', 'ord_dtl_discount'); define('ORDPROM_PROMOTION', 'ordprom_promotion'); define('ORDPROM_DISCOUNT_ID', 'ordprom_discount_id'); define('ORDPROM_DISCOUNT_AMT', 'ordprom_discount_amt'); define('TBL_ORDER_APPLIED_PROMS_ACTIVE_DATE',  '');define('TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE',  '');$tbl_order_applied_proms_active_condition= ' ('.TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE.' is NULL OR '.TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE.' = 0 OR '.TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE.' > CURDATE( )) ';class tbl_order_applied_proms {	private $ord_app_prom;	private $ord_dtl_id;	private $ord_dtl_order_id;	private $ord_dtl_sbmenu_dish_id;	private $ord_dtl_quantity;	private $ord_dtl_price;	private $ord_dtl_discount;	private $ordprom_promotion;	private $ordprom_discount_id;	private $ordprom_discount_amt;	private $tbl_order_applied_proms_active_date;	private $tbl_order_applied_proms_deactive_date;	public function setord_app_prom($pArg="0") {$this->ord_app_prom=$pArg;}	public function setord_dtl_id($pArg="0") {$this->ord_dtl_id=$pArg;}	public function setord_dtl_order_id($pArg="0") {$this->ord_dtl_order_id=$pArg;}	public function setord_dtl_sbmenu_dish_id($pArg="0") {$this->ord_dtl_sbmenu_dish_id=$pArg;}	public function setord_dtl_quantity($pArg="0") {$this->ord_dtl_quantity=$pArg;}	public function setord_dtl_price($pArg="0") {$this->ord_dtl_price=$pArg;}	public function setord_dtl_discount($pArg="0") {$this->ord_dtl_discount=$pArg;}	public function setordprom_promotion($pArg="0") {$this->ordprom_promotion=$pArg;}	public function setordprom_discount_id($pArg="0") {$this->ordprom_discount_id=$pArg;}	public function setordprom_discount_amt($pArg="0") {$this->ordprom_discount_amt=$pArg;}	public function settbl_order_applied_proms_active_date($pArg="0") {$this->tbl_order_applied_proms_active_date=$pArg;}	public function settbl_order_applied_proms_deactive_date($pArg="0") {$this->tbl_order_applied_proms_deactive_date=$pArg;}	public function getord_app_prom() {return $this->ord_app_prom;}	public function getord_dtl_id() {return $this->ord_dtl_id;}	public function getord_dtl_order_id() {return $this->ord_dtl_order_id;}	public function getord_dtl_sbmenu_dish_id() {return $this->ord_dtl_sbmenu_dish_id;}	public function getord_dtl_quantity() {return $this->ord_dtl_quantity;}	public function getord_dtl_price() {return $this->ord_dtl_price;}	public function getord_dtl_discount() {return $this->ord_dtl_discount;}	public function getordprom_promotion() {return $this->ordprom_promotion;}	public function getordprom_discount_id() {return $this->ordprom_discount_id;}	public function getordprom_discount_amt() {return $this->ordprom_discount_amt;}	public function gettbl_order_applied_proms_active_date($pArg="0") {return $this->tbl_order_applied_proms_active_date;}	public function gettbl_order_applied_proms_deactive_date($pArg="0") {return $this->tbl_order_applied_proms_deactive_date;}	public function readObject($array = array()) {		$qry = "SELECT *".RET."FROM ".TBL_ORDER_APPLIED_PROMS.RET;		$and = "WHERE".RET;		if($array[ORD_APP_PROM] != "") {			$qry .= $and.ORD_APP_PROM." = '".$array[ORD_APP_PROM]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_DISCOUNT] != "") {			$qry .= $and.ORD_DTL_DISCOUNT." = '".$array[ORD_DTL_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			$qry .= $and.ORDPROM_DISCOUNT_AMT." = '".$array[ORDPROM_DISCOUNT_AMT]."'".RET;			$and = "AND".RET;		}	$result = mysql_query($qry);		if($result) {			while ($row = mysql_fetch_array($result)) {				$record = $row;				break;//end after first record			}			if(count($record[0]) == 0) {				return array();			} else {				$this->setord_app_prom($record[ORD_APP_PROM]);				$this->setord_dtl_id($record[ORD_DTL_ID]);				$this->setord_dtl_order_id($record[ORD_DTL_ORDER_ID]);				$this->setord_dtl_sbmenu_dish_id($record[ORD_DTL_SBMENU_DISH_ID]);				$this->setord_dtl_quantity($record[ORD_DTL_QUANTITY]);				$this->setord_dtl_price($record[ORD_DTL_PRICE]);				$this->setord_dtl_discount($record[ORD_DTL_DISCOUNT]);				$this->setordprom_promotion($record[ORDPROM_PROMOTION]);				$this->setordprom_discount_id($record[ORDPROM_DISCOUNT_ID]);				$this->setordprom_discount_amt($record[ORDPROM_DISCOUNT_AMT]);				$this->settbl_order_applied_proms_active_date($record[TBL_ORDER_APPLIED_PROMS_ACTIVE_DATE]);				$this->settbl_order_applied_proms_deactive_date($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE]);				return true;			}		}	}	/*public static function readArray($array = array(),&$result_found=0,$isArray=1) {		global $tbl_order_applied_proms_active_condition;		$qry = "SELECT *".RET."FROM ".TBL_ORDER_APPLIED_PROMS.RET;		$and = "WHERE".RET;		if($array[ORD_APP_PROM] != "") {			$qry .= $and.ORD_APP_PROM." = '".$array[ORD_APP_PROM]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_DISCOUNT] != "") {			$qry .= $and.ORD_DTL_DISCOUNT." = '".$array[ORD_DTL_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			$qry .= $and.ORDPROM_DISCOUNT_AMT." = '".$array[ORDPROM_DISCOUNT_AMT]."'".RET;			$and = "AND".RET;		}		if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_order_applied_proms_active_condition;;			$and = "AND".RET;		}		if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {		$qry .=" ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;				//..check deactive date is not set or 0				if((is_not_empty($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE]))== false)){					$isActive = 1; 				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE]) > strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}				if($isArray){					$class_object = array();					$class_object["ord_app_prom"]=$record[ORD_APP_PROM];					$class_object["ord_dtl_id"]=$record[ORD_DTL_ID];					$class_object["ord_dtl_order_id"]=$record[ORD_DTL_ORDER_ID];					$class_object["ord_dtl_sbmenu_dish_id"]=$record[ORD_DTL_SBMENU_DISH_ID];					$class_object["ord_dtl_quantity"]=$record[ORD_DTL_QUANTITY];					$class_object["ord_dtl_price"]=$record[ORD_DTL_PRICE];					$class_object["ord_dtl_discount"]=$record[ORD_DTL_DISCOUNT];					$class_object["ordprom_promotion"]=$record[ORDPROM_PROMOTION];					$class_object["ordprom_discount_id"]=$record[ORDPROM_DISCOUNT_ID];					$class_object["ordprom_discount_amt"]=$record[ORDPROM_DISCOUNT_AMT];					$class_object["isActive"]=$isActive;				}else{					$class_object = new tbl_order_applied_proms();					$class_object->setord_app_prom($record[ORD_APP_PROM]);					$class_object->setord_dtl_id($record[ORD_DTL_ID]);					$class_object->setord_dtl_order_id($record[ORD_DTL_ORDER_ID]);					$class_object->setord_dtl_sbmenu_dish_id($record[ORD_DTL_SBMENU_DISH_ID]);					$class_object->setord_dtl_quantity($record[ORD_DTL_QUANTITY]);					$class_object->setord_dtl_price($record[ORD_DTL_PRICE]);					$class_object->setord_dtl_discount($record[ORD_DTL_DISCOUNT]);					$class_object->setordprom_promotion($record[ORDPROM_PROMOTION]);					$class_object->setordprom_discount_id($record[ORDPROM_DISCOUNT_ID]);					$class_object->setordprom_discount_amt($record[ORDPROM_DISCOUNT_AMT]);				}				$class_objects[$record[ORD_APP_PROM]] = $class_object;			}		}		return $class_objects;	}//..End readArray*/				public static function readArray($array = array(),&$result_found=0,$isArray=1,$isOptDetailed=0) {		global $tbl_order_applied_proms_active_condition;		//$qry = "SELECT *".RET."FROM ".TBL_ORDER_DETAILS.RET;		$qry = "SELECT  				`ord_app_prom`,`ord_dtl_id`,`ord_dtl_order_id`,				`ord_dtl_discount`,`ord_dtl_sbmenu_dish_id`, 				`ord_dtl_quantity`, 				`ord_dtl_price`, (					SELECT  `dish_name`  					FROM  					`tbl_submenu_dishes` sbmd 					INNER JOIN `tbl_dishes` d ON					sbmd.sbmnu_dish_dish=d.dish_id  					WHERE `sbmnu_dish_id` = `ord_dtl_sbmenu_dish_id`)  AS `title`, (SELECT  IFNULL(pds_list_promotions.title,'--')  FROM pds_list_promotions WHERE `pds_list_promotions`.`id` = `ordprom_promotion`) AS `prom_title`,					`ordprom_promotion`,`ordprom_discount_id`,`ordprom_discount_amt` 				".RET."FROM ".TBL_ORDER_APPLIED_PROMS.' INNER JOIN '.TBL_ORDERS.' ON  '.ORDER_ID.'='.ORD_DTL_ORDER_ID.' '.RET;		$and = "WHERE".RET;		 		if($array[ORD_APP_PROM] != "") {			//$qry .= $and.ORD_APP_PROM." = '".$array[ORD_APP_PROM]."'".RET;			$qry .= $and.ORD_APP_PROM." IN (".$array[ORD_APP_PROM].")".RET;			$and = "AND".RET;		}				if($array['except_ordprom_id'] != "") {			$qry .= $and.ORD_APP_PROM." NOT IN (".$array['except_ordprom_id'].")".RET;			$and = "AND".RET;		}						if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			//$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." IN (".$array[ORD_DTL_SBMENU_DISH_ID].")".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}				if(is_not_empty($array[ORDPROM_PROMOTION])) {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		 		if(is_not_empty($array['ordprom_promotion_there'])) { 			$qry .= $and.ORDPROM_PROMOTION." > 0'".RET;			$and = "AND".RET;		}						if(is_not_empty($array[ORDPROM_DISCOUNT_ID])) { 			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if(is_not_empty($array[ORDPROM_DISCOUNT_AMT])) {			if($array['isDiscAmtGtZero']==1){				$qry .= $and.ORDPROM_DISCOUNT_AMT." > 0 ".RET;			}else{				$qry .= $and.ORDPROM_DISCOUNT_AMT." = ".$array[ORDPROM_DISCOUNT_AMT]."".RET;			}						$and = "AND".RET;		}				if(is_not_empty($array[ORDER_SESSION_ID])) {		/*	$qry .= $and.ORD_DTL_ORDER_ID.' IN (SELECT '.ORDER_ID.' FROM '.TBL_ORDERS.' WHERE '.ORDER_SESSION_ID.'='.$array[ORDER_SESSION_ID].')';*/			$qry .= $and.ORDER_SESSION_ID." = '".$array[ORDER_SESSION_ID]."'".RET;			$and = "AND".RET;		}				if(is_gt_zero_num($array['non_cancelled_order'])) {		/*	$qry .= $and.ORD_DTL_ORDER_ID.' IN (SELECT '.ORDER_ID.' FROM '.TBL_ORDERS.' WHERE '.ORDER_SESSION_ID.'='.$array[ORDER_SESSION_ID].')';*/			$qry .= $and.ORDER_STATUS_ID." <> ".TBL_STATUS_ORDER_CANCELLED.RET;			$and = "AND".RET;		}				if(is_gt_zero_num($array['isExclusiveApplied'])) {		/*	$qry .= $and.ORD_DTL_ORDER_ID.' IN (SELECT '.ORDER_ID.' FROM '.TBL_ORDERS.' WHERE '.ORDER_SESSION_ID.'='.$array[ORDER_SESSION_ID].')';*/			$qry .= $and.ORDPROM_PROMOTION." IN (SELECT  `pds_list_promotions`.`id` FROM  `pds_list_promotions` WHERE  `pds_list_promotions`.`is_exclusive`=1)".RET;			$and = "AND".RET;		}				 		if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_order_applied_proms_active_condition;;			$and = "AND".RET;		}		if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {		$qry .=" ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		} 	 //echo "<br>SQL=$qry_with_limit <hr>";		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;				//..check deactive date is not set or 0				if((is_not_empty($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE]))== false)){					$isActive = 1; 				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE]) > strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}				if($isArray){					$class_object = array();					$class_object[ORD_APP_PROM]=$record[ORD_APP_PROM];					$class_object["ord_dtl_id"]=$record[ORD_DTL_ID];					$class_object["ord_dtl_order_id"]=$record[ORD_DTL_ORDER_ID];					$class_object["ord_dtl_sbmenu_dish_id"]=$record[ORD_DTL_SBMENU_DISH_ID];					$class_object["ord_dtl_quantity"]=$record[ORD_DTL_QUANTITY];					$class_object["ord_dtl_price"]=$record[ORD_DTL_PRICE];					$class_object["ord_dtl_discount"]=$record[ORD_DTL_DISCOUNT];					$class_object["ordprom_promotion"]=$record[ORDPROM_PROMOTION];					$class_object["ordprom_discount_id"]=$record[ORDPROM_DISCOUNT_ID];					$class_object["ordprom_discount_amt"]=$record[ORDPROM_DISCOUNT_AMT];					$class_object['prom_title'] = (is_not_empty($record['prom_title'])?$record['prom_title']:'--');					$class_object["title"]=$record["title"];					if($isOptDetailed==1){						//get order option details						$objtbl_order_details_options= new tbl_order_details_options();						$opt_val_lst= $objtbl_order_details_options->readArray(array(ORD_DET_OPT_ORDER_DETAIL => $record[ORD_DTL_ID]));						if(is_not_empty($opt_val_lst)){							$class_object["opt_val_details"]=$opt_val_lst;						}						unset($objtbl_order_details_options);					}											$class_object["isActive"]=$isActive;				}else{					$class_object = new tbl_order_applied_proms();					$class_object->setord_app_prom($record[ORD_APP_PROM]);					$class_object->setord_dtl_id($record[ORD_DTL_ID]);					$class_object->setord_dtl_order_id($record[ORD_DTL_ORDER_ID]);					$class_object->setord_dtl_sbmenu_dish_id($record[ORD_DTL_SBMENU_DISH_ID]);					$class_object->setord_dtl_quantity($record[ORD_DTL_QUANTITY]);					$class_object->setord_dtl_price($record[ORD_DTL_PRICE]);					$class_object->setord_dtl_discount($record[ORD_DTL_DISCOUNT]);					$class_object->setordprom_promotion($record[ORDPROM_PROMOTION]);					$class_object->setordprom_discount_id($record[ORDPROM_DISCOUNT_ID]);					$class_object->setordprom_discount_amt($record[ORDPROM_DISCOUNT_AMT]);				}				$class_objects[$record[ORD_APP_PROM]] = $class_object;			}		}		return $class_objects;	}//..End readArray	public function insert() {		if($this->getord_app_prom() != '') {			$qry  = "UPDATE ".TBL_ORDER_APPLIED_PROMS.RET."SET".RET."			".ORD_APP_PROM." = '".$this->getord_app_prom()."',".RET."			".ORD_DTL_ID." = '".$this->getord_dtl_id()."',".RET."			".ORD_DTL_ORDER_ID." = '".$this->getord_dtl_order_id()."',".RET."			".ORD_DTL_SBMENU_DISH_ID." = '".$this->getord_dtl_sbmenu_dish_id()."',".RET."			".ORD_DTL_QUANTITY." = '".$this->getord_dtl_quantity()."',".RET."			".ORD_DTL_PRICE." = '".$this->getord_dtl_price()."',".RET."			".ORD_DTL_DISCOUNT." = '".$this->getord_dtl_discount()."',".RET."			".ORDPROM_PROMOTION." = '".$this->getordprom_promotion()."',".RET."			".ORDPROM_DISCOUNT_ID." = '".$this->getordprom_discount_id()."',".RET."			".ORDPROM_DISCOUNT_AMT." = '".$this->getordprom_discount_amt()."'".RET.			"WHERE ".ORD_APP_PROM." = ".$this->getord_app_prom().RET;			mysql_query($qry);		} else {			$qry  = "INSERT INTO ".TBL_ORDER_APPLIED_PROMS." (".RET.			"".ORD_DTL_ID.", ".ORD_DTL_ORDER_ID.", ".ORD_DTL_SBMENU_DISH_ID.", ".ORD_DTL_QUANTITY.", ".ORD_DTL_PRICE.", ".ORD_DTL_DISCOUNT.", ".ORDPROM_PROMOTION.", ".ORDPROM_DISCOUNT_ID.", ".ORDPROM_DISCOUNT_AMT.RET.				") VALUES (".RET.			"'".$this->getord_dtl_id()."',".RET.			"'".$this->getord_dtl_order_id()."',".RET.			"'".$this->getord_dtl_sbmenu_dish_id()."',".RET.			"'".$this->getord_dtl_quantity()."',".RET.			"'".$this->getord_dtl_price()."',".RET.			"'".$this->getord_dtl_discount()."',".RET.			"'".$this->getordprom_promotion()."',".RET.			"'".$this->getordprom_discount_id()."',".RET.			"'".$this->getordprom_discount_amt()."'".RET.			")".RET;			$res = mysql_query($qry);			$this->setord_app_prom(mysql_insert_id());		}	}//..End Insert	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".TBL_ORDER_APPLIED_PROMS.RET;		$and = "WHERE".RET;		if($array[ORD_APP_PROM] != "") {			$qry .= $and.ORD_APP_PROM." = '".$array[ORD_APP_PROM]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_DISCOUNT] != "") {			$qry .= $and.ORD_DTL_DISCOUNT." = '".$array[ORD_DTL_DISCOUNT]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			$qry .= $and.ORDPROM_DISCOUNT_AMT." = '".$array[ORDPROM_DISCOUNT_AMT]."'".RET;			$and = "AND".RET;		}		$res = mysql_query($qry);		if($res){			return OPERATION_SUCCESS;		};		return OPERATION_FAIL;	}//..End Delete	public function isAlreadyThere($ord_dtl_id ,$ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price ,$ord_dtl_discount ,$ordprom_promotion ,$ordprom_discount_id ,$ordprom_discount_amt) {		$unique_arr = array();			//$unique_arr[ORD_APP_PROM]=$ord_app_prom;			//$unique_arr[ORD_DTL_ID]=$ord_dtl_id;			//$unique_arr[ORD_DTL_ORDER_ID]=$ord_dtl_order_id;			//$unique_arr[ORD_DTL_SBMENU_DISH_ID]=$ord_dtl_sbmenu_dish_id;			//$unique_arr[ORD_DTL_QUANTITY]=$ord_dtl_quantity;			//$unique_arr[ORD_DTL_PRICE]=$ord_dtl_price;			//$unique_arr[ORD_DTL_DISCOUNT]=$ord_dtl_discount;			//$unique_arr[ORDPROM_PROMOTION]=$ordprom_promotion;			//$unique_arr[ORDPROM_DISCOUNT_ID]=$ordprom_discount_id;			//$unique_arr[ORDPROM_DISCOUNT_AMT]=$ordprom_discount_amt;		if(is_not_empty($unique_arr)){			return $this->readObject($unique_arr);		}		return false;	}//..isAlreadyThere	public function create($ord_dtl_id ,$ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price ,$ord_dtl_discount ,$ordprom_promotion ,$ordprom_discount_id ,$ordprom_discount_amt) {		if(is_not_empty($ord_dtl_id)){			if($this->isAlreadyThere($ord_dtl_id ,$ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price ,$ord_dtl_discount ,$ordprom_promotion ,$ordprom_discount_id ,$ordprom_discount_amt)){				return OPERATION_DUPLICATE;			}else{				$this->setord_app_prom("");				$this->setord_dtl_id($ord_dtl_id);				$this->setord_dtl_order_id($ord_dtl_order_id);				$this->setord_dtl_sbmenu_dish_id($ord_dtl_sbmenu_dish_id);				$this->setord_dtl_quantity($ord_dtl_quantity);				$this->setord_dtl_price($ord_dtl_price);				$this->setord_dtl_discount($ord_dtl_discount);				$this->setordprom_promotion($ordprom_promotion);				$this->setordprom_discount_id($ordprom_discount_id);				$this->setordprom_discount_amt($ordprom_discount_amt);				$this->insert();				return $this->getord_app_prom();			}		}		return OPERATION_FAIL;	}//..create	public function update($ord_app_prom, $ord_dtl_id, $ord_dtl_order_id, $ord_dtl_sbmenu_dish_id, $ord_dtl_quantity, $ord_dtl_price, $ord_dtl_discount, $ordprom_promotion, $ordprom_discount_id, $ordprom_discount_amt) {		if(is_gt_zero_num($ord_app_prom)){			if ($this->readObject(array(ORD_APP_PROM=>$ord_app_prom))){				$this->setord_dtl_id($ord_dtl_id);				$this->setord_dtl_order_id($ord_dtl_order_id);				$this->setord_dtl_sbmenu_dish_id($ord_dtl_sbmenu_dish_id);				$this->setord_dtl_quantity($ord_dtl_quantity);				$this->setord_dtl_price($ord_dtl_price);				$this->setord_dtl_discount($ord_dtl_discount);				$this->setordprom_promotion($ordprom_promotion);				$this->setordprom_discount_id($ordprom_discount_id);				$this->setordprom_discount_amt($ordprom_discount_amt);				$this->insert();				return OPERATION_SUCCESS;			}		}		return OPERATION_FAIL;	}//..update	public function activate($ord_app_prom){		if(is_gt_zero_num($ord_app_prom)){			if ($this->readObject(array(ORD_APP_PROM=>$ord_app_prom))){				$qry  = "UPDATE ".TBL_ORDER_APPLIED_PROMS.RET."SET".RET."			".TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE." = '".date(EMPTY_DATE_FORMAT)."' WHERE ".ORD_APP_PROM."={$ord_app_prom}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end activate	public function deactivate($ord_app_prom){		if(is_gt_zero_num($ord_app_prom)){			if ($this->readObject(array(ORD_APP_PROM=>$ord_app_prom))){				$qry  = "UPDATE ".TBL_ORDER_APPLIED_PROMS.RET."SET".RET."			".TBL_ORDER_APPLIED_PROMS_DEACTIVE_DATE." = '".date(DATE_FORMAT)."' WHERE ".ORD_APP_PROM."={$ord_app_prom}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end deactivate	public static function GetInfo($ord_app_prom) {		$info = array();		if($ord_app_prom != ""){			$obj_tbl_order_applied_proms = new tbl_order_applied_proms();			if($obj_tbl_order_applied_proms->readObject(array("ord_app_prom"=>$ord_app_prom))){				$info["ord_app_prom"]=$obj_tbl_order_applied_proms->getord_app_prom();				$info["ord_dtl_id"]=$obj_tbl_order_applied_proms->getord_dtl_id();				$info["ord_dtl_order_id"]=$obj_tbl_order_applied_proms->getord_dtl_order_id();				$info["ord_dtl_sbmenu_dish_id"]=$obj_tbl_order_applied_proms->getord_dtl_sbmenu_dish_id();				$info["ord_dtl_quantity"]=$obj_tbl_order_applied_proms->getord_dtl_quantity();				$info["ord_dtl_price"]=$obj_tbl_order_applied_proms->getord_dtl_price();				$info["ord_dtl_discount"]=$obj_tbl_order_applied_proms->getord_dtl_discount();				$info["ordprom_promotion"]=$obj_tbl_order_applied_proms->getordprom_promotion();				$info["ordprom_discount_id"]=$obj_tbl_order_applied_proms->getordprom_discount_id();				$info["ordprom_discount_amt"]=$obj_tbl_order_applied_proms->getordprom_discount_amt();				$info["isActive"] = 0;				//..check deactive date is not set or 0				if((is_not_empty($obj_tbl_order_applied_proms->gettbl_order_applied_proms_deactive_date())==false)  || (is_gt_zero_num(strtotime($obj_tbl_order_applied_proms->gettbl_order_applied_proms_deactive_date()))== false)){					$info["isActive"] = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($obj_tbl_order_applied_proms->gettbl_order_applied_proms_deactive_date()) > strtotime(date(DATE_FORMAT))){						$info["isActive"] = 1;					}				}			}		unset($obj_tbl_order_applied_proms);		return $info;		}	}//..End GetInfo	public static function GetFields($data){		global $tbl_order_applied_proms_active_condition;		$arr = array();		if(is_not_empty($data)){			$qry ="SELECT ".$data['key_field'].",".$data['value_field']." FROM ".TBL_ORDER_APPLIED_PROMS."";			if(is_gt_zero_num($data['isActive'])){				$qry .= " WHERE ".$tbl_order_applied_proms_active_condition;			}			$res = mysql_query($qry); 			if($res){				while($row=mysql_fetch_assoc($res)){					$arr[$row[$data['key_field']]] = $row[$data['value_field']];				}			}		}		return $arr;	}//.. End of GetFields	/*** Add records to the order_applied promotions table based on the order details* @param undefined $order_id* */	public static function add_ord_details_to_applied_tbl($order_id){	if(is_gt_zero_num($order_id)){			//..variable for records found			$tmp_fnd=0; 			$order_info = tbl_orders::GetInfo($order_id);						//..check if the order is already has claimed promotions 		if(is_gt_zero_num($order_info[ORDER_ISCLAIMED_PROMOTIONS])){			// .do nothing 			}else{			 //..First Delete the all exisiting record of that order 			 self::delete(array(ORD_DTL_ORDER_ID=>$order_id)); 				//..so now insert records from order deatils toit				//..Fetch all order details based on the order id				$tmp_fnd=0;			$order_items=tbl_order_details::readArray(array(ORD_DTL_ORDER_ID=>$order_id),$tmp_fnd,1,0); 			$objtbl_order_applied_proms = new tbl_order_applied_proms();				foreach($order_items as $itm){				//..loop through until qty is reached				for ($i = 1; $i <= $itm[ORD_DTL_QUANTITY]; $i++) {				   //..Insert record into order_applied_proms					 $objtbl_order_applied_proms->create($itm[ORD_DTL_ID], $itm[ORD_DTL_ORDER_ID], $itm[ORD_DTL_SBMENU_DISH_ID], 1, $itm[ORD_DTL_PRICE], $itm[ORD_DTL_DISCOUNT], $itm[ORDPROM_PROMOTION], $itm[ORDPROM_DISCOUNT_ID], $itm[ORDPROM_DISCOUNT_AMT]); 				}			}						}   }   }		/** * Get the order promotion items * @param integer $order_id * @param integer $promotion_id * @return string */   public static function getOrderPromotionItems($order_id,$promotion_id){			$items='';				$listof_submenu = '';		//..Get the Promotions submenu Discount 		$tmpres  = mysql_query('SELECT GROUP_CONCAT('.PRMDISC_BOGO_SBMNU.')  FROM '.TBL_PROM_DISCOUNTS.' WHERE '.PRMDISC_BOGO_SBMNU_DISH.' = 0 AND '.PRMDISC_PROMOTION.'='.$promotion_id);		if($tmpres && mysql_num_rows($tmpres)){			$listof_submenu = mysql_result($tmpres,0);		} 		unset($tmpres);				$listof_order_items = '';		if(is_not_empty($listof_submenu)){			$tmpres = mysql_query('SELECT GROUP_CONCAT('.ORDER_DTL_ID.') FROM'.TBL_ORDER_APPLIED_PROMS.' WHERE '.ORDER_DTL_ORDER_ID.'='.$order_id.' AND '.ORDER_DTL_SUBMENU_DISH_ID.' IN (SELECT '.SBMNU_DISH_ID.' FROM '.TBL_SUBMENU_DISHES.' WHERE '.SBMNU_DISH_SUBMENU.' IN ('.$listof_submenu.')) ');			if($tmpres && mysql_num_rows($tmpres)){				$listof_order_items = mysql_result($tmpres,0);			} 			unset($tmpres);		}			 if(is_not_empty($listof_order_items)){			$tmpres=mysql_query('SELECT GROUP_CONCAT(`ordprom_order_sbmnu_dish`) FROM '.TBL_TMP_ORDER_PROM.'  WHERE '.ORDPROM_ORDER.'='.$order_id.' AND '.ORDPROM_PROMOTION.'='.$promotion_id.' AND '.ORDPROM_DISCOUNT_AMT.'>0 AND '.ORD_DTL_ID.' IN  ('.$listof_order_items.')'); 			if($tmpres && mysql_num_rows($tmpres)){				$items=mysql_result($res, 0); 			}			unset($tmpres);	 }	 		return $items;   } /*** Get the order items* @param string $filt_cond* @return string*/	public static function getOrderItems($filt_cond=0){			$items='';		$qry='SELECT * FROM `'.TBL_ORDER_APPLIED_PROMS.'` WHERE '.$filt_cond;		$res = mysql_query($qry); 		if($res){			$items=mysql_result($res, 0); 		}		return $items;   }	  /**	* To check if discount is applied to the order	* @param integer $order_id	* @param integer $promotion_id	* @return integer	*/	public static function chkIfDiscountAlreadyApplied($order_id,$promotion_id){	$fnd=0;			//..First check if it is applied to that order discount	//$order_items=tbl_orders::readArray(array(ORDER_ID=>$order_id,ORDER_DISCOUNT_AMT=>1,'isDiscAmtGtZero'=>1),$fnd,1);	$order_items=tbl_orders::readArray(array(ORDER_ID=>$order_id,'ordprom_promotion_there'=>1),$fnd,1);	if($fnd){		return 1;	}else{ 			$tmp_fnd=0;		//..Check if all the applied promotion include isExclusive in it		$order_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,'isExclusiveApplied'=>1),$tmp_fnd,1,0);		if(is_gt_zero_num($tmp_fnd)){ 			return 1;		}else{			$tmp_fnd=0;			//..Check if all the items in order deatils are discounted			$order_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORDPROM_DISCOUNT_AMT=>0,ORDPROM_PROMOTION=>0),$tmp_fnd,1,0);	 			if($tmp_fnd==0) return 1;			else $fnd=0; 		}   		}	return $fnd;		}//..function to check if the submenu item is already discounted public static function chkIfOrdDtlSubmnuDiscounted($order_id,$submnudish){ 		$tmp_fnd=0;		$order_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$submnudish,ORDPROM_DISCOUNT_AMT=>0,ORDPROM_PROMOTION=>0),$tmp_fnd,1,0);				if($tmp_fnd>0)			return 1;		else			return 0;	 }  public static function update_item_with_discount($ord_prom_app_id,$order_promotion,$order_discount_id,$order_discount_amt){//..Update the order detail when the promtion is applied	if(is_gt_zero_num($ord_prom_app_id)){		$objtbl_order_applied_proms=new tbl_order_applied_proms();		if($objtbl_order_applied_proms->readObject(array(ORD_APP_PROM=>$ord_prom_app_id))){			$objtbl_order_applied_proms->setordprom_promotion($order_promotion);			$objtbl_order_applied_proms->setordprom_discount_id($order_discount_id);			$objtbl_order_applied_proms->setordprom_discount_amt($order_discount_amt);			$objtbl_order_applied_proms->insert();			return 1;		}		unset($objtbl_order_applied_proms);		}  	return 0;	 }/*** Check if promoiton is applicable for date range and time* @param undefined $promotion_id* @param undefined $arr_search* */ public static function _is_prom_day_time_allowed($promotion_id){ 	$_sel_cond_lst_itms=array(); 	$tmp_fnd=0;					if(is_not_empty($promotion_id)){			 	  $lst_disc_conds=pds_list_prom_cond::readArray(array(PROM_CND_PROMOTION=>$promotion_id),$tmp_fnd,1,0);		//print_r($lst_disc_conds);		//..use		$is_day_time_allowed=1;		if($tmp_fnd>0){									//..loop through each conditions			foreach($lst_disc_conds as $_cond){				 //..Based on the condition type					if($_cond[PROM_CND_COND_TYPE]=='WKDAY'){			 		$todays_day=strtolower(date("l"));					if($_cond["prom_cnd_wkdy_{$todays_day}"]=='N'){						$is_day_time_allowed=0;						}				 }elseif($_cond[PROM_CND_COND_TYPE]=='DAYTIME'){				 	$cur_time=date("H:i:s");			 	  if((($_cond["prom_cnd_daytime_from"]<=$cur_time)&&($_cond["prom_cnd_daytime_to"]>=$cur_time))){					//..do nothing					}else{						$is_day_time_allowed=0;					}								 	 				 }			}					}	 }		 return $is_day_time_allowed;	 }  /*** Get bogo_get_conditions and apply discount* @param undefined $promotion_id* @param undefined $arr_search* */ public static function bogo_get_conditions($order_id,$arr_search){ 	$_sel_cond_lst_itms=array(); 	$tmp_fnd=0;					if(is_not_empty($arr_search)){		 	  $lst_disc_conds=tbl_prom_cond_details::readArray($arr_search,$tmp_fnd,1,0);		//print_r($arr_search);		//print_r($lst_disc_conds);		//exit;		//..use		$is_day_time_allowed=1;		if($tmp_fnd>0){									//..loop through each conditions			foreach($lst_disc_conds as $_cond){				 //..Based on the condition type				/*	if($_cond[PRCNDTL_COND_TYPE]=='WKDAY'){			 		$todays_day=strtolower(date("l"));					if($_cond["prcndtl_wkdy_{$todays_day}"]=='N'){						//continue;						$is_day_time_allowed=0;						}				 }elseif($_cond[PRCNDTL_COND_TYPE]=='DAYTIME'){				 	$cur_time=date("H:i:s");			 	  if((($_cond["prcndtl_daytime_from"]<=$cur_time)&&($_cond["prcndtl_daytime_to"]>=$cur_time))){					//..do nothing					}else{						//continue;						$is_day_time_allowed=0;					}								 	 				 }else*/				 				 if($_cond[PRCNDTL_COND_TYPE]=='BOGO' || $_cond[PRCNDTL_COND_TYPE]=='BOGO_ITEM'){				 					//if(is_gt_zero_num($is_day_time_allowed)){						$tmp_qty=str_replace("+", "", $_cond["prcndtl_bogo_qty"]);																	$_found_cond_lst_itms=self::_get_slectd_item_from_bogo($order_id,$_cond["prcndtl_bogo_sbmnu"],$_cond["prcndtl_bogo_sbmnu_dish"],$tmp_qty,$_sel_cond_lst_itms);						//print_r($_found_cond_lst_itms);						//exit;		 						//..Merge found list to the selected item list												if(is_not_empty($_found_cond_lst_itms)){							$_sel_cond_lst_itms=array_unique(array_merge($_sel_cond_lst_itms,$_found_cond_lst_itms));						}							//print_r($_sel_cond_lst_itms);					//}									 }			}					}	 }		 return $_sel_cond_lst_itms;	 }  /*** function to get the selected order items id from the BOGO condition*/ public static function _get_slectd_item_from_bogo($order_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$_sel_items_lst=array()){ 		 	//..echo "$order_id,$promotion_id,$prmdisc_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$disc_amt_type,$disc_amt";	//..Check if discount is with sub menu item is selected		if(is_gt_zero_num($prmdisc_bogo_sbmnu_dish)){	//..Do nothing..because we already have submenudishid		}else{		  //..Get all submenu dish ids from submenu..			$rs_apl_disc_items= tbl_submenu_dishes::getSubMenuItems($prmdisc_bogo_sbmnu);			if(is_not_empty($rs_apl_disc_items)){				$prmdisc_bogo_sbmnu_dish=$rs_apl_disc_items;			}else{				$strOpMsg= "No items found to apply discount" ;				return $_sel_items_lst;			}		}			//..Check if $prmdisc_bogo_sbmnu_dish is not empty 		if($prmdisc_bogo_sbmnu_dish!=''){			$sub_mnu_ids = explode(",", $prmdisc_bogo_sbmnu_dish);		}		//..array for the filter the order items		$_flt_for_ord_itms=array();		//print_r($sub_mnu_ids);		//echo "<hr>-$prmdisc_bogo_sbmnu_dish";		//..Loop through each submenu ids from records 		foreach($sub_mnu_ids as $ech_submnu_id){				$tmp_fnd=0;				//..Check if ['submnuid'x'qty'] is present				//..items with 'submenu id' with disocunt applied				//..add condition except the selected list				$_excpt_flt_itms=implode(',',$_sel_items_lst);						$_excpt_flt_itms=(is_not_empty($_excpt_flt_itms) ? $_excpt_flt_itms : "''");						$_flt_for_ord_itms[ORD_DTL_ORDER_ID]=$order_id;				$_flt_for_ord_itms[ORD_DTL_SBMENU_DISH_ID]=$prmdisc_bogo_sbmnu_dish;//$ech_submnu_id;				$_flt_for_ord_itms[ORDPROM_DISCOUNT_AMT]='0';				$_flt_for_ord_itms[ORDPROM_PROMOTION]='0';				$_flt_for_ord_itms['except_ordprom_id']=$_excpt_flt_itms;				//print_r($_flt_for_ord_itms);				//echo "<hr> === ";				$ord_det_items=self::readArray($_flt_for_ord_itms,$tmp_fnd,1,0);				$tmp_fnd=count($ord_det_items);				//$ord_det_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$ech_submnu_id,ORDPROM_DISCOUNT_AMT=>0,ORDPROM_PROMOTION=>0),$tmp_fnd,1,0);				//...Count($ord_det_items)==qty				//print_r($ord_det_items);				//echo "<hr> === $tmp_fnd>=$prmdisc_bogo_qty ";				//exit;				if($tmp_fnd>=$prmdisc_bogo_qty){					$itms_to_apply_disc=0;					//echo "itms_to_apply_disc=$itms_to_apply_disc <br>";					//..Loop through records found apply discount to all					foreach($ord_det_items as $order_itm){						//..Applicable items are only as per BOGO qty						if($itms_to_apply_disc<$prmdisc_bogo_qty){								//..start adding the items to the selected list							if (!(in_array($order_itm[ORD_APP_PROM], $_sel_items_lst))) {                  $_sel_items_lst[]=$order_itm[ORD_APP_PROM];                  $itms_to_apply_disc=$itms_to_apply_disc+1;              }						}else{							break 2;						}						//$itms_to_apply_disc=$itms_to_apply_disc+1;					}										//..get only							if(is_not_empty($_sel_items_lst))  {                $_sel_items_lst=array_unique($_sel_items_lst);              }				}		 }  //..end for each for the submenu id		 //echo "final------------------------<br>";		 //print_r($_sel_items_lst);		 //exit;		 		return $_sel_items_lst;		 } /** * fun to get the bill amount of the specified items */ public static function _get_bill_amnt_of_sp_items($sel_prom_ids){ 			$bill_amnt=0;			/*+			SUM(IFNULL(op1.`ord_det_opt_qty`,0) * IFNULL(op1.`ord_det_opt_price`,0)) */			$sql='			SELECT 			(			SUM(IFNULL(od1.`ord_dtl_quantity`,0) * IFNULL(od1.`ord_dtl_price`,0))						) 			as `bill_amnt` 			FROM '.TBL_ORDER_APPLIED_PROMS.' od1			LEFT OUTER JOIN 				'.TBL_ORDER_DETAILS_OPTIONS.' op1 			ON 				od1.`ord_dtl_id` = op1.`ord_det_opt_order_detail` 			WHERE '.ORD_APP_PROM.' IN ('.$sel_prom_ids.')';			//echo "sql=$sql <br>";			//exit; 			$tmpres=mysql_query($sql); 			if($tmpres && mysql_num_rows($tmpres)){				$bill_amnt=mysql_result($tmpres, 0); 			}			return $bill_amnt; } /** * fun to apply the discount for the selected list */ public static function _apply_disc_selected_lst($_sel_items_lst=array(),$promotion_id,$prmdisc_id,$disc_amt_type,$disc_amt,$isFixed=0){ 	$success=0;	$tmp_fnd=0; 	//..If items are present & disocunt amount is there then only proceed further	if(is_not_empty($_sel_items_lst) && is_gt_zero_num($disc_amt) && is_gt_zero_num($promotion_id)){		$_flt_itms=implode(',',$_sel_items_lst);						$ord_det_items=self::readArray(array(ORD_APP_PROM=>$_flt_itms),$tmp_fnd,1,0);		$_is_added=false;		//.If record found then only proceed		if(is_gt_zero_num($tmp_fnd)){			//..if fixed price then get the bill amount of the specified items			if(is_gt_zero_num($isFixed)){				$fixed_item_price=self::_get_bill_amnt_of_sp_items($_flt_itms);				if($fixed_item_price>0)					$fixed_discount_amnt=($fixed_item_price-$disc_amt);				else					$fixed_discount_amnt=$disc_amt;				}			//echo "fixed_item_price=$fixed_item_price fixed_discount_amnt=$fixed_discount_amnt disc_amt=$disc_amt | _flt_itms=$_flt_itms";			//exit;			//..Loop through records found apply discount to all			foreach($ord_det_items as $order_itm){				if(is_gt_zero_num($isFixed)){					if($_is_added==false){						//..Calculate discount amount							$discount_amount=self::getDiscountAmnt($disc_amt_type,$fixed_discount_amnt,$order_itm[ORD_DTL_PRICE],1);						$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,$discount_amount);						$_is_added=true;					}Else{						$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,0);					}									}else{					 //..Calculate discount amount						$discount_amount=self::getDiscountAmnt($disc_amt_type,$disc_amt,$order_itm[ORD_DTL_PRICE],0);					$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,$discount_amount);				}		 						//..Calculate discount amount					//$discount_amount=self::getDiscountAmnt($disc_amt_type,$disc_amt,$order_itm[ORD_DTL_PRICE],$isFixed);				//..Update the order detail with discount and promotion				//$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,$discount_amount);							}			}			}	return $success; }  /*** Discount apply logic for without condition* */ public static function bogo_apply_disc($order_id,$promotion_id,$prmdisc_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$disc_amt_type,$disc_amt){	  	//..echo "$order_id,$promotion_id,$prmdisc_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$disc_amt_type,$disc_amt";	//..Check if discount is with sub menu item is selected		if(is_gt_zero_num($prmdisc_bogo_sbmnu_dish)){	//..Do nothing..because we already have submenudishid		}else{		  //..Get all submenu dish ids from submenu..			$rs_apl_disc_items= tbl_submenu_dishes::getSubMenuItems($prmdisc_bogo_sbmnu);			if(is_not_empty($rs_apl_disc_items)){				$prmdisc_bogo_sbmnu_dish=$rs_apl_disc_items;			}else{				$strOpMsg= "No items found to apply discount" ;				return 0;			}		}			//..Check if $prmdisc_bogo_sbmnu_dish is not empty 		if($prmdisc_bogo_sbmnu_dish!=''){			$sub_mnu_ids = explode(",", $prmdisc_bogo_sbmnu_dish);		}		//..Loop through each submenu ids from records 		foreach($sub_mnu_ids as $ech_submnu_id){				$tmp_fnd=0;				//..Check if ['submnuid'x'qty'] is present				//..items with 'submenu id' with disocunt applied				$ord_det_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$ech_submnu_id,ORDPROM_DISCOUNT_AMT=>'0',ORDPROM_PROMOTION=>'0'),$tmp_fnd,1,0);				//...Count($ord_det_items)==qty				if($tmp_fnd>=$prmdisc_bogo_qty){					$itms_to_apply_disc=0;					//..Loop through records found apply discount to all					foreach($ord_det_items as $order_itm){						//..Applicable items are only as per BOGO qty						if($itms_to_apply_disc<$prmdisc_bogo_qty){											 		//..Right item to apply discount						//..Calculate discount amount							$discount_amount=self::getDiscountAmnt($disc_amt_type,$disc_amt,$order_itm[ORD_DTL_PRICE]);						//..Update the order detail with discount and promotion						$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,$discount_amount);							}						$itms_to_apply_disc=$itms_to_apply_disc+1;					}				}		} 				return 1; }    /*public static function chk_submnu_qty_present($order_id,$prmdisc_bogo_sbmnu_dish,$qty){ 		//..Check if $prmdisc_bogo_sbmnu_dish is not empty 		if($prmdisc_bogo_sbmnu_dish!=''){				$sub_mnu_ids = explode(",", $prmdisc_bogo_sbmnu_dish);		}		//..Loop through each submenu ids 		foreach($sub_mnu_ids as $ech_submnu_id){				$tmp_fnd=0;				//..Check if ['submnuid'x'qty'] is present				$ord_det_items=self::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$ech_submnu_id,ORDPROM_DISCOUNT_AMT=>0,ORDPROM_PROMOTION=>0),$tmp_fnd,1,0);				//...Count($ord_det_items)==qty				if($tmp_fnd==$qty){						//..recd fnd apply discount to both						foreach($ord_det_items as $order_itm){	  					 	//..Right item to apply discount								//..Calculate discount amount									$discount_amount=self::getDiscountAmnt($disc_amt_type,$disc_amt,$order_itm[ORD_DTL_PRICE]);								//..Update the order detail with discount and promotion								$success=self::update_item_with_discount($order_itm[ORD_APP_PROM],$promotion_id,$prmdisc_id,$discount_amount);							}				}		} }*/  public static function getDiscountAmnt($disc_type,$disc_amnt,$price,$isFixed=0){ 		$discount_amount=0; 		//..Calculate discount amount		if($disc_type=='PERCENT'){		  //$discount_amount=($price-($price*($disc_amnt/100)));			//$discount_amount=($price*($disc_amnt/100));			  $discount_amount = ($price *($disc_amnt/100.00));					}else{			if(is_gt_zero_num($isFixed)){				$discount_amount=$disc_amnt;			}else{				//$discount_amount=($price-$disc_amnt);				  $discount_amount = $disc_amnt;			}					}				return $discount_amount; }	}//..End tbl_order_applied_proms?>