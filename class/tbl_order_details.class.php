<?php/**********************************************************************tbl_order_details.class.phpGenerated by STRUCTY 2013.04.18 11:46:55.Copyright 2011 Structy, Frédéric Aebi. All rights reserved.**********************************************************************/define('TBL_ORDER_DETAILS', 'tbl_order_details'); define('ORD_DTL_ID', 'ord_dtl_id'); define('ORD_DTL_ORDER_ID', 'ord_dtl_order_id');define('ORD_DTL_SUB_ORDER_ID', 'ord_dtl_sub_order_id'); define('ORD_DTL_SBMENU_DISH_ID', 'ord_dtl_sbmenu_dish_id'); define('ORD_DTL_QUANTITY', 'ord_dtl_quantity'); define('ORD_DTL_PRICE', 'ord_dtl_price'); define('ORD_DTL_DISCOUNT', 'ord_dtl_discount');define('ORDPROM_PROMOTION', 'ordprom_promotion');define('ORDPROM_DISCOUNT_ID', 'ordprom_discount_id');define('ORDPROM_DISCOUNT_AMT', 'ordprom_discount_amt');define('TBL_ORDER_DETAILS_ACTIVE_DATE',  '');define('TBL_ORDER_DETAILS_DEACTIVE_DATE',  '');$tbl_order_details_active_condition= ' ('.TBL_ORDER_DETAILS_DEACTIVE_DATE.' is NULL OR '.TBL_ORDER_DETAILS_DEACTIVE_DATE.' = 0 OR '.TBL_ORDER_DETAILS_DEACTIVE_DATE.' > CURDATE( )) ';class tbl_order_details {	private $ord_dtl_id;	private $ord_dtl_order_id;	private $ord_dtl_sub_order_id;	private $ord_dtl_sbmenu_dish_id;	private $ord_dtl_quantity;	private $ord_dtl_price;	private $ord_dtl_discount;		private $ordprom_promotion;	private $ordprom_discount_id;	private $ordprom_discount_amt;			private $tbl_order_details_active_date;	private $tbl_order_details_deactive_date;	private $title;		public function setord_dtl_id($pArg="0") {$this->ord_dtl_id=$pArg;}	public function setord_dtl_order_id($pArg="0") {$this->ord_dtl_order_id=$pArg;}	public function setord_dtl_sub_order_id($pArg="0") {$this->ord_dtl_sub_order_id=$pArg;}	public function setord_dtl_sbmenu_dish_id($pArg="0") {$this->ord_dtl_sbmenu_dish_id=$pArg;}	public function setord_dtl_quantity($pArg="0") {$this->ord_dtl_quantity=$pArg;}	public function setord_dtl_price($pArg="0") {$this->ord_dtl_price=$pArg;}	public function settbl_order_details_active_date($pArg="0") {$this->tbl_order_details_active_date=$pArg;}	public function settbl_order_details_deactive_date($pArg="0") {$this->tbl_order_details_deactive_date=$pArg;}	public function settitle($pArg="0") {$this->title=$pArg;}	public function setord_dtl_discount($pArg="0"){$this->ord_dtl_discount=$pArg;}		public function setordprom_promotion($pArg="0") {$this->ordprom_promotion=$pArg;}	public function setordprom_discount_id($pArg="0") {$this->ordprom_discount_id=$pArg;}	public function setordprom_discount_amt($pArg="0") {$this->ordprom_discount_amt=$pArg;}	public function getord_dtl_id() {return $this->ord_dtl_id;}	public function getord_dtl_order_id() {return $this->ord_dtl_order_id;}	public function getord_dtl_sub_order_id() {return $this->ord_dtl_sub_order_id;}	public function getord_dtl_sbmenu_dish_id() {return $this->ord_dtl_sbmenu_dish_id;}	public function getord_dtl_quantity() {return $this->ord_dtl_quantity;}	public function getord_dtl_price() {return $this->ord_dtl_price;}	public function gettbl_order_details_active_date($pArg="0") {return $this->tbl_order_details_active_date;}	public function gettbl_order_details_deactive_date($pArg="0") {return $this->tbl_order_details_deactive_date;}	public function gettitle($pArg="0") {return $this->title;}	public function getord_dtl_discount() {return $this->order_status_id;}		public function getordprom_promotion() { return $this->ordprom_promotion;}	public function getordprom_discount_id() { return $this->ordprom_discount_id;}	public function getordprom_discount_amt() { return $this->ordprom_discount_amt;}	public function readObject($array = array()) {		//$qry = "SELECT *".RET."FROM ".TBL_ORDER_DETAILS.RET;		$qry = "SELECT  			   	`ord_dtl_id`,`ord_dtl_order_id`,`ord_dtl_sub_order_id`,				 	`ord_dtl_discount`, `ord_dtl_sbmenu_dish_id`, `ord_dtl_quantity`, 					`ord_dtl_price`, (					SELECT  `dish_name`					FROM  					`tbl_submenu_dishes` sbmd 					INNER JOIN `tbl_dishes` d ON					sbmd.sbmnu_dish_dish=d.dish_id  					WHERE `sbmnu_dish_id` = `ord_dtl_sbmenu_dish_id`)  AS `title`,					`ordprom_promotion`,`ordprom_discount_id`,`ordprom_discount_amt`  ".RET."FROM ".TBL_ORDER_DETAILS.RET;		$and = "WHERE".RET;		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}				if($array[ORD_DTL_SUB_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_SUB_ORDER_ID." = '".$array[ORD_DTL_SUB_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}				if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			$qry .= $and.ORDPROM_DISCOUNT_AMT." = '".$array[ORDPROM_DISCOUNT_AMT]."'".RET;			$and = "AND".RET;		}			$result = mysql_query($qry);		if($result) {			while ($row = mysql_fetch_array($result)) {				$record = $row;				break;//end after first record			}			if(count($record[0]) == 0) {				return array();			} else {				$this->setord_dtl_id($record[ORD_DTL_ID]);				$this->setord_dtl_order_id($record[ORD_DTL_ORDER_ID]);				$this->setord_dtl_sub_order_id($record[ORD_DTL_SUB_ORDER_ID]);				$this->setord_dtl_sbmenu_dish_id($record[ORD_DTL_SBMENU_DISH_ID]);				$this->setord_dtl_quantity($record[ORD_DTL_QUANTITY]);				$this->setord_dtl_price($record[ORD_DTL_PRICE]);				$this->setord_dtl_discount($record[ORD_DTL_DISCOUNT]);								$this->setordprom_promotion($record[ORDPROM_PROMOTION]);				$this->setordprom_discount_id($record[ORDPROM_DISCOUNT_ID]);				$this->setordprom_discount_amt($record[ORDPROM_DISCOUNT_AMT]);								$this->settitle($record["title"]);								$this->settbl_order_details_active_date($record[TBL_ORDER_DETAILS_ACTIVE_DATE]);				$this->settbl_order_details_deactive_date($record[TBL_ORDER_DETAILS_DEACTIVE_DATE]);				return true;			}		}	}	public static function readArray($array = array(),&$result_found=0,$isArray=1,$isOptDetailed=0) {		global $tbl_order_details_active_condition;		//$qry = "SELECT *".RET."FROM ".TBL_ORDER_DETAILS.RET;		$qry = "SELECT  				`ord_dtl_id`,`ord_dtl_order_id`,`ord_dtl_sub_order_id`,				 	`ord_dtl_discount`, `ord_dtl_sbmenu_dish_id`, `ord_dtl_quantity`, 				`ord_dtl_price`, (					SELECT  `dish_name`  					FROM  					`tbl_submenu_dishes` sbmd 					INNER JOIN `tbl_dishes` d ON					sbmd.sbmnu_dish_dish=d.dish_id  					WHERE `sbmnu_dish_id` = `ord_dtl_sbmenu_dish_id`)  AS `title`					, (					SELECT `dish_ethor_mnu_itm_id`  					FROM  					`tbl_submenu_dishes` sbmd 					INNER JOIN `tbl_dishes` d ON					sbmd.sbmnu_dish_dish=d.dish_id  					WHERE `sbmnu_dish_id` = `ord_dtl_sbmenu_dish_id`)  AS `ethor_menu_item`,					`ordprom_promotion`,`ordprom_discount_id`,`ordprom_discount_amt` 				".RET."FROM ".TBL_ORDER_DETAILS.' INNER JOIN '.TBL_ORDERS.' ON  '.ORDER_ID.'='.ORD_DTL_ORDER_ID.' '.RET;		$and = "WHERE".RET;		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." = '".$array[ORD_DTL_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}				if($array[ORD_DTL_SUB_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_SUB_ORDER_ID." = '".$array[ORD_DTL_SUB_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			//$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." IN (".$array[ORD_DTL_SBMENU_DISH_ID].")".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		}				if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			if($array['isDiscAmtGtZero']==1){				$qry .= $and.ORDPROM_DISCOUNT_AMT." > 0 ".RET;			}else{				$qry .= $and.ORDPROM_DISCOUNT_AMT." = ".$array[ORDPROM_DISCOUNT_AMT]."".RET;			}						$and = "AND".RET;		}				if($array[ORDER_SESSION_ID] != "") {		/*	$qry .= $and.ORD_DTL_ORDER_ID.' IN (SELECT '.ORDER_ID.' FROM '.TBL_ORDERS.' WHERE '.ORDER_SESSION_ID.'='.$array[ORDER_SESSION_ID].')';*/			$qry .= $and.ORDER_SESSION_ID." = '".$array[ORDER_SESSION_ID]."'".RET;			$and = "AND".RET;		}				if(is_gt_zero_num($array['non_cancelled_order'])) {		/*	$qry .= $and.ORD_DTL_ORDER_ID.' IN (SELECT '.ORDER_ID.' FROM '.TBL_ORDERS.' WHERE '.ORDER_SESSION_ID.'='.$array[ORDER_SESSION_ID].')';*/			$qry .= $and.ORDER_STATUS_ID." <> ".TBL_STATUS_ORDER_CANCELLED.RET;			$and = "AND".RET;		}				 		if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_order_details_active_condition;;			$and = "AND".RET;		}		if(is_not_empty($array[SORT_ON]) && is_not_empty($array[SORT_BY])) {		$qry .=" ORDER BY ".$array[SORT_ON]." ".$array[SORT_BY];		}		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}		//echo "$qry_with_limit <br>";		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		if($r1){			$result_found = mysql_num_rows($r1);		}		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;				//..check deactive date is not set or 0				if((is_not_empty($record[TBL_ORDER_DETAILS_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_ORDER_DETAILS_DEACTIVE_DATE]))== false)){					$isActive = 1; 				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_ORDER_DETAILS_DEACTIVE_DATE]) > strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}				if($isArray){					$class_object = array();					$class_object["ord_dtl_id"]=$record[ORD_DTL_ID];					$class_object["ord_dtl_order_id"]=$record[ORD_DTL_ORDER_ID];					$class_object["ord_dtl_sub_order_id"]=$record[ORD_DTL_SUB_ORDER_ID];					$class_object["ord_dtl_sbmenu_dish_id"]=$record[ORD_DTL_SBMENU_DISH_ID];					$class_object["ord_dtl_quantity"]=$record[ORD_DTL_QUANTITY];					$class_object["ord_dtl_price"]=$record[ORD_DTL_PRICE];					$class_object["ord_dtl_discount"]=$record[ORD_DTL_DISCOUNT];					$class_object["ordprom_promotion"]=$record[ORDPROM_PROMOTION];					$class_object["ordprom_discount_id"]=$record[ORDPROM_DISCOUNT_ID];					$class_object["ordprom_discount_amt"]=$record[ORDPROM_DISCOUNT_AMT];									$class_object["title"]=$record["title"];					$class_object["ethor_menu_item"]=$record["ethor_menu_item"];										if($isOptDetailed==1){						//get order option details						$objtbl_order_details_options= new tbl_order_details_options();						$opt_val_lst= $objtbl_order_details_options->readArray(array(ORD_DET_OPT_ORDER_DETAIL => $record[ORD_DTL_ID]));						if(is_not_empty($opt_val_lst)){							$class_object["opt_val_details"]=$opt_val_lst;						}						unset($objtbl_order_details_options);					}											$class_object["isActive"]=$isActive;				}else{					$class_object = new tbl_order_details();					$class_object->setord_dtl_id($record[ORD_DTL_ID]);					$class_object->setord_dtl_order_id($record[ORD_DTL_ORDER_ID]);					$class_object->setord_dtl_sub_order_id($record[ORD_DTL_SUB_ORDER_ID]);					$class_object->setord_dtl_sbmenu_dish_id($record[ORD_DTL_SBMENU_DISH_ID]);					$class_object->setord_dtl_quantity($record[ORD_DTL_QUANTITY]);					$class_object->setord_dtl_price($record[ORD_DTL_PRICE]);					$class_object->setord_dtl_discount($record[ORD_DTL_DISCOUNT]);					$class_object->setordprom_promotion($record[ORDPROM_PROMOTION]);					$class_object->setordprom_discount_id($record[ORDPROM_DISCOUNT_ID]);					$class_object->setordprom_discount_amt($record[ORDPROM_DISCOUNT_AMT]);				}				$class_objects[$record[ORD_DTL_ID]] = $class_object;			}		}		return $class_objects;	}//..End readArray	public function insert() {		if($this->getord_dtl_id() != '') {			$qry  = "UPDATE ".TBL_ORDER_DETAILS.RET."SET".RET." 			".ORD_DTL_ORDER_ID." = '".$this->getord_dtl_order_id()."',".RET."			".ORD_DTL_SUB_ORDER_ID." = '".$this->getord_dtl_sub_order_id()."',".RET."			".ORD_DTL_SBMENU_DISH_ID." = '".$this->getord_dtl_sbmenu_dish_id()."',".RET."			".ORD_DTL_QUANTITY."='".$this->getord_dtl_quantity()."',".RET."			".ORD_DTL_PRICE." = '".$this->getord_dtl_price()."',".RET."			".ORDPROM_PROMOTION." = '".$this->getordprom_promotion()."',".RET."			".ordprom_discount_id." = '".$this->getordprom_discount_id()."',".RET."			".ORDPROM_DISCOUNT_AMT." = '".$this->getordprom_discount_amt()."'".RET.			" WHERE ".ORD_DTL_ID." = '".$this->getord_dtl_id()."';".RET;			 mysql_query($qry);		} else {			$qry  = "INSERT INTO ".TBL_ORDER_DETAILS." (".RET.			"".ORD_DTL_ORDER_ID.", ".ORD_DTL_SUB_ORDER_ID.", ".ORD_DTL_SBMENU_DISH_ID.", ".ORD_DTL_QUANTITY.", ".ORD_DTL_PRICE.", ".ORDPROM_PROMOTION.", ".ORDPROM_DISCOUNT_ID.", ".ORDPROM_DISCOUNT_AMT.RET.				") VALUES (".RET.			"'".$this->getord_dtl_order_id()."',".RET.			"'".$this->getord_dtl_sub_order_id()."',".RET.			"'".$this->getord_dtl_sbmenu_dish_id()."',".RET.			"'".$this->getord_dtl_quantity()."',".RET.			"'".$this->getord_dtl_price()."',".RET.						"'".$this->getordprom_promotion()."',".RET.			"'".$this->getordprom_discount_id()."',".RET.			"'".$this->getordprom_discount_amt()."'".RET.						")".RET;			 			$res = mysql_query($qry);			//echo "qry=$qry <br>";			//exit;			$this->setord_dtl_id(mysql_insert_id());		}	}//..End Insert	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".TBL_ORDER_DETAILS.RET;		$and = "WHERE".RET;		if($array[ORD_DTL_ID] != "") {			$qry .= $and.ORD_DTL_ID." IN (".$array[ORD_DTL_ID].")".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_ORDER_ID." = '".$array[ORD_DTL_ORDER_ID]."'".RET;			$and = "AND".RET;		}				if($array[ORD_DTL_SUB_ORDER_ID] != "") {			$qry .= $and.ORD_DTL_SUB_ORDER_ID." = '".$array[ORD_DTL_SUB_ORDER_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_SBMENU_DISH_ID] != "") {			$qry .= $and.ORD_DTL_SBMENU_DISH_ID." = '".$array[ORD_DTL_SBMENU_DISH_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_QUANTITY] != "") {			$qry .= $and.ORD_DTL_QUANTITY." = '".$array[ORD_DTL_QUANTITY]."'".RET;			$and = "AND".RET;		}		if($array[ORD_DTL_PRICE] != "") {			$qry .= $and.ORD_DTL_PRICE." = '".$array[ORD_DTL_PRICE]."'".RET;			$and = "AND".RET;		} 		if($array[ORDPROM_PROMOTION] != "") {			$qry .= $and.ORDPROM_PROMOTION." = '".$array[ORDPROM_PROMOTION]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_ID] != "") {			$qry .= $and.ORDPROM_DISCOUNT_ID." = '".$array[ORDPROM_DISCOUNT_ID]."'".RET;			$and = "AND".RET;		}		if($array[ORDPROM_DISCOUNT_AMT] != "") {			$qry .= $and.ORDPROM_DISCOUNT_AMT." = '".$array[ORDPROM_DISCOUNT_AMT]."'".RET;			$and = "AND".RET;		}				$res = mysql_query($qry);		if($res){			return OPERATION_SUCCESS;		} 		return OPERATION_FAIL;	}//..End Delete	public function isAlreadyThere($ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price) {		$unique_arr = array();			//$unique_arr[ORD_DTL_ID]=$ord_dtl_id;			//$unique_arr[ORD_DTL_ORDER_ID]=$ord_dtl_order_id;			//$unique_arr[ORD_DTL_SBMENU_DISH_ID]=$ord_dtl_sbmenu_dish_id;			//$unique_arr[ORD_DTL_QUANTITY]=$ord_dtl_quantity;			//$unique_arr[ORD_DTL_PRICE]=$ord_dtl_price;		if(is_not_empty($unique_arr)){			return $this->readObject($unique_arr);		}		return false;	}//..isAlreadyThere	public function create($ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price,$ordprom_promotion=0,$ordprom_discount_id=0,$ordprom_discount_amt=0,$ord_dtl_sub_order_id=0) {		if(is_not_empty($ord_dtl_order_id)){			//..delete previous details if any			//tbl_order_details::delete_ord_detls($ord_dtl_order_id,$ord_dtl_sbmenu_dish_id);			//..delete previous record if any			//tbl_order_details_options::delete_ord_detls_options($order_id,$ord_dtl_sbmenu_dish_id);				//..now insert new record			$this->setord_dtl_id("");			$this->setord_dtl_order_id($ord_dtl_order_id);			$this->setord_dtl_sub_order_id($ord_dtl_sub_order_id);			$this->setord_dtl_sbmenu_dish_id($ord_dtl_sbmenu_dish_id);			$this->setord_dtl_quantity($ord_dtl_quantity);			$this->setord_dtl_price($ord_dtl_price);						$this->setordprom_promotion($ordprom_promotion);			$this->setordprom_discount_id($ordprom_discount_id);			$this->setordprom_discount_amt($ordprom_discount_amt);			$this->insert();			return $this->getord_dtl_id();							/*if($this->isAlreadyThere($ord_dtl_order_id ,$ord_dtl_sbmenu_dish_id ,$ord_dtl_quantity ,$ord_dtl_price)){				return OPERATION_DUPLICATE;			}else{				$this->setord_dtl_id("");				$this->setord_dtl_order_id($ord_dtl_order_id);				$this->setord_dtl_sbmenu_dish_id($ord_dtl_sbmenu_dish_id);				$this->setord_dtl_quantity($ord_dtl_quantity);				$this->setord_dtl_price($ord_dtl_price);				$this->insert();				return $this->getord_dtl_id();			}*/		}		return OPERATION_FAIL;	}//..create	public function update($ord_dtl_id, $ord_dtl_order_id, $ord_dtl_sbmenu_dish_id, $ord_dtl_quantity, $ord_dtl_price,$ordprom_promotion=0,$ordprom_discount_id=0,$ordprom_discount_amt=0,$ord_dtl_sub_order_id=0){		if(is_gt_zero_num($ord_dtl_id)){			if ($this->readObject(array(ORD_DTL_ID=>$ord_dtl_id))){				$this->setord_dtl_order_id($ord_dtl_order_id);				$this->setord_dtl_sub_order_id($ord_dtl_sub_order_id);				$this->setord_dtl_sbmenu_dish_id($ord_dtl_sbmenu_dish_id);				$this->setord_dtl_quantity($ord_dtl_quantity);				$this->setord_dtl_price($ord_dtl_price);								$this->setordprom_promotion($ordprom_promotion);				$this->setordprom_discount_id($ordprom_discount_id);				$this->setordprom_discount_amt($ordprom_discount_amt);							$this->insert();				return OPERATION_SUCCESS;			}		}		return OPERATION_FAIL;	}//..update		//..Add discount to the order detail item	public function addDiscountToOrder($ord_dtl_id,$discount){		if(is_gt_zero_num($ord_dtl_id) && is_gt_zero_num($discount)){			if ($this->readObject(array(ORD_DTL_ID=>$ord_dtl_id))){				//..get the discount value				$discount_val=0;				$discount_detail=tbl_discounts::GetInfo($discount);								if(is_not_empty($discount_detail)){						if($discount_detail[DISCOUNT_TYPE]=='PERCENT'){							$discount_val=($this->getord_dtl_price()*($discount_detail[DISCOUNT_PERCENT]/100));						}else{							$discount_val=($discount_detail[DISCOUNT_PERCENT]);						}				}												$qry  = "UPDATE ".TBL_ORDER_DETAILS.RET."SET".RET."			".ORD_DTL_DISCOUNT." = ".$discount_val." WHERE ".ORD_DTL_ID."={$ord_dtl_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end activate	public function activate($ord_dtl_id){		if(is_gt_zero_num($ord_dtl_id)){			if ($this->readObject(array(ORD_DTL_ID=>$ord_dtl_id))){				$qry  = "UPDATE ".TBL_ORDER_DETAILS.RET."SET".RET."			".TBL_ORDER_DETAILS_DEACTIVE_DATE." = '".date(EMPTY_DATE_FORMAT)."' WHERE ".ORD_DTL_ID."={$ord_dtl_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end activate	public function deactivate($ord_dtl_id){		if(is_gt_zero_num($ord_dtl_id)){			if ($this->readObject(array(ORD_DTL_ID=>$ord_dtl_id))){				$qry  = "UPDATE ".TBL_ORDER_DETAILS.RET."SET".RET."			".TBL_ORDER_DETAILS_DEACTIVE_DATE." = '".date(DATE_FORMAT)."' WHERE ".ORD_DTL_ID."={$ord_dtl_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end deactivate	public static function GetInfo($ord_dtl_id) {		$info = array();		if($ord_dtl_id != ""){			$obj_tbl_order_details = new tbl_order_details();			if($obj_tbl_order_details->readObject(array("ord_dtl_id"=>$ord_dtl_id))){				$info["ord_dtl_id"]=$obj_tbl_order_details->getord_dtl_id();				$info["ord_dtl_order_id"]=$obj_tbl_order_details->getord_dtl_order_id();				$info["ord_dtl_sub_order_id"]=$obj_tbl_order_details->getord_dtl_sub_order_id();				$info["ord_dtl_sbmenu_dish_id"]=$obj_tbl_order_details->getord_dtl_sbmenu_dish_id();				$info["ord_dtl_quantity"]=$obj_tbl_order_details->getord_dtl_quantity();				$info["ord_dtl_price"]=$obj_tbl_order_details->getord_dtl_price();				$info["ord_dtl_discount"]=$obj_tbl_order_details->getord_dtl_discount();								$info["ordprom_promotion"]=$obj_tbl_order_details->getordprom_promotion();				$info["ord_dtl_discount"]=$obj_tbl_order_details->getordprom_discount_id();				$info["ord_dtl_discount"]=$obj_tbl_order_details->getordprom_discount_amt();								$info["title"]=$obj_tbl_order_details->gettitle();								$info["isActive"] = 0;				//..check deactive date is not set or 0				if((is_not_empty($obj_tbl_order_details->gettbl_order_details_deactive_date())==false)  || (is_gt_zero_num(strtotime($obj_tbl_order_details->gettbl_order_details_deactive_date()))== false)){					$info["isActive"] = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($obj_tbl_order_details->gettbl_order_details_deactive_date()) > strtotime(date(DATE_FORMAT))){						$info["isActive"] = 1;					}				}			}					unset($obj_tbl_order_details);		return $info;		}	}//..End GetInfo	public static function GetFields($data){		global $tbl_order_details_active_condition;		$arr = array();		if(is_not_empty($data)){			$qry ="SELECT ".$data['key_field'].",".$data['value_field']." FROM ".TBL_ORDER_DETAILS."";			if(is_gt_zero_num($data['isActive'])){				$qry .= " WHERE ".$tbl_order_details_active_condition;			}			$res = mysql_query($qry); 			if($res){				while($row=mysql_fetch_assoc($res)){					$arr[$row[$data['key_field']]] = $row[$data['value_field']];				}			}		}		return $arr;	}//.. End of GetFields		//..get last order details id	public static function get_max_order_detail_id(){		$qry  = "SELECT MAX(`ord_dtl_id`) as last_detail FROM ".TBL_ORDER_DETAILS.RET;		$res = mysql_query($qry);		if($res && is_gt_zero_num(mysql_num_rows($res))){			return mysql_result($res,0); 				}				return 0;	}//..end get_max_order_detail_id		//..delete previous order details for particular order,submenu dish	public static function delete_ord_detls($order_id){		//..delete the options if exists for that deatils		$qry  = "DELETE FROM ".TBL_ORDER_DETAILS_OPTIONS." WHERE ".ORD_DET_OPT_ORDER_DETAIL ." IN (SELECT ORD_DTL_ID FROM ".TBL_ORDER_DETAILS.RET. " WHERE ".ORD_DTL_ORDER_ID ."=".$order_id. ")";		$res = mysql_query($qry);		//..now delete the order detail record		$qry  = "DELETE FROM ".TBL_ORDER_DETAILS.RET. " WHERE ".ORD_DTL_ORDER_ID ."=".$order_id;		$res = mysql_query($qry);						return true;	}//..end delete_ord_detls	/*//..delete previous order details for particular order,submenu dish	public static function delete_ord_detls($order_id,$ord_dtl_sbmenu_dish_id){		//..delete the options if exists for that deatils		$qry  = "DELETE FROM ".TBL_ORDER_DETAILS_OPTIONS." WHERE ".ORD_DET_OPT_ORDER_DETAIL ." IN (SELECT ORD_DTL_ID FROM ".TBL_ORDER_DETAILS.RET. " WHERE ".ORD_DTL_ORDER_ID ."=".$order_id. " AND ".ORD_DTL_SBMENU_DISH_ID."=".$ord_dtl_sbmenu_dish_id.")";		$res = mysql_query($qry);		//..now delete the order detail record		$qry  = "DELETE FROM ".TBL_ORDER_DETAILS.RET. " WHERE ".ORD_DTL_ORDER_ID ."=".$order_id. " AND ".ORD_DTL_SBMENU_DISH_ID."=".$ord_dtl_sbmenu_dish_id;		$res = mysql_query($qry);						return true;	}//..end delete_ord_detls*/		/** * Get the order promotion items * @param integer $order_id * @param integer $promotion_id * @return string */   public static function getOrderPromotionItems($order_id,$promotion_id){			$items='';				$listof_submenu = '';		//..Get the Promotions submenu Discount 		$tmpres  = mysql_query('SELECT GROUP_CONCAT('.PRMDISC_BOGO_SBMNU.')  FROM '.TBL_PROM_DISCOUNTS.' WHERE '.PRMDISC_BOGO_SBMNU_DISH.' = 0 AND '.PRMDISC_PROMOTION.'='.$promotion_id);		if($tmpres && mysql_num_rows($tmpres)){			$listof_submenu = mysql_result($tmpres,0);		} 		unset($tmpres);				$listof_order_items = '';		if(is_not_empty($listof_submenu)){			$tmpres = mysql_query('SELECT GROUP_CONCAT('.ORDER_DTL_ID.') FROM'.TBL_ORDER_DETAILS.' WHERE '.ORDER_DTL_ORDER_ID.'='.$order_id.' AND '.ORDER_DTL_SUBMENU_DISH_ID.' IN (SELECT '.SBMNU_DISH_ID.' FROM '.TBL_SUBMENU_DISHES.' WHERE '.SBMNU_DISH_SUBMENU.' IN ('.$listof_submenu.')) ');			if($tmpres && mysql_num_rows($tmpres)){				$listof_order_items = mysql_result($tmpres,0);			} 			unset($tmpres);		}			 if(is_not_empty($listof_order_items)){			$tmpres=mysql_query('SELECT GROUP_CONCAT(`ordprom_order_sbmnu_dish`) FROM '.TBL_TMP_ORDER_PROM.'  WHERE '.ORDPROM_ORDER.'='.$order_id.' AND '.ORDPROM_PROMOTION.'='.$promotion_id.' AND '.ORDPROM_DISCOUNT.'>0 AND '.ORD_DTL_ID.' IN  ('.$listof_order_items.')'); 			if($tmpres && mysql_num_rows($tmpres)){				$items=mysql_result($res, 0); 			}			unset($tmpres);	 }	 		return $items;   } /*** Get the order items* @param integer $order_id* @return string*/	public static function getOrderItems($filt_cond=0){			$items='';		$qry='SELECT * FROM `'.TBL_ORDER_DETAILS.'` WHERE '.$filt_cond;		$res = mysql_query($qry); 		if($res){			$items=mysql_result($res, 0); 		}		return $items;   }	  /**	* To check if discount is applied to the order	* @param integer $order_id	* @param integer $promotion_id	* @return integer	*/	public static function chkIfDiscountAlreadyApplied($order_id,$promotion_id){	$fnd=0;			//..First check if it is applied to that order discount	$order_items=tbl_orders::readArray(array(ORDER_ID=>$order_id,ORDER_DISCOUNT_AMT=>1,'isDiscAmtGtZero'=>1),$fnd,1);	if($fnd){		return 1;	}else{					$tmp_fnd=0;		//..Check if all the items in order deatils are discounted		$order_items=tbl_order_details::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORDPROM_DISCOUNT_AMT=>0),$tmp_fnd,1,0);			if($tmp_fnd){			$fnd=0;		}		}	return $fnd;		} //..function to check if the submenu item is already discounted public static function chkIfOrdDtlSubmnuDiscounted($order_id,$submnudish){ 		$tmp_fnd=0;		$order_items=tbl_order_details::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$submnudish,ORDPROM_DISCOUNT_AMT=>0),$tmp_fnd,1,0);				if($tmp_fnd>0)			return 1;		else			return 0;	 }  public static function update_item_with_discount($detail_id,$order_promotion,$order_discount_id,$order_discount_amt){//..Update the order detail when the promtion is applied	if(is_gt_zero_num($detail_id)){		$objtbl_order_details=new tbl_order_details();		if($objtbl_order_details->readObject(array(ORD_DTL_ID=>$detail_id))){			$objtbl_order_details->setordprom_promotion($order_promotion);			$objtbl_order_details->setordprom_discount_id($order_discount_id);			$objtbl_order_details->setordprom_discount_amt($order_discount_amt);			$objtbl_order_details->insert();			return 1;		}		unset($objtbl_order_details);		}  	return 0;	 } /*** Discount apply logic for without condition* */ public static function bogo_apply_disc($order_id,$promotion_id,$prmdisc_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$disc_amt_type,$disc_amt){ 	//echo "$order_id,$promotion_id,$prmdisc_id,$prmdisc_bogo_sbmnu,$prmdisc_bogo_sbmnu_dish,$prmdisc_bogo_qty,$disc_amt_type,$disc_amt";		//..Check if discount is with sub menu item is selected		if(is_gt_zero_num($prmdisc_bogo_sbmnu_dish)){			//..do nothing..because we already ahve submenudishid		}else{		  //..Get all submenu dish ids from submenu..			$rs_apl_disc_items= tbl_submenu_dishes::getSubMenuItems($prmdisc_bogo_sbmnu);			if(is_not_empty($rs_apl_disc_items)){				$prmdisc_bogo_sbmnu_dish=$rs_apl_disc_items;			}else{				$strOpMsg= "No items found to apply discount" ;				return 0;			}		}		 		//...Check if the item is in the order detail		$tmp_fnd=0;		$ord_det_items=tbl_order_details::readArray(array(ORD_DTL_ORDER_ID=>$order_id,ORD_DTL_SBMENU_DISH_ID=>$prmdisc_bogo_sbmnu_dish,ORDPROM_DISCOUNT_AMT=>0),$tmp_fnd,1,0);									if($tmp_fnd>0){		  			//..item presents in order detail wihtout disocunt			//..loop through the all the order items records			foreach($ord_det_items as $order_itm){				 //..now check if the quantity >= disc qty					 				 if($order_itm[ORD_DTL_QUANTITY]>=$prmdisc_bogo_qty){				 	 //..Right item to apply discount					 //..Calculate discount amount						$discount_amount=tbl_order_details::getDiscountAmnt($disc_amt_type,$disc_amt,$order_itm[ORD_DTL_PRICE]);					//..Update the order detail with discount and promot					$success=tbl_order_details::update_item_with_discount($order_itm[ORD_DTL_ID],$promotion_id,$prmdisc_id,$discount_amount);												 				 }			}			unset($ord_det_items);			}else{			$strOpMsg= "Item not present in your order or alreday discounted" ;		}			return 1; }    public static function getDiscountAmnt($disc_type,$disc_amnt,$price){ 		$discount_amount=0; 		//..Calculate discount amount		if($disc_type=='PERCENT'){			//$discount_amount=($price-($price*($disc_amnt/100)));			$discount_amount=($price*($disc_amnt/100));		}else{			$discount_amount=$disc_amnt;		}				return $discount_amount; }  public static function getOrderDishToRate($order_id,$cust_id,$cust_type=CUST_TYPE_LOGIN){ 	$arr = array(); 	if(is_gt_zero_num($order_id) && is_gt_zero_num($cust_id)){		$res = mysql_query('SELECT DISTINCT `ord_dtl_sbmenu_dish_id` \'submenu_dish\', `ord_dtl_id`, ( SELECT '.DISH_NAME.' FROM '.TBL_SUBMENU_DISHES.' sbmd  INNER JOIN '.TBL_DISHES.' d ON sbmd.sbmnu_dish_dish=d.dish_id WHERE `sbmnu_dish_id` = `ord_dtl_sbmenu_dish_id` LIMIT 0,1)  AS `title`, (SELECT DISTINCT '.RECOMM_RATING.' FROM  '.TBL_FEEDBACK.' WHERE '.POST_ID.'=`ord_dtl_sbmenu_dish_id` AND '.POST_TYPE.'=\''.tbl_feedback::PST_TYP_SUBMNUDISH.'\' AND '.USER_ID.'='.$cust_id.' AND '.USER_TYPE.' = \''.$cust_type.'\' LIMIT 0,1) `rate` FROM '.TBL_ORDER_DETAILS.' WHERE '.ORD_DTL_ORDER_ID.'='.$order_id ) or die(mysql_error()); 			if($res && mysql_num_rows($res)){				while($row=mysql_fetch_assoc($res)){ 					$row['rate'] = ceil($row['rate'] * 2);					$arr[$row['submenu_dish']] = $row; 				} 			} 	} 	 return $arr;  } /*** return OrderIdsBySubmenu* @param integer $sub_menu_dish* @return string */ public static function getOrderIdsBySubMenuDish($sub_menu_dish){ 	 return (is_gt_zero_num($sub_menu_dish)) ?  DB::ExecScalarQry('SELECT IFNULL(GROUP_CONCAT(IFNULL('.ORD_DTL_ORDER_ID.',0)),0) FROM '.TBL_ORDER_DETAILS.' WHERE '.ORD_DTL_SBMENU_DISH_ID.'='.$sub_menu_dish) : '0'; }  }//..End tbl_order_details ?>