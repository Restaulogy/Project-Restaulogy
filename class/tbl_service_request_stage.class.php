<?php/**********************************************************************tbl_service_request_stage.class.phpGenerated by STRUCTY 2013.03.27 04:13:49.Copyright 2011 Structy, Frédéric Aebi. All rights reserved.**********************************************************************/define("TBL_SERVICE_REQUEST_STAGE", "tbl_service_request_stage"); define('SRVC_REQ_STG_ID', 'srvc_req_stg_id'); define('SRVC_REQ_STG_REQUEST_ID', 'srvc_req_stg_request_id'); define('SRVC_REQ_STG_SERVICE_STAGE_ID', 'srvc_req_stg_service_stage_id'); define('SRVC_REQ_STG_TIME_FINISHED', 'srvc_req_stg_time_finished'); //define("TBL_SERVICE_REQUEST_STAGE_ACTIVE_DATE", "");//define("TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE", "");//$tbl_service_request_stage_active_condition="";//$tbl_service_request_stage_active_condition= " (".TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE." is NULL OR ".TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE." = 0 OR ".TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE." > CURDATE( )) ";class tbl_service_request_stage {	private $srvc_req_stg_id;	private $srvc_req_stg_request_id;	private $srvc_req_stg_service_stage_id;	private $srvc_req_stg_time_finished;	//private $tbl_service_request_stage_active_date;	//private $tbl_service_request_stage_deactive_date;	public function setsrvc_req_stg_id($pArg="0") {$this->srvc_req_stg_id=$pArg;}	public function setsrvc_req_stg_request_id($pArg="0") {$this->srvc_req_stg_request_id=$pArg;}	public function setsrvc_req_stg_service_stage_id($pArg="0") {$this->srvc_req_stg_service_stage_id=$pArg;}	public function setsrvc_req_stg_time_finished($pArg="0") {$this->srvc_req_stg_time_finished=$pArg;}	//public function settbl_service_request_stage_active_date($pArg="0") {$this->tbl_service_request_stage_active_date=$pArg;}	//public function settbl_service_request_stage_deactive_date($pArg="0") {$this->tbl_service_request_stage_deactive_date=$pArg;}	public function getsrvc_req_stg_id() {return $this->srvc_req_stg_id;}	public function getsrvc_req_stg_request_id() {return $this->srvc_req_stg_request_id;}	public function getsrvc_req_stg_service_stage_id() {return $this->srvc_req_stg_service_stage_id;}	public function getsrvc_req_stg_time_finished() {return $this->srvc_req_stg_time_finished;}	//public function gettbl_service_request_stage_active_date($pArg="0") {return $this->tbl_service_request_stage_active_date;}	//public function gettbl_service_request_stage_deactive_date($pArg="0") {return $this->tbl_service_request_stage_deactive_date;}	public function readObject($array = array()) {		$qry = "SELECT *".RET."FROM ".TBL_SERVICE_REQUEST_STAGE.RET;		$and = "WHERE".RET;		if($array[SRVC_REQ_STG_ID] != "") {			$qry .= $and.SRVC_REQ_STG_ID." = '".$array[SRVC_REQ_STG_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_REQUEST_ID] != "") {			$qry .= $and.SRVC_REQ_STG_REQUEST_ID." = '".$array[SRVC_REQ_STG_REQUEST_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_SERVICE_STAGE_ID] != "") {			$qry .= $and.SRVC_REQ_STG_SERVICE_STAGE_ID." = '".$array[SRVC_REQ_STG_SERVICE_STAGE_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_TIME_FINISHED] != "") {			$qry .= $and.SRVC_REQ_STG_TIME_FINISHED." = '".$array[SRVC_REQ_STG_TIME_FINISHED]."'".RET;			$and = "AND".RET;		}	$result = mysql_query($qry);		if($result) {			while ($row = mysql_fetch_array($result)) {				$record = $row;				break;//end after first record			}			if(count($record[0]) == 0) {				return array();			} else {				$this->setsrvc_req_stg_id($record[SRVC_REQ_STG_ID]);				$this->setsrvc_req_stg_request_id($record[SRVC_REQ_STG_REQUEST_ID]);				$this->setsrvc_req_stg_service_stage_id($record[SRVC_REQ_STG_SERVICE_STAGE_ID]);				$this->setsrvc_req_stg_time_finished($record[SRVC_REQ_STG_TIME_FINISHED]);				//$this->settbl_service_request_stage_active_date($record[TBL_SERVICE_REQUEST_STAGE_ACTIVE_DATE]);				//$this->settbl_service_request_stage_deactive_date($record[TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE]);				return true;			}		}	}	public static function readArray($array = array(),&$result_found=0,$isArray=1) {		//global $tbl_service_request_stage_active_condition;		$qry = "SELECT *".RET."FROM ".TBL_SERVICE_REQUEST_STAGE.RET;		$and = "WHERE".RET;		if($array[SRVC_REQ_STG_ID] != "") {			$qry .= $and.SRVC_REQ_STG_ID." = '".$array[SRVC_REQ_STG_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_REQUEST_ID] != "") {			$qry .= $and.SRVC_REQ_STG_REQUEST_ID." = '".$array[SRVC_REQ_STG_REQUEST_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_SERVICE_STAGE_ID] != "") {			$qry .= $and.SRVC_REQ_STG_SERVICE_STAGE_ID." = '".$array[SRVC_REQ_STG_SERVICE_STAGE_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_TIME_FINISHED] != "") {			$qry .= $and.SRVC_REQ_STG_TIME_FINISHED." = '".$array[SRVC_REQ_STG_TIME_FINISHED]."'".RET;			$and = "AND".RET;		}  /*if(is_gt_zero_num($array["isActive"])) {			$qry .= $and.$tbl_service_request_stage_active_condition;;			$and = "AND".RET;		}*/		if(is_not_empty($array[OFFSET_TITLE]) && is_not_empty($array[LIMIT_TITLE])) {			$qry_with_limit  = $qry." LIMIT ".$array[OFFSET_TITLE].",".$array[LIMIT_TITLE];		}else{			$qry_with_limit  = $qry;		}		$result = mysql_query ($qry_with_limit);		$r1 = mysql_query($qry);		$result_found = mysql_num_rows($r1);		$class_objects = array();		if($result) {			while ($record = mysql_fetch_assoc($result)) {				$isActive= 0;   /*	//..check deactive date is not set or 0				if((is_not_empty($record[TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE])==false) || (is_gt_zero_num(strtotime($record[TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE]))== false)){					$isActive = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($record[TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE]) >= strtotime(date(DATE_FORMAT))){						$isActive = 1;					}				}*/				if($isArray){					$class_object = array();					$class_object["srvc_req_stg_id"]=$record[SRVC_REQ_STG_ID];					$class_object["srvc_req_stg_request_id"]=$record[SRVC_REQ_STG_REQUEST_ID];					$class_object["srvc_req_stg_service_stage_id"]=$record[SRVC_REQ_STG_SERVICE_STAGE_ID];					$class_object["srvc_req_stg_time_finished"]=$record[SRVC_REQ_STG_TIME_FINISHED];					$class_object["isActive"]=$isActive;				}else{					$class_object = new tbl_service_request_stage();					$class_object->setsrvc_req_stg_id($record[SRVC_REQ_STG_ID]);					$class_object->setsrvc_req_stg_request_id($record[SRVC_REQ_STG_REQUEST_ID]);					$class_object->setsrvc_req_stg_service_stage_id($record[SRVC_REQ_STG_SERVICE_STAGE_ID]);					$class_object->setsrvc_req_stg_time_finished($record[SRVC_REQ_STG_TIME_FINISHED]);				}				$class_objects[$record[SRVC_REQ_STG_ID]] = $class_object;			}		}		return $class_objects;	}//..End readArray	public function insert() {		if($this->getsrvc_req_stg_id() != '') {			$qry  = "UPDATE ".TBL_SERVICE_REQUEST_STAGE.RET."SET".RET."			".SRVC_REQ_STG_ID." = '".$this->getsrvc_req_stg_id()."',".RET."			".SRVC_REQ_STG_REQUEST_ID." = '".$this->getsrvc_req_stg_request_id()."',".RET."			".SRVC_REQ_STG_SERVICE_STAGE_ID." = '".$this->getsrvc_req_stg_service_stage_id()."',".RET."			".SRVC_REQ_STG_TIME_FINISHED." = '".$this->getsrvc_req_stg_time_finished()."'".RET.			"WHERE ".SRVC_REQ_STG_ID." = ".$this->getsrvc_req_stg_id().RET;			mysql_query($qry);		} else {			$qry  = "INSERT INTO ".TBL_SERVICE_REQUEST_STAGE." (".RET.			"".SRVC_REQ_STG_REQUEST_ID.", ".SRVC_REQ_STG_SERVICE_STAGE_ID.", ".SRVC_REQ_STG_TIME_FINISHED.RET.				") VALUES (".RET.			"'".$this->getsrvc_req_stg_request_id()."',".RET.			"'".$this->getsrvc_req_stg_service_stage_id()."',".RET.			"'".$this->getsrvc_req_stg_time_finished()."'".RET.			")".RET; 			 			$res = mysql_query($qry);			$this->setsrvc_req_stg_id(mysql_insert_id());		}	}//..End Insert	public static function delete($array = array()) {		$qry = "DELETE".RET."FROM ".TBL_SERVICE_REQUEST_STAGE.RET;		$and = "WHERE".RET;		if($array[SRVC_REQ_STG_ID] != "") {			$qry .= $and.SRVC_REQ_STG_ID." = '".$array[SRVC_REQ_STG_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_REQUEST_ID] != "") {			$qry .= $and.SRVC_REQ_STG_REQUEST_ID." = '".$array[SRVC_REQ_STG_REQUEST_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_SERVICE_STAGE_ID] != "") {			$qry .= $and.SRVC_REQ_STG_SERVICE_STAGE_ID." = '".$array[SRVC_REQ_STG_SERVICE_STAGE_ID]."'".RET;			$and = "AND".RET;		}		if($array[SRVC_REQ_STG_TIME_FINISHED] != "") {			$qry .= $and.SRVC_REQ_STG_TIME_FINISHED." = '".$array[SRVC_REQ_STG_TIME_FINISHED]."'".RET;			$and = "AND".RET;		}		$res = mysql_query($qry);		if($res){			return OPERATION_SUCCESS;		};		return OPERATION_FAIL;	}//..End Delete	public function isAlreadyThere($srvc_req_stg_request_id ,$srvc_req_stg_service_stage_id ) {		$unique_arr = array();			//$unique_arr[SRVC_REQ_STG_ID]=$srvc_req_stg_id;			$unique_arr[SRVC_REQ_STG_REQUEST_ID]=$srvc_req_stg_request_id;			$unique_arr[SRVC_REQ_STG_SERVICE_STAGE_ID]=$srvc_req_stg_service_stage_id;			//$unique_arr[SRVC_REQ_STG_TIME_FINISHED]=$srvc_req_stg_time_finished; 		if(is_not_empty($unique_arr)){			return $this->readObject($unique_arr);		}		return false;	}//..isAlreadyThere	public function create($srvc_req_stg_request_id ,$srvc_req_stg_service_stage_id ,$srvc_req_stg_time_finished) {		if(is_not_empty($srvc_req_stg_request_id)){			if($this->isAlreadyThere($srvc_req_stg_request_id ,$srvc_req_stg_service_stage_id ,$srvc_req_stg_time_finished)){				self::delete(array(SRVC_REQ_STG_REQUEST_ID=>$srvc_req_stg_request_id,SRVC_REQ_STG_SERVICE_STAGE_ID=>$srvc_req_stg_service_stage_id)); 				/*return OPERATION_DUPLICATE;*/				return OPERATION_SUCCESS;			}else{				$this->setsrvc_req_stg_id("");				$this->setsrvc_req_stg_request_id($srvc_req_stg_request_id);				$this->setsrvc_req_stg_service_stage_id($srvc_req_stg_service_stage_id);				$this->setsrvc_req_stg_time_finished($srvc_req_stg_time_finished);				$this->insert();								$objServReqst = new tbl_services_requests();				if($objServReqst->readObject(array(SRVC_REQST_ID=>$srvc_req_stg_request_id))){					$objServReqst->setsrvc_reqst_status($srvc_req_stg_service_stage_id);										$objServReqst->insert();					//..send biz status notification					 					biz_send_status_notifications($objServReqst->getsrvc_reqst_table_id(),$objServReqst->getsrvc_reqst_created_by(),$objServReqst->getsrvc_reqst_id(),$srvc_req_stg_service_stage_id,$objServReqst->getsrvc_reqst_emp_id(),$objServReqst->getsrvc_reqst_cust_id(),$objServReqst->getsrvc_reqst_cust_type()); 				}  				return $this->getsrvc_req_stg_id();			}		}		return OPERATION_FAIL;	}//..create	public function update($srvc_req_stg_id, $srvc_req_stg_request_id, $srvc_req_stg_service_stage_id, $srvc_req_stg_time_finished) {		if(is_gt_zero_num($srvc_req_stg_id)){			if ($this->readObject(array(SRVC_REQ_STG_ID=>$srvc_req_stg_id))){				$this->setsrvc_req_stg_request_id($srvc_req_stg_request_id);				$this->setsrvc_req_stg_service_stage_id($srvc_req_stg_service_stage_id);				$this->setsrvc_req_stg_time_finished($srvc_req_stg_time_finished);				$this->insert();				return OPERATION_SUCCESS;			}		}		return OPERATION_FAIL;	}//..update /*public function activate($srvc_req_stg_id){		if(is_gt_zero_num($srvc_req_stg_id)){			if ($this->readObject(array(SRVC_REQ_STG_ID=>$srvc_req_stg_id))){				$qry  = "UPDATE ".TBL_SERVICE_REQUEST_STAGE.RET."SET".RET."			".TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE." = '".date(EMPTY_DATE_FORMAT)."' WHERE ".SRVC_REQ_STG_ID."={$srvc_req_stg_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end activate	public function deactivate($srvc_req_stg_id){		if(is_gt_zero_num($srvc_req_stg_id)){			if ($this->readObject(array(SRVC_REQ_STG_ID=>$srvc_req_stg_id))){				$qry  = "UPDATE ".TBL_SERVICE_REQUEST_STAGE.RET."SET".RET."			".TBL_SERVICE_REQUEST_STAGE_DEACTIVE_DATE." = '".date(DATE_FORMAT)."' WHERE ".SRVC_REQ_STG_ID."={$srvc_req_stg_id}";				$res = mysql_query($qry);				if($res){					return 1;				}			}		}		return 0;	}//..end deactivate*/	public function GetInfo($srvc_req_stg_id) {		$info = array();		if($srvc_req_stg_id != ""){			if($this->readObject(array("srvc_req_stg_id"=>$srvc_req_stg_id))){				$info["srvc_req_stg_id"]=$this->getsrvc_req_stg_id();				$info["srvc_req_stg_request_id"]=$this->getsrvc_req_stg_request_id();				$info["srvc_req_stg_service_stage_id"]=$this->getsrvc_req_stg_service_stage_id();				$info["srvc_req_stg_time_finished"]=$this->getsrvc_req_stg_time_finished();				$info["isActive"] = 0;				//..check deactive date is not set or 0    /*if((is_not_empty($this->gettbl_service_request_stage_deactive_date())==false)  || (is_gt_zero_num(strtotime($this->gettbl_service_request_stage_deactive_date()))== false)){					$info["isActive"] = 1;				}else{					//..check the deactive date is greater than todays date					if(strtotime($this->gettbl_service_request_stage_deactive_date()) >= strtotime(date(DATE_FORMAT))){						$info["isActive"] = 1;					}				}*/			}		return $info;		}	}//..End GetInfo			public static function getLastStatusOfRequst($request_id){	 if(is_gt_zero_num($request_id)){	 	return DB::ExecScalarQry('SELECT '.SRVC_REQ_STG_SERVICE_STAGE_ID.' FROM '.TBL_SERVICE_REQUEST_STAGE.' WHERE '.SRVC_REQ_STG_ID.'= ( SELECT MAX('.SRVC_REQ_STG_ID.') FROM '.TBL_SERVICE_REQUEST_STAGE.' WHERE '.SRVC_REQ_STG_REQUEST_ID.'='.$request_id.')');	 }	 return 0;			}	 		public static function GetRemainingStages($request_id,$service_id){		$arr = array(); 		 		global $tbl_service_stage_active_condition;		if(is_gt_zero_num($service_id) && is_gt_zero_num($request_id)){			$qry = "SELECT * FROM ".TBL_SERVICE_STAGE." WHERE ".SRVC_STG_SERVICE_ID." = {$service_id}  AND {$tbl_service_stage_active_condition} AND ".SRVC_STG_ID." NOT IN (SELECT ".SRVC_REQ_STG_SERVICE_STAGE_ID." FROM ".TBL_SERVICE_REQUEST_STAGE." WHERE ".SRVC_REQ_STG_REQUEST_ID." = {$request_id}) ORDER BY ".SRVC_STG_SORT_ORDER ." ASC";		 	 			$res = mysql_query($qry);			if($res){				while($row = mysql_fetch_assoc($res)){				  if($row){ 					 	$arr[] = $row; 				  } 				}			}		}  		return $arr;	} 		/**	* it will return the used stage of the request	* @param integer $request_id ..	* @param integer $service_id ..	* @return array of used stages  	*/	public static function GetUsedStage($request_id,$service_id){		$arr = array();		global $tbl_service_stage_active_condition;		if(is_gt_zero_num($service_id) && is_gt_zero_num($request_id)){			$qry = 'SELECT * FROM '.TBL_SERVICE_STAGE.' WHERE '.SRVC_STG_SERVICE_ID.' = '.$service_id.'  AND '.$tbl_service_stage_active_condition.' AND '.SRVC_STG_ID.' IN (SELECT '.SRVC_REQ_STG_SERVICE_STAGE_ID.' FROM '.TBL_SERVICE_REQUEST_STAGE.' WHERE '.SRVC_REQ_STG_REQUEST_ID.' = '.$request_id.') ORDER BY '.SRVC_STG_SORT_ORDER .' DESC';			//echo $qry;		 	 $res = mysql_query($qry);			  if($res){					while($row = mysql_fetch_assoc($res)){					 	$arr[] = $row; 					}				}			 }			 return $arr;	}	 		/**	* Fetch all the stage record completed for the particualr request	* @param integer $request_id	* @return array	*/	public static function getAllCompletedStagesForRequest($request_id){		$arr = array();		 		if(is_gt_zero_num($request_id)){			 /*$qry = 'SELECT '.SRVC_REQ_STG_ID.','.SRVC_REQ_STG_TIME_FINISHED.','.SRVC_STG_NAME.','.SRVC_STG_THRESH_HOLD_TIME.' FROM '.TBL_SERVICE_REQUEST_STAGE.' INNER JOIN '.TBL_SERVICE_STAGE.'  ON '.SRVC_REQ_STG_SERVICE_STAGE_ID.' = '.SRVC_STG_ID.' WHERE SRVC_REQ_STG_REQUEST_ID = '.$request_id;*/			 $qry = 'SELECT '.SRVC_REQ_STG_ID.','.SRVC_REQ_STG_TIME_FINISHED.','.STATUS_NAME.','.STATUS_EXP_TIME.' FROM '.TBL_SERVICE_REQUEST_STAGE.' INNER JOIN '.TBL_STATUSES.'  ON '.SRVC_REQ_STG_SERVICE_STAGE_ID.' = '.STATUS_ID.' WHERE SRVC_REQ_STG_REQUEST_ID = '.$request_id.' ORDER BY '.SRVC_REQ_STG_ID.' ASC';			 //echo $qry;			 		 	 $res = mysql_query($qry);		  if($res){				$cnt = 0;				while($row = mysql_fetch_assoc($res)){ 				  $arr[$cnt][SRVC_REQ_STG_ID] 		= $row[SRVC_REQ_STG_ID];          $arr[$cnt]['actual_time']				= $row[SRVC_REQ_STG_TIME_FINISHED];          $arr[$cnt]['service_name'] 			= $row[STATUS_NAME];          $arr[$cnt]['expected_time']			= $row[STATUS_EXP_TIME];					$arr[$cnt]['diff_time'] 				= $arr[$cnt]['actual_time'] - $arr[$cnt]['expected_time']; 					$arr[$cnt]['diff_time_min'] 		= biz_convSecToMin($arr[$cnt]['diff_time']);				 	$arr[$cnt]['expected_time_min'] = biz_convSecToMin($arr[$cnt]['expected_time']);				 	$arr[$cnt]['actual_time_min'] 	= biz_convSecToMin($arr[$cnt]['actual_time']);				 	$cnt++;				}			}		 }			 return $arr;	}	 }//..End tbl_service_request_stage?>