<?phpinclude_once(dirname(dirname(__FILE__))."/init.php");include_once("header.php");$active_page = "tbl_complaints";/*if($sesslife==true){*/if(is_not_empty($_SESSION[SES_RESTAURANT])){$complnt_id= get_input("complnt_id");$complnt_title= get_sql_input("complnt_title",'');$complnt_description= get_sql_input("complnt_description");$complnt_email= get_sql_input("complnt_email");$complnt_phone= get_sql_input("complnt_phone");$complnt_restaurant= get_input("complnt_restaurant",$_SESSION[SES_RESTAURANT]);$complnt_user_id= get_input("complnt_user_id",$_SESSION['guid']);$complnt_user_type= get_input("complnt_user_type",CUST_TYPE_LOGIN);$complnt_table= get_input("complnt_table",$_SESSION[SES_TABLE]);$complnt_start_date= get_input("complnt_start_date");$complnt_end_date= get_input("complnt_end_date",NULL);$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,"complnt_id");$sel_tbl_complaints = get_input('sel_tbl_complaints');if($sel_tbl_complaints){ 		$sel_tbl_complaints_ids = biz_implode(',',array_keys($sel_tbl_complaints)); }if(is_not_empty($_SESSION[SES_CUST_NM])){	$ask_cust_name=0;	}else{	$ask_cust_name = 1;}$sort_by=$new_sort="";biz_set_sorting_var($sort_by,$new_sort,'DESC');$url = "{$website}/user/tbl_complaints.php";$navigationURL = $url."?".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}";$isSuccess = "";$objtbl_complaints= new tbl_complaints();$restaurant_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);if(is_not_empty($action)){	switch($action){		case ACTION_CREATE:			//..fetch user id from the session/cookie			if(is_gt_zero_num($_SESSION['guid'])){				$complnt_user_id = $_SESSION['guid']; 			}else{								$complnt_user_id= getCustomerId($complnt_user_type);											} 			//..upsert user using phone number			if(is_not_empty($complnt_phone)){				$user_details=upsert_usr_by_phone($complnt_phone);				$complnt_user_id=$user_details['id'];				$complnt_user_type= CUST_TYPE_LOGIN;								//..Check for the last psoted complaint by that user_error				$sql=  'SELECT DATEDIFF(NOW(),MAX(`complnt_start_date`)) as `last_rec` FROM `tbl_complaints` WHERE `complnt_user_id`='.$user_details['id'];				$last_post=DB::ExecQry($sql,1);					//print_r($last_post);			}			$isSuccess = $objtbl_complaints->create('--', $complnt_description, $complnt_email, $complnt_phone, $complnt_restaurant, $complnt_user_id, $complnt_user_type, $complnt_table, $complnt_start_date, $complnt_end_date);			$_rest_mngr_ph=$restaurant_info[RESTAURENT_PHONE_1];			if(is_not_empty($_rest_mngr_ph) && is_gt_zero_num($isSuccess)){				if(is_gt_zero_num($complnt_phone)){					$_des= $complnt_phone.':'.$complnt_description;				}else{					$_des= $complnt_description;				}				try {					//$isSuccess=send_sms_using_twilio(array($_rest_mngr_ph),get_elipsis($_des,120));				}catch(Exception $e) {				  // echo 'Caught exception: ',  $e->getMessage(), "\n";				}				}						//..Send email			if(is_not_empty($complnt_email)){					//..Finally send the email with the above content										$subject = "Complaint/suggestion from {$complnt_email} on ".$restaurant_info[RESTAURENT_NAME];					//$email_body=sprintf($_lang['tbl_complaints']['info_msg']['complnt_email_msg'],$complnt_description,$_SESSION[SES_CUST_NM],$complnt_email,$complnt_phone);					$email_body=sprintf($_lang['tbl_complaints']['info_msg']['complnt_email_msg'],$complnt_description,'',$complnt_email,$complnt_phone);										try {						@send_mail_using_php($subject,$complnt_email,$restaurant_info[RESTAURENT_EMAIL],$email_body,$restaurant_info[RESTAURENT_NAME]);					}catch(Exception $e) {					  // echo 'Caught exception: ',  $e->getMessage(), "\n";					}			}				//..Send SMS 			if(is_not_empty($complnt_phone)){								 								/*				try {					$_dsc = $complnt_phone .':'.get_elipsis($complnt_description,100);					$isSuccess=send_sms_using_twilio(array($restaurant_info['restaurent_phone_1']),$_dsc);				}catch(Exception $e) {				  // echo 'Caught exception: ',  $e->getMessage(), "\n";				}*/								//..Add reward feedback points if added by restaurant				if(is_gt_zero_num( $restaurant_info['restaurent_fdbk_award_pts'])){					//$user_details=upsert_usr_by_phone($complnt_phone);					if(is_not_empty($user_details)){												if(($last_post['last_rec']==NULL) || ($last_post['last_rec']>=30)){							$objbiz_checkins=new biz_checkins();								//...Add reward points to sender loyalty program							$isSuccess = $objbiz_checkins->create($_SESSION[SES_RESTAURANT], 0, $user_details['id'],0, $restaurant_info['restaurent_fdbk_award_pts'], date(DATE_FORMAT),0,$restaurant_info['restaurent_fdbk_award_pts'],"FEEDBACK REWARD");							unset($objbiz_checkins);													}										}										}			}						if(is_not_empty($isSuccess)){				if(is_gt_zero_num($isSuccess)){					$err .= "<div class='info'>".$_lang['tbl_complaints'][$action]['SUCCESS_MSG']."</div>";				}elseif($isSuccess == OPERATION_FAIL){					$err .= "<div class='error'>".$_lang['tbl_complaints'][$action]['FAILURE_MSG']."</div>";				}elseif($isSuccess == OPERATION_DUPLICATE){					$err .= "<div class='error'>".$_lang['tbl_complaints'][$action]['DUPLICATE_MSG']."</div>";				}			}//..if 				$_SESSION[SES_FLASH_MSG] =$err;			biz_script_forward($website.'/user/dashboard.php');					 						break;					case ACTION_UPDATE: 			$isSuccess = $objtbl_complaints->update($complnt_id, $complnt_title, $complnt_description, $complnt_email, $complnt_phone, $complnt_restaurant, $complnt_user_id, $complnt_user_type, $complnt_table, $complnt_start_date, $complnt_end_date);			break;						case ACTION_DELETE: 		 if(is_not_empty($sel_tbl_complaints_ids)){ 		 	 $isSuccess = $objtbl_complaints->delete(array(COMPLNT_ID=>$sel_tbl_complaints_ids));		 }else{		 	 $isSuccess = $objtbl_complaints->delete(array(COMPLNT_ID=>$complnt_id));		 }						break;					case ACTION_ACTIVATE:			if(is_not_empty($sel_tbl_complaints_ids)){ 			 $isSuccess = $objtbl_complaints->activate($sel_tbl_complaints_ids);		 }else{		 	 $isSuccess = $objtbl_complaints->activate($complnt_id);		 } 			 			break;					case ACTION_DEACTIVATE:						if(is_not_empty($sel_tbl_complaints_ids)){ 				$isSuccess = $objtbl_complaints->deactivate($sel_tbl_complaints_ids);		 }else{		 	 $isSuccess = $objtbl_complaints->deactivate($complnt_id);		 }  			break;						/*case ACTION_DELETE: 			$isSuccess = $objtbl_complaints->delete(array(COMPLNT_ID=>$complnt_id));			break;		case ACTION_ACTIVATE: 			$isSuccess = $objtbl_complaints->activate($complnt_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objtbl_complaints->deactivate($complnt_id);			break;*/	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$err .= "<div class='info'>".$_lang['tbl_complaints'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$err .= "<div class='error'>".$_lang['tbl_complaints'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$err .= "<div class='error'>".$_lang['tbl_complaints'][$action]['DUPLICATE_MSG']."</div>";	}}//..if  	$result_found=0;	$tbl_complaintslist = $objtbl_complaints->readArray(array(COMPLNT_RESTAURANT=>$complnt_restaurant,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array("url"=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,"count"=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_complaintslist', $tbl_complaintslist);	$smarty->assign('result_found',$result_found);	//$template = "tbl_complaints/tbl_complaints.tpl";	if(($sesslife==true) && (isCustomer()==false)){		$template = "tbl_complaints/grid.tpl";	}else{		$template = "tbl_complaints/create.tpl";	}	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($complnt_id)){			$tbl_complaintsinfo= $objtbl_complaints->GetInfo($complnt_id);			$smarty->assign('tbl_complaintsinfo',$tbl_complaintsinfo);			if($mode==MODE_UPDATE){				$smarty->assign("isUpdate",1);			}			$template = "tbl_complaints/view.tpl";		}elseif($mode == MODE_CREATE){			$template = "tbl_complaints/create.tpl";		}	}	$_custinfo_msg='* Please provide contact number so we know it is a valid feedback.';	if(is_gt_zero_num( $restaurant_info['restaurent_fdbk_award_pts'])){		$_custinfo_msg.='You can also get reward points added to your loyalty program.';	}	$smarty->assign('_custinfo_msg', $_custinfo_msg);		$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('ask_cust_name', $ask_cust_name);}else{	$template="index.tpl";}include_once("footer.php");?>