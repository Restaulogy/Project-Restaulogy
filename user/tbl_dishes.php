<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_dishes';$mode = strtoupper(get_input(MODE_TITLE));if(($sesslife==true) || ($mode == MODE_VIEW)){$dish_id= get_input('dish_id');$dish_name= get_sql_input('dish_name');$dish_restaurent = get_sql_input('dish_restaurent', $_SESSION[SES_RESTAURANT]);$dish_chef_notes= get_sql_input('dish_chef_notes');$dish_ingrad_allergic_contents= get_sql_input('dish_ingrad_allergic_contents');$dish_is_nutrition_text= get_input('dish_is_nutrition_text',0);$dish_nutri_cal_info= get_sql_input('dish_nutri_cal_info');$dish_allergy= get_input('dish_allergy','');//$dish_food_wine_pair= get_input('dish_food_wine_pair',array());$dish_food_wine_pair_f= get_input('dish_food_wine_pair_f',array());$dish_food_wine_pair_d= get_input('dish_food_wine_pair_d',array());$dish_food_wine_pair=array_merge($dish_food_wine_pair_f,$dish_food_wine_pair_d);//print_r($dish_food_wine_pair_f);//exit;$dish_pair_note= get_sql_input('dish_pair_note');$dish_notes= get_sql_input('dish_notes'); $dish_winery= get_sql_input("dish_winery");$dish_type_cat= get_input("dish_type_cat",0);$dish_alcohol_percent= get_input("dish_alcohol_percent",0);$dish_vintage= get_sql_input("dish_vintage");$dish_varietal= get_sql_input("dish_varietal");$dish_region= get_sql_input("dish_region");$dish_country= get_sql_input("dish_country",'');$dish_bottle_price= get_input("dish_bottle_price",0);$dish_glass_price= get_input("dish_glass_price",0);$dish_winemaking= get_sql_input("dish_winemaking");$dish_maturity= get_input("dish_maturity");$dish_is_drink= get_input("dish_is_drink",0);$dish_attributes= get_input("dish_attributes",'');if(is_not_empty($dish_attributes)){	$dish_attributes=implode(',',$dish_attributes);	}$dish_food_notes= get_input("dish_food_notes",'');if(is_not_empty($dish_food_notes)){	$dish_food_notes=implode(',',$dish_food_notes);	}if(is_not_empty($dish_allergy)){	$dish_allergy=implode(',',$dish_allergy);	}$dish_ethor_mnu_itm_id= get_input("dish_ethor_mnu_itm_id",'');$dish_ethor_mnu_itm_img= get_input("dish_ethor_mnu_itm_img",'');$dish_start_date= get_input('dish_start_date');$dish_end_date= get_input('dish_end_date');$action = strtoupper(get_input(ACTION_TITLE));//$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'dish_name');$is_preview = get_input('is_preview',0);$nutr_id= get_input("nutr_id");$nutr_dish_id= get_input("nutr_dish_id");$nutr_total_cal= get_input("nutr_total_cal",0);$nutr_cal_from_fat= get_input("nutr_cal_from_fat",0);$nutr_total_fat= get_input("nutr_total_fat",0);$nutr_saturated_fat= get_input("nutr_saturated_fat",0);$nutr_trans_fat= get_input("nutr_trans_fat",0);$nutr_cholestrol= get_input("nutr_cholestrol",0);$nutr_sodium= get_input("nutr_sodium",0);$nutr_total_carbohydrate= get_input("nutr_total_carbohydrate",0);$nutr_sugar= get_input("nutr_sugar",0);$nutr_dietary_fiber= get_input("nutr_dietary_fiber",0);$nutr_protein= get_input("nutr_protein",0);$nutr_start_date= get_input("nutr_start_date",'');$nutr_end_date= get_input("nutr_end_date",'');//..for FILTER$search_dish= get_input("search_dish",'');//print_r($_REQUEST);//echo "action=$action";//..Image save logic//..$dish_img= get_input('dish_img')$dish_img='';if((isset($_FILES['dish_img'])) && (is_not_empty($_FILES['dish_img']['name']))){	$save_path=PATHROOT.DISH_IMG_UPLOAD_PATH;	$file_save_nm=time().'_'.$_FILES['dish_img']['name'];		//now save the new file	$sv_fl_rslt=SaveFile($_FILES,'dish_img',$save_path,$file_save_nm);	if($sv_fl_rslt==1){		$dish_img=$file_save_nm;				if($action==ACTION_UPDATE){			//..Delete previous file			tbl_dishes::deletePrevDishImg($dish_id,$save_path);		}		//..Everything OK database insert/update will ok from here	}else{				$err .= '<div class="info">'.$sv_fl_rslt.'</div>';	}		}$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/tbl_dishes.php';$navigationURL = $url.'?'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';//..get list of selected items$sel_dishes= get_input('sel_dishes');$lst_sel_ids='';if(is_not_empty($sel_dishes)){		$lst_sel_ids=implode(',', array_keys($sel_dishes));} //.. Unset the session stored value of the menu if($is_preview==0){ 	 unset($_SESSION[SES_DISH]);}$objtbl_dishes= new tbl_dishes();$objtbl_nutrition=new tbl_nutrition();//..Delete the dish image$del_dish_img= get_input('del_dish_img',0);if(is_gt_zero_num($del_dish_img)){	$save_path=PATHROOT.DISH_IMG_UPLOAD_PATH;	$dish_img='';	//..Delete previous file	tbl_dishes::deletePrevDishImg($dish_id,$save_path);		if($objtbl_dishes->delete_img($dish_id)){		$_SESSION[SES_FLASH_MSG]='<div class="info">Dish image deleted successfully.</div>';	}	}if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 				if($dish_is_nutrition_text==0){				$dish_nutri_cal_info='';			}				$isSuccess = $objtbl_dishes->create($dish_name,$dish_chef_notes, $dish_ingrad_allergic_contents, $dish_nutri_cal_info, $dish_notes, $dish_img, $dish_winery, $dish_type_cat, $dish_alcohol_percent, $dish_vintage, $dish_varietal, $dish_region, $dish_country, $dish_bottle_price, $dish_glass_price, $dish_winemaking, $dish_maturity, $dish_is_drink, $dish_restaurent,$dish_allergy,$dish_food_wine_pair,$dish_attributes,$dish_pair_note,$dish_is_nutrition_text,$dish_food_notes,$dish_ethor_mnu_itm_id,$dish_ethor_mnu_itm_img);			if(is_gt_zero_num($isSuccess) && $dish_is_nutrition_text==0){					$isSuccess = $objtbl_nutrition->create($isSuccess, $nutr_total_cal, $nutr_cal_from_fat, $nutr_total_fat, $nutr_saturated_fat, $nutr_trans_fat, $nutr_cholestrol, $nutr_sodium, $nutr_total_carbohydrate, $nutr_sugar, $nutr_dietary_fiber, $nutr_protein, $nutr_start_date, $nutr_end_date);			}			break;		case ACTION_UPDATE: 			if($dish_is_nutrition_text==0){				$dish_nutri_cal_info='';			}				$isSuccess = $objtbl_dishes->update($dish_id, $dish_name, $dish_chef_notes, $dish_ingrad_allergic_contents, $dish_nutri_cal_info, $dish_notes, $dish_img, $dish_winery, $dish_type_cat, $dish_alcohol_percent, $dish_vintage, $dish_varietal, $dish_region, $dish_country, $dish_bottle_price, $dish_glass_price, $dish_winemaking, $dish_maturity, $dish_is_drink, $dish_restaurent,$dish_allergy,$dish_food_wine_pair,$dish_attributes,$dish_pair_note,$dish_is_nutrition_text,$dish_food_notes,$dish_ethor_mnu_itm_id,$dish_ethor_mnu_itm_img);			if(is_gt_zero_num($dish_id)){					$cor_nutrition_rec=$objtbl_nutrition->GetInfo(0,$dish_id);			}			if($dish_is_nutrition_text==0){					//$cor_nutrition_rec=$objtbl_nutrition->GetInfo(0,$dish_id);					if(is_not_empty($cor_nutrition_rec)){						//..record found update It						$isSuccess = $objtbl_nutrition->update($cor_nutrition_rec[NUTR_ID], $dish_id, $nutr_total_cal, $nutr_cal_from_fat, $nutr_total_fat, $nutr_saturated_fat, $nutr_trans_fat, $nutr_cholestrol, $nutr_sodium, $nutr_total_carbohydrate, $nutr_sugar, $nutr_dietary_fiber, $nutr_protein, $nutr_start_date, $nutr_end_date);					}else{						//..no record found insert into db						$isSuccess = $objtbl_nutrition->create($dish_id, $nutr_total_cal, $nutr_cal_from_fat, $nutr_total_fat, $nutr_saturated_fat, $nutr_trans_fat, $nutr_cholestrol, $nutr_sodium, $nutr_total_carbohydrate, $nutr_sugar, $nutr_dietary_fiber, $nutr_protein, $nutr_start_date, $nutr_end_date);					}				}elseif($dish_is_nutrition_text==1){				if(is_not_empty($cor_nutrition_rec)){					//..Delete the corosponding record					$isSuccess = $objtbl_nutrition->delete(array(NUTR_ID=>$cor_nutrition_rec[NUTR_ID]));				}			}			$mode = MODE_VIEW;						break;					case ACTION_DELETE:			if(is_not_empty($lst_sel_ids)){					$isSuccess = $objtbl_dishes->delete(array(DISH_ID=>$lst_sel_ids));			}else{				$isSuccess = OPERATION_FAIL;			}  			//$isSuccess = $objtbl_dishes->delete(array(DISH_ID=>$dish_id));			break;					case ACTION_ACTIVATE: 			if(is_not_empty($lst_sel_ids)){					$isSuccess = $objtbl_dishes->activate($lst_sel_ids);			}else{					$isSuccess = $objtbl_dishes->activate($dish_id);			}  			 			break;		case ACTION_DEACTIVATE: 			if(is_not_empty($lst_sel_ids)){					$isSuccess = $objtbl_dishes->deactivate($lst_sel_ids);			}else{				$isSuccess = $objtbl_dishes->deactivate($dish_id);			}  			break;	}//..switch}//..if if(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] .= '<div class="success">'.$_lang['tbl_dishes'][$action]['SUCCESS_MSG'].'</div>';	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] .= '<div class="error">'.$_lang['tbl_dishes'][$action]['FAILURE_MSG'].'</div>';	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] .= '<div class="info">'.$_lang['tbl_dishes'][$action]['DUPLICATE_MSG'].'</div>';	}}//..if	$arr_filter=array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on,DISH_RESTAURENT=>$_SESSION[SES_RESTAURANT]);		if(is_not_empty($search_dish)){			$arr_filter[DISH_NAME]=str_replace(' ','%%',$search_dish);							$filt_text[]="Dish Like {$search_dish}";	}	$result_found=0;	$tbl_disheslist = $objtbl_dishes->readArray($arr_filter,$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_disheslist', $tbl_disheslist);	//print_r($tbl_disheslist);	$smarty->assign('result_found',$result_found);		$template = 'tbl_dishes/tbl_dishes.tpl';	if($sesslife==true && ($Global_member['member_role_id'] == ROLE_WAITER || $Global_member['member_role_id'] == ROLE_MANAGER || $Global_member['member_role_id'] == ROLE_ADMIN)){		$breadcrumbs[] = array(					 	'link'=>$website.'/user/pref_mng_cntrols.php',						'title'=>$_lang['main']['pref_mng_cntrls']);		$breadcrumbs [] =   array(						 	'link'=>$url,							'title'=>$_lang['tbl_dishes']['listing_title']);	}else{		$breadcrumbs[] = array(						'link'=>$website.'/user/tbl_menu.php',						'title'=>$_lang['tbl_menu']['listing_title']); 	}		if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE || $mode=='LIST') && is_gt_zero_num($dish_id)){			$tbl_dishesinfo= $objtbl_dishes->GetInfo($dish_id); 			if(is_not_empty($tbl_dishesinfo)){			$breadcrumbs[] =  array(						 	'link'=>$url.'?'.MODE_TITLE.'='.MODE_VIEW.'&'.DISH_ID.'='.$dish_id,							'title'=>$tbl_dishesinfo['dish_name'].getModeSubTitle($mode));				$tbl_dishesinfo['dish_options'] = tbl_dish_options::readArray(array(DISH_OPT_DISH_ID=>$dish_id));				//print_r($tbl_dishesinfo['dish_options']);							$tbl_dishesinfo['submenu'] = tbl_submenu_dishes::readArray(array(SBMNU_DISH_DISH=>$dish_id));					//print_r($tbl_dishesinfo['submenu']); 				$menulist = tbl_menu::GetFields(array('key_field'=>MENU_ID,'value_field'=>MENU_NAME));				$smarty->assign('menulist',$menulist);				$smarty->assign('tbl_dishesinfo',$tbl_dishesinfo);				//print_r($tbl_dishesinfo);				//print_r($tbl_dishesinfo["paired_dishes_details"]);			}			 			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}						if($mode=='LIST'){				$template = 'tbl_dishes/list.tpl';			}else{				$template = 'tbl_dishes/view.tpl';				}		}elseif($mode == MODE_CREATE){			$template = 'tbl_dishes/create.tpl';		}}	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('country_list',getCountries());	$smarty->assign('vintage_list', tbl_dishes::getVintage());	$lst_dish_attribs=tbl_dish_attrib::GetFields(array('key_field'=>DISH_ATTRIB_ID,'value_field'=>DISH_ATTRIB_NAME,'isActive'=>1));	$smarty->assign('lst_dish_attribs', $lst_dish_attribs);			$lst_food_notes=tbl_food_notes::GetFields(array('key_field'=>FDNOTE_ID,'value_field'=>FDNOTE_NUMBER,'isActive'=>1));	$smarty->assign('lst_food_notes', $lst_food_notes);			$lst_allergies=tbl_allergy_list::GetFields(array('key_field'=>ALERGY_ID,'value_field'=>ALERGY_NAME,'isActive'=>1));	$smarty->assign('lst_allergies', $lst_allergies);			$lst_dishes=tbl_dishes::GetFields(array('key_field'=>DISH_ID,'value_field'=>DISH_NAME,'isActive'=>1),DISH_IS_DRINK.'=0');  $smarty->assign('lst_dishes', $lst_dishes);		$lst_wine=tbl_dishes::GetFields(array('key_field'=>DISH_ID,'value_field'=>DISH_NAME,'isActive'=>1),DISH_IS_DRINK.'=1');  $smarty->assign('lst_wine', $lst_wine);		$smarty->assign('active_page',$active_page);			if(is_not_empty($filt_text)){		$smarty->assign('filt_text',implode('|',array_unique($filt_text)));			} }else{	$template='index.tpl';}include_once('footer.php');?>