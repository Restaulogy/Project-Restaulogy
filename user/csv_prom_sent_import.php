<?phpini_set('max_execution_time', 0); include_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'csv_prom_sent_import';$restaurant_id = $_SESSION[SES_RESTAURANT];	//..if you are not logged in and restaurant id is not present	if(($sesslife==false)|| (is_gt_zero_num($restaurant_id)==false)){	echo "<div class='error'> Access denied. </div>";}else{	$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,10);$sort_on = get_input(SORT_ON,'crm_id');$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/csv_prom_sent_import.php';$navigationURL = $url.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';$upfile= get_input('upfile','');if($mode == 'CSV_IMPORT'){	if(is_not_empty($upfile)){	// check feilds are not empty	 	if(pathinfo($_FILES["uploaded"]["name"], PATHINFO_EXTENSION)!= 'csv'){		$error[] = 'Only CSV files accepted!';	}	 	if (!$error){	 	$tot = 0;	$handle = fopen($_FILES["uploaded"]["tmp_name"], "r");	$clmn_prom=-1;	$clmn_phone=-1;	$clmn_date=-1;	$is_complete=0;	$objcrm_prom_emails= new crm_prom_emails();		while(($data = fgetcsv($handle, 1000, ",")) !== FALSE) {	 //..get firsttime only field	 if($tot==0){		for ($columns=0; $columns < count($data); $columns++) {			if(strtoupper(trim($data[$columns]))=='PROM'){				$clmn_prom=$columns;			}elseif(strtoupper(trim($data[$columns]))=='PHONE'){				$clmn_phone=$columns;			}elseif(strtoupper(trim($data[$columns]))=='DATE'){				$clmn_date=$columns;			}		}	 }	/* echo "$clmn_prom|$clmn_phone";	 exit;*/	 if(($clmn_prom == -1) || ($clmn_phone == -1)|| ($clmn_date == -1)){		$_SESSION[SES_FLASH_MSG] = "<div class='error'> CSV File must have 'PROM','PHONE','DATE' as column header.</div>";		break;				 }else{		for ($c=0; $c < 1; $c++) {			$tot=$tot+1;	 			//echo 'i m in -'.$data[$clmn_prom];	       //Only run if the first column if not equal to name	       if(strtoupper(trim($data[$clmn_prom])) !='PROM'){	       	 	//echo 'AAA';		 		$crm_cust_prom	=$data[$clmn_prom];					$crm_cust_phone	=$data[$clmn_phone];				$crm_cust_date	=$data[$clmn_date];			 		if(is_gt_zero_num($crm_cust_phone)) {					if(is_not_empty($crm_cust_prom)){						$crm_pr_ml_userid=tbl_crm::get_crm_id_from_phone($crm_cust_phone);						$crm_cust_date_1=date('Y-m-d h:i:s',strtotime($crm_cust_date));							$isSuccess = $objcrm_prom_emails->create($crm_pr_ml_userid, $crm_cust_prom, 0, $crm_cust_date_1, '');						$is_complete=$is_complete+1;					}else{						if(strtoupper(trim($crm_cust_phone))!='PHONE')							$error[] = 'ROW-'.$tot.'] ..Invalid Phone -'.$crm_cust_phone;					}	  				} 		  }			  //$tot++;		}			}   }		fclose($handle);	if(is_gt_zero_num($is_complete)){		$_SESSION[SES_FLASH_MSG] = "<div class='success'> CSV File Imported, $is_complete records added </div>";	}		    }// end no error   unset($objcrm_prom_emails);}//close if isset upfile$err = capture_errors($error);if(is_not_empty($err)){	$_SESSION[SES_FLASH_MSG] =$err;}}	$rest_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);		$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$template = 'menu_import/csv_prom_import.tpl'; 				$smarty->assign('err', $err);	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);}							include_once('footer.php');?>