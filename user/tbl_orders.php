<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');//..These added since we need functions from the buss_list include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php'); include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_redim_cupons.class.php');  include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/functions.php');   include_once('header.php');global $emp_tables;//$_SESSION[SES_TABLE] = 1; if($sesslife==false){	    //..Force them to login	//$_SESSION['prev_page']='order';		//biz_script_forward($website.'/user/login.php');}else{	if(isCustomer()){		$_SESSION[SES_CUST_NM]=$Global_member['staff_phone'];	}}//..if this is online customer if(is_gt_zero_num($_SESSION[SES_ONLINE_STORE])){	 unset($_SESSION['qr_sess_expired']);}$active_page = 'tbl_orders'; $order_id 					= get_input('order_id');$order_table_id			= get_input('order_table_id');$order_emp_id				= get_input('order_emp_id',$_SESSION['guid']);$order_customer_id	= get_input('order_customer_id');$order_customer_name= get_input('order_customer_name');$order_customer_type= get_input(ORDER_CUSTOMER_TYPE);$order_note					= get_input('order_note');$order_tip 					= get_input('order_tip','');$order_created_on		= get_input('order_created_on');$order_completed_on	= get_input('order_completed_on');$order_status_id		= get_input('order_status_id',2);$order_manager_note	= get_input('order_manager_note','');  $report 						= strtoupper(get_input('report','all'));$sub_id 						= get_input('sub_id',0);$emp_id 						= get_input('emp_id',0);$keyword 						= get_input('keyword','');$cust_name 					= get_input('cust_name','');$pst_table_id 			= get_input('table_id',''); $srch_table_id 			= get_input('srch_table_id','');$booked 						= get_input('booked',0);$booked_orders 			= get_input('booked_orders','');//..variable for showing/hiding the notifications delete Button$notify_id 			= get_input('notify_id',0); //..Capture the order_live_expired$ord_live_only=get_input('ord_live_only',1);//..variable for the order item popup$sbmnu_dish_id=get_input('sbmnu_dish_id',0);$sequence_num = get_input('sequence_num',0);$add_proms = get_input('add_proms',0);//..if customer then set sub_id to zeroif(isCustomer()){ 	$sub_id = 0;}//..capture the only online orders for take out $ord_online =get_input('ord_online',0); //..Rolewise securityif(($Global_member['rl_fn_order_live']==1) && ($Global_member['rl_fn_order_expired']==1)){  //..Donot change the latestonly}else{   if($Global_member['rl_fn_order_live']==1){		$ord_live_only = 1;  }elseif($Global_member['rl_fn_order_expired']==1){		$ord_live_only = 0; 		  }else{  			if($sesslife==true){	  		$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['main']['not_allowed'].'</div>';			biz_script_forward($website);		}		  } }//..capture the input from the payment process$ord_pmnt_split_amng = get_input('ord_pmnt_split_amng',0);$payment_choice = get_input('payment_choice',''); $process_payment = get_input('process_payment','');$order_takeout_email = get_input('order_takeout_email','');$order_payment_id = get_input('order_payment_id',0); $order_amt_i_pay= get_input('order_amt_i_pay',0); //..capture fields for the kitchen sections only$kitchen_send = get_input('kitchen_send',0);$kitchen_messsage = get_input('kitchen_messsage','');$msg_to = get_input('msg_to','');$order_picked = get_input('order_picked',0);$order_delayed = get_input('order_delayed',0);$ord_delay_msg = get_input('ord_delay_msg','');if(is_not_empty($pst_table_id) == false){	$pst_table_id = get_input('pst_table_id',''); }if(is_not_empty($srch_bill_ammt) == false){	$srch_bill_ammt = get_input('srch_bill_ammt',''); }//..for getting current customer user TYPE if(is_gt_zero_num($_SESSION['guid']) || is_gt_zero_num($_SESSION[SES_COOKIE_UID])){  if(is_gt_zero_num($_SESSION['guid'])){		$customer_id = $_SESSION['guid'];		$customer_type = CUST_TYPE_LOGIN;	}else{		$customer_id = $_SESSION[SES_COOKIE_UID];		$customer_type = CUST_TYPE_COOKIE;	} }//echo "customer_id=$customer_id || customer_type=$customer_type";$order_session_id = get_input('order_session_id',0);//$pst_table_id = get_input('table_id','');//print_r($_SESSION);//exit; /*$start_date = get_input('start_date','');$end_date = get_input('end_date','');*///..Condition to show for only todays and yesterday bydefualt if($Global_member['member_role_id']==ROLE_ADMIN || $Global_member['member_role_id']==ROLE_OWNER){ 		$start_date = get_input('start_date',date('m/d/Y',strtotime("-1 day"))); 		$end_date = get_input('end_date',date('m/d/Y'));	 }else{ 		$start_date = get_input('start_date','');		$end_date = get_input('end_date',''); } $action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'order_id');$table_status = get_input('table_status',0);$check_paid = get_input('check_paid',0);$order_popup = get_input('order_popup',0);$cancel_update = get_input('cancel_update',0);$prom_claim = get_input('prom_claim','');$claim_promotions = get_input('claim_promotions');//..@1Aug2013#1 for customer filter$flt_cust = get_input(FILTER_BY_CUST,'');$flt_cust_prefs = get_input('flt_cust_prefs','');//..Exception added for the manager to see past records//if(($Global_member['member_role_id']==ROLE_MANAGER)&&(is_not_empty($flt_cust))){if((chk_preferance_allwd())&&(is_not_empty($flt_cust))){	$ord_live_only = 0;}if(is_not_empty($prom_claim)){	 if(is_not_empty($claim_promotions)){	 		if(pds_redim_cupons::claimPromotionForOrder($claim_promotions,$order_id)){		 				 		//..First add_ord_details_to_applied_tbl 				tbl_order_applied_proms::add_ord_details_to_applied_tbl($order_id);				//..Now call actual logic of apply promotion 				$returnSucc=@applyPromotionToOrder($order_id);				//..If success confirm claim				if(is_gt_zero_num($returnSucc)){					$retValue = 0;					$objorder = new tbl_orders();					if($objorder->readObject(array(ORDER_ID=>$order_id))){ 						$objorder->setorder_isclaimed_promotions(1);						$objorder->insert(); 					   						$retValue = 1;					}					unset($objorder);					if($retValue){						$_SESSION[SES_FLASH_MSG]  ='<div class="success">Successfully Applied.</div>';					}else{						$_SESSION[SES_FLASH_MSG]  ='<div class="error">Problem during applying promotion.</div>';					}						}else{					$_SESSION[SES_FLASH_MSG]  ='<div class="error">Sorry! one or more promotion could not be applied.</div>';				}			 				 		//$_SESSION[SES_FLASH_MSG] = '<div class="success">Promotion Claimed Successfully.</div>';		 	}else{		 		$_SESSION[SES_FLASH_MSG] = '<div class="error">Problem during claiming promotion.</div>';	 		}		 }else{	 	$_SESSION[SES_FLASH_MSG] = '<div class="error">Please select promotions to claim.</div>';	 } }  $sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort,'DESC');$sort_by = get_input(SORT_BY,'DESC');//..Assign order to employee$assign_order= get_input('assign_order','');$pst_order_id= get_input('pst_order_id',0);//..apply_discount section variables ..complimentary$pst_apply_discount= get_input('pst_apply_discount',0);$pst_ord_detail_id= get_input('pst_ord_detail_id',0);$pst_ord_detail_discount= get_input('pst_ord_detail_discount',0);$pst_itm_type_for_disc= get_input('pst_itm_type_for_disc','');//..START SAN Changes 14-02-2018//..switch order to main order$go_edit_ord = get_input('go_edit_ord',0);if(is_gt_zero_num($go_edit_ord) && is_gt_zero_num($order_id)){	//..Add from temporary to active	$_SESSION[SES_CART]=$_SESSION[SES_TEMP_CART];		$_SESSION[SES_ORDER_SEQUENCE]=$_SESSION[SES_TEMP_ORDER_SEQUENCE];	//..Clear temp cart			$_SESSION[SES_TEMP_CART] = array();	$_SESSION[SES_TEMP_ORDER_SEQUENCE] = NULL;	//..delete order from all tables..	tbl_orders::_delete_liked_data($order_id);	//..forward to menu	biz_script_forward($website.'/user/tbl_menu.php?is_preview=1');}//..switch order to main order$go_cancel_order = get_input('go_cancel_order',0);if(is_gt_zero_num($go_cancel_order) && is_gt_zero_num($order_id)){	//..Add from temporary to active	$_SESSION[SES_CART]= array();		$_SESSION[SES_ORDER_SEQUENCE]=NULL;	//..Clear temp cart			$_SESSION[SES_TEMP_CART] = array();	$_SESSION[SES_TEMP_ORDER_SEQUENCE] = NULL;	//..delete order from all tables..	tbl_orders::_delete_liked_data($order_id);	//..forward to menu	biz_script_forward($website.'/user/tbl_menu.php?is_preview=1');}//..Switch order to main order$switch_to_main = get_input('switch_to_main',0);if(is_gt_zero_num($switch_to_main) && is_gt_zero_num($order_id)){	tbl_orders::_switchFrTempToMain($order_id);	//..Empty the cart	$_SESSION[SES_TEMP_CART] = array();	$_SESSION[SES_TEMP_ORDER_SEQUENCE] = NULL;	$_SESSION[SES_CART] = array();	$_SESSION[SES_ORDER_SEQUENCE] = NULL;	//..now redeem rewards 	tbl_orders::_redeem_order_reward($order_id);	//..send alert messages 		$_ord_spc=tbl_orders::GetInfo($order_id);	//..send notification to manager	if($_ord_spc[ORDER_SESSION_ID]==0){		$_t_status=STS_ONLINE_ORDER_PLACED;		}else{		$_t_status=STS_ORDER_PLACED;		}		//..Send notification to mngr/kitchen	$_sub_ord_keys=array_keys($_ord_spc['sub_orders']);	if(is_not_empty($_sub_ord_keys)){		biz_send_status_notifications($_ord_spc[ORDER_TABLE_ID],$_ord_spc[ORDER_CUSTOMER_NAME],$_sub_ord_keys[0],$_t_status,$_ord_spc[ORDER_EMP_ID],$_ord_spc[ORDER_CUSTOMER_ID],$_ord_spc[ORDER_CUSTOMER_TYPE],1);	}	/*biz_send_status_notifications($_ord_spc[ORDER_TABLE_ID],$_ord_spc[ORDER_CUSTOMER_NAME],$order_id,$_t_status,$_ord_spc[ORDER_EMP_ID],$_ord_spc[ORDER_CUSTOMER_ID],$_ord_spc[ORDER_CUSTOMER_TYPE],1);	if(is_gt_zero_num($_ord_spc['sub_orders'][$order_id]['sub_order_id'])){		biz_send_status_notifications($_ord_spc[ORDER_TABLE_ID],$_ord_spc[ORDER_CUSTOMER_NAME],$_ord_spc['sub_orders'][$order_id]['sub_order_id'],$_t_status,$_ord_spc[ORDER_EMP_ID],$_ord_spc[ORDER_CUSTOMER_ID],$_ord_spc[ORDER_CUSTOMER_TYPE],1);	}*/	unset($_ord_spc);	unset($_t_status); 	$_SESSION[SES_FLASH_MSG]  ='<div class="success">Successfully submitted.</div>';}//..coding for the removing applied promotion$order_remove_apply_promotion = get_input('order_remove_apply_promotion',0);//$order_app_prom_id = get_input('order_app_prom_id',0);if(is_gt_zero_num($order_remove_apply_promotion) && is_gt_zero_num($order_id)){	$_ord_detls=tbl_orders::GetInfo($order_id);	if($_ord_detls[ORDER_ISCLAIMED_PROMOTIONS]==1){		//..if it has complete order discount applied				if(is_gt_zero_num($_ord_detls[ORDER_PROMOTION]) && is_gt_zero_num($_ord_detls[ORDER_PROM_DISCNT]) ){				DB::ExecNonQry("UPDATE `tbl_orders` SET `order_promotion`=0,`order_discount_id`=0,`order_discount_amt`=0,`order_isclaimed_promotions`=0 WHERE `order_id`={$order_id};");	 				}				//..Delete all coupons with that order id	 	DB::ExecNonQry("DELETE FROM `pds_redim_cupons` WHERE `order_id`={$order_id} ");	 	//..Delete all tbl_order_applied_proms with that order id	 		 	DB::ExecNonQry("DELETE FROM `tbl_order_applied_proms` WHERE `ord_dtl_order_id`={$order_id}");	 	//..Update the order_isclaimed_promotions to 0	 	DB::ExecNonQry("UPDATE `tbl_orders` SET `order_isclaimed_promotions`=0 WHERE `order_id`={$order_id};");	 	$_SESSION[SES_FLASH_MSG]  ='<div class="success">Successfully Removed Applied Promotion.</div>';	}else{		$_SESSION[SES_FLASH_MSG]  ='<div class="error">Sorry! No promotion applied.</div>';	}		unset($_ord_detls);}//..END SAN Changes 14-02-2018	//..logic to apply promotion to the ORDER$order_apply_promotion = get_input('order_apply_promotion',0);if(is_gt_zero_num($order_apply_promotion) && is_gt_zero_num($order_id)){	//..First add_ord_details_to_applied_tbl 	tbl_order_applied_proms::add_ord_details_to_applied_tbl($order_id);	//..Now call actual logic of apply promotion 	$returnSucc=@applyPromotionToOrder($order_id);	//..If success confirm claim	if(is_gt_zero_num($returnSucc)){		$retValue = 0;		$objorder = new tbl_orders();		if($objorder->readObject(array(ORDER_ID=>$order_id))){ 			$objorder->setorder_isclaimed_promotions(1);			$objorder->insert(); 		   //biz_send_alert($objorder->getorder_table_id(),$objorder->getorder_customer_name(),$objorder->getorder_id(),$_lang[TBL_ALERTS]['customer'][ALERT_CNF_CUPON],$objorder->getorder_customer_id(),CONFIRM_COUPON,$objorder->getorder_customer_type(),NULL,NULL,STS_PROM_CONFIRM); 			$retValue = 1;		}		unset($objorder);		if($retValue){			$_SESSION[SES_FLASH_MSG]  ='<div class="success">Successfully Applied.</div>';		}else{			$_SESSION[SES_FLASH_MSG]  ='<div class="error">Problem during applying promotion.</div>';		}			}else{		$_SESSION[SES_FLASH_MSG]  ='<div class="error">Sorry! one or more promotion could not be applied.</div>';	}}$employees = tbl_staff::GetActiveEmployees();$diningtables = tbl_dining_table::GetActiveDiningTables();//..Get the sub menu dish list only for search		$tbl_submenu_disheslist = tbl_submenu_dishes::getAllSubMnuDishes();	$result_found=1;$tbl_sub_menulist = tbl_sub_menu::readArray(array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on,SUBMNU_MENU=>$submnu_menu),$result_found,1);//..for discount we need different types of discount$discount_lst=tbl_discounts::readArray(array('discount_restaurent'=>$_SESSION[SES_RESTAURANT],'isActive'=>1));//..logic for the check paid status//if(($check_paid==1)&&($order_id>0)){if(is_gt_zero_num($order_id)){	//..Please Update Table Status 	$objtbl_orders= new tbl_orders();	$tbl_ordersinfo= $objtbl_orders->GetInfo($order_id);	//print_r($tbl_ordersinfo);		//..Apply discount logic goes here 	//..these are complimentary discounts	if(is_gt_zero_num($pst_apply_discount) && is_gt_zero_num($pst_ord_detail_id) && is_gt_zero_num($pst_ord_detail_discount) && (is_not_empty($pst_itm_type_for_disc))){		//echo "im in.. $pst_ord_detail_id,$pst_apply_discount,$pst_ord_detail_discount,$pst_itm_type_for_disc";		if($pst_itm_type_for_disc=='SUBMENUDISH'){			//..if it is submenu dish item			$objtbl_order_details= new tbl_order_details();			$objtbl_order_details->addDiscountToOrder($pst_ord_detail_id,$pst_ord_detail_discount);			unset($objtbl_order_details);		}else{			//..if it is submenu dish option item			$objtbl_order_details_options= new tbl_order_details_options();			$objtbl_order_details_options->addDiscountToDetailOption($pst_ord_detail_id,$pst_ord_detail_discount);			unset($objtbl_order_details_options);		}				$_SESSION[SES_FLASH_MSG]='<div class="success">'.$_lang['tbl_discounts']['APPLY']['SUCCESS_MSG'].'</div>';  	}    //..logic for the payment processing	//echo "$process_payment,$payment_choice,$ord_pmnt_split_amng";	$tbl_cust_sess_id = tbl_table_customer_session::GetCurrentActiveCustSession($tbl_ordersinfo['order_table_id']);			//..First time pay process	if(is_not_empty($process_payment)&&($process_payment=='yes')){	//echo "order_amt_i_pay=$order_amt_i_pay"; 	//..if order_payment_id is created 	if(is_gt_zero_num($order_payment_id)){		//..Amount you are paying should not be 0			if(is_gt_zero_num($order_amt_i_pay)){			$objtbl_order_payment=new tbl_order_payment();  		 	$resl= $objtbl_order_payment->updateOrderPayment($order_payment_id,$customer_id, $order_amt_i_pay,$tbl_cust_sess_id,$order_id,$customer_type);			unset($objtbl_order_payment);			if($resl){ 				//..START..SAN ..13/02/2018				//..logic to add order to payment				add_reward_points_on_order($tbl_ordersinfo);				//..START..SAN ..13/02/2018				$_SESSION[SES_FLASH_MSG]='<div class="success">Payment sucessfull</div>'; 				unset($objtbl_table_status_link);			}					}			}else{ 					    //..first time devide the tip in all orders				if(strtoupper($payment_choice)=='INDIVIDUAL'){		 tbl_orders::applyOrderTipToAllOrders($order_id,$order_tip,1);		}else{			tbl_orders::applyOrderTipToAllOrders($order_id,$order_tip);		}			  //..if order payment is not created			if($tbl_ordersinfo['order_status_id']!=TBL_STATUS_CHECK){			$objtbl_order_payment=new tbl_order_payment();			$objtbl_table_status_link=new tbl_table_status_link();			//..order payment for indidual			if(strtoupper($payment_choice)=='INDIVIDUAL'){				$ord_pmnt_order=$order_id;				 				//..update the order email 				if(($tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_TAKE_OUT || $tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_DELIVERY) && (is_gt_zero_num($tbl_cust_sess_id)==false)){							if(is_not_empty($order_takeout_email)){								if($objtbl_orders->readObject(array(ORDER_ID=>$order_id))){									$objtbl_orders->setorder_takeout_email($order_takeout_email);									$objtbl_orders->insert();								}							}             		}else{					 	//..Update the order status to check paid		        	$objtbl_orders->update_ord_sts($order_id,TBL_STATUS_CHECK); 				}												 //..Get the table session orders 			  if(($tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_TAKE_OUT || $tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_DELIVERY) && (is_gt_zero_num($tbl_cust_sess_id)==false)){					$tb_sess_ords=tbl_orders::getOrdGrAmtBySession(0,$order_id);						  }else{					$tb_sess_ords=tbl_orders::getOrdGrAmtBySession($tbl_cust_sess_id);						  }        		 				$ord_amnt=$tb_sess_ords['total'];//..Order amount				$ord_pmnt_bill_amnt=$tb_sess_ords['orders'][$order_id];							    //..Create the payment order record		       //$isSuccess = $objtbl_order_payment->create($tbl_cust_sess_id, $order_id, $ord_amnt, $Global_member['member_id'], $payment_choice, $ord_pmnt_split_amng, $Global_member['member_id'] , $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL);						//change@7Aug2013#1						//$isSuccess = $objtbl_order_payment->create($tbl_cust_sess_id, $order_id, $ord_amnt, $tbl_ordersinfo[ORDER_CUSTOMER_ID], $payment_choice, $ord_pmnt_split_amng, $tbl_ordersinfo[ORDER_CUSTOMER_ID] , $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL,$tbl_ordersinfo[ORDER_CUSTOMER_TYPE],$tbl_ordersinfo[ORDER_CUSTOMER_TYPE]);						$isSuccess = $objtbl_order_payment->create($tbl_cust_sess_id, $order_id, $ord_pmnt_split_amng, $tbl_ordersinfo[ORDER_CUSTOMER_ID], $payment_choice, $ord_pmnt_split_amng, $tbl_ordersinfo[ORDER_CUSTOMER_ID] , $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL,$tbl_ordersinfo[ORDER_CUSTOMER_TYPE],$tbl_ordersinfo[ORDER_CUSTOMER_TYPE]);         //..Check if all orders are paid ..and settable stataus to check-paid				//..once again call the same above function				//..Get the table session orders 				//print_r($tb_sess_ords);								//.. rewrad point				/*add_reward_points_on_order($tbl_ordersinfo[ORDER_RESTAURANT],$tbl_ordersinfo[ORDER_CUSTOMER_ID],$tbl_ordersinfo[ORDER_TABLE_ID],$ord_amnt,$_rest_multiplier);*/				 							if(is_gt_zero_num($tb_sess_ords['is_all_paid'])){                    $isSuccess = $objtbl_table_status_link->create($tbl_ordersinfo['order_table_id'], $tbl_ordersinfo['order_customer_name'], TBL_STATUS_CHECK, $tbl_ordersinfo['order_emp_id'],$tbl_cust_sess_id, date(DATE_FORMAT), NULL);                                    }                //..Alert manager about the check paid				alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_CHK_OUT);				 			}elseif(strtoupper($payment_choice)=='SINGLE'){                //..Get the table session orders                $tb_sess_ords=tbl_orders::getOrdGrAmtBySession($tbl_cust_sess_id);                //..fetch the order ids from above                $ord_keys=array_filter(array_keys($tb_sess_ords['orders']));				if(is_not_empty($ord_keys)){					$ord_pmnt_order=implode(",",$ord_keys);				}				$ord_amnt=$tb_sess_ords['total']; //..order amount				$ord_pmnt_bill_amnt=$ord_amnt; //..pay amount				//..create the payment order record				$isSuccess = $objtbl_order_payment->create($tbl_cust_sess_id, $ord_pmnt_order, $ord_amnt, $Global_member['member_id'], $payment_choice, 1, $Global_member['member_id'], $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL);								//..update all the orders from table session status to check paid				$isSuccess = tbl_orders::updateAllTblSessOrdChkPaid($tbl_cust_sess_id);								/*add_reward_points_on_order($tbl_ordersinfo[ORDER_RESTAURANT],$tbl_ordersinfo[ORDER_CUSTOMER_ID],$tbl_ordersinfo[ORDER_TABLE_ID],$ord_amnt,$_rest_multiplier);*/								//..Set table stataus to check-paid				$isSuccess = $objtbl_table_status_link->create($tbl_ordersinfo['order_table_id'], $tbl_ordersinfo['order_customer_name'], TBL_STATUS_CHECK, $tbl_ordersinfo['order_emp_id'],$tbl_cust_sess_id, date(DATE_FORMAT), NULL);                               //..alert manager about the check paid				alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_CHK_OUT);			}else{				//..for split payment method           //..get the table session orders          $tb_sess_ords	=	tbl_orders::getOrdGrAmtBySession($tbl_cust_sess_id);          //..fetch the order ids from above          $ord_keys	=	array_filter(array_keys($tb_sess_ords['orders']));												if(is_not_empty($ord_keys)){					$ord_pmnt_order=implode(",",$ord_keys);				}				$ord_amnt	=	$tb_sess_ords['total'];  //..order amount				$ord_pmnt_bill_amnt	=	($tb_sess_ords['total']/$ord_pmnt_split_amng);				//..pay amount								//..create the payment order record				$isSuccess = $objtbl_order_payment->create($tbl_cust_sess_id, $ord_pmnt_order, $ord_amnt, $Global_member['member_id'], $payment_choice, $ord_pmnt_split_amng, $Global_member['member_id'], $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL);                //..alert manager about the check paid				alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_CHK_OUT);							}						//print_r($tb_sess_ords);			//print_r($ord_keys);			//echo("$tbl_cust_sess_id, $ord_pmnt_order, $ord_pmnt_bill_amnt, ".$Global_member['member_id'].", $payment_choice, $ord_pmnt_split_amng,".$Global_member['member_id'].", $ord_pmnt_bill_amnt, Date(DATE_FOMAT), NULL");						//..START..SAN ..13/02/2018			//..logic to add order to payment			add_reward_points_on_order($tbl_ordersinfo);			//..START..SAN ..13/02/2018						//$_SESSION[SES_FLASH_MSG] ='Payment sucessfull';			$_SESSION[SES_FLASH_MSG]  = '<div class="success">Payment sucessfull</div>'; 		}else{			//$_SESSION[SES_FLASH_MSG] ='Payment for this order is already done';			$_SESSION[SES_FLASH_MSG] = '<div class="info">Payment for this order is already done</div>'; 		}		unset($objtbl_table_status_link);		unset($objtbl_order_payment);	 }	}		if($check_paid==1){		//$tbl_cust_sess_id = tbl_table_customer_session::GetCurrentActiveCustSession($tbl_ordersinfo['order_table_id']);			//..update the order status to check paid	$objtbl_orders->update_ord_sts($order_id,TBL_STATUS_CHECK);		//..Change the table status to check paid			//..for that Add record to table to table status link table with "check" status 	$objtbl_table_status_link=new tbl_table_status_link();	$isSuccess = $objtbl_table_status_link->create($tbl_ordersinfo['order_table_id'], $tbl_ordersinfo['order_customer_name'], TBL_STATUS_CHECK, $tbl_ordersinfo['order_emp_id'],$tbl_cust_sess_id, date(DATE_FORMAT), NULL);	 	unset($objtbl_table_status_link); 	unset($objtbl_orders); 	unset($tbl_cust_sess_id);					 //alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_CHK_OUT);	$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang[TBL_ALERTS]['customer'][ALERT_CHK_OUT].'</div>'; 	}					}//..Functionalities for order by kitchenif(is_gt_zero_num($order_id) && ($Global_member['member_role_id'] == ROLE_KITCHEN || $Global_member['member_role_id'] == ROLE_BAR) ){	//..order picked 	$objtbl_orders= new tbl_orders();	if($order_picked==1){	 		$objtbl_orders->update_ord_sts($order_id,TBL_STATUS_ORDER_PICKED); 		//alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_ORDER_PICKED);	}		//..order delayed 	if(($order_delayed==1) && (is_not_empty($ord_delay_msg))){		  		/*$objtbl_orders->update_ord_sts($order_id,TBL_STATUS_ORDER_DELAYED);*/		$objsub_order = new tbl_sub_orders();	  	//$objsub_order->update_status($sub_id,TBL_STATUS_ORDER_DELAYED);	 	$objsub_order->update_status($sub_id,STS_ORDER_GOING_TO_DELAY);		if(is_gt_zero_num($tbl_ordersinfo['order_emp_id'])){			 biz_send_alert($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$sub_id,$ord_delay_msg, $tbl_ordersinfo['order_emp_id'],ALERT_SUB_ORDER,CUST_TYPE_LOGIN,NULL,NULL,ALERT_ORDER);		} 		 //..change@17Aug2013#1 <---		 // biz_send_alert($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,$ord_delay_msg,ALERT_FOR_MANGER,ALERT_ORDER);		 //..change@17Aug2013#1 --->				/*alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,ALERT_ORDER_PICKED);*/	}	unset($objtbl_orders);	//..Send message by kitchenif(($kitchen_send==1) && (is_not_empty($kitchen_messsage)) &&($msg_to !="") ){	   	$objsub_order = new tbl_sub_orders();	  $objsub_order->update_status($sub_id,STS_ORDER_GOING_TO_DELAY);				if($msg_to=='server'){			 	biz_send_alert($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,$kitchen_messsage, $tbl_ordersinfo['order_emp_id'],ALERT_ORDER);		}elseif($msg_to=='manager'){		 		biz_send_alert($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,$kitchen_messsage,ALERT_FOR_MANGER,ALERT_ORDER);		}	//alertToManager($tbl_ordersinfo['order_table_id'],$tbl_ordersinfo['order_customer_name'],$order_id,$kitchen_messsage);		}	}if(is_not_empty($tbl_ordersinfo)){	unset($tbl_ordersinfo); }/**disabled @3Aug2013	if($cancel_update==1){	if(is_not_empty($_SESSION[SES_ORDER_UDP]))		unset($_SESSION[SES_ORDER_UDP]);}*/	 if(($assign_order=='assign_order') && ($pst_order_id>0) && ($Global_member['member_role_id'] == ROLE_WAITER)){		$objtbl_orders= new tbl_orders();	$objtbl_orders->assign_emp($pst_order_id,$Global_member['member_id']);	unset($objtbl_orders);}$lst_booked_orders='';if(is_gt_zero_num($booked)){		//..fetch only pending and update that		//..$report='BOOKED_ORDERS';	$lst_booked_orders=tbl_orders::getMyBookedOrders();		if(is_not_empty($lst_booked_orders) && is_gt_zero_num($_SESSION[SES_TABLE]) && is_not_empty($_SESSION[SES_CUST_NM])){		tbl_orders::addTableSessToMyBookedOrders();			}}//$url = $website.'/user/tbl_orders.php'; $url = $website.'/user/tbl_orders.php?ord_live_only='.$ord_live_only.'&ord_online='.$ord_online;$navigationURL = $url.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by.'&report='.$report;$isSuccess = '';$objtbl_orders= new tbl_orders();if(is_gt_zero_num($order_emp_id) && ($_SESSION['member_role_id'] == ROLE_WAITER) ){  	$obj = new tbl_employee_last_request();  	$res = $obj->chkEmplyoeeOrder($_SESSION['guid'],$lastEmpOrder);  	unset($res);}  	if(is_not_empty($action)){		switch($action){			case ACTION_CREATE: 				$isSuccess = $objtbl_orders->create($order_table_id, $order_emp_id, $order_customer_id, $order_customer_name, $order_note, $order_created_on, $order_completed_on, $order_status_id,$order_manager_note);				//..Please Update Table Status				/*@alertToManager();*/				/*				//..add record to table to status record				$objtbl_table_status_link=new tbl_table_status_link();				$isSuccess = @$objtbl_table_status_link->create($order_table_id, $order_customer_id, 2, $order_emp_id, date(DATE_FORMAT), NULL);				*/							break;			case ACTION_UPDATE: 				$isSuccess = $objtbl_orders->update($order_id, $order_table_id, $order_emp_id, $order_customer_id, $order_customer_name, $order_note, $order_created_on, $order_completed_on, $order_status_id,$order_manager_note);				break;			case ACTION_DELETE: 				$isSuccess = $objtbl_orders->delete(array(ORDER_ID=>$order_id));				break;			case ACTION_ACTIVATE: 				$isSuccess = $objtbl_orders->activate($order_id);				break;			case ACTION_DEACTIVATE: 				$isSuccess = $objtbl_orders->deactivate($order_id);				break;		}//..switch	}//..if	if(is_not_empty($isSuccess)){		if(is_gt_zero_num($isSuccess)){			$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_orders'][$action]['SUCCESS_MSG'].'</div>';		}elseif($isSuccess == OPERATION_FAIL){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_orders'][$action]['FAILURE_MSG'].'</div>';		}elseif($isSuccess == OPERATION_DUPLICATE){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_orders'][$action]['DUPLICATE_MSG'].'</div>';		}	}	//..if	$result_found=0;	 	$search_array = array();	$navigation_array = array();	 	$search_route = 0;	//..Based on the order posted show their list	if($Global_member['member_role_id'] == ROLE_CUSTOMER){		$search_array = array(ORDER_TABLE_ID => $_SESSION[SES_TABLE],ORDER_CUSTOMER_ID=>$Global_member['member_id'],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);			}elseif($Global_member['member_role_id'] == ROLE_WAITER){		//..ORDER_EMP_ID=>$Global_member['member_id'],		$search_array = array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);	}elseif($Global_member['member_role_id'] == ROLE_KITCHEN || $Global_member['member_role_id'] == ROLE_BAR){		//..DOn't show the orders which are not attached to table session		//$search_array = array('isTempAllowed'=>0,'isConfirmedOnly'=>1, 'route'=>ROLE_KITCHEN,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);		$search_array = array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);					if(is_gt_zero_num($ord_online)==FALSE){				$search_array['isConfirmedOnly']= 1;				$search_array['isTempAllowed']=0 ;		}		$search_route = $Global_member['member_role_id'];	 		}else{				$search_array = array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);	}  $search_text="";			  $search_array[ORDER_RESTAURANT] = $_SESSION[SES_RESTAURANT]; 	  //..Date wise report  if(is_not_empty($start_date) && is_not_empty($end_date)){  	$search_array['created_on_start'] 		= $start_date;  	$search_array['created_on_end'] 		= $end_date; 		$navigationURL .='&start_date='.$start_date.'&end_date='.$end_date;		$search_text .= 'Date range: '.$start_date.'-'.$end_date.'|&nbsp;';  }     //..Employee wise report  if(is_gt_zero_num($emp_id)){  	$usr_detail=get_user($emp_id);  	$search_array[ORDER_EMP_ID]		= $emp_id;		//$navigationURL .='&'.ORDER_EMP_ID.'='.$emp_id;		$navigationURL .='&emp_id='.$emp_id;		$search_text .= 'Server: '.$usr_detail['full_name'].'|&nbsp;';  }else{  	if($Global_member['member_role_id']==1){		$usr_detail=get_user($Global_member['member_id']);		$search_array[ORDER_EMP_ID]	 	 = $Global_member['member_id']; 		$navigationURL .='&emp_id='.$Global_member['member_id'];		$search_text .= 'Server: '.$usr_detail['full_name'].'|&nbsp;';	}  }    //..Table wise report  if(is_gt_zero_num($srch_table_id)){		$table_info=tbl_dining_table::GetInfo($srch_table_id);  	$search_array[ORDER_TABLE_ID]= $srch_table_id;  		$navigationURL .='&srch_table_id='.$srch_table_id;		$search_text .= 'Table: '.$table_info['table_number'].'|&nbsp;';  }		//..Table wise report  if(is_gt_zero_num($pst_table_id)){		$table_info=tbl_dining_table::GetInfo($pst_table_id);  	$search_array[ORDER_TABLE_ID]= $pst_table_id;  		$navigationURL .='&'.ORDER_TABLE_ID.'='.$pst_table_id;		$search_text .= 'Table: '.$table_info['table_number'].'|&nbsp;';  }    //..Search based on the bill amount	//echo "srch_bill_ammt=$srch_bill_ammt";	  if(is_not_empty($srch_bill_ammt)){	  	switch ($srch_bill_ammt) {		case 1:		   $disp_txt='$0-$20';		   break;		case 2:		   $disp_txt='$20-$40';		   break;		case 3:		   $disp_txt='$40-$60';		   break;		case 4:		   $disp_txt='$60-$80';		   break;		case 5:		   $disp_txt='$80-$100';		   break;		case 6:		   $disp_txt='$100-$1000';		   break;	}		//echo "disp_txt=$disp_txt";  	$search_array['srch_bill_ammt']= $srch_bill_ammt;  		$navigationURL .='&srch_bill_ammt='.$srch_bill_ammt;		$search_text .= 'Amount: '.$disp_txt.'|&nbsp;';  }    if(is_gt_zero_num($order_session_id)){  	$search_array[ORDER_SESSION_ID]= $order_session_id;  		$navigationURL .='&'.ORDER_SESSION_ID.'='.$order_session_id;	//$search_text .= "Session: {$order_session_id}|&nbsp;";  }    if(is_not_empty($keyword)){  	$search_array['keyword']= $keyword;  		$navigationURL .='&keyword='.$keyword;			$search_text .='Menu Item: '.$tbl_submenu_disheslist[$keyword].'|&nbsp;';  }    if(is_not_empty($cust_name)){  		$search_array[ORDER_CUSTOMER_NAME]= $cust_name;  		$navigationURL .='&cust_name='.$cust_name;		$search_text .= 'Customer: '.$cust_name.'|&nbsp;';  }		if(is_not_empty($ord_online)){ 		$search_array['online_orders']= $ord_online;  		//$navigationURL .='&online_orders='.$ord_online;	} 	     //...Booked orders only  if(is_gt_zero_num($booked)){  	if(!is_not_empty($lst_booked_orders)){		$lst_booked_orders=0;	}	$search_array['booked']= 1;	$search_array['lst_booked_orders']= $lst_booked_orders;  	$navigationURL .='&booked=1&booked_orders='.$lst_booked_orders;  }      if($_SESSION['member_role_id'] == ROLE_MANAGER || $_SESSION['member_role_id'] == ROLE_EXPEDITOR || $_SESSION['member_role_id'] == ROLE_WAITER || $_SESSION['member_role_id'] == ROLE_KITCHEN || $_SESSION['member_role_id'] == ROLE_OWNER || $_SESSION['member_role_id'] == ROLE_ADMIN || $_SESSION['member_role_id']== ROLE_BAR ){     }else{   	//$search_array[ORDER_CUSTOMER_NAME] = $_SESSION['user'];   }  //..If the online store session is true then allow temp /*  if(is_gt_zero_num($_SESSION['SES_ONLINE_STORE']))  	$search_array['isTempAllowed'] = 1; else	  	$search_array['isTempAllowed'] = 0; */  		$search_array['ord_live_only'] = $ord_live_only;	//..Fetch records by filter 	$search_array[REPORT]= $report; 		if(is_gt_zero_num($_SESSION[SES_ONLINE_STORE])==false){		//.to convert online takeout orders 		tbl_orders::addTableSessToMyBookedOrders(); 	 	}	$smarty->assign('flt_cust_prefs','');		if($sesslife==true){			}else{ 	   		//if(is_gt_zero_num($_SESSION[SES_TABLE])){			//..Here we need to consider the online customer as well	 		if(is_gt_zero_num($_SESSION[SES_TABLE]) || is_gt_zero_num($_SESSION[SES_ONLINE_STORE])){			 			if(is_not_empty($_SESSION[SES_CUST_NM])){				if(is_gt_zero_num($_SESSION[SES_ONLINE_STORE])){					$search_array[ORDER_SESSION_ID] =0;					$search_array['online_orders'] =1;				}else{					 					$search_array[ORDER_SESSION_ID] = checkNcreateSession($_SESSION[SES_TABLE],$_SESSION[SES_CUST_NM]);									}									$search_array[ORDER_CUSTOMER_NAME] = $_SESSION[SES_CUST_NM];						if(is_gt_zero_num($_SESSION[SES_COOKIE_UID])){					$search_array[ORDER_CUSTOMER_ID] = $_SESSION[SES_COOKIE_UID];					$search_array[ORDER_CUSTOMER_TYPE] = CUST_TYPE_COOKIE;				}							}else{				$ask_cust_name = 1;			} 		}else{			biz_script_forward($website.'/user/dashboard.php');		} 	}				//if($Global_member['member_role_id']==ROLE_MANAGER){	if(chk_preferance_allwd()){		if(is_not_empty($flt_cust)){						$search_array[ORDER_CUSTOMER_NAME] =$flt_cust;			if(is_not_empty($order_customer_type)){				$search_array[ORDER_CUSTOMER_TYPE] =$order_customer_type; 				$navigationURL .='&'.ORDER_CUSTOMER_TYPE.'='.$order_customer_type;			}						/*			Needs to be uncommneted			if(is_gt_zero_num($order_customer_id)){				$search_array[ORDER_CUSTOMER_ID] =$order_customer_id; 				$navigationURL .='&'.ORDER_CUSTOMER_ID.'='.$order_customer_id;			}			*/ 			$navigationURL .='&'.FILTER_BY_CUST.'='.$flt_cust;			$smarty->assign('flt_cust',$flt_cust);										$smarty->assign('flt_cust_type',$order_customer_type); 			$smarty->assign('flt_cust_id',$order_customer_id);			if(is_not_empty($flt_cust_prefs)){				$search_array['order_note_not_empty'] =1;				$smarty->assign('flt_cust_prefs',$flt_cust_prefs);				$smarty->assign('tb_sts_lnk_tab','preferences');			}else{								$smarty->assign('tb_sts_lnk_tab','order');			}			 					}	}  	if(is_gt_zero_num($ask_cust_name)){		$smarty->assign('ask_cust_name',$ask_cust_name);		$info = array();			}else{				$search_array[order_is_tmp]=0;		$info = $objtbl_orders->readArray($search_array,$result_found,1);	}// print_r($search_array);// exit;  	$tbl_orderslist = array(); 	$sub_order_found = 0;	foreach($info as $order){		$cur_sub_order_count = 0;		$tbl_orderslist[$order['order_id']] = tbl_orders::GetInfo($order['order_id'],0,array('route'=>$search_route),$cur_sub_order_count);		$sub_order_found = $sub_order_found + $cur_sub_order_count;	}  	 	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',		$allpageCount);	$smarty->assign('currentPage',		$currentPage);	$smarty->assign('tbl_orderslist', $tbl_orderslist);	$smarty->assign('result_found',$result_found);	$smarty->assign('sub_order_found',$sub_order_found);	$template = 'tbl_orders/grid.tpl';		//print_r($_SESSION[SES_CART]);	/*disabled @3Aug2013	 unset($_SESSION[SES_ORDER_UDP]);	 */	 unset($_SESSION[SES_ORDER_UDP]);	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($order_id)){						if(is_gt_zero_num($sbmnu_dish_id)){				$objtbl_submenu_dishes=new tbl_submenu_dishes();				$tbl_submenu_dishesinfo= $objtbl_submenu_dishes->GetInfo($sbmnu_dish_id);				//$tbl_submenu_dishesinfo['optionsPrice'] = tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForDish($sbmnu_dish_id,$tbl_submenu_dishesinfo['sbmnu_dish_dish']);								$dish_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForDish($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_DISH],1); 			 $submenu_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForSubmenu($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_SUBMENU],1);  	$tbl_submenu_dishesinfo['optionsPrice'] = array_merge($dish_option_prices,$submenu_option_prices); 																$smarty->assign('tbl_submenu_dishesinfo',$tbl_submenu_dishesinfo); 				$smarty->assign('sbmnu_dish_id',$sbmnu_dish_id);				$smarty->assign('sequence_num',$sequence_num);				 //print_r($tbl_submenu_dishesinfo);					unset($objtbl_submenu_dishes);			}			$tbl_ordersinfo= $objtbl_orders->GetInfo($order_id,$sub_id);		 	$isAllSubOrderConfirmed = tbl_sub_orders::chkAllSubOrderConfirmed($order_id);			$smarty->assign('isAllSubOrderConfirmed',$isAllSubOrderConfirmed);					//..Get the cust and order session			$cust_sess_id = checkNcreateSession($tbl_ordersinfo['order_table_id'], $tbl_ordersinfo['order_customer_name']);			 			//..needs to change code here			$CustSessionLastOrder = tbl_orders::getCustSessionLastOrder($cust_sess_id);						$_SESSION[CUST_LAST_ORDER]=$CustSessionLastOrder;			 			$smarty->assign('CustSessionLastOrder',$CustSessionLastOrder);						 //print_r($tbl_ordersinfo);			//..get all orders of the current session			$all_ses_ord_dtl =  tbl_orders::getAllOrderDetailBySession($tbl_ordersinfo[ORDER_SESSION_ID]);			$smarty->assign('all_ses_ord_dtl',$all_ses_ord_dtl);			//print_r($all_ses_ord_dtl);						/*if(($check_paid==1)&&($CustSessionLastOrder==$tbl_ordersinfo['order_id'])){				//..Change the table sattus to check paid							//..Add record to table to table status link table with "check" status 			 	$objtbl_table_status_link=new tbl_table_status_link();				$isSuccess = $objtbl_table_status_link->create($tbl_ordersinfo['order_table_id'], $tbl_ordersinfo['order_customer_name'], TBL_STATUS_CHECK, $tbl_ordersinfo['order_emp_id'],$cust_sess_id, date(DATE_FORMAT), NULL);										}*/						//..Add order details to session first time Only ..						if(is_not_empty($tbl_ordersinfo['order_details'])){				$ord_detail=$tbl_ordersinfo['order_details'];			   			/*	disabled @3Aug2013 */        if($order_popup==1){			if(is_not_empty($_SESSION[SES_ORDER_UDP]['order_info']['order_id']) && ($_SESSION[SES_ORDER_UDP]['order_info']['order_id']==$tbl_ordersinfo['order_id'])){				  				}else{				 				if($tbl_ordersinfo['order_status_id'] != TBL_STATUS_CHECK){					unset($_SESSION[SES_ORDER_UDP]);					$ord_info = array();					$ord_info['order_id']=$tbl_ordersinfo['order_id'];					$ord_info['order_customer_name']=$tbl_ordersinfo['order_customer_name'];					$ord_info['order_table_id']=$tbl_ordersinfo['order_table_id'];					$ord_info['order_note']=$tbl_ordersinfo['order_note'];					$_SESSION[SES_ORDER_UDP]['order_info']=$ord_info;					unset($ord_info);					foreach($ord_detail as $kydish_cart=>$dish_cart){ 					  $info = array();						$info['title']=$dish_cart['title'];						$info['qty']=$dish_cart['ord_dtl_quantity'];						$info['price']=$dish_cart['ord_dtl_price'];						$_SESSION[SES_ORDER_UDP][$kydish_cart][SES_SUB_MENU_DISH][$dish_cart[ord_dtl_sbmenu_dish_id]] = $info;					 						unset($info);						$dish_info = array();						 //print_r($dish_cart['opt_val_details']);						if(is_not_empty($dish_cart['opt_val_details'])){							foreach($dish_cart['opt_val_details'] as $key_sbmndsh=>$val_sbmndsh){											// $dish_info[$key_sbmndsh] = $val_sbmndsh; 		 								$dish_info[$val_sbmndsh['ord_det_opt_optionvalue']]['type']= $val_sbmndsh['opt_type'];								$dish_info[$val_sbmndsh['ord_det_opt_optionvalue']]['qty']= $val_sbmndsh['ord_det_opt_qty'];								$dish_info[$val_sbmndsh['ord_det_opt_optionvalue']]['price']= $val_sbmndsh['ord_det_opt_price'];								$dish_info[$val_sbmndsh['ord_det_opt_optionvalue']]['title']=$val_sbmndsh['opt_value'];																			}							$_SESSION[SES_ORDER_UDP][$kydish_cart][SES_SUB_MENU_DISH][$dish_cart[ord_dtl_sbmenu_dish_id]][SES_DISH_OPTION_VALUE]= $dish_info;								 						}												unset($dish_info);						}				 }															}				$smarty->assign('order_popup',$order_popup);				}						}									//print_r($_SESSION[SES_ORDER_UDP]);			//..add promotion_id			 $tbl_ordersinfo['coupons']=getClaimedCouponsForOrder($order_id); 			//$payment_options=tbl_order_payment::readArray(array(ORD_PMNT_TABLE_SESS=>$cust_sess_id,ORD_PMNT_ORDER=>$order_id));			 		  if(is_gt_zero_num($cust_sess_id) || is_gt_zero_num($order_id)){				 $search_cond = array(); 				 if(is_gt_zero_num($cust_sess_id)){				 		$search_cond[ORD_PMNT_TABLE_SESS]= $cust_sess_id;			 	 				 }elseif(is_gt_zero_num($order_id)){				 		$search_cond[ORD_PMNT_ORDER]= $order_id;				 }				 				 $payment_options=tbl_order_payment::readArray($search_cond);			} 		 			//..get payment options from the tbl_order_payment      if(is_not_empty($payment_options)){        $payment_options = array_shift($payment_options);        $tbl_ordersinfo['payment_options']= $payment_options;      }			//..Show the payment options form or not			//..Show Amount to pay 			$show_opt_bx=0;			$can_pay_amt=0;				$am_i_in_chk_paid=0;					//..Get the table session orders			//exception for online order without table session@7Aug2013#1  			if(($tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_TAKE_OUT || $tbl_ordersinfo[ORDER_TYPE] == ORDER_TYPE_DELIVERY) && (is_gt_zero_num($cust_sess_id)==false) || ($payment_options['ord_pmnt_option'] == 'INDIVIDUAL')){				$tb_sess_ords=tbl_orders::getOrdGrAmtBySession(0,$order_id);						}else{				$tb_sess_ords=tbl_orders::getOrdGrAmtBySession($cust_sess_id);						}			 //print_r($tb_sess_ords);     		   			//$tbl_ordersinfo['all_bill_amnt']=$tb_sess_ords['total']; 			$tbl_ordersinfo['bill_amnt']=$tb_sess_ords['total'];			$tbl_ordersinfo['tax_amnt']=$tb_sess_ords['tax_amt'];			$tbl_ordersinfo['tip_amnt']=$tb_sess_ords['tip_amt'];			$tbl_ordersinfo['misc_charge']=$tb_sess_ords['misc_charge'];			$tbl_ordersinfo['all_bill_amnt']=$tb_sess_ords['gr_amt'];			$tbl_ordersinfo['curr_bill_amnt']=$tb_sess_ords['orders'][$order_id];			$tbl_ordersinfo['orders_count']= count($tb_sess_ords['orders']); 			//print_r($tbl_ordersinfo['curr_bill_amnt']);	 			 //print_r($tbl_ordersinfo); 			if(is_not_empty($payment_options)){        //$payment_options =array_shift($payment_options);				//..Check if i am in the list of amount paid				if(is_not_empty($payment_options["ord_pmnt_paid_by"])){					$lst_paid_by=biz_explode(',',$payment_options["ord_pmnt_paid_by"]); 										if(in_array($customer_id,$lst_paid_by)){						$am_i_in_chk_paid=1;					}					$how_many_sec_paid=0;					foreach($lst_paid_by as $_eachpaid) {						 if($_eachpaid==$customer_id){						 		$am_i_in_chk_paid=1;								$how_many_sec_paid++;						 }					}									}									if($Global_member['member_role_id']!=ROLE_CUSTOMER){					$show_opt_bx=1;				}else{			//..If created by same user then only show			//..$payment_options["ord_pmnt_created_by"]=$Global_member['member_id']					if($am_i_in_chk_paid==1){						$show_opt_bx=1;					}					}								 				if($payment_options["ord_pmnt_option"]=='INDIVIDUAL'){									if($tbl_ordersinfo['order_status_id']!=TBL_STATUS_CHECK){						if(($am_i_in_chk_paid==0)||($Global_member['member_role_id']==ROLE_MANAGER ||($Global_member['member_role_id']==ROLE_EXPEDITOR)|| $Global_member['member_role_id']==ROLE_WAITER)){							$can_pay_amt=$tb_sess_ords['orders'][$order_id];						}											}				}else{            //echo floatval($payment_options["ord_pmnt_bill_amnt"])."/".floatval($payment_options["ord_pmnt_amnt_paid"]);															if(floatval($payment_options['ord_pmnt_bill_amnt']) > floatval($payment_options['ord_pmnt_amnt_paid'])){                                     //if($am_i_in_chk_paid==0){							if(($am_i_in_chk_paid==0)||($Global_member['member_role_id']==ROLE_MANAGER ||($Global_member['member_role_id']==ROLE_EXPEDITOR) || $Global_member['member_role_id']==ROLE_WAITER)){							if($payment_options["ord_pmnt_option"]=='SINGLE'){								//$can_pay_amt=$payment_options["ord_pmnt_bill_amnt"];								$can_pay_amt=0;								$show_opt_bx=1;							}else{                //echo $payment_options["ord_pmnt_bill_amnt"]."/".$payment_options["ord_pmnt_split_amng"];								$can_pay_amt=(floatval($payment_options["ord_pmnt_bill_amnt"])/floatval($payment_options["ord_pmnt_split_amng"]));							}						}													}									}								/*if(is_not_empty($payment_options['ord_pmnt_paid_by']) && is_not_empty($payment_options[ORD_PMNT_PAID_TYPE])){					 				}*/								$tbl_ordersinfo['bill_paid_by']=GetMembersFromIDs($payment_options['ord_pmnt_paid_by'],$payment_options[ORD_PMNT_PAID_TYPE]); 			   				//.. code for fetching the paypal_transactions 				$rst_found = 0;			 	$tbl_ordersinfo['translist'] = tbl_ord_paypal_trans::readArray(array(PAYPAL_PAYMENT_ID=>$payment_options[ORD_PMNT_ID]),$rst_found);			  //print_r($tbl_ordersinfo['translist']);			 	$tbl_ordersinfo['trans_count'] = $rst_found;			 	unset($rst_found);					 			}else{  			 		$show_opt_bx=1;					$can_pay_amt=1;  			}						$tbl_cust_sess_id = tbl_table_customer_session::GetCurrentActiveCustSession($tbl_ordersinfo['order_table_id']);			 //..if only the current ssession not match the order session then disable the values at any case			if($tbl_ordersinfo[ORDER_SESSION_ID]!=$tbl_cust_sess_id){ 			 		$show_opt_bx=0;					$can_pay_amt=0; 			}			 			$tbl_ordersinfo['show_opt_bx']=$show_opt_bx;			$tbl_ordersinfo['can_pay_amt']=$can_pay_amt;			$tbl_ordersinfo['am_i_in_chk_paid']=$am_i_in_chk_paid;			$tbl_ordersinfo['how_many_sec_paid']=$how_many_sec_paid;			if(is_not_empty($lst_paid_by)){				$tbl_ordersinfo['paid_member_cnt']=count($lst_paid_by);			}else{				$tbl_ordersinfo['paid_member_cnt']=0;				}						$tbl_ordersinfo['is_all_paid']= $tb_sess_ords['is_all_paid'];			$tbl_ordersinfo['is_all_suborder_confirmed'] = tbl_sub_orders::chkAllSubOrderConfirmed($order_id);     //print_r($tb_sess_ords);				     //print_r($tbl_ordersinfo);					 //..  			$smarty->assign('tbl_ordersinfo',$tbl_ordersinfo);			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}			$template = 'tbl_orders/view.tpl';		}elseif($mode == MODE_CREATE){			$template = 'tbl_orders/create.tpl';		}	}				$smarty->assign('tiplist',tbl_tip::GetFields(array('key_field'=>TIP_ID,'value_field'=>TIP_PERCENT,'isActive'=>1)));		//..Grid click link	$gr_clk_navigationURL=modify_navigattion_url($navigationURL);		$smarty->assign('gr_clk_navigationURL',$gr_clk_navigationURL);		$availtables = tbl_table_customer_session::getLiveSessTables();	//print_r($availtables);	$smarty->assign('availtables',$availtables);	$smarty->assign('sub_id',$sub_id);	$smarty->assign('tbl_submenu_disheslist',$tbl_submenu_disheslist); 	$smarty->assign('employees',$employees);  $smarty->assign('diningtables',$diningtables);	$smarty->assign('report',strtolower($report));	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('emp_id',$emp_id);	$smarty->assign('pst_table_id',$pst_table_id);	$smarty->assign('srch_bill_ammt',$srch_bill_ammt);		$smarty->assign('ord_online',$ord_online);	$smarty->assign('ord_live_only',$ord_live_only);	$smarty->assign('search_text',$search_text);		$smarty->assign('start_date',$start_date);	$smarty->assign('end_date',$end_date);	$smarty->assign('cust_name',$cust_name);	$smarty->assign('keyword',$keyword);	$smarty->assign('srch_table_id',$srch_table_id);			$smarty->assign('notify_id',$notify_id);	$smarty->assign('add_proms',$add_proms);			 	$smarty->assign('discount_lst',$discount_lst); 	 	if(is_gt_zero_num($table_status)){	 		$breadcrumbs[] =array(   							'link'=>$website.'/user/tbl_table_status_link.php?latestOnly=1',							'title'=>$_lang['tbl_table_status_link']['listing_title']); 		if(is_gt_zero_num($pst_table_id)){		 		//$table_info = tbl_dining_table::GetInfo($pst_table_id);		if(is_gt_zero_num($order_session_id)){						$breadcrumbs[] =array(   							'link'=>$website.'/user/tbl_table_status_link.php?customer_session_id='.$order_session_id.'&pst_table_id='.$pst_table_id,							'title'=>$table_info['number']							);									}else{			 			$breadcrumbs[] =array(   							'link'=>$website.'/user/tbl_table_status_link.php?latestOnly=0&todays_request=1&pst_table_id='.$pst_table_id,							'title'=>$table_info['number']							);		}			$smarty->assign('table_info',$table_info);		}								$smarty->assign('tb_sts_lnk_tab','order'); 					}else{/*		$breadcrumbs[0] =array(   							'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']);*/	}		$breadcrumbs[] = array(						 	'link'=>$url.'&table_id='.$pst_table_id.'&table_status='.$table_status.'&order_session_id='.$order_session_id,							'title'=>$_lang['tbl_orders']['listing_title']);   				if($tbl_ordersinfo){		$breadcrumbs[] = array(						 	'link'=>$url.'&table_id='.$pst_table_id.'&table_status='.$table_status.'&mode=VIEW&order_id='.$tbl_ordersinfo['order_id'].'&order_session_id='.$order_session_id.((is_gt_zero_num($sub_id)?'&sub_id='.$sub_id:'')),							'title'=>$_lang['tbl_orders']['title'].getModeSubTitle('ID-'.$tbl_ordersinfo['order_id'].((is_gt_zero_num($sub_id)?'/'.$sub_id:'')),1) 							); 	}	//.. for filter customer clear all the bread crumbs and add only the filt customers breadcrumb;	if(is_not_empty($flt_cust)){		if(isset($breadcrumbs)) unset($breadcrumbs);		$tmp_url = $website.'/user/tbl_orders.php?'.FILTER_BY_CUST.'='.$flt_cust;		if(is_not_empty($order_customer_type)){			 $tmp_url .='&'.ORDER_CUSTOMER_TYPE.'='.$order_customer_type;			}						if(is_gt_zero_num($order_customer_id)){			 	$tmp_url .='&'.ORDER_CUSTOMER_ID.'='.$order_customer_id;			} 				$breadcrumbs[] = array(						 	'link'=>$tmp_url,							'title'=>'"'.strtoupper($flt_cust).'" - '.$_lang['tbl_orders']['listing_title']							); 	   unset($tmp_url);							}			/*}else{	$template='index.tpl';}*///print_r($tbl_ordersinfo); //print_r($_SERVER); //print_r($_SESSION);//exit;include_once('footer.php');?>