<?phpinclude_once(dirname(dirname(__FILE__))."/init.php");include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');include_once("header.php");$active_page = "crm_prom_emails";if($sesslife==true){$crm_pr_ml_id= get_input("crm_pr_ml_id");$crm_pr_ml_userid= get_input("crm_pr_ml_userid");$crm_pr_ml_promotion= get_input("crm_pr_ml_promotion");$flg_send= get_input("flg_send");$start_date= get_input("start_date");$end_date= get_input("end_date");$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,"crm_pr_ml_id");//..fields for search$search_from_dt= get_input("search_from_dt",'');$search_to_dt= get_input("search_to_dt",'');$search_prom= get_input("search_prom",0);$do_search= get_input("do_search",0);$filt_text=array();$sort_by=$new_sort="";biz_set_sorting_var($sort_by,$new_sort);$sort_by="DESC";$url = "{$website}/user/crm_prom_emails.php";$navigationURL = $url."?".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}";$isSuccess = "";$objcrm_prom_emails= new crm_prom_emails();if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 			$isSuccess = $objcrm_prom_emails->create($crm_pr_ml_userid, $crm_pr_ml_promotion, $flg_send, $start_date, $end_date);			break;		case ACTION_UPDATE: 			$isSuccess = $objcrm_prom_emails->update($crm_pr_ml_id, $crm_pr_ml_userid, $crm_pr_ml_promotion, $flg_send, $start_date, $end_date);			break;		case ACTION_DELETE: 			$isSuccess = $objcrm_prom_emails->delete(array(CRM_PR_ML_ID=>$crm_pr_ml_id));			break;		case ACTION_ACTIVATE: 			$isSuccess = $objcrm_prom_emails->activate($crm_pr_ml_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objcrm_prom_emails->deactivate($crm_pr_ml_id);			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$err .= "<div class='info'>".$_lang['crm_prom_emails'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$err .= "<div class='error'>".$_lang['crm_prom_emails'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$err .= "<div class='error'>".$_lang['crm_prom_emails'][$action]['DUPLICATE_MSG']."</div>";	}}//..if	$result_found=0;	$arr_filter=array(FLG_SEND=>1,'prm_restaurent'=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);	//..filter criteria	if(is_not_empty($search_from_dt) && is_not_empty($search_to_dt)){			$arr_filter['search_from_dt']=$search_from_dt;			$arr_filter['search_to_dt']=$search_to_dt;			$filt_text[]="Date range:{$search_from_dt}-{$search_to_dt}";	}	if(is_gt_zero_num($search_prom)){			$arr_filter['search_prom']=$search_prom;			$prom_info=pds_list_promotions::GetPromotionDetail($search_prom);			$filt_text[]="Promotion:".$prom_info["title"];	}			//$tbl_qrcode_loglist = $objtbl_qrcode_log->readArray($arr_filter,$result_found,1);		$crm_prom_emailslist = $objcrm_prom_emails->readArray($arr_filter,$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array("url"=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,"count"=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('crm_prom_emailslist', $crm_prom_emailslist);	$smarty->assign('result_found',$result_found);	$template = "crm_prom_emails/grid.tpl";	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($crm_pr_ml_id)){			$crm_prom_emailsinfo= $objcrm_prom_emails->GetInfo($crm_pr_ml_id);			$smarty->assign('crm_prom_emailsinfo',$crm_prom_emailsinfo);			if($mode==MODE_UPDATE){				$smarty->assign("isUpdate",1);			}			$template = "crm_prom_emails/view.tpl";		}elseif($mode == MODE_CREATE){			$template = "crm_prom_emails/create.tpl";					}}	$breadcrumbs[] = array(				 	'link'=>$website.'/modules/business_listing/promotionslisting.php?show_type=PR',				  'title'=>$_lang['main']['pref_mng_cntrols']['mng_proms']					); 	$breadcrumbs[] = array(				 	'link'=>$website.'/user/crm_prom_emails.php',					'title'=>$_lang['crm_prom_emails']['listing_title']);							//..Get the listing of active promotions	$lst_promotion = pds_list_promotions::GetPromotions(1);	$smarty->assign('lst_promotion',$lst_promotion);		$smarty->assign('search_from_dt',$search_from_dt);	$smarty->assign('search_to_dt',$search_to_dt);	$smarty->assign('search_prom',$search_prom);				if(is_not_empty($filt_text)){		$smarty->assign('filt_text',implode('|',array_unique($filt_text)));			}			$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);}else{	$template="index.tpl";}include_once("footer.php");?>