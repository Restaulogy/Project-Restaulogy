<?phpinclude_once(dirname(dirname(__FILE__))."/init.php");include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');include_once("header.php");$active_page = "biz_rewards";if($sesslife==true){$rwd_id= get_input("rwd_id");$rwd_buss_id= get_input("rwd_buss_id",$_SESSION[SES_RESTAURANT]);$rwd_cup_id= get_input("rwd_cup_id",'');$rwd_type= get_input("rwd_type",'point_based');$rwd_one_point_val= get_input("rwd_one_point_val",1);$rwd_point_limit= get_input("rwd_point_limit",1);$rwd_basic= get_input("rwd_basic");$rwd_total_balance= get_input("rwd_total_balance",'total');$rwd_lr_type= get_input("rwd_lr_type",'b');$rwd_is_reduction= get_input("rwd_is_reduction",0);$rwd_is_recurring= get_input("rwd_is_recurring",0);$rwd_is_one_time= get_input("rwd_is_one_time",0);$rwd_check_in= get_input("rwd_check_in",0);$rwd_is_quest_asc= get_input("rwd_is_quest_asc",0);$rwd_coupon_id= get_input("rwd_coupon_id");$rwd_is_non_ending= get_input("rwd_is_non_ending",0);$rwd_loyalty_level= get_input("rwd_loyalty_level",0);$rwd_start_dt= get_input("rwd_start_dt");$rwd_end_dt= get_input("rwd_end_dt");$rwd_created_dt= get_input("rwd_created_dt");$rwd_updated_dt= get_input("rwd_updated_dt");$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,"rwd_id");$sort_by=$new_sort="";biz_set_sorting_var($sort_by,$new_sort);$url = "{$website}/user/biz_rewards.php";$navigationURL = $url."?".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}";$isSuccess = "";$sel_biz_rewards= get_input('sel_biz_rewards');$lst_sel_ids='';if(is_not_empty($sel_biz_rewards)){		$lst_sel_ids=biz_implode(',', array_keys($sel_biz_rewards));} //..get the lst of the groups$_lylty_levels_lst=tbl_loyalty_level::GetFields(array('isActive'=>1,'key_field'=>LOYLEV_ID,'value_field'=>LOYLEV_LEVEL,LOYLEV_RESTAURANT=>$_SESSION[SES_RESTAURANT]));	$objbiz_rewards= new biz_rewards();if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 			if($rwd_lr_type=='b'){				$rwd_is_reduction=1;				$rwd_is_recurring=1;				$rwd_is_one_time=1;			}elseif($rwd_lr_type=='rm'){				$rwd_is_reduction=0;				$rwd_is_recurring=1;				$rwd_is_one_time=1;			}			/*if(is_not_empty($rwd_end_dt)==false){				$rwd_end_dt=date(DATE_FORMAT,strtotime("+1 day"));			}*/			if($rwd_loyalty_level=='all'){				foreach($_lylty_levels_lst as $_ky => $_val){					$isSuccess = $objbiz_rewards->create($_SESSION[SES_RESTAURANT], $rwd_cup_id, $rwd_type, $rwd_one_point_val, $rwd_point_limit, $rwd_basic, $rwd_total_balance, $rwd_lr_type, $rwd_is_reduction, $rwd_is_recurring, $rwd_is_one_time, $rwd_check_in, $rwd_is_quest_asc, $rwd_coupon_id, $rwd_start_dt, $rwd_end_dt, $rwd_created_dt, $rwd_updated_dt,$rwd_is_non_ending,$_ky);				}			}else{				$isSuccess = $objbiz_rewards->create($_SESSION[SES_RESTAURANT], $rwd_cup_id, $rwd_type, $rwd_one_point_val, $rwd_point_limit, $rwd_basic, $rwd_total_balance, $rwd_lr_type, $rwd_is_reduction, $rwd_is_recurring, $rwd_is_one_time, $rwd_check_in, $rwd_is_quest_asc, $rwd_coupon_id, $rwd_start_dt, $rwd_end_dt, $rwd_created_dt, $rwd_updated_dt,$rwd_is_non_ending,$rwd_loyalty_level);			}						break;		case ACTION_UPDATE: 			if($rwd_lr_type=='b'){				$rwd_is_reduction=1;				$rwd_is_recurring=1;				$rwd_is_one_time=1;			}elseif($rwd_lr_type=='rm'){				$rwd_is_reduction=0;				$rwd_is_recurring=1;				$rwd_is_one_time=1;			}			$isSuccess = $objbiz_rewards->update($rwd_id, $_SESSION[SES_RESTAURANT], $rwd_cup_id, $rwd_type, $rwd_one_point_val, $rwd_point_limit, $rwd_basic, $rwd_total_balance, $rwd_lr_type, $rwd_is_reduction, $rwd_is_recurring, $rwd_is_one_time, $rwd_check_in, $rwd_is_quest_asc, $rwd_coupon_id, $rwd_start_dt, $rwd_end_dt, $rwd_created_dt, $rwd_updated_dt,$rwd_is_non_ending,$rwd_loyalty_level);			break;		case ACTION_DELETE: 			//$isSuccess = $objbiz_rewards->delete(array(RWD_ID=>$rwd_id));			if(is_not_empty($lst_sel_ids)){							$isSuccess = $objbiz_rewards->delete(array(RWD_ID=>$lst_sel_ids));			}else{				$isSuccess = $objbiz_rewards->delete(array(RWD_ID=>$rwd_id));			}					break;		case ACTION_ACTIVATE: 			if(is_not_empty($lst_sel_ids)){							$isSuccess = $objbiz_rewards->activate($lst_sel_ids);			}else{				$isSuccess = $objbiz_rewards->activate($rwd_id);			}					//$isSuccess = $objbiz_rewards->activate($rwd_id);			break;		case ACTION_DEACTIVATE: 			//$isSuccess = $objbiz_rewards->deactivate($rwd_id);			if(is_not_empty($lst_sel_ids)){							$isSuccess = $objbiz_rewards->deactivate($lst_sel_ids);			}else{				$isSuccess = $objbiz_rewards->deactivate($rwd_id);			}			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$err .= "<div class='info'>".$_lang['biz_rewards'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$err .= "<div class='error'>".$_lang['biz_rewards'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$err .= "<div class='error'>".$_lang['biz_rewards'][$action]['DUPLICATE_MSG']."</div>";	}}//..if	$result_found=0;	$biz_rewardslist = $objbiz_rewards->readArray(array(RWD_BUSS_ID=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array("url"=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,"count"=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('biz_rewardslist', $biz_rewardslist);	$smarty->assign('result_found',$result_found);	$template = "biz_rewards/biz_rewards.tpl";		$breadcrumbs[] = array(				 	'link'=>$website.'/user/pref_mng_cntrols.php',					'title'=>$_lang['main']['pref_mng_cntrls']);  $breadcrumbs[] =array(				 	'link'=>$url,					'title'=>$_lang['biz_rewards']['listing_title']);	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($rwd_id)){			$biz_rewardsinfo= $objbiz_rewards->GetInfo($rwd_id);			$smarty->assign('biz_rewardsinfo',$biz_rewardsinfo);			if($mode==MODE_UPDATE){				$smarty->assign("isUpdate",1);			}			$template = "biz_rewards/view.tpl";		}elseif($mode == MODE_CREATE){			$template = "biz_rewards/create.tpl";		}}		//..Get the listing of active promotions	$lst_rewards = array(); 	if($res = mysql_query('SELECT `id`,`title` FROM `'.PDS_LIST_PROMOTIONS.'` WHERE `prm_restaurent`='.$_SESSION[SES_RESTAURANT].' AND (`cupon_type`="reward" OR `cupon_type`="refer_friend") AND `end_date`>=CURDATE() ORDER BY id DESC;')){		$x = 0;		while($row = mysql_fetch_assoc($res)){			$lst_rewards[$row['id']] = $row['title']; 			$x++;		}	}		$smarty->assign('_lylty_levels_lst',$_lylty_levels_lst);	//$lst_rewards = pds_list_promotions::GetRewards(1);	$smarty->assign('lst_rewards',$lst_rewards);			$smarty->assign('lst_rwd_lr_type', biz_rewards::get_lst_rwd_lr_type());	$smarty->assign('lst_rwd_total_balance', biz_rewards::get_lst_rwd_total_balance());		$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);}else{	$template="index.tpl";}include_once("footer.php");?>