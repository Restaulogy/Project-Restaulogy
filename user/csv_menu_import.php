<?phpini_set('max_execution_time', 0); include_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'csv_menu_import';$restaurant_id = $_SESSION[SES_RESTAURANT];	//..if you are not logged in and restaurant id is not present	if(($sesslife==false)|| (is_gt_zero_num($restaurant_id)==false)){	echo "<div class='error'> Access denied. </div>";}else{	$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,10);$sort_on = get_input(SORT_ON,'crm_id');$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/csv_menu_import.php';$navigationURL = $url.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';$upfile= get_input('upfile','');if($mode == 'CSV_IMPORT'){ if(is_not_empty($upfile)){	// check feilds are not empty	if(pathinfo($_FILES["uploaded"]["name"], PATHINFO_EXTENSION)!= 'csv')	{		$error[] = 'Only CSV files accepted!';	}	 	if (!$error){	 	$tot = 0;	$handle = fopen($_FILES["uploaded"]["tmp_name"], "r");	//$clmn_srno=-1;	$clmn_menu=-1;	$clmn_submenu=-1;	$clmn_dish_nm=-1;	$clmn_dish_desc=-1;	$clmn_dish_price=-1;	$is_complete=0;		 //...Constants for the Menu	$menu_route= 5;	$menu_category=2; //lunch		$menu_image ='';	$mnu_wkdy_sunday=$mnu_wkdy_monday=$mnu_wkdy_tuesday=$mnu_wkdy_wednesday=$mnu_wkdy_thursday=$mnu_wkdy_friday=$mnu_wkdy_saturday='Y';	$mnu_wkdy_sunday_start= '00:00:00';	$mnu_wkdy_sunday_end= '23:59:00';	$mnu_wkdy_monday_start= '00:00:00';	$mnu_wkdy_monday_end= '23:59:00';	$mnu_wkdy_tuesday_start= '00:00:00';	$mnu_wkdy_tuesday_end= '23:59:00';	$mnu_wkdy_wednesday_start= '00:00:00';	$mnu_wkdy_wednesday_end= '23:59:00';	$mnu_wkdy_thursday_start= '00:00:00';	$mnu_wkdy_thursday_end= '23:59:00';	$mnu_wkdy_friday_start= '00:00:00';	$mnu_wkdy_friday_end= '23:59:00';	$mnu_wkdy_saturday_start= '00:00:00';	$mnu_wkdy_saturday_end= '23:59:00';	//..submenu	$submnu_spl_note ='';	$submnu_start_date=''; 	$submnu_end_date='';	$submnu_image='';		//..Dish variables..	$dish_id= '';	$dish_name= get_sql_input('dish_name');	$dish_restaurent = $_SESSION[SES_RESTAURANT];	$dish_chef_notes= '';	$dish_ingrad_allergic_contents= '';	$dish_is_nutrition_text= '';//0	$dish_nutri_cal_info= '';	$dish_food_wine_pair= array();	/*$dish_food_wine_pair_f= get_input('dish_food_wine_pair_f',array());	$dish_food_wine_pair_d= get_input('dish_food_wine_pair_d',array());	$dish_food_wine_pair=array_merge($dish_food_wine_pair_f,$dish_food_wine_pair_d);*/	$dish_pair_note= '';	$dish_notes= '';	$dish_winery= '';	$dish_type_cat= 0;	$dish_alcohol_percent= 0;	$dish_vintage= '';	$dish_varietal= '';	$dish_region= '';	$dish_country= '';	$dish_bottle_price= '';	$dish_glass_price= '';	$dish_winemaking= '';	$dish_maturity= '';	$dish_is_drink= 0;	$dish_attributes= '';	if(is_not_empty($dish_attributes)){		$dish_attributes=implode(',',$dish_attributes);		}	$dish_food_notes= '';	if(is_not_empty($dish_food_notes)){		$dish_food_notes=implode(',',$dish_food_notes);		}	$dish_allergy= '';	if(is_not_empty($dish_allergy)){		$dish_allergy=implode(',',$dish_allergy);		}	$dish_ethor_mnu_itm_id= '';	$dish_ethor_mnu_itm_img= '';	$dish_start_date= '';	$dish_end_date= '';	$nutr_id= '';	$nutr_dish_id= '';	$nutr_total_cal= 0;	$nutr_cal_from_fat= 0;	$nutr_total_fat= 0;	$nutr_saturated_fat= 0;	$nutr_trans_fat= 0;	$nutr_cholestrol= 0;	$nutr_sodium= 0;	$nutr_total_carbohydrate= 0;	$nutr_sugar= 0;	$nutr_dietary_fiber= 0;	$nutr_protein= 0;	$nutr_start_date= '';	$nutr_end_date= '';			//..Create object	$objtbl_menu= new tbl_menu();		$objtbl_mnu_weekdays= new tbl_mnu_weekdays();	$objtbl_sub_menu= new tbl_sub_menu();	$objtbl_submenu_dishes= new tbl_submenu_dishes();	$objtbl_dishes= new tbl_dishes();	$objtbl_nutrition=new tbl_nutrition();		$menu_display_order=0;		$submnu_display_order=0;		$_curr_menu=0;	$_curr_submenu=0;	$_curr_dish=0;	$_curr_submenu_dish=0;	$_curr_dish_price=0;		while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {	 //..get firsttime only field	 if($tot==0){		for ($columns=0; $columns < count($data); $columns++) {			if(strtoupper(trim($data[$columns]))=='MENU'){				$clmn_menu=$columns;			}elseif(strtoupper(trim($data[$columns]))=='SUB MENU'){				$clmn_submenu=$columns;			}elseif(strtoupper(trim($data[$columns]))=='DISH NAME'){				$clmn_dish_nm=$columns;			}elseif(strtoupper(trim($data[$columns]))=='DISH DESCRIPTION'){				$clmn_dish_desc=$columns;			}elseif(strtoupper(trim($data[$columns]))=='DISH PRICE'){				$clmn_dish_price=$columns;			}elseif(strtoupper(trim($data[$columns]))=='IS DRINK'){				$clmn_dish_is_drink=$columns;			}		}	 }							 if(($clmn_menu == -1) || ($clmn_submenu == -1) || ($clmn_dish_nm == -1)|| ($clmn_dish_desc == -1)|| ($clmn_dish_price == -1)){			$error[] = "<div class='error'> CSV File must have 'MENU','SUB MENU','DISH NAME','DISH DESCRIPTION','DISH PRICE' as column header.</div>";			break;				 }else{				for ($c=0; $c < 1; $c++) {		$tot=$tot+1;				         //Only run if the first column if not equal to MENU        if(strtoupper(trim($data[$clmn_menu])) !='MENU'){		 			 		$tbfl_menu			=	$data[$clmn_menu];	 		$tbfl_submenu		=	$data[$clmn_submenu];	 		$tbfl_dish_nm		=	$data[$clmn_dish_nm];	 		$tbfl_dish_desc		=	$data[$clmn_dish_desc];	 		$tbfl_dish_price	=	$data[$clmn_dish_price];	 		$tbfl_dish_is_drink	=	$data[$clmn_dish_is_drink];	 		/*$_curr_menu=0;	 		$_curr_submenu=0;	 		$_curr_dish=0;	 		$_curr_submenu_dish=0;	 		$_curr_dish_price=0;*/	 		$isSuccess = '';	 			 		/*$error[] = 'ROW-'.$tot.'] ...'.$tbfl_menu.'-'.$tbfl_submenu.'-'.$tbfl_dish_nm.'-'.$tbfl_dish_desc.'-'.$tbfl_dish_price;*/	 			 		//..Add menu 	 		if(is_not_empty($tbfl_menu)){	 			$submnu_display_order=0;				$menu_display_order=$menu_display_order+1;				$menu_desc = $tbfl_menu;									$isSuccess = $objtbl_menu->create(mysql_real_escape_string($tbfl_menu), $menu_category, mysql_real_escape_string($menu_desc), $menu_image, '', '', $restaurant_id, $menu_route, $menu_display_order,'');				if($isSuccess>0){					$_curr_menu = $isSuccess;										$isSuccess =$objtbl_mnu_weekdays->create($_curr_menu ,$mnu_wkdy_sunday ,$mnu_wkdy_monday ,$mnu_wkdy_tuesday ,$mnu_wkdy_wednesday ,$mnu_wkdy_thursday ,$mnu_wkdy_friday ,$mnu_wkdy_saturday,$mnu_wkdy_sunday_start, $mnu_wkdy_sunday_end, $mnu_wkdy_monday_start, $mnu_wkdy_monday_end, $mnu_wkdy_tuesday_start, $mnu_wkdy_tuesday_end, $mnu_wkdy_wednesday_start, $mnu_wkdy_wednesday_end, $mnu_wkdy_thursday_start, $mnu_wkdy_thursday_end, $mnu_wkdy_friday_start, $mnu_wkdy_friday_end, $mnu_wkdy_saturday_start, $mnu_wkdy_saturday_end);				}							}			//..Add submenu			if(is_not_empty($tbfl_submenu) && is_gt_zero_num($_curr_menu)){				$sbmnu_dish_display_order=0;				$submnu_display_order=$submnu_display_order+1;				$isSuccess = '';				$submnu_description=$tbfl_submenu;									$isSuccess = $objtbl_sub_menu->create($tbfl_submenu, $_curr_menu, $submnu_display_order, $submnu_description, $submnu_spl_note, $submnu_start_date, $submnu_end_date,$submnu_image);				if(is_gt_zero_num($isSuccess))					$_curr_submenu = $isSuccess;								}						//..Add Dish			if(is_not_empty($tbfl_dish_nm) && is_gt_zero_num($_curr_submenu) ){					$isSuccess = '';					$dish_chef_notes= mysql_real_escape_string($tbfl_dish_desc);				$dish_is_drink=$tbfl_dish_is_drink;				if($dish_is_drink==1){					$dish_winery= $dish_chef_notes;					$dish_bottle_price=$tbfl_dish_price;				}				$isSuccess = $objtbl_dishes->create(mysql_real_escape_string($tbfl_dish_nm),$dish_chef_notes, $dish_ingrad_allergic_contents, $dish_nutri_cal_info, $dish_notes, $dish_img, $dish_winery, $dish_type_cat, $dish_alcohol_percent, $dish_vintage, $dish_varietal, $dish_region, $dish_country, $dish_bottle_price, $dish_glass_price, $dish_winemaking, $dish_maturity,$dish_is_drink, $dish_restaurent,$dish_allergy,$dish_food_wine_pair,$dish_attributes,$dish_pair_note,$dish_is_nutrition_text,$dish_food_notes,$dish_ethor_mnu_itm_id,$dish_ethor_mnu_itm_img);				$_curr_dish = $isSuccess;				if(is_gt_zero_num($isSuccess) && $dish_is_nutrition_text==0){						$isSuccess = $objtbl_nutrition->create($isSuccess, $nutr_total_cal, $nutr_cal_from_fat, $nutr_total_fat, $nutr_saturated_fat, $nutr_trans_fat, $nutr_cholestrol, $nutr_sodium, $nutr_total_carbohydrate, $nutr_sugar, $nutr_dietary_fiber, $nutr_protein, $nutr_start_date, $nutr_end_date);								}												}			//..Add submenu dishes						$isSuccess = '';			if(is_not_empty($_curr_submenu) && is_gt_zero_num($_curr_dish) && is_numeric($tbfl_dish_price)){				$sbmnu_dish_display_order=$sbmnu_dish_display_order+1;				$sbmnu_dish_desc='';				$isSuccess = $objtbl_submenu_dishes->create($_curr_submenu, $_curr_dish, $tbfl_dish_price, $sbmnu_dish_display_order, mysql_real_escape_string($sbmnu_dish_desc), '', '');				$_curr_submenu_dish = $isSuccess;							}			if(is_gt_zero_num($isSuccess)){				$is_complete = $is_complete+1;				$error[] = 'ROW-'.$tot.'] ..Imported successfully.';			}else{				$error[] = 'ROW-'.$tot.']-['.$tbfl_dish_nm.'] - ERROR - [Adding dish to database] .'.$_curr_submenu .'-'. $_curr_dish.'-'. $tbfl_dish_price.'-'. $sbmnu_dish_display_order;			}			/*			//..Add Dish options			if(is_not_empty($tbfl_dish_opt) && is_gt_zero_num($_curr_dish)){				$objtbl_dish_options= new tbl_dish_options();				$isSuccess = $objtbl_dish_options->create($dish_opt_dish_id, $dish_opt_name, $dish_opt_type, $dish_opt_submenu,$dish_opt_mandotory);				unset($objtbl_dish_options);			}			//..Add Dish option values			if(is_not_empty($tbfl_dish_opt_val) && is_gt_zero_num($_curr_dish)){				$objtbl_dish_options_values= new tbl_dish_options_values();				$isSuccess = $objtbl_dish_options_values->create($dish_opt_val_option_id, $dish_opt_val_value,$dish_opt_val_ethor_variant);	 			unset($objtbl_dish_options_values);  			} 			*/			         }	 		 //$tot++;	  }		}		  }	fclose($handle);		//..Destroy allocated object resources.	unset($objtbl_menu);	unset($objtbl_mnu_weekdays);	unset($objtbl_sub_menu);	unset($objtbl_dishes);	unset($objtbl_nutrition);	unset($objtbl_submenu_dishes);		if(is_gt_zero_num($is_complete)){			$error[] = "<div class='success'> CSV File Imported, {$is_complete} records added </div>";	}		   }// end no error  }//close if isset upfile$err = capture_errors($error);/*if(is_not_empty($err)){	$_SESSION[SES_FLASH_MSG] =$err;}*/}	$rest_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);		$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$template = 'menu_import/csv_import.tpl'; 				$smarty->assign('err', $err);	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);}							include_once('footer.php');?>