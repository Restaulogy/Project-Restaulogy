<?phpinclude_once(dirname(dirname(__FILE__))."/init.php");include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');include_once("header.php");$active_page = "tbl_cust_filter_email";if($sesslife==true){$cfe_id= get_input("cfe_id");$cfe_filter= get_input("cfe_filter");$cfe_value= get_input("cfe_value",'');$cfe_promotion= get_input("cfe_promotion");$cfe_reward= get_input("cfe_reward",0);$cfe_mesasge= get_input("cfe_mesasge",'');$cfe_email_or_sms= get_input("cfe_email_or_sms");$cfe_period_start= get_input("cfe_period_start");$cfe_period_end= get_input("cfe_period_end");$cfe_restaurant= get_input("cfe_restaurant",$_SESSION[SES_RESTAURANT]);$cfe_start_date= get_input("cfe_start_date");$cfe_end_date= get_input("cfe_end_date");$prom_id						= get_input('prom_id',0);$sms_msg						= get_sql_input('sms_msg','');$sms_text_msg				= get_sql_input('sms_text_msg','');$tab_sms_email			= get_input('tab_sms_email','email');$hid_action					= get_input('hid_action');if($hid_action=='SEND_EMAIL'){		$cfe_email_or_sms='email';		$cfe_mesasge=$sms_msg;}elseif($hid_action=='SEND_SMS'){		$cfe_email_or_sms='sms';		$cfe_mesasge=$sms_text_msg;}$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,"cfe_id");$sort_by=$new_sort="";biz_set_sorting_var($sort_by,$new_sort);$url = "{$website}/user/tbl_cust_filter_email.php";$navigationURL = $url."?".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}";$isSuccess = "";$sel_tbl_cust_filter= get_input('sel_tbl_cust_filter');$lst_sel_ids='';if(is_not_empty($sel_tbl_cust_filter)){		$lst_sel_ids=biz_implode(',', array_keys($sel_tbl_cust_filter));}	$objtbl_cust_filter_email= new tbl_cust_filter_email();if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 			/*			//..First add the reward and then			$objbiz_rewards=new biz_rewards();			$cfe_reward = $objbiz_rewards->create($_SESSION[SES_RESTAURANT], 'EMAIL_COUPON', 'email_based', 1, 0, 0, 'total', 'm', 0, 0, 1, 0, 1, $prom_id, $cfe_period_start, $cfe_period_end, '', '',1);			unset($objbiz_rewards);			*/						/*if(is_gt_zero_num($cfe_reward)){*/				$isSuccess = $objtbl_cust_filter_email->create($cfe_filter, $cfe_value, $prom_id, $cfe_mesasge, $cfe_email_or_sms, $cfe_period_start, $cfe_period_end, $cfe_restaurant, $cfe_start_date, $cfe_end_date,$cfe_reward);			/*}else{				$cfe_reward=$isSuccess;			}		*/							break;					case ACTION_UPDATE: 			//..Update the reward			/*			$isSuccess = $objbiz_rewards->update($cfe_reward,$_SESSION[SES_RESTAURANT], 'EMAIL_COUPON', 'email_based', 1, 0, 0, 'total', 'm', 0, 0, 1, 0, 1, $cfe_promotion, $cfe_period_start, $cfe_period_end, '', '',1);			*/						$isSuccess = $objtbl_cust_filter_email->update($cfe_id, $cfe_filter, $cfe_value, $prom_id, $cfe_mesasge, $cfe_email_or_sms, $cfe_period_start, $cfe_period_end, $cfe_restaurant, $cfe_start_date, $cfe_end_date);						break;					case ACTION_DELETE: 			//$isSuccess = $objtbl_cust_filter_email->delete(array(CFE_ID=>$cfe_id));			if(is_not_empty($lst_sel_ids)){							$isSuccess = $objtbl_cust_filter_email->delete(array(CFE_ID=>$lst_sel_ids));			}else{				$isSuccess = $objtbl_cust_filter_email->delete(array(CFE_ID=>$cfe_id));			}					break;		case ACTION_ACTIVATE: 			$isSuccess = $objtbl_cust_filter_email->activate($cfe_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objtbl_cust_filter_email->deactivate($cfe_id);			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$err .= "<div class='info'>".$_lang['tbl_cust_filter_email'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$err .= "<div class='error'>".$_lang['tbl_cust_filter_email'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$err .= "<div class='error'>".$_lang['tbl_cust_filter_email'][$action]['DUPLICATE_MSG']."</div>";	}}//..if	$result_found=0;	$tbl_cust_filter_emaillist = $objtbl_cust_filter_email->readArray(array(CFE_RESTAURANT=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array("url"=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,"count"=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_cust_filter_emaillist', $tbl_cust_filter_emaillist);	$smarty->assign('result_found',$result_found);	//..lookup fields	$smarty->assign('lst_cust_filters',tbl_cust_filter_email::getCustFilters());	$smarty->assign('lst_sms_email',tbl_cust_filter_email::getEmailSms());	//..Get the listing of active promotions	//$lst_promotion = pds_list_promotions::GetRewards(1);	$lst_promotion = pds_list_promotions::GetExclusiveOnly(1);	$smarty->assign('lst_promotion',$lst_promotion);		$template = "tbl_cust_filter_email/tbl_cust_filter_email.tpl";		$breadcrumbs[] = array(				 	'link'=>$website.'/user/pref_mng_cntrols.php',					'title'=>$_lang['main']['pref_mng_cntrls']); 	$breadcrumbs[] = array(				 	'link'=>$website.'/user/tbl_cust_filter_email.php',					'title'=>$_lang['tbl_cust_filter_email']['title']);	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($cfe_id)){			$tbl_cust_filter_emailinfo= $objtbl_cust_filter_email->GetInfo($cfe_id);			$smarty->assign('tbl_cust_filter_emailinfo',$tbl_cust_filter_emailinfo);			if(is_not_empty($tbl_cust_filter_emailinfo)){				$prom_id						= $tbl_cust_filter_emailinfo[CFE_PROMOTION];				if($tbl_cust_filter_emailinfo[CFE_EMAIL_OR_SMS]=='email'){					$sms_msg					= $tbl_cust_filter_emailinfo[CFE_MESASGE];					$tab_sms_email		= 'email';									}else{					$sms_text_msg			= $tbl_cust_filter_emailinfo[CFE_MESASGE];					$tab_sms_email		= 'sms';				}							}						if($mode==MODE_UPDATE){				$smarty->assign("isUpdate",1);			}			$template = "tbl_cust_filter_email/view.tpl";		}elseif($mode == MODE_CREATE){			$template = "tbl_cust_filter_email/create.tpl";		}}	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);			$smarty->assign('prom_id',$prom_id);	$smarty->assign('tab_sms_email',$tab_sms_email);}else{	$template="index.tpl";}include_once("footer.php");?>