<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');//..These added since we need functions from the buss_list include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');//..this page only for the customerif(($sesslife==true) && (isCustomer()==FALSE)){ 		biz_script_forward("{$website}/user/tbl_feedback_stats.php");}  include_once('header.php');$active_page="tbl_feedback";// echo $_SESSION[SES_RESTAURANT];// if((is_gt_zero_num($_SESSION[SES_RESTAURANT])) && ($sesslife==true)){if((is_gt_zero_num($_SESSION[SES_RESTAURANT]))){	//echo 'rest='.$_SESSION[SES_RESTAURANT];//if($Global_member['member_role_id'] == ROLE_CUSTOMER){	if(is_gt_zero_num($_SESSION[SES_RESTAURANT])){ 		$restaurentinfo = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);	} 	//print_r($restaurentinfo);//}  $id= get_input('id');$post_id= get_input('post_id',$restaurentinfo['id']);$post_title= get_sql_input('post_title', $restaurentinfo['name']); $cust_user_name = get_sql_input('cust_user_name');$cust_user_phone = get_sql_input('cust_user_phone');if(is_not_empty($cust_user_name)){	$_SESSION[SES_CUST_NM] = $cust_user_name;}$post_type= get_input('post_type', DFLT_FEEDBACK_TYPE); //$mnusel = get_input('mnusel');//$user_id= get_input('user_id');//$user_type= get_input('user_type');$user_id=$_SESSION['guid'];$user_type=CUST_TYPE_LOGIN;$recomm_title= get_sql_input('recomm_title');$recomm_desc= get_sql_input('recomm_desc');$recomm_rating= get_input('recomm_rating');$recomm_QOS_rating= get_input('recomm_QOS_rating');$recomm_QOF_rating= get_input('recomm_QOF_rating');$recomm_ambience_rating= get_input('recomm_ambience_rating');$recomm_email= get_sql_input('recomm_email',$cust_user_name);$recomm_phone= get_sql_input('recomm_phone',$cust_user_phone);$recomm_table= get_input('recomm_table',$_SESSION[SES_TABLE]);$start_date= get_input('start_date');$end_date= get_input('end_date');$my_post= get_input('my_post',0); $action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'id');$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort,'DESC');$sort_by = get_input(SORT_BY,'DESC');$url = $website.'/user/tbl_feedback.php?my_post='.$my_post;$isSuccess = '';$objtbl_feedback= new tbl_feedback();//..get list of selected items$sel_tbl_feedback= get_input('sel_tbl_feedback');$lst_sel_ids='';if(is_not_empty($sel_tbl_feedback)){		$lst_sel_ids=implode(',', array_keys($sel_tbl_feedback));}if(is_not_empty($_SESSION[SES_CUST_NM])){	$ask_cust_name=0;	}else{	$ask_cust_name = 1;}//echo "ask_cust_name=$ask_cust_name";  if(is_not_empty($action)){	switch($action){		case ACTION_CREATE:		if(is_gt_zero_num($user_id)==false){			if(is_not_empty($_SESSION[SES_CUST_NM])==FALSE){				if(is_not_empty($recomm_phone)){					$_SESSION[SES_CUST_NM]= $recomm_phone;				}elseif(is_not_empty($recomm_email)){					$_SESSION[SES_CUST_NM]= $recomm_email;				}else{					$_SESSION[SES_CUST_NM]= 'guest';				}					}							$user_id = getCustomerId($user_type); 					} 				if(is_gt_zero_num($user_id)){			 				$isSuccess = $objtbl_feedback->create($post_id, $post_title, $post_type, $user_id, $recomm_title, $recomm_desc, $recomm_rating, $recomm_QOS_rating, $recomm_QOF_rating, $recomm_ambience_rating,$user_type,$recomm_email,$recomm_phone,$recomm_table);			$restaurant_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);			//..Email to manager about poor rating			//if(($recomm_rating==1) || ($recomm_rating==2) ){				//..Send email				if(is_not_empty($recomm_email)){						//..Finally send the email with the above content						//$restaurant_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]);						$subject = "Poor Feedback from {$recomm_email} on ".$restaurant_info[RESTAURENT_NAME];						//$email_body=sprintf($_lang['tbl_complaints']['info_msg']['complnt_email_msg'],tbl_feedback::Get_Email_Content($isSuccess),$_SESSION[SES_CUST_NM],$recomm_email,$complnt_phone);								$email_body=sprintf($_lang['tbl_complaints']['info_msg']['complnt_email_msg'],tbl_feedback::Get_Email_Content($isSuccess),'',$recomm_email,$recomm_phone);									//echo $email_body;							try {							@send_mail_using_php($subject,$recomm_email,$restaurant_info[RESTAURENT_EMAIL],$email_body,$restaurant_info[RESTAURENT_NAME]);						}catch(Exception $e) {						  // echo 'Caught exception: ',  $e->getMessage(), "\n";						}				}					//..Send SMS 				$_rest_mngr_ph=$restaurant_info[RESTAURENT_PHONE_1];												if(is_not_empty($_rest_mngr_ph)){						if ($post_type == tbl_feedback::PST_TYP_SUBMNUDISH){						$recomm_desc = 'Dish Rated :'.$post_title.':'.$recomm_rating.' stars';					}					if(is_gt_zero_num($recomm_phone)){						$_des= $recomm_phone.':'.$recomm_desc;					}else{						$_des= $recomm_desc;					}											 									try {						//$isSuccess=send_sms_using_twilio(array($_rest_mngr_ph),get_elipsis($_des,120));					}catch(Exception $e) {					  // echo 'Caught exception: ',  $e->getMessage(), "\n";					}				}							//}						//..Email feedback coupons			if((is_gt_zero_num($isSuccess)) && (strtoupper($post_type)=='BUSINESS') && ($sesslife==true)){										$obj_prom=new pds_list_promotions();					$obj_prom->email_feedback_coupons($Global_member['email']);					unset($obj_prom);								}		}else{			unset($_SESSION[SES_CUST_NM]);			$ask_cust_name=1;				/*$_SESSION['prev_fdbk_stored']['post_id']	= $post_id;			$_SESSION['prev_fdbk_stored']['post_title']= $post_title;			$_SESSION['prev_fdbk_stored']['post_type']=$post_type;			$_SESSION['prev_fdbk_stored']['recomm_title']= $recomm_title;			$_SESSION['prev_fdbk_stored']['recomm_desc']= $recomm_desc;			$_SESSION['prev_fdbk_stored']['recomm_rating']= $recomm_rating;			$_SESSION['prev_fdbk_stored']['recomm_QOS_rating']= $recomm_QOS_rating;			$_SESSION['prev_fdbk_stored']['recomm_QOF_rating']= $recomm_QOF_rating;			$_SESSION['prev_fdbk_stored']['recomm_ambience_rating']= $recomm_ambience_rating;							$_SESSION['prev_fdbk_stored']['recomm_email']= $recomm_email;			$_SESSION['prev_fdbk_stored']['recomm_phone']= $recomm_phone;			//echo "<script>location.href='{$website}/user/cust_login.php?prev_page=FEEDBACK';</script>";				biz_script_forward($website.'/user/login.php?prev_page=FEEDBACK');	*/			}						break;				case ACTION_UPDATE: 			$isSuccess = $objtbl_feedback->update($id, $post_id, $post_title, $post_type, $user_id, $recomm_title, $recomm_desc, $recomm_rating, $recomm_QOS_rating, $recomm_QOF_rating, $recomm_ambience_rating,$user_type,$recomm_email,$recomm_phone,$recomm_table);			break;				case ACTION_DELETE: 			if(is_not_empty($lst_sel_ids)){				$isSuccess = $objtbl_feedback->delete(array(ID=>$lst_sel_ids));			}elseif(is_not_empty($id)){ 				$isSuccess = $objtbl_feedback->delete(array(ID=>$id));			}					break;				case ACTION_ACTIVATE:						if(is_not_empty($lst_sel_ids)){				$isSuccess = $objtbl_feedback->activate($lst_sel_ids);			}elseif(is_not_empty($id)){ 				$isSuccess = $objtbl_feedback->activate($id);			}						//$isSuccess = $objtbl_feedback->activate($id);			break;				case ACTION_DEACTIVATE: 			//$isSuccess = $objtbl_feedback->deactivate($id);			if(is_not_empty($lst_sel_ids)){				$isSuccess = $objtbl_feedback->deactivate($lst_sel_ids);			}elseif(is_not_empty($id)){ 				$isSuccess = $objtbl_feedback->deactivate($id);			}						break;		case 'BULK_CREATE':			  if(is_gt_zero_num($user_id)==false){					$user_id = getCustomerId($user_type); 				} 				//echo $recomm_title,$recomm_desc,$post_type,$user_id,$user_type,$recomm_rating,$post_id,$post_title;exit;			 $isSuccess =  tbl_feedback::bulkCreate($recomm_title,$recomm_desc,$post_type,$user_id,$user_type,$recomm_rating,$post_id,$post_title);			 //print_r($_REQUEST);exit;			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if ($post_type == tbl_feedback::PST_TYP_SUBMNUDISH){		$action = 'RATE';	}	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_feedback'][$action]['SUCCESS_MSG'].'</div>';	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_feedback'][$action]['FAILURE_MSG'].'</div>';	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_feedback'][$action]['DUPLICATE_MSG'].'</div>';	} 	 if(is_not_empty($post_id)){ 	if($post_type == tbl_feedback::PST_TYP_SUBMNUDISH){		biz_script_forward($_SERVER[HTTP_REFERER]);		/* 		if($action == 'BULK_CREATE'){				biz_script_forward($website.'/user/tbl_submenu_dishes.php?sbmnu_dish_id='.$post_id.'&is_preview=1');			 }else{		  	biz_script_forward($refUrl);			 } 			 */	} /*	if(is_not_empty($redirect_value) && is_not_empty($redirect_type)){		biz_script_forward()	}*/ 	 }}//..if 	$result_found=0;	$srch_arr=array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);	if($mnusel == 'dish'){		$srch_arr[POST_TYPE]=tbl_feedback::PST_TYP_SUBMNUDISH;	}else{		$srch_arr[POST_TYPE]=tbl_feedback::PST_TYP_BIZ;	}	 	if(isCustomer()){		$srch_arr["isActive"]=1;		//if($sesslife){ 			if($my_post==1){					if(is_gt_zero_num($user_id)==false){						//echo "idsfsn {$user_id}={$user_type}";						$user_id = getCustomerId($user_type); 					} 					$srch_arr[USER_ID]=$user_id;					$srch_arr[USER_TYPE]=$user_type;			}						//}	}	/*print_r($srch_arr);*/	$srch_arr[FDBK_RESTAURENT]=$_SESSION[SES_RESTAURANT];	$tbl_feedbacklist = $objtbl_feedback->readArray($srch_arr,$result_found,1);		$smarty->assign('pagination',biz_pagination(array('url'=>$url,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found)));	$smarty->assign('tbl_feedbacklist', $tbl_feedbacklist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_feedback/tbl_feedback_man.tpl';//tbl_feedback.tpl	 		if($_SESSION['member_role_id'] == ROLE_ADMIN || $_SESSION['member_role_id'] == ROLE_MANAGER || $_SESSION['member_role_id'] == ROLE_EXPEDITOR){			$breadcrumbs[] = array('link'=>$website.'/user/pref_mng_cntrols.php', 'title'=>$_lang['main']['navbar']['controls']); 	}	/*	$breadcrumbs[] = array(   							'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']);								*/	$breadcrumbs [] = array(						 	'link'=>$url,							'title'=>$_lang['tbl_feedback']['create_title']) ;	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($id)){			$tbl_feedbackinfo= $objtbl_feedback->GetInfo($id);		 			if($tbl_feedbackinfo){				$breadcrumbs [] = array(						 	'link'=>$website.'/user/tbl_feedback.php?id='.$id.'&'.MODE_TITLE.'='.$mode,							'title'=>$tbl_feedbackinfo['recomm_title']) ;			}			$smarty->assign('tbl_feedbackinfo',$tbl_feedbackinfo);			 			if($mode==MODE_UPDATE){				//$smarty->assign('isUpdate',1);			}			$template = 'tbl_feedback/view.tpl';		}elseif($mode == MODE_CREATE){			$breadcrumbs [] = array(						 	'link'=>$website.'/user/tbl_feedback.php?'.MODE_TITLE.'='.MODE_CREATE,							'title'=>$_lang['tbl_feedback']['create_title']) ;			$template = 'tbl_feedback/create.tpl';		}}	$smarty->assign('Enum_Overall_Rating',$objtbl_feedback->Enum_OverAll_Rating());	$smarty->assign('Enum_QOS_Rating',$objtbl_feedback->Enum_QOS_Rating());	$smarty->assign('Enum_QOF_Rating',$objtbl_feedback->Enum_QOF_Rating());	$smarty->assign('Enum_Ambience_Rating',$objtbl_feedback->Enum_Ambience_Rating()); 	$smarty->assign('isCustomer',isCustomer());	$smarty->assign('restaurentinfo',$restaurentinfo);	//print_r($restaurentinfo);		$smarty->assign('page_url', $url);	$smarty->assign('my_post', $my_post);	$smarty->assign('ask_cust_name', $ask_cust_name);	$smarty->assign('active_page',$active_page); }else{	$template='index.tpl';} include_once('footer.php');?>