<?phpinclude_once(dirname(dirname(__FILE__))."/init.php");include_once("header.php");/*$search_from_dt= get_input("search_from_dt",date('Y-m-d'));$search_to_dt= get_input("search_to_dt",date('Y-m-d'));*/$search_from_dt= get_input("search_from_dt",'');$search_to_dt= get_input("search_to_dt",'');$rpt_to_show= get_input("rpt_to_show",'');$cust_id= get_input("cust_id",0);//====================== CONFIGURATION ======================	/*$_RWD_CONFIG_TYPE='CUSTOMER'; //..'SERVER';	if($_SESSION[SES_RESTAURANT]==4){		//..for Fired Up Grill		$_RWD_CONFIG_TYPE='SERVER';		}*/	$_RWD_CONFIG_TYPE=$_SESSION['rest_menu_opt_det'][RST_MNU_REWARD_CONF];	//====================== CONFIGURATION ======================$active_page = "biz_checkins"; //.. Time to capture posted values if(is_gt_zero_num($_SESSION[SES_TABLE])) 	$table_id =$_SESSION[SES_TABLE];  else	 	$table_id = get_input('table_id',$_SESSION[SES_TABLE]);		 if((isCustomer()) && (is_gt_zero_num($table_id)==false || is_gt_zero_num($_SESSION[SES_RESTAURANT])==false)){ 	$_SESSION[SES_FLASH_MSG]  ='<div class="error">'.$_lang['main']['qrcode']['empty'].'</div>';	 	biz_script_forward($website.'/user/dashboard.php');	 }  if(is_not_empty($_SESSION[SES_CUST_NM])==FALSE){	$_SESSION[SES_CUST_NM]=$_SESSION[SES_REWARD]['email'];}  /*if($sesslife==true){*///..If the configuration is of customer type then serverpin is mandatoryif($_RWD_CONFIG_TYPE=='CUSTOMER')	$reward_code=get_input('reward_code','');else		$reward_code=0;		$server_validated=get_input('server_validated',0);//==START START CUSTOMER SESSION FOR MANAGER ONLY WITHOUT REQUEST$manager_cust_sess_id = get_input('manager_cust_sess_id',0);$chkin_id= get_input("chkin_id");$chkin_buss_id= get_input("chkin_buss_id");$chkin_rwd_id= get_input("chkin_rwd_id");$chkin_user_id= get_input("chkin_user_id");$chkin_session= get_input("chkin_session");$chkin_points= get_input("chkin_points",0);$chkin_amount= get_input("chkin_amount",0);$is_history= get_input("is_history",0);$chkin_edit_commnt= get_sql_input("chkin_edit_commnt",'');$chkin_invoice= get_sql_input("chkin_invoice",'');//..get table_id if(is_gt_zero_num($_SESSION[SES_TABLE])){	$_tbl_id=$_SESSION[SES_TABLE];}elseif(is_gt_zero_num($_SESSION[CUST_TBL_ID])){	$_tbl_id=$_SESSION[CUST_TBL_ID];}else{	//..if still table not found use default table..		$sql=  'SELECT `'.TABLE_ID.'`						FROM `'.TBL_DINING_TABLE.'` 					  WHERE `'.TABLE_RESTAURANT.'`='.$_SESSION[SES_RESTAURANT].' LIMIT 1;';		$_tbl_id=DB::ExecScalarQry($sql);		//$_tbl_id=$lst_deflf_rest;}$chkin_date= get_input("chkin_date");$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);//echo "$limit=$limit_his |$offset=$offset_his";$sort_on = get_input(SORT_ON,"chkin_id");$sort_by=$new_sort="";biz_set_sorting_var($sort_by,$new_sort);$url = "{$website}/user/biz_checkins.php?rpt_to_show=".$rpt_to_show;$navigationURL = $url."&is_history=0&search_from_dt=".$search_from_dt."&search_to_dt=".$search_to_dt."&".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}&rpt_to_show=".$rpt_to_show;$navigationURL_his = $url."&is_history=1&search_from_dt=".$search_from_dt."&search_to_dt=".$search_to_dt."&".SORT_ON."={$sort_on}&".SORT_BY."={$sort_by}&rpt_to_show=".$rpt_to_show;if($is_history==1){		$offset_his=$offset;		$offset_point=0;}else{				$offset_point=$offset;		$offset_his=0;}$isSuccess = "";$objbiz_checkins= new biz_checkins();$filt_search_phone=get_input('filt_search_phone','');if(is_not_empty($filt_search_phone)){		//$filt_search_phone=str_replace(array('+','-'), '', filter_var($filt_search_phone, FILTER_SANITIZE_NUMBER_INT));		$filt_search_phone1=$phone=_get_us_phone($filt_search_phone,1);		$filt_search_phone=$phone=_get_us_phone($filt_search_phone);				//..First check if there are more than 1 matching record..		//..If found redirect 			$_filt_mem_lst=DB::ExecScalarQry("SELECT COUNT(`".STAFF_MEMBER_ID."`) FROM `".TBL_STAFF."` INNER JOIN ".MEMBERS." ON `".STAFF_MEMBER_ID."`=`".MEMBERS."`.`id` WHERE (`".STAFF_PHONE."`='{$filt_search_phone}' OR `".STAFF_PHONE."`='{$filt_search_phone1}' ) AND `".STAFF_IS_REWARD."`=1 AND `".STAFF_RESTAURENT."`=".$_SESSION[SES_RESTAURANT]);		if($_filt_mem_lst>1){						//..Redirect to page showing the reward member lookup with			biz_script_forward("{$website}/user/rewrad_point_list.php?rpt_to_show=&search_phone={$filt_search_phone}");			exit;		}		//...Upsert user		$UsrReturned  = _upsert_phone_to_rest($filt_search_phone1,'sample','Guest','User',$_SESSION[SES_RESTAURANT]);		$_filt_mem_id = $UsrReturned['id'];						/*$_filt_mem_id=DB::ExecScalarQry("SELECT `".STAFF_MEMBER_ID."` FROM `".TBL_STAFF."` INNER JOIN ".MEMBERS." ON `".STAFF_MEMBER_ID."`=`".MEMBERS."`.`id` WHERE (`".STAFF_PHONE."`='{$filt_search_phone}' OR `".STAFF_PHONE."`='{$filt_search_phone1}' ) AND `".STAFF_IS_REWARD."`=1 AND `".STAFF_RESTAURENT."`=".$_SESSION[SES_RESTAURANT]);*/		if(is_gt_zero_num($_filt_mem_id)){			//..Add points if points are added.			if(is_gt_zero_num($chkin_points)){				$isSuccess = $objbiz_checkins->create($_SESSION[SES_RESTAURANT], 0, $_filt_mem_id,$_tbl_id, $chkin_points, date(DATE_FORMAT),$server_validated,$chkin_amount,$chkin_edit_commnt,$chkin_invoice);				_add_award_pt_sms($_filt_mem_id,$_SESSION[SES_RESTAURANT],$chkin_points);				biz_send_alert($_SESSION[CUST_TBL_ID],$filt_search_phone1,0,sprintf($_lang[TBL_ALERTS]['manager']['RWD_ADD_VISIT_COMP'],$_SESSION[CUST_TBL_ID],$_filt_mem_id),ALERT_FOR_MANGER,REWARD_CUST); 				$_SESSION[SES_FLASH_MSG] = "<div class='info'>".$_lang['biz_checkins'][ACTION_CREATE]['SUCCESS_MSG']."</div>";				}					biz_script_forward("{$website}/user/customer_rewards.php?manager_cust_sess_id={$_filt_mem_id}");		}else{			$_SESSION[SES_FLASH_MSG] = '<div class="error">Member not found with this phone number.</div>';			//..Redirect to page showing the reward member lookup with			biz_script_forward("{$website}");			exit;		}}if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 				//$isSuccess = $objbiz_checkins->create($chkin_buss_id, $chkin_rwd_id, $chkin_user_id, $chkin_session, $chkin_points, $chkin_date);			//..First check if the code matches with any of the reward			if(is_gt_zero_num($cust_id)){				$isSuccess = $objbiz_checkins->create($_SESSION[SES_RESTAURANT], 0, $cust_id,$_tbl_id, $chkin_points, date(DATE_FORMAT),$server_validated,$chkin_amount,$chkin_edit_commnt,$chkin_invoice);				//..send sms to customer				 _add_award_pt_sms($cust_id,$_SESSION[SES_RESTAURANT],$chkin_points);				 biz_send_alert($_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD][STAFF_PHONE],0,sprintf($_lang[TBL_ALERTS]['manager']['RWD_ADD_VISIT_COMP'],$_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD]['id']),ALERT_FOR_MANGER,REWARD_CUST);				$_SESSION[SES_FLASH_MSG] = "<div class='info'>".$_lang['biz_checkins'][$action]['SUCCESS_MSG']."</div>";															biz_script_forward($website.'/user/rewrad_point_list.php');			}else{				if(is_not_empty($reward_code)){						if($_RWD_CONFIG_TYPE=='CUSTOMER' && ((isCustomer()) || ($_SESSION['curr_restant']['restaurent_rwd_multiplier']==1))){					$rslt_fnd=validate_server_pin($reward_code);				}else{					$rslt_fnd=1;				}						//				if(is_not_empty($rslt_fnd)){								//if(1){					//..Check if the returned customer record is last 2 hours						//$is_found=biz_checkins::chk_if_record_wthin_2_hrs($_SESSION[SES_REWARD]['id'],$_SESSION[CUST_TBL_ID]);						//if(is_gt_zero_num($is_found)==false){							//$_SESSION[SES_CUSTOMER_SESSION]=1							if($rslt_fnd>1)						$server_validated=$rslt_fnd;															$isSuccess = $objbiz_checkins->create($_SESSION[SES_RESTAURANT], 0, $_SESSION[SES_REWARD]['id'],$_tbl_id, $chkin_points, date(DATE_FORMAT),$server_validated,$chkin_amount,$chkin_edit_commnt,$chkin_invoice);					//..update the main users balance					if(is_gt_zero_num($isSuccess)){						//..send notification to the customer							$_SESSION[SES_FLASH_MSG] = "<div class='info'>".$_lang['biz_checkins'][$action]['SUCCESS_MSG']."</div>";						//..send sms to customer 						_add_award_pt_sms($_SESSION[SES_REWARD]['id'],$_SESSION[SES_RESTAURANT],$chkin_points);						 						biz_send_alert($_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD][STAFF_PHONE],0,sprintf($_lang[TBL_ALERTS]['manager']['RWD_ADD_VISIT_COMP'],$_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD]['id']),ALERT_FOR_MANGER,REWARD_CUST);										if(is_gt_zero_num($_SESSION['sel_reward_sess'])){							//..change status to approved							$obj_temp_reward_sess= new tbl_temp_reward_sess();$obj_temp_reward_sess->_update_status($_SESSION['sel_reward_sess'],'APPROVED');							unset($obj_temp_reward_sess);														//..add visit							members::update_reward_bal_visits($_SESSION[SES_REWARD]['id'],"ADD");							//..add points							members::update_reward_bal_points($_SESSION[SES_REWARD]['id'],$chkin_points);														if($_RWD_CONFIG_TYPE=='RESTAURANT'){								biz_send_alert($_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD][STAFF_PHONE],0,$_lang['biz_checkins']['CREATE']['CUST_VISIT_SUCCESS_MSG'],$_SESSION[SES_REWARD]['id'],REWARD_CUST);																				//biz_send_alert($_SESSION[CUST_TBL_ID],$_SESSION[SES_CUST_NM],0,sprintf($_lang[TBL_ALERTS]['manager']['RWD_ADD_VISIT_COMP'],$_SESSION[CUST_TBL_ID],$_SESSION[SES_REWARD]['unique_cd']),ALERT_FOR_MANGER,REWARD_CUST);								//..remove the session..								_destroy_cust_reward_sess();								biz_script_forward($website.'/user/biz_checkins.php');								}else{								biz_script_forward($website.'/user/customer_rewards.php');							}						}else{							if($_RWD_CONFIG_TYPE=='RESTAURANT'){								_destroy_cust_reward_sess();								biz_script_forward($website.'/user/biz_checkins.php');							}else{								//biz_script_forward($website.'/user/customer_rewards.php');								if(isCustomer()){									biz_script_forward($website.'/user/customer_rewards.php');								}else{									biz_script_forward($website.'/user/customer_rewards.php?manager_cust_sess_id='.$manager_cust_sess_id);								}							}																	}																}							/*}else{									$_SESSION[SES_FLASH_MSG]= "<div class='error'>".$_lang['tbl_temp_reward_sess']['CREATE']['MAN_VISIT_MSG']."</div>";						}*/				}else{					$_SESSION[SES_FLASH_MSG] = "<div class='error'>".$_lang['biz_checkins'][$action]['CD_DOES_NOT_MATCH']."</div>";				}							}else{					$_SESSION[SES_FLASH_MSG] = "<div class='error'>".$_lang['biz_checkins'][$action]['CD_NOT_PROVIDED']."</div>";			}							if(isCustomer()){					biz_script_forward($website.'/user/customer_rewards.php');				}				if($_SESSION['curr_restant']['restaurent_rwd_multiplier']==1){					biz_script_forward($website.'/user/customer_rewards.php?manager_cust_sess_id='.$manager_cust_sess_id);				}							}						break;		case ACTION_UPDATE: 			//$isSuccess = $objbiz_checkins->update($chkin_id, $chkin_buss_id, $chkin_rwd_id, $chkin_user_id, $chkin_session, $chkin_points, $chkin_date);			$isSuccess = $objbiz_checkins->update_point($chkin_id,$chkin_points,$chkin_edit_commnt);			break;		case ACTION_DELETE: 			$isSuccess = $objbiz_checkins->delete(array(CHKIN_ID=>$chkin_id));			break;		case ACTION_ACTIVATE: 			$isSuccess = $objbiz_checkins->activate($chkin_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objbiz_checkins->deactivate($chkin_id);			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$err .= "<div class='info'>".$_lang['biz_checkins'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$err .= "<div class='error'>".$_lang['biz_checkins'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$err .= "<div class='error'>".$_lang['biz_checkins'][$action]['DUPLICATE_MSG']."</div>";	}}//..if	$result_found=0;	$biz_checkinslist =array();	//if(is_gt_zero_num($_SESSION[SES_REWARD]['id'])){	if(($Global_member['member_role_id'] == ROLE_WAITER || $Global_member['member_role_id'] == ROLE_MANAGER || $Global_member['member_role_id'] == ROLE_ADMIN)){		//$biz_checkinslist = $objbiz_checkins->readArray(array(CHKIN_BUSS_ID=>$_SESSION[SES_RESTAURANT],CHKIN_USER_ID=>$_SESSION[SES_REWARD]['id'],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);		//$arr_filter = array(CHKIN_BUSS_ID=>$_SESSION[SES_RESTAURANT],CHKIN_USER_ID=>$_SESSION[SES_REWARD]['id'],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on);		$arr_filter = array(SES_RESTAURANT=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset_point,LIMIT_TITLE=>$limit);				//..filter criteria		if(is_not_empty($search_from_dt) && is_not_empty($search_to_dt)){				$arr_filter['search_from_dt']=$search_from_dt;				$arr_filter['search_to_dt']=$search_to_dt;				$filt_text[]="Date range:{$search_from_dt} to {$search_to_dt}";		}		$biz_checkinslist = $objbiz_checkins->_get_award_redeem_history($arr_filter,$result_found,1);	}		$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array("url"=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset_point,"count"=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('biz_checkinslist', $biz_checkinslist);	$smarty->assign('result_found',$result_found);		//..START claim history ...	//.........................	$result_found_his=0;	$objcrm_prom_emails=new crm_prom_emails();			$arr_filter_his=array(FLG_SEND=>1,'prm_restaurent'=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset_his,LIMIT_TITLE=>$limit,SORT_BY=>'DESC',SORT_ON=>'crm_pr_ml_id');	//..filter criteria		if(is_not_empty($search_from_dt) && is_not_empty($search_to_dt)){				$arr_filter_his['search_from_dt']=$search_from_dt;				$arr_filter_his['search_to_dt']=$search_to_dt;				$filt_text[]="Date range:{$search_from_dt} to {$search_to_dt}";		}	$crm_prom_emailslist = $objcrm_prom_emails->readArray($arr_filter_his,$result_found_his,1);	$allpageCount_his = 0;	$currentPage_his = 0;	$smarty->assign('pagination_his',biz_pagination(array("url"=>$navigationURL_his,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset_his,"count"=>$result_found_his),$allpageCount_his,$currentPage_his));	$smarty->assign('allpageCount_his',$allpageCount_his);	$smarty->assign('currentPage_his',$currentPage_his);	$smarty->assign('crm_prom_emailslist', $crm_prom_emailslist);	$smarty->assign('result_found_his',$result_found_his);		//.........................	//..END CLAIM HISTORY......			$template = "biz_checkins/grid.tpl";		$breadcrumbs[] = array('link'=>$website.'/user/customer_rewards.php', 'title'=>$_lang['biz_rewards']['title']);	$breadcrumbs[] = array('link'=>$website.'/user/biz_checkins.php', 'title'=>$_lang['biz_checkins']['title']);		if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($chkin_id)){			$biz_checkinsinfo= $objbiz_checkins->GetInfo($chkin_id);			$smarty->assign('biz_checkinsinfo',$biz_checkinsinfo);			if($mode==MODE_UPDATE){				$smarty->assign("isUpdate",1);			}			$template = "biz_checkins/view.tpl";		}elseif($mode == MODE_CREATE){			$template = "biz_checkins/create.tpl";		}	}	if(is_not_empty($filt_text)){		$smarty->assign('filt_text',implode('|',array_unique($filt_text)));			}	$smarty->assign('search_from_dt',$search_from_dt);	$smarty->assign('search_to_dt',$search_to_dt);	$smarty->assign('rpt_to_show',$rpt_to_show);		$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('navigationURL_his',$navigationURL_his);		$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('_RWD_CONFIG_TYPE',$_RWD_CONFIG_TYPE);	$smarty->assign('server_validated',$server_validated);/*}else{	$template="index.tpl";}*/include_once("footer.php");?>