<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_statuses'; if($sesslife==true){ $status_id					= get_input('status_id');$status_name				= get_input('status_name');$status_desc				= get_input('status_desc');$status_event				= get_input('status_event','REQUEST');$status_control			= get_input('status_control');$status_prev				= get_input('status_prev');$status_next				= get_input('status_next');$status_prev_must		= get_input('status_prev_must');$status_next_must		= get_input('status_next_must');$status_exp_time		= get_input('status_exp_time');$status_color				= get_input('status_color');$status_hidden			= get_input('status_hidden',0);$transfer_status		= get_input('transfer_status',0);$status_restaurant	= get_input('status_restaurant'); $status_is_optional	= get_input('status_is_optional',0); $status_start_date	= get_input('status_start_date');$status_end_date		= get_input('status_end_date');$is_preview 				= get_input('is_preview',0);$status_trigger 		= get_input ('status_trigger','');$action 						= strtoupper(get_input(ACTION_TITLE));$mode 							= strtoupper(get_input(MODE_TITLE));$offset 						= get_input(OFFSET_TITLE,OFFSET_VALUE);$limit 							= get_input(LIMIT_TITLE,30);$sort_on 						= get_input(SORT_ON,'status_next');//status_id$sort_by = $new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/tbl_statuses.php';$navigationURL = $url.'?'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';$objtbl_statuses= new tbl_statuses(); unset($_SESSION[SES_STATUS]);if(is_not_empty($action)){  	switch($action){				case ACTION_CREATE:						$isSuccess = $objtbl_statuses->create($status_name, $status_desc, $status_event, $status_control, $status_prev, $status_exp_time, $status_color, $status_hidden,$status_trigger,$status_is_optional,$status_next_must);			break;		case ACTION_UPDATE:  			$isSuccess = $objtbl_statuses->update($status_id, $status_name, $status_desc, $status_event, $status_control, $status_prev, $status_exp_time, $status_color, $status_hidden,$status_trigger,$status_is_optional,$status_next_must);			break;		case ACTION_DELETE: 			//$isSuccess = $objtbl_statuses->delete(array(STATUS_ID=>$status_id));			 $isSuccess = $objtbl_statuses->remove($status_id,$transfer_status);			break;		case ACTION_ACTIVATE: 			$isSuccess = $objtbl_statuses->activate($status_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objtbl_statuses->deactivate($status_id);			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] = "<div class='success'>".$_lang['tbl_statuses'][$action]['SUCCESS_MSG']."</div>";	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] = "<div class='error'>".$_lang['tbl_statuses'][$action]['FAILURE_MSG']."</div>";	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] = "<div class='info'>".$_lang['tbl_statuses'][$action]['DUPLICATE_MSG']."</div>";	}elseif($isSuccess == -4){		$_SESSION[SES_FLASH_MSG] = "<div class='info'>".$_lang['tbl_statuses'][$action]['FAILURE_AUTO_NO_NOTIFICATION']."</div>";	}		if($action == ACTION_CREATE){		 biz_script_forward($website.'/user/tbl_notifications.php?notify_status='.$isSuccess);	}	}//..if   if($status_event == 'TABLE'){		$status_event_str = "'TABLE','ORDER'";	}elseif($status_event == 'ORDER'){		$status_event_str = "'TABLE','ORDER'";	}else{		$status_event_str = "'{$status_event}'";	} 		$result_found=0;	$tbl_statuseslist = $objtbl_statuses->readArray(array(STATUS_EVENT=>$status_event_str,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit),$result_found,1);		$tmp_tbl_lst = array();	foreach($tbl_statuseslist as $key=>$statusitm){		$tmp_tbl_lst[$key]= $statusitm;		$tmp_tbl_lst[$key]['notifications'] = tbl_notifications::readArray(array(NOTIFY_STATUS=>$statusitm[STATUS_ID]),$fnd);		$tmp_tbl_lst[$key]['notification_count'] = $fnd;	}	 $tbl_statuseslist = $tmp_tbl_lst;	 unset($tmp_tbl_lst);	 	 /* 	 $tmp = $tbl_statuseslist;	 $listData = array(); 		//$curritm = array_shift($tmp);		//.find the item where the previous_node_status is zero.		//and assign it to the the $curritm		foreach($tmp as $itm){			if($itm[STATUS_PREV] == 0){				$curritm = $itm;				break;			}		}		unset($tmp); 		if($curritm){					}else{			$tmp = $tbl_statuseslist;			$curritm = array_shift($tmp);		}		  				$current = $curritm[STATUS_ID];						        while($current != NULL)        {					 if(is_not_empty($tbl_statuseslist[$current])){					 	$listData[$current] = $tbl_statuseslist[$current];            $current = $tbl_statuseslist[$current][STATUS_NEXT]; 					 }else{					 	break;					 }        }    // $tbl_statuseslist = $listData;  		$visible_list = $hid_list = array();		foreach($listData as $key=>$val){ 			if($val[STATUS_RESTAURANT] == $_SESSION[SES_RESTAURANT] || $val[STATUS_RESTAURANT]== STS_DFLT_RESTAURANT){				if($val[STATUS_HIDDEN]==1){				$hid_list[] = $val; 			} else{				if(($status_event == 'ORDER') && ($val[STATUS_ID]==STS_TBL_DINING || $val[STATUS_ID]==STS_TBL_DESERT)){ 			 }else{ 				$visible_list[] = $val;			 }				}			}		}		      $tbl_statuseslist = array_merge($visible_list,$hid_list); 	 */	 $visible_list = tbl_statuses::_getStatusSortList($status_event,$tbl_statuseslist,1);	   	 $tbl_statuseslist = tbl_statuses::_getStatusSortList($status_event,$tbl_statuseslist,0);  	 	 $mandatory_list = tbl_statuses::_getMandatoryStatuses($status_event); 	 	 $list = tbl_statuses::_getPrevMandatoryStatus($status_event);	  	  	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_statuseslist', $tbl_statuseslist);	$smarty->assign('mandatory_list',$mandatory_list);	$smarty->assign('result_found',$result_found);	$smarty->assign('status_event',$status_event);	if(is_gt_zero_num($is_preview)){		$template = 'tbl_statuses/preview.tpl';	}else{		$template = 'tbl_statuses/grid.tpl';	} 	/*print_r($mandatory_list);*/	$breadcrumbs[] = array(				 	'link'=>$website.'/user/pref_mng_cntrols.php',					'title'=>$_lang['main']['pref_mng_cntrls']);	$breadcrumbs[] = array(				 	'link'=>$website.'/user/tbl_statuses.php',					'title'=>$_lang['tbl_statuses']['title']);if (is_not_empty($mode)){	if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($status_id)){		$tbl_statusesinfo = $objtbl_statuses->GetInfo($status_id);		 		$tbl_statusesinfo['notification']= tbl_notifications::readArray(array(NOTIFY_STATUS=>$status_id),$fnd);		$tbl_statusesinfo['status_previnfo']= $objtbl_statuses->GetInfo($tbl_statusesinfo[STATUS_PREV]);		$tbl_statusesinfo['status_nextinfo']= $objtbl_statuses->GetInfo($tbl_statusesinfo[STATUS_NEXT]);		$tbl_statusesinfo['status_prev_must_info']= $objtbl_statuses->GetInfo($tbl_statusesinfo[STATUS_PREV_MUST]);		$tbl_statusesinfo['status_next_must_info']= $objtbl_statuses->GetInfo($tbl_statusesinfo[STATUS_NEXT_MUST]);		$tbl_statusesinfo['notification_cnt']= $fnd;		$smarty->assign('tbl_statusesinfo',$tbl_statusesinfo);		if($mode==MODE_UPDATE){			$smarty->assign('isUpdate',1);		}		$template = 'tbl_statuses/view.tpl';	}elseif($mode == MODE_CREATE){		$template = 'tbl_statuses/create.tpl';	}}		//..for each table check what are avialable statuses	/*if($status_event == 'TABLE'){		$status_event = "'TABLE','ORDER'";	}else{		$status_event = "'{$status_event}'"; 	}*/		//$lst_drpdwn_status =$objtbl_statuses->readArray(array(STATUS_EVENT=>$status_event,STATUS_HIDDEN=>0,SORT_BY=>'ASC',SORT_ON=>STATUS_NEXT),$result_found,1);	$smarty->assign('visibleitmCount', count($visible_list));	$visible_list = array_reverse($visible_list);	$cnt=0;	foreach($visible_list as $list){		  if($cnt==0){ 			}else{  				$lst_drpdwn_status[]= $list; 			}			$cnt++;	} 	if(is_not_empty($lst_drpdwn_status)){		$lst_drpdwn_status = array_reverse($lst_drpdwn_status); 	}	 	$smarty->assign('lst_drpdwn_status', $lst_drpdwn_status);  $member_roles=member_role::readArray(array('isActive'=>1,'no_developer'=>1));	$smarty->assign('member_roles',$member_roles);	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',	$new_sort);	$smarty->assign('active_page',$active_page); }else{	$template='index.tpl';} include_once('footer.php');?>