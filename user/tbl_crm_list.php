<?phpini_set('max_execution_time', 0);include_once(dirname(dirname(__FILE__)).'/init.php');include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');include_once('header.php');$active_page = 'tbl_crm_list';$crm_id= get_input('crm_id');$crm_cust_id= get_input('crm_cust_id');$crm_cust_nm= get_input('crm_cust_nm');$crm_cust_email= get_sql_input('crm_cust_email');$crm_cust_phone= get_sql_input('crm_cust_phone');$crm_cust_type= get_input('crm_cust_type');$crm_is_subsribed= get_input('crm_is_subsribed');$crm_start_date= get_input('crm_start_date');$crm_end_date= get_input('crm_end_date');$order_id = get_input('order_id',0);$payment_choice = get_input('payment_choice');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);//$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$limit =  get_input(LIMIT_TITLE,10);$sort_on = get_input(SORT_ON,'crm_id'); $prom_id						= get_input('prom_id',0);$sms_msg						= get_input('sms_msg','');$sms_text_msg				= get_input('sms_text_msg','');$tab_sms_email			= get_input('tab_sms_email','email');$_is_all_selected=get_input('_is_all_selected','');//print_r($_REQUEST);if(is_not_empty($sms_msg)){	$sms_msg=nl2br($sms_msg,false);}$upfile= get_input('upfile','');if($mode == 'CSV_IMPORT'){	if(is_not_empty($upfile)){	// check feilds are not empty	 	if(pathinfo($_FILES["uploaded"]["name"], PATHINFO_EXTENSION)!= 'csv')	{		$error[] = 'Only CSV files accepted!';	}	 	if (!$error){	 	$tot = 0;	$handle = fopen($_FILES["uploaded"]["tmp_name"], "r");	$clmn_name=-1;	$clmn_email=-1;	$clmn_phone=-1;	$is_complete=0;	while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {	 //..get firsttime only field	 if($tot==0){		for ($columns=0; $columns < count($data); $columns++) {				if(strtoupper(trim($data[$columns]))=='NAME'){					$clmn_name=$columns;				}elseif(strtoupper(trim($data[$columns]))=='EMAIL'){					$clmn_email=$columns;				}elseif(strtoupper(trim($data[$columns]))=='PHONE'){					$clmn_phone=$columns;				}		}	 }	 //echo "$clmn_name/$clmn_email/$clmn_phone <br>";	 if(($clmn_name == -1) || ($clmn_email == -1) || ($clmn_phone == -1)){			$_SESSION[SES_FLASH_MSG] = "<div class='error'> CSV File must have 'NAME','EMAIL','PHONE' as column header.</div>";			break;					}else{			for ($c=0; $c < 1; $c++) {	 	       //Only run if the first column if not equal to name	       if($data[$clmn_name] !='name'){				 		$crm_cust_email	=$data[$clmn_email];							$crm_cust_phone	=$data[$clmn_phone];				 		if((is_not_empty($crm_cust_email))&&(filter_var($crm_cust_email, FILTER_VALIDATE_EMAIL))) {							if(is_not_empty($data[$clmn_name])){							$full_nm=explode(' ',$data[$clmn_name]);							$fname=$full_nm[$clmn_name];								if(count($full_nm)>1){														$lname=$full_nm[(count($full_nm)-1)];								}else{									$lname='-';								} 							}															$password='sample';							//echo "ROW-$tot ]$crm_cust_email,$password,0,$fname,$lname,$crm_cust_phone,0,0,0,1 <br>";							//$isSuccess = registerME($crm_cust_email,$password,0,$fname,$lname,$crm_cust_phone,0,0,0,1);							$isSuccess = registerME($crm_cust_email,$password,0,$fname,$lname,$crm_cust_phone,1,0,0,1,$_SESSION[SES_RESTAURANT],0);							$is_complete=$is_complete+1;						}else{							if(strtoupper(trim($crm_cust_email))!='EMAIL')								$error[] = 'ROW-'.$tot.'] ..Invalid Email -'.$crm_cust_email;						}		      }	 			 $tot++;		  }			}			}	fclose($handle);	if(is_gt_zero_num($is_complete)){			$_SESSION[SES_FLASH_MSG] = "<div class='success'> CSV File Imported, $is_complete records added </div>";	}		 	}// end no error}//close if isset upfile$err = capture_errors($error);if(is_not_empty($err)){	$_SESSION[SES_FLASH_MSG] =$err;}}if((in_array($Global_member[MEMBER_ROLE_ID], array(ROLE_MANAGER,ROLE_ADMIN,ROLE_OWNER,ROLE_DEV))) || (is_gt_zero_num($order_id) && isCustomer())){	$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);//$url = $website.'/user/tbl_crm.php';$url = $website.'/user/tbl_crm_list.php';$navigationURL = $url.'?'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';if((is_not_empty($_GET['offset'])==false) && (is_not_empty($action)==false)){	unset($_SESSION['_sel_crm_id_fr_email']);}//print_r($_SESSION['_sel_crm_id_fr_email']);//exit;//..get list of selected items$sel_tbl_staff= get_input('sel_tbl_staff');$lst_sel_ids='';if(is_not_empty($sel_tbl_staff)){		//$lst_sel_ids=implode(',', array_keys($sel_tbl_staff));	//$lst_sel_ids= array_keys($sel_tbl_staff);	/*	if(is_not_empty($lst_sel_ids)){		$_SESSION['_sel_crm_id_fr_email']=array_merge($_SESSION['_sel_crm_id_fr_email'],$lst_sel_ids);	}else{		$_SESSION['_sel_crm_id_fr_email']=$lst_sel_ids;	}	$_SESSION['_sel_crm_id_fr_email']=array_unique($_SESSION['_sel_crm_id_fr_email']);	*/}//..get the selcted ids from the session.if(is_not_empty($_SESSION['_sel_crm_id_fr_email'])){	$lst_sel_ids=array_unique($_SESSION['_sel_crm_id_fr_email']);}else{	$lst_sel_ids=array();}$rest_info = tbl_restaurent::GetInfo($_SESSION[SES_RESTAURANT]); $objtbl_crm= new tbl_crm(); if(is_not_empty($action)){	switch($action){		case 'SEND_SMS':			//if(is_gt_zero_num($prom_id) && is_not_empty($sms_text_msg) && is_not_empty($lst_sel_ids)){			if(is_not_empty($sms_text_msg) && (is_not_empty($_is_all_selected) || is_not_empty($lst_sel_ids))){					$obj_prom=new pds_list_promotions();					$obj_crm_prom_emails=new crm_prom_emails();					if(is_not_empty($_is_all_selected)){						$tbl_stafflist = $objtbl_crm->readArray(array('exclude_banned'=>1,CRM_RESTAURANT=>$_SESSION[SES_RESTAURANT],CRM_IS_SUBSRIBED=>1,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);						$_arr_to_use=$tbl_stafflist;					}elseif( is_not_empty($lst_sel_ids)){						$_arr_to_use=$lst_sel_ids;					}										//..Loop through each email 					foreach($_arr_to_use as $_crm_id){						//..capture the emails of the selected conatcts						//..$subscriber_emails=get_crm_email_from_id($_crm_id);						if(is_not_empty($_is_all_selected)){							$_crm_id=$_crm_id['crm_id'];						}					//..Loop through each email 					//foreach($lst_sel_ids as $_crm_id){						//..capture the phone numbers of the selected conatcts						$phone_nos=get_crm_email_from_id($_crm_id,'phone');						if(is_not_empty($phone_nos)){							//..add record to the crm notify											 $_crm_id=$obj_crm_prom_emails->create($_crm_id, $prom_id, 0, '', '');							 							if(is_gt_zero_num($prom_id)){								 //..now email the promotion to the above emails											 				 $tmp_rslt=$obj_prom->sms_promtoion($prom_id,$phone_nos,$_crm_id,$sms_text_msg);								 							 }else{							  //print_r($phone_nos);							 	//echo "i am here now, $phone_nos,$sms_text_msg";								//exit;							 	 $isSuccess=@send_sms_using_twilio($phone_nos,$sms_text_msg);								 }							 $isSuccess=1;							 							 						}else{							//$_SESSION[SES_FLASH_MSG] =  '<div class="error">'.$_lang["tbl_staff"][$action]["NO_PHONES"].'</div>';							}							}					unset($obj_prom);					unset($obj_crm_prom_emails);					unset($_SESSION['_sel_crm_id_fr_email']);					$_is_all_selected='';			}						break;					case 'SEND_EMAIL':			//if(is_gt_zero_num($prom_id) && is_not_empty($lst_sel_ids)){			//if(is_not_empty($lst_sel_ids) && is_not_empty($sms_msg)){			//echo "_is_all_selected=$_is_all_selected <br>";			if(is_not_empty($sms_msg) && (is_not_empty($_is_all_selected) || is_not_empty($lst_sel_ids))){					$obj_prom=new pds_list_promotions();					$obj_crm_prom_emails=new crm_prom_emails();					if(is_not_empty($_is_all_selected)){						$tbl_stafflist = $objtbl_crm->readArray(array('exclude_banned'=>1,CRM_RESTAURANT=>$_SESSION[SES_RESTAURANT],CRM_IS_SUBSRIBED=>1,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);						$_arr_to_use=$tbl_stafflist;					}elseif( is_not_empty($lst_sel_ids)){						$_arr_to_use=$lst_sel_ids;					}										//..Loop through each email 					foreach($_arr_to_use as $_crm_id){						//..capture the emails of the selected conatcts						//..$subscriber_emails=get_crm_email_from_id($_crm_id);						if(is_not_empty($_is_all_selected)){							$_crm_id=$_crm_id['crm_id'];						}								//echo "{$_crm_id}";								//..Loop through each email 					//foreach($lst_sel_ids as $_crm_id){						//..capture the emails of the selected conatcts						$subscriber_emails=get_crm_email_from_id($_crm_id);						//if(is_not_empty($subscriber_emails)){						if((is_not_empty($subscriber_emails)) && (_chk_if_usr_witout_email($subscriber_emails[0])==0)){							  						//..Send::Email promotion		 							try {								 if(is_gt_zero_num($prom_id)){								 	 //..add record to the crm notify											 	 	 $_crm_id=$obj_crm_prom_emails->create($_crm_id, $prom_id,0, '', '');									 	 $isSuccess=$obj_prom->email_promtoion($prom_id,1,$subscriber_emails,$_crm_id,'',$sms_msg);								   								 }else{								 		$subscriber_emails_lst=implode(',',$subscriber_emails);								 		$isSuccess=send_mail_using_php('Message from '.$rest_info[RESTAURENT_NAME],$rest_info[RESTAURENT_EMAIL],$subscriber_emails_lst,$sms_msg);								 }												 		 	 								 $isSuccess=1;							 							}catch(Exception $e) {							   //echo 'Caught exception: ', $e->getMessage(), "\n";							}						}else{							//$_SESSION[SES_FLASH_MSG] =  '<div class="error">'.$_lang["tbl_staff"][$action]["NO_EMAILS"].'</div>';							$err .= '<div class="error">'.tbl_crm::get_user_nm_from_crm($_crm_id,"customer_name").' does not have email.</div>';													}											}					unset($obj_prom);					unset($obj_crm_prom_emails);					unset($_SESSION['_sel_crm_id_fr_email']);						$_is_all_selected='';					}				break;								case ACTION_CREATE: 			//$isSuccess = $objtbl_crm->create($crm_cust_id, $crm_cust_email, $crm_cust_type, $crm_is_subsribed, $crm_cust_phone);			$password = "sample";			if(is_not_empty($crm_cust_nm)){				$full_nm=explode(' ',$crm_cust_nm);				$fname=$full_nm[0];				if(count($full_nm)>1){										$lname=$full_nm[(count($full_nm)-1)];				}else{					$lname='-';				} 			}						$isSuccess = registerME($crm_cust_email,$password,0,$fname,$lname,$crm_cust_phone,0,0,0,1);			break;		case ACTION_UPDATE: 			$isSuccess = $objtbl_crm->update($crm_id, $crm_cust_id, $crm_cust_email, $crm_cust_type, $crm_is_subsribed, $crm_cust_phone);			break;		case ACTION_DELETE: 			$isSuccess = $objtbl_crm->delete(array(CRM_ID=>$crm_id));			break;		case ACTION_ACTIVATE:			if(is_not_empty($lst_sel_ids)) 				$isSuccess = $objtbl_crm->activate($lst_sel_ids);			break;		case ACTION_DEACTIVATE: 			if(is_not_empty($lst_sel_ids))				$isSuccess = $objtbl_crm->deactivate($lst_sel_ids);			break;								}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_crm'][$action]['SUCCESS_MSG'].'</div>';	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_crm'][$action]['FAILURE_MSG'].'</div>';	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_crm'][$action]['DUPLICATE_MSG'].'</div>';	}}//..if		if(is_gt_zero_num($order_id)){ 		if(tbl_orders::emailOrderReceipt($order_id,$crm_cust_email,$payment_choice)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">Order receipt is emailed to you. Please, Check your mailbox.</div>';		}else{			$_SESSION[SES_FLASH_MSG] = '<div class="error">Problem during sending email.</div>';		} 		biz_script_forward($website.'/user/tbl_orders.php?order_id='.$order_id.'&'.MODE_TITLE.'='.MODE_VIEW);	}	$result_found=0;	//$tbl_crmlist = $objtbl_crm->readArray(array(CRM_RESTAURANT=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);	$tbl_stafflist = $objtbl_crm->readArray(array('exclude_banned'=>1,CRM_RESTAURANT=>$_SESSION[SES_RESTAURANT],CRM_IS_SUBSRIBED=>1,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);		//$rwd_ls = tbl_staff::getRewardUserPointsDetails(array(STAFF_RESTAURENT=>$_SESSION[SES_RESTAURANT],'is_reward'=>1,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);				//..Get the listing of active promotions	$lst_promotion = pds_list_promotions::GetPromotions(1);	$smarty->assign('lst_promotion',$lst_promotion);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_stafflist', $tbl_stafflist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_crm_list/tbl_staff.tpl'; 	$breadcrumbs[] = array(				 	'link'=>$website.'/modules/business_listing/promotionslisting.php?show_type=PR',					'title'=>$_lang['main']['pref_mng_cntrols']['mng_proms']); 	$breadcrumbs[] = array(				 	'link'=>$website.'/user/tbl_crm_list.php',					'title'=>$_lang['tbl_crm']['listing_title']);						if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($crm_id)){			$tbl_crminfo= $objtbl_crm->GetInfo($crm_id);			$smarty->assign('tbl_crminfo',$tbl_crminfo);			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}				$template = 'tbl_crm/view.tpl'; 		}elseif($mode == MODE_CREATE){				$template = 'tbl_crm/create.tpl'; 		}elseif($mode == 'CSV_EXPORT'){				$template = 'tbl_crm_list/csv_export.tpl'; 		}	}			$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('tab_sms_email',$tab_sms_email);	$smarty->assign('rest_info',$rest_info);	$smarty->assign('_is_all_selected',$_is_all_selected);		$prom_lst_link= biz_get_tiny_url(WWWROOT."modules/business_listing/promotionslisting.php?show_type=PR&ps_restnt=".$_SESSION[SES_RESTAURANT]);	$smarty->assign('prom_lst_link',$prom_lst_link);  	}else{	$template='index.tpl';} include_once('footer.php');?>