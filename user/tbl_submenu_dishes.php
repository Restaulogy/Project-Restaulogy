<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_submenu_dishes';$sbmnu_dish_id= get_input('sbmnu_dish_id');$sequence_num = get_input(SES_ORDER_SEQUENCE); $sbmnu_dish_submenu= get_input('sbmnu_dish_submenu',0);$sbmnu_dish_dish= get_input('sbmnu_dish_dish');$sbmnu_dish_price= get_input('sbmnu_dish_price');$sbmnu_dish_display_order= get_input('sbmnu_dish_display_order');$sbmnu_dish_desc= get_input('sbmnu_dish_desc');$sbmnu_dish_start_date= get_input('sbmnu_dish_start_date');$sbmnu_dish_end_date= get_input('sbmnu_dish_end_date');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'sbmnu_dish_display_order');//$sort_on = get_input(SORT_ON,'dish_name');$dish_id = get_input('dish_id',0);$menu_id = get_input('menu_id',0);$sel_sbmnu_dish = get_input('sel_sbmnu_dish');$is_redirection = get_input('is_redirection','');//..retun to teh submenu page$submnu_menu = get_input('submnu_menu',0); $updt_dish_desc = get_input('updt_dish_desc',0);//..logic to fetch always any menu..$_other_dishes_from_submnu_str=DB::ExecScalarQry('SELECT GROUP_CONCAT(`'.MENU_ID.'`) FROM `'.TBL_MENU.'` WHERE `'.SBMNU_DISH_SUBMENU.'`='.$tbl_submenu_dishesinfo[SBMNU_DISH_SUBMENU].' ORDER BY `'.SBMNU_DISH_ID.'` ASC;');	$_other_dishes_from_submnu_arr= explode(',',$_other_dishes_from_submnu_str);	 if(is_not_empty($sel_sbmnu_dish)){	$sel_sbmnudish_ids = biz_implode(',',$sel_sbmnu_dish);}//echo $sel_sbmnudish_ids;$is_preview= get_input('is_preview',0);$web_redt= get_input('web_redt',0);/**disabeld @3Aug2013if(is_gt_zero_num($_SESSION[SES_ORDER_UDP]['order_info'][SES_ORDER])){	$is_preview = 1;} */	$only_matched = 0;if(is_gt_zero_num($is_preview)){		$only_matched = 1;} $sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/tbl_submenu_dishes.php?sbmnu_dish_submenu='.$sbmnu_dish_submenu;$navigationURL = $url.'&sbmnu_dish_submenu='.$sbmnu_dish_submenu.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';$smarty->assign('page_url', $url);$smarty->assign('navigationURL',$navigationURL);$smarty->assign('new_sort',$new_sort);$smarty->assign('active_page',$active_page);if(($sesslife==true) && (is_gt_zero_num($sbmnu_dish_submenu))){ $_SESSION['mnu_sel']='dish';$_SESSION[SES_SUB_MENU]=$sbmnu_dish_submenu;unset($_SESSION[SES_SUB_MENU_DISH]);//$_SESSION['sbmnu_dish_submenu']=$sbmnu_dish_submenu;//..Get the main menu details$objtbl_sub_menu= new tbl_sub_menu();$sub_mnu_deatils=$objtbl_sub_menu->GetInfo($sbmnu_dish_submenu);unset($objtbl_sub_menu);$objtbl_submenu_dishes= new tbl_submenu_dishes();if(is_gt_zero_num($updt_dish_desc)){	$sql='UPDATE `'.TBL_SUBMENU_DISHES.'` SET `'.SBMNU_DISH_DESC.'`=(SELECT `'.DISH_NOTES.'` FROM `'.TBL_DISHES.'` WHERE `'.DISH_ID.'`=`'.SBMNU_DISH_DISH.'` )';	$isSuccess=DB::ExecNonQry($sql);	/*	echo $sql;	if($res>0){				$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_submenu_dishes']['extra_info']['update_all_dishes_success'].'</div>';	}	*/}if(is_not_empty($action)){ 	switch($action){		case ACTION_CREATE: 			$isSuccess = $objtbl_submenu_dishes->create($sbmnu_dish_submenu, $sbmnu_dish_dish, $sbmnu_dish_price, $sbmnu_dish_display_order, mysql_real_escape_string($sbmnu_dish_desc), $sbmnu_dish_start_date, $sbmnu_dish_end_date);			break;		case ACTION_UPDATE: 			$isSuccess = $objtbl_submenu_dishes->update($sbmnu_dish_id, $sbmnu_dish_submenu, $sbmnu_dish_dish, $sbmnu_dish_price, $sbmnu_dish_display_order, mysql_real_escape_string($sbmnu_dish_desc), $sbmnu_dish_start_date, $sbmnu_dish_end_date);			break;		case ACTION_DELETE: 		 if(is_not_empty($sel_sbmnudish_ids)){		 	$isSuccess = $objtbl_submenu_dishes->delete(array(SBMNU_DISH_ID=>$sel_sbmnudish_ids));		 }else{		 	$isSuccess = $objtbl_submenu_dishes->delete(array(SBMNU_DISH_ID=>$sbmnu_dish_id));		 }			 			break;		case ACTION_ACTIVATE: 		if(is_not_empty($sel_sbmnudish_ids)){		 	$isSuccess = $objtbl_submenu_dishes->activate($sel_sbmnudish_ids);		 }else{			$isSuccess = $objtbl_submenu_dishes->activate($sbmnu_dish_id);		 }			break;		case ACTION_DEACTIVATE: 		  if(is_not_empty($sel_sbmnudish_ids)){		 	$isSuccess = $objtbl_submenu_dishes->deactivate($sel_sbmnudish_ids);		 }else{			$isSuccess = $objtbl_submenu_dishes->deactivate($sbmnu_dish_id);			}			break;	}//..switch}//..ifif(is_gt_zero_num($dish_id)){	if(is_not_empty($isSuccess)){		if(is_gt_zero_num($isSuccess)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_submenu_dishes'][$action]['SUCCESS_MSG'].'</div>';		}elseif($isSuccess == OPERATION_FAIL){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_submenu_dishes'][$action]['FAILURE_MSG'].'</div>';		}elseif($isSuccess == OPERATION_DUPLICATE){			$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_submenu_dishes'][$action]['DUPLICATE_MSG'].'</div>';		}	}//..if	//echo '<script type="text/javascript">window.location.href="'.$website.'/user/tbl_dishes.php?dish_id='.$dish_id.'&'.MODE_TITLE.'=LIST";</script>';		//echo '<script type="text/javascript">window.location.href="'.$website.'/user/tbl_dishes.php?dish_id='.$dish_id.'&mode='.MODE_UPDATE.'";</script>';		if(is_not_empty($is_redirection)){			switch($is_redirection){				case 'tbl_dishes':						 biz_script_forward($website.'/user/tbl_dishes.php?'.MODE_TITLE.'='.MODE_UPDATE.'&'.DISH_ID.'='.$dish_id);				break;							}		}		}elseif(is_gt_zero_num($submnu_menu)){	//echo "i am in";	if(is_not_empty($isSuccess)){		if(is_gt_zero_num($isSuccess)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_submenu_dishes'][$action]['SUCCESS_MSG'].'</div>';		}elseif($isSuccess == OPERATION_FAIL){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_submenu_dishes'][$action]['FAILURE_MSG'].'</div>';		}elseif($isSuccess == OPERATION_DUPLICATE){			$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_submenu_dishes'][$action]['DUPLICATE_MSG'].'</div>';		}	}//..if	biz_script_forward($website.'/user/tbl_sub_menu.php?submnu_menu='.$submnu_menu.'&mode='.MODE_UPDATE.'&submnu_id='.$sbmnu_dish_submenu);	}else{	if(is_not_empty($isSuccess)){		if(is_gt_zero_num($isSuccess)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_submenu_dishes'][$action]['SUCCESS_MSG'].'</div>';		}elseif($isSuccess == OPERATION_FAIL){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_submenu_dishes'][$action]['FAILURE_MSG'].'</div>';		}elseif($isSuccess == OPERATION_DUPLICATE){			$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_submenu_dishes'][$action]['DUPLICATE_MSG'].'</div>';		}				if(is_not_empty($is_redirection)){			switch($is_redirection){				case 'tbl_dishes':						 biz_script_forward($website.'/user/tbl_dishes.php?'.MODE_TITLE.'='.MODE_UPDATE.'&'.DISH_ID.'='.$sbmnu_dish_dish);						 			  case 'tbl_menu':						 biz_script_forward($website.'/user/tbl_menu.php?'.MODE_TITLE.'='.MODE_UPDATE.'&'.MENU_ID.'='.$menu_id);				break;							}		}			}//..if	}	$result_found=0;	$info = $objtbl_submenu_dishes->readArray(array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SBMNU_DISH_SUBMENU=>$sbmnu_dish_submenu,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);		$tbl_submenu_disheslist = array();	$x = 0;	foreach($info as $value){		$tbl_submenu_disheslist[$x] = $value;		$tbl_submenu_disheslist[$x]['dish']=tbl_dishes::GetInfo($value[SBMNU_DISH_DISH]);		$x++;	}		$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_submenu_disheslist', $tbl_submenu_disheslist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_submenu_dishes/tbl_submenu_dishes.tpl';	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($sbmnu_dish_id)){			$tbl_submenu_dishesinfo= $objtbl_submenu_dishes->GetInfo($sbmnu_dish_id);					 $dish_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForDish($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_DISH],$only_matched);			 $submenu_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForSubmenu($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_SUBMENU],$only_matched);  	$tbl_submenu_dishesinfo['optionsPrice'] = array_merge($dish_option_prices,$submenu_option_prices); 		unset($dish_option_prices);		unset($submenu_option_prices);	 					 	$smarty->assign('tbl_submenu_dishesinfo',$tbl_submenu_dishesinfo); 			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}			if(is_gt_zero_num($is_preview)){				$template = 'tbl_submenu_dishes/cust_view.tpl';			}else{				$template = 'tbl_submenu_dishes/view.tpl';			}		}elseif($mode == MODE_CREATE){			$template = 'tbl_submenu_dishes/create.tpl';		}	}	/*	$smarty->assign('mnu_sel','dish');	$smarty->assign('sbmnu_dish_submenu',$sbmnu_dish_submenu);	*/	$smarty->assign('sub_mnu_deatils',$sub_mnu_deatils); 	$smarty->assign('submenuList',tbl_sub_menu::GetFields(array('key_field'=>SUBMNU_ID,'value_field'=>SUBMNU_NAME)));	$smarty->assign('dishList',tbl_dishes::GetFields(array('key_field'=>DISH_ID,'value_field'=>DISH_NAME)));		if(is_gt_zero_num($_SESSION[SES_MENU])){		 			$menu_info = tbl_menu::GetInfo($_SESSION[SES_MENU]);		}		if($_SESSION['member_role_id']==ROLE_MANAGER || $_SESSION['member_role_id']==ROLE_ADMIN ){			//..Get the max display order			$_mx_disply_ord=DB::ExecScalarQry('SELECT MAX(`'.SBMNU_DISH_DISPLAY_ORDER.'`) as mx_ord FROM `'.TBL_SUBMENU_DISHES.'` WHERE `'.SBMNU_DISH_SUBMENU.'`='.$sbmnu_dish_submenu.';');						$smarty->assign('mx_disply_ord', ($_mx_disply_ord+1));		}  	if($sesslife){				 switch($_SESSION['member_role_id']){		 	 			 case ROLE_MANAGER : 			 case ROLE_EXPEDITOR :			 case ROLE_ADMIN : 			 case ROLE_OWNER :  			     			 						$breadcrumbs[] = array(					 	'link'=>$website.'/user/pref_mng_cntrols.php',						'title'=>$_lang['main']['pref_mng_cntrls']);									break;			 case ROLE_WAITER :    			 						$breadcrumbs[] = array(		   						'link'=>$website.'/user/dashboard.php',									'title'=>$_lang['main']['customer_nav_menu']['dashboard']									);																break;			default :   $breadcrumbs[] = array(		   						'link'=>$website.'/user/dashboard.php',									'title'=>$_lang['main']['customer_nav_menu']['dashboard']									);									break;									 			} 	}/*else{		 				$breadcrumbs[0] = array(   						'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']							);	}	*/ 	$breadcrumbs[] = array(						'link'=>$website.'/user/tbl_menu.php',						'title'=>$_lang['tbl_menu']['listing_title']); 	$breadcrumbs[] = array(					 	'link'=>$website.'/user/tbl_sub_menu.php?submnu_menu='.$_SESSION[SES_MENU],						'title'=> '"'.$menu_info[MENU_NAME].'"-'. $_lang['tbl_sub_menu']['listing_title']);	$breadcrumbs[] = array(					 	'link'=>$url,						'title'=>'"'.$sub_mnu_deatils[SUBMNU_NAME].'"-'.$_lang['tbl_submenu_dishes']['listing_title']);						}elseif(is_gt_zero_num($sbmnu_dish_id)){	$_SESSION[SES_SUB_MENU_DISH] = $sbmnu_dish_id;	$tbl_submenu_dishesinfo= tbl_submenu_dishes::GetInfo($sbmnu_dish_id);		$_other_dishes_from_submnu_str=DB::ExecScalarQry('SELECT GROUP_CONCAT(`'.SBMNU_DISH_ID.'` ORDER BY `'.SBMNU_DISH_DISPLAY_ORDER.'` ASC) FROM `'.TBL_SUBMENU_DISHES.'` WHERE `'.SBMNU_DISH_SUBMENU.'`='.$tbl_submenu_dishesinfo[SBMNU_DISH_SUBMENU].' AND  ('.TBL_SUBMENU_DISHES_DEACTIVE_DATE.' IS NULL OR '.TBL_SUBMENU_DISHES_DEACTIVE_DATE.'= 0);');	$_other_dishes_from_submnu_arr= explode(',',$_other_dishes_from_submnu_str);	//..find teh current position of shown dish	$cur_dish_key = array_search($sbmnu_dish_id, $_other_dishes_from_submnu_arr); 	$_next_link_id=-1;	$_prev_link_id=-1;	$_total_itms=count($_other_dishes_from_submnu_arr);	if($_total_itms==1){		//..no next,previous link		$_next_link_id=-1;		$_prev_link_id=-1;	}elseif($cur_dish_key==0){		//..no previous link		$_next_link_id=1;		$_prev_link_id=-1;	}elseif($cur_dish_key==($_total_itms-1)){		//..no next link		$_next_link_id=-1;		$_prev_link_id=$cur_dish_key-1;	}else{		$_next_link_id=$cur_dish_key+1;		$_prev_link_id=$cur_dish_key-1;	}		$_next_dish_id=0;	$_prev_dish_id=0;	if($_next_link_id>=0){		$_next_dish_id=$_other_dishes_from_submnu_arr[$_next_link_id];	}	if($_prev_link_id>=0){		$_prev_dish_id=$_other_dishes_from_submnu_arr[$_prev_link_id];	}		$smarty->assign('_next_dish_id',$_next_dish_id);	$smarty->assign('_prev_dish_id',$_prev_dish_id);		//print_r($_other_dishes_from_submnu);	/* print_r($tbl_submenu_dishesinfo);*/	$dish_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForDish($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_DISH],$only_matched);		$submenu_option_prices =   tbl_sbmnu_dish_opt_price::getAllOptionValuePricesForSubmenu($sbmnu_dish_id,$tbl_submenu_dishesinfo[SBMNU_DISH_SUBMENU],$only_matched);  	$tbl_submenu_dishesinfo['optionsPrice'] = array_merge($dish_option_prices,$submenu_option_prices); 	unset($dish_option_prices);		unset($submenu_option_prices);	 	 //..this for don't show; 		if($_SESSION['member_role_id']==ROLE_CUSTOMER){			$tbl_submenu_dishesinfo['cust_favorite'] = tbl_cust_favorites::getPostWiseFavorite($sbmnu_dish_id,$_SESSION['guid']);		}		 	/*	$smarty->assign('sub_mnu_deatils',tbl_sub_menu::GetInfo($tbl_submenu_dishesinfo['sbmnu_dish_submenu'])) 	   if(isset($_SESSION[SES_CART][SES_SUB_MENU_DISH][$sbmnu_dish_id])){	//print_r($_SESSION[SES_CART][SES_SUB_MENU_DISH][$sbmnu_dish_id]); }	*/		if(isCustomer()){				$customer_id = getCustomerId($customer_type);				$dishrating = tbl_feedback::getPostRating($sbmnu_dish_id,tbl_feedback::PST_TYP_SUBMNUDISH);				$is_rated = tbl_feedback::getUserRateId($sbmnu_dish_id,tbl_feedback::PST_TYP_SUBMNUDISH,$customer_id,$customer_type);				$allrating = tbl_feedback::readArray(array(POST_ID=>$sbmnu_dish_id,POST_TYPE=>tbl_feedback::PST_TYP_SUBMNUDISH),$ratingcount);				 								 				 				if(is_gt_zero_num($is_rated)){					$rate_info = tbl_feedback::GetInfo($is_rated);					$smarty->assign('rate_info',$rate_info); 				} 				$smarty->assign('dishrating',$dishrating); 				$smarty->assign('is_rated',$is_rated);				$smarty->assign('allrating',$allrating); 				$smarty->assign('ratingcount',$ratingcount);  				$Enum_Overall_Rating = tbl_feedback::Enum_OverAll_Rating();				 				$smarty->assign('Enum_Overall_Rating',$Enum_Overall_Rating);					}			$smarty->assign('tbl_submenu_dishesinfo',$tbl_submenu_dishesinfo); 	$smarty->assign('sequence_num',$sequence_num);	$smarty->assign('active_page',$active_page);	$smarty->assign('is_preview',$is_preview);	$smarty->assign('web_redt',$web_redt);		$template = 'tbl_submenu_dishes/cust_view.tpl';		if(is_gt_zero_num($sesslife)){			switch($_SESSION['member_role_id']){			 case ROLE_MANAGER :			 case ROLE_EXPEDITOR: 			 case ROLE_ADMIN : 			 case ROLE_OWNER :    			 					$breadcrumbs[] = array(					 	'link'=>$website.'/user/pref_mng_cntrols.php',						'title'=>$_lang['main']['pref_mng_cntrls']);																		break;			 case ROLE_WAITER :    			 					$breadcrumbs[] = array(		   						'link'=>$website.'/user/dashboard.php',									'title'=>$_lang['main']['customer_nav_menu']['dashboard']									);																break;									/*			default :    $breadcrumbs[0] = array(		   							'link'=>$website.'/user/dashboard.php',									'title'=>$_lang['main']['customer_nav_menu']['dashboard']									);									break;*/							 			}	}/*else{			$breadcrumbs[0] = array(   						'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']							);	} */	//...menu		if((isCustomer()==FALSE) && ($is_preview==0)){		$_mn_bread_url=$website.'/user/tbl_menu.php';	}else{		$_mn_bread_url=$website.'/user/tbl_menu.php?menu_id='.$_SESSION[SES_MENU].'&mode=VIEW&is_preview=1';	}			if(is_gt_zero_num($_SESSION[SES_MENU])){					$_mnu_info = tbl_menu::GetInfo($_SESSION[SES_MENU]);		}	if(is_gt_zero_num($is_preview)){		$breadcrumbs[] = array(						'link'=>$_mn_bread_url,						'title'=>$_mnu_info[MENU_NAME]); 	}else{		$breadcrumbs[] = array(						'link'=>$website.'/user/tbl_menu.php',						'title'=>$_lang['tbl_menu']['listing_title']); 	}		/**disabeld @3Aug2013	if(is_gt_zero_num($_SESSION[SES_ORDER_UDP]['order_info'][SES_ORDER])){ 	$breadcrumbs[] = array( 'link'=>$website.'/user/tbl_orders.php?'.MODE_TITLE.'='.MODE_VIEW.'&'.SES_ORDER.'='.$_SESSION[SES_ORDER_UDP]['order_info'][SES_ORDER],						'title'=>strtoupper($_lang['tbl_orders']['label']['order_id'])."-".$_SESSION[SES_ORDER_UDP]['order_info'][SES_ORDER]); 		}	*/	 		/*if(isCustomer()){		if(is_gt_zero_num($_SESSION[SES_MENU])){		 			//$menu_info = tbl_menu::GetInfo($_SESSION[SES_MENU]);	 			if($menu_info){				$breadcrumbs[] = array(						'link'=>$website.'/user/tbl_menu.php?menu_id='.$menu_info['menu_id'].'&mode='.MODE_VIEW.'&is_preview=1',						'title'=>$menu_info['menu_name']); 			} 		}		//else{		//	$breadcrumbs[] = array(		//				'link'=>$website.'/user/tbl_sub_menu.php',		//				'title'=>$_lang['tbl_sub_menu']['listing_title']);		//}	}*/	/*	$breadcrumbs[2] = array(					 	'link'=>$website.'/user/tbl_sub_menu.php',						'title'=>$_lang['tbl_sub_menu']['listing_title']);	$breadcrumbs[3] = array(					 	'link'=>$url,						'title'=>$_lang['tbl_submenu_dishes']['listing_title']);	*/	 }else{	$template='index.tpl';} if($tbl_submenu_dishesinfo){	 	$breadcrumbs[] = array(			'link'=>$website.'/user/tbl_submenu_dishes.php?sbmnu_dish_id='.$tbl_submenu_dishesinfo['sbmnu_dish_id'].'&is_preview='.$is_preview,			'title'=>$tbl_submenu_dishesinfo['sbmnu_dish_detail']['dish_name'].getModeSubTitle($mode));}	include_once('footer.php');?>