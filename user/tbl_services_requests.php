<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_services_requests';$srvc_reqst_id= get_input('srvc_reqst_id');$srvc_reqst_created_by= get_input('srvc_reqst_created_by');$srvc_reqst_srvc_id= get_input('srvc_reqst_srvc_id');$srvc_reqst_table_id= get_input('srvc_reqst_table_id');$srvc_reqst_session_id= get_input('srvc_reqst_session_id');$srvc_reqst_emp_id= get_input('srvc_reqst_emp_id');$srvc_reqst_tbl_sft_assoc_id= get_input('srvc_reqst_tbl_sft_assoc_id');$srvc_reqst_cat_id= get_input('srvc_reqst_cat_id');$srvc_reqst_status= get_input('srvc_reqst_status');$srvc_reqst_created_on= get_input('srvc_reqst_created_on');$srvc_reqst_attended_on= get_input('srvc_reqst_attended_on');$srvc_reqst_completed_at= get_input('srvc_reqst_completed_at');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$table_status = get_input('table_status','');$pst_table_id = get_input('table_id','');$request_type = get_input('request_type','');$stage_id = get_input('stage_id',0);$new_stage_id = get_input('new_stage_id',0);$request_id = get_input('request_id',0);$is_from_view = get_input('is_from_view',1);//..variable for showing/hiding the notifications delete Button$notify_id = get_input('notify_id',0); $url = $website.'/user/tbl_services_requests.php';$isSuccess = '';$objtbl_services_requests= new tbl_services_requests();if(is_not_empty($action)){	switch($action){		case 'CREATE': 			$srvc_reqst_session_id = checkNcreateSession($srvc_reqst_table_id); 			$isSuccess = $objtbl_services_requests->create($srvc_reqst_created_by, $srvc_reqst_srvc_id, $srvc_reqst_table_id,$srvc_reqst_session_id, $srvc_reqst_emp_id, $srvc_reqst_tbl_sft_assoc_id, $srvc_reqst_cat_id, $srvc_reqst_status, $srvc_reqst_created_on, $srvc_reqst_attended_on, $srvc_reqst_completed_at);			if(is_gt_zero_num($srvc_reqst_session_id)== false){			 				@alertToManager($srvc_reqst_table_id,$srvc_reqst_created_by,$isSuccess,sprintf(ALERT_TMP_REQST, $srvc_reqst_table_id));				}			break;		case 'UPDATE': 			$isSuccess = $objtbl_services_requests->update($srvc_reqst_id, $srvc_reqst_created_by, $srvc_reqst_srvc_id, $srvc_reqst_table_id,$srvc_reqst_session_id, $srvc_reqst_emp_id, $srvc_reqst_tbl_sft_assoc_id, $srvc_reqst_cat_id, $srvc_reqst_status, $srvc_reqst_created_on, $srvc_reqst_attended_on, $srvc_reqst_completed_at);			break;		case 'DELETE': 			$isSuccess = $objtbl_services_requests->delete(array(SRVC_REQST_ID=>$srvc_reqst_id));		  	 			break;		case 'ACTIVATE': 			$isSuccess = $objtbl_services_requests->activate($srvc_reqst_id);			break;		case 'DEACTIVATE': 			$isSuccess = $objtbl_services_requests->deactivate($srvc_reqst_id);			break;		case 'CHANGE_STAGE' :		  //die($request_id.'--'.$stage_id);			/*print_r($_REQUEST);			exit;*/			if(is_gt_zero_num($request_id) && is_gt_zero_num($stage_id)){								 				$tmp_info = $objtbl_services_requests->GetInfo($request_id);				/*print_r($tmp_info);*/				$cal_sec = 0; 				if(strtotime($tmp_info[SRVC_REQST_CREATED_ON]) > 0){				 $cal_sec = strtotime('now') - strtotime($tmp_info[SRVC_REQST_CREATED_ON]); 				} 				$obj_srvc_rqst_stg = new tbl_service_request_stage();								if(is_gt_zero_num($new_stage_id)){					$middle_statuses = tbl_table_status::getMiddleRequestStatuses($new_stage_id,$stage_id); 					foreach($middle_statuses as $middle_status){						 $obj_srvc_rqst_stg->delete(array(SRVC_REQ_STG_REQUEST_ID=>$request_id,SRVC_REQ_STG_SERVICE_STAGE_ID=>$middle_status));					} 					$isSuccess =	$obj_srvc_rqst_stg->create($request_id,$new_stage_id ,$cal_sec);	 				}else{					$isSuccess =	$obj_srvc_rqst_stg->create($request_id,$stage_id ,$cal_sec);					} 				  		    																//..Check whether the order is picked				//$service_stage_info = tbl_service_stage::GetInfo($stage_id);				//if($service_stage_info['srvc_stg_sort_order'] != ORDER_INITIATED){ 				if($stage_id != STS_REQST_INITIATED){  					//$isSuccess = $objtbl_services_requests->attendRequest($request_id,$_SESSION['guid']); 					$objtbl_services_requests->attendRequest($request_id,$_SESSION['guid']); 				} 				//unset($service_stage_info);				 				//..for detecting final stage  				//if(tbl_service_stage::GetLastServiceStage($tmp_info['srvc_id']) == $stage_id){ 			 if($stage_id == STS_REQST_COMPLETED){    					//$isSuccess = $objtbl_services_requests->completeRequest($request_id,$_SESSION['guid']);					$objtbl_services_requests->completeRequest($request_id,$_SESSION['guid']);				}  		        unset($obj_srvc_rqst_stg);				unset($tmp_info);		 	}			biz_script_forward($_SERVER[HTTP_REFERER]);			break;			//echo $isSuccess; 	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION['disp_msg'] = '<div class="success">'.$_lang['tbl_services_requests'][$action]['SUCCESS_MSG'].'</div>';	}else{		$_SESSION['disp_msg'] = '<div class="error">'.$_lang['tbl_services_requests'][$action]['FAILURE_MSG'].'</div>';	}}//..if	$result_found=0;	$tbl_services_requestslist = $objtbl_services_requests->readArray(array('offset'=>$offset,'limit'=>$limit,SES_RESTAURANT=>$_SESSION[SES_RESTAURANT]),$result_found,1);		$smarty->assign('pagination',biz_pagination(array('url'=>$url,'limit'=>$limit,'offset'=>$offset,'count'=>$result_found)));	$smarty->assign('tbl_services_requestslist', $tbl_services_requestslist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_services_requests/tbl_services_requests.tpl';	$smarty->assign('notify_id',$notify_id);	if (is_not_empty($mode)){		if(($mode == 'VIEW' || $mode=='UPDATE') && (is_gt_zero_num($srvc_reqst_id) || is_gt_zero_num($request_id))){		  if(is_gt_zero_num($srvc_reqst_id)){		  			  }else if(is_gt_zero_num($request_id)){		  	$srvc_reqst_id = $request_id;		  }			$tbl_services_requestsinfo= $objtbl_services_requests->GetInfo($srvc_reqst_id);			$tbl_services_requestsinfo['service'] = tbl_services_code::GetInfo($tbl_services_requestsinfo['srvc_reqst_srvc_id']);			//..Fetch service deatils associated						//$tmp_values=array();			//$tbl_services_requestsinfo['srvc_dtl_opt'] 			$tmpvar= tbl_serv_request_details::readArray(array(SRVC_REQST_REQUEST =>$srvc_reqst_id));			//print_r($tmpvar);						if(is_not_empty($tmpvar)){				$index = 0;					$selected_opts=array();					$objtbl_services_details=new tbl_services_details();						foreach($tmpvar as $val){														if(is_gt_zero_num($val['subcode_id'])){						  $tmp_val=$objtbl_services_details->GetInfo($val['subcode_id']);					 /* 					 if(is_not_empty($tmp_val)){							$tmp_values[$index]['name']=$tmp_val['name'];					  }					  $tmp_values[$index]['value']=$tmpvar['srvc_reqst_subcode_value'];					*/					  if($tmp_val['type']=='CHECKBOX'){					  	 $selected_opts[]=$tmp_val['name'];					  }else{					  	 $selected_opts[]=$val['subcode_value'];					  }					  					}					$index++;									}								}							if(is_not_empty($selected_opts)){				$selected_opts = array_filter($selected_opts);				$tbl_services_requestsinfo['srvc_dtl_opt'] =implode(',',$selected_opts);			}						unset($objtbl_services_details);			/*if(is_not_empty($tmp_values))				$tbl_services_requestsinfo['srvc_dtl_opt'] =implode($tmp_values);*/							$tbl_services_requestsinfo['table'] = tbl_dining_table::GetInfo($tbl_services_requestsinfo['srvc_reqst_table_id']);			$tbl_services_requestsinfo['employee'] = tbl_staff::GetInfo($tbl_services_requestsinfo['srvc_reqst_emp_id']); 			/*			$remain_stages = tbl_service_request_stage::GetRemainingStages($tbl_services_requestsinfo['id'],$tbl_services_requestsinfo['srvc_id']);			 			$tbl_services_requestsinfo['remain_stages'] = $remain_stages;						$allStage = tbl_service_stage::GetAllServieceStage($tbl_services_requestsinfo['srvc_id']);			$stages = array();			 			$x = 0; 			foreach($allStage as $stage){			 	if(biz_arr_search($remain_stages,SRVC_STG_ID,$stage[SRVC_STG_ID])){								}else{					$stages[$x] = $stage;					$x++;				}			}						$stages = array_reverse($stages);			 			$lastStage = array();			$used_stages = array();			$y = 0;			if(is_gt_zero_num($x)){  				for($i=0;$i<$x;$i++){					if($i == 0){						$lastStage = $stages[0];					}else{						$used_stages[$y] = $stages[$i];						$y++;					}				}   			}			*/  			$lst_reqst_status = tbl_service_request_stage::getLastStatusOfRequst($tbl_services_requestsinfo['id']);	  	  	$arr = tbl_table_status::getRequest_Statuses($lst_reqst_status);	  	 $remain_stages	= $arr['remain_statuses'];	 $used_stages		= $arr['used_statuses'];	 $lastStage			= array_shift($arr['last_statuses']); 	  		 $tbl_services_requestsinfo['remain_stages'] = $remain_stages;			$tbl_services_requestsinfo['used_stages'] = $used_stages;	 		$tbl_services_requestsinfo['last_stage'] = $lastStage;			$tbl_services_requestsinfo['request_stages'] = tbl_service_request_stage::getAllCompletedStagesForRequest($srvc_reqst_id);			$tbl_services_requestsinfo = array_merge($tbl_services_requestsinfo,$objtbl_services_requests->request_stage($tbl_services_requestsinfo,$tbl_services_requestsinfo['remain_stages'])) ;						   //print_r($tbl_services_requestsinfo);		  //print_r($tbl_services_requestsinfo); 			$smarty->assign('tbl_services_requestsinfo',$tbl_services_requestsinfo);			if($mode=='UPDATE'){				$smarty->assign('isUpdate',1);			}			$template = 'tbl_services_requests/view.tpl';		}elseif($mode == 'NEW'){			$template = 'tbl_services_requests/create.tpl'; 		}		//..Breadcrumb logic goes here	if(is_gt_zero_num($pst_table_id)){	$tbl_details = tbl_dining_table::GetInfo($pst_table_id);	$breadcrumbs[0] = array(					 	'link'=>$website.'/user/tbl_table_status_link.php?latestOnly=1',						'title'=>$_lang['tbl_table_status_link']['listing_title']); 		if($tbl_details){		$breadcrumbs[1] = array(					 	'link'=>$website.'/user/tbl_table_status_link.php?todays_requests=0&pst_table_id='.$tbl_details['id'],						'title'=>$tbl_details['number']);	}	$smarty->assign('table_info',$tbl_details);	}			 if(is_not_empty($request_type)){		switch(strtoupper($request_type)){			case 'EMPLOYEE' : 				$breadcrumbs[] = array(					 	'link'=>$website.'/user/employee_requests.php?table_status=1&table_id='.$tbl_details['id'],						'title'=>$_lang['tbl_services_requests']['title']);						break; 			case 'CUSTOMER' : 				$breadcrumbs[] = array(					 	'link'=>$website.'/user/customer_requests.php?table_status=1&table_id='.$tbl_details['id'],						'title'=>$_lang['tbl_services_requests']['title']); 						break;			case 'PENDING' : 				$breadcrumbs[] = array(					 	'link'=>$website.'/user/pending_requests.php?table_status=1&table_id='.$tbl_details['id'],						'title'=>$_lang['tbl_services_requests']['title']); 						break;					}	} 	   		if($tbl_services_requestsinfo){		$breadcrumbs[] = array(					 	'link'=>$url.'?table_status='.$table_status.'&table_id='.$pst_table_id.'&mode=view&srvc_reqst_id='.$srvc_reqst_id.'&request_type='.$request_type,						'title'=>$tbl_services_requestsinfo['service']['srvc_name']						); 	}				} $smarty->assign('page_url', $url);include_once('footer.php');?>