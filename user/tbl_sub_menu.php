<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_sub_menu';$sel_sub_menu= get_input('sel_sub_menu');$submnu_id= get_input('submnu_id');$submnu_name= get_input('submnu_name');$submnu_menu= get_input('submnu_menu',0);$submnu_display_order= get_input('submnu_display_order');$submnu_description= get_input('submnu_description');$submnu_spl_note= get_input('submnu_spl_note');$submnu_start_date= get_input('submnu_start_date');$submnu_end_date= get_input('submnu_end_date');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'submnu_display_order');$sort_by = get_input(SORT_BY,'ASC');$is_redirection = get_input('is_redirection');$frm_submnu_id= get_input('frm_submnu_id');$is_forward= get_input('is_forward',0);//..Image save logic//..$submnu_image= get_input('submnu_image');$submnu_image='';if((isset($_FILES['submnu_image'])) && (is_not_empty($_FILES['submnu_image']['name']))){	$save_path=PATHROOT.SUB_MNU_IMG_UPLOAD_PATH;	$file_save_nm=time().'_'.$_FILES['submnu_image']['name'];		//print_r($_FILES);	//echo "save_path=$save_path";	//now save the new file	$sv_fl_rslt=SaveFile($_FILES,'submnu_image',$save_path,$file_save_nm);	if($sv_fl_rslt==1){		$submnu_image=$file_save_nm;				if($action==ACTION_UPDATE){			//..Delete previous file			tbl_sub_menu::deletePrevSubMnuImg($submnu_id,$save_path);		}		//..Everything OK database insert/update will ok from here	}else{				$err .= '<div class="info">'.$sv_fl_rslt.'</div>';	}		}$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url =$website.'/user/tbl_sub_menu.php?submnu_menu='.$submnu_menu;$navigationURL = $url.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';unset($_SESSION[SES_DISH]);if(($sesslife==true) && (is_gt_zero_num($submnu_menu))){//..Clear the previous session since this is teh first time if($is_forward==1){	$_SESSION[SES_MENU]=0;    $_SESSION[SES_SUB_MENU]=0;}//..Set Session for setup wizard$_SESSION['mnu_sel']='sub_menu';$_SESSION[SES_MENU]=$submnu_menu; //$_SESSION['submnu_menu']=$submnu_menu;//..Get the main menu details$objtbl_menu= new tbl_menu();$mnu_deatils=$objtbl_menu->GetInfo($submnu_menu);unset($objtbl_menu);$objtbl_sub_menu= new tbl_sub_menu();if(is_not_empty($sel_sub_menu)){	$sel_submnu_ids = biz_implode(',',array_keys($sel_sub_menu));} if(is_not_empty($action)){		switch($action){		case ACTION_CREATE: 			$isSuccess = $objtbl_sub_menu->create($submnu_name, $submnu_menu, $submnu_display_order, $submnu_description, $submnu_spl_note, $submnu_start_date, $submnu_end_date,$submnu_image);			break;					case ACTION_UPDATE: 			$isSuccess = $objtbl_sub_menu->update($submnu_id, $submnu_name, $submnu_menu, $submnu_display_order, $submnu_description, $submnu_spl_note, $submnu_start_date, $submnu_end_date,$submnu_image); 			break;					case ACTION_DELETE: 		 if(is_not_empty($sel_submnu_ids)){		 	$isSuccess = $objtbl_sub_menu->delete(array(SUBMNU_ID=>$sel_submnu_ids));		 }else{		 	$isSuccess = $objtbl_sub_menu->delete(array(SUBMNU_ID=>$submnu_id));		 }					 break;		 		case ACTION_ACTIVATE: 		  if(is_not_empty($sel_submnu_ids)){		 	$isSuccess = $objtbl_sub_menu->activate($sel_submnu_ids);		 }else{		 	$isSuccess = $objtbl_sub_menu->activate($submnu_id);		 }		 break;		case ACTION_DEACTIVATE: 		if(is_not_empty($sel_submnu_ids)){		 	$isSuccess = $objtbl_sub_menu->deactivate($sel_submnu_ids);		 }else{		 	$isSuccess = $objtbl_sub_menu->deactivate($submnu_id);		 } 			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] .= '<div class="success">'.$_lang['tbl_sub_menu'][$action]['SUCCESS_MSG'].'</div>';	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] .= '<div class="info">'.$_lang['tbl_sub_menu'][$action]['FAILURE_MSG'].'</div>';	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] .= '<div class="error">'.$_lang['tbl_sub_menu'][$action]['DUPLICATE_MSG'].'</div>';	}		if(is_not_empty($is_redirection)){			switch($is_redirection){ 			  case 'tbl_menu':						 biz_script_forward($website.'/user/tbl_menu.php?'.MODE_TITLE.'='.MODE_UPDATE.'&'.MENU_ID.'='.$submnu_menu);				break;							}		}	}//..if 	$result_found=0;	$tbl_sub_menulist = $objtbl_sub_menu->readArray(array(OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on,SUBMNU_MENU=>$submnu_menu),$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_sub_menulist', $tbl_sub_menulist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_sub_menu/tbl_sub_menu.tpl';	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($submnu_id)){			$tbl_sub_menuinfo= $objtbl_sub_menu->GetInfo($submnu_id);			$submenu_dish_count = 0; 						//$tbl_sub_menuinfo['dishes']  =tbl_submenu_dishes::readArray(array(SBMNU_DISH_SUBMENU=>$tbl_sub_menuinfo[SUBMNU_ID],'isActive'=>1),$submenu_dish_count,1,1);			$tbl_sub_menuinfo['dishes']  =tbl_submenu_dishes::readArray(array(SBMNU_DISH_SUBMENU=>$tbl_sub_menuinfo[SUBMNU_ID]),$submenu_dish_count,1,1);  			$tbl_sub_menuinfo['dish_options'] = tbl_dish_options::readArray(array(DISH_OPT_SUBMENU=>$submnu_id)); 						$tbl_sub_menuinfo['dishes_count'] = $submenu_dish_count; 			$smarty->assign('tbl_sub_menuinfo',$tbl_sub_menuinfo);			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}			$template = 'tbl_sub_menu/view.tpl';		}elseif($mode == MODE_CREATE){				$template = 'tbl_sub_menu/create.tpl';		}	}	//..For menu item selection	/*$smarty->assign('mnu_sel','sub_menu');	$smarty->assign('submnu_menu',$submnu_menu);*/	$smarty->assign('mnu_deatils',$mnu_deatils);		//..Get the max display order	$_mx_disply_ord=DB::ExecScalarQry('SELECT MAX(`s`.`'.SUBMNU_DISPLAY_ORDER.'`) as mx_ord FROM `'.TBL_SUB_MENU.'` `s` INNER JOIN `'.TBL_MENU.'` `m` ON `m`.`'.MENU_ID.'`=`s`.`'.SUBMNU_MENU.'` WHERE `m`.`'.MENU_RESTAURENT.'`='.$_SESSION[SES_RESTAURANT].';');	$smarty->assign('mx_disply_ord', ($_mx_disply_ord+1));				$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('menuList',tbl_menu::GetFields(array('key_field'=>MENU_ID,'value_field'=>MENU_NAME)));		switch($_SESSION['member_role_id']){	 case ROLE_MANAGER :	 case ROLE_EXPEDITOR:	 case ROLE_ADMIN :	 case ROLE_OWNER :    	 					 $breadcrumbs[] = array(					 	'link'=>$website.'/user/pref_mng_cntrols.php',						'title'=>$_lang['main']['pref_mng_cntrls']);							break;	 case ROLE_WAITER :    $breadcrumbs[0] = array(   							'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']							);														break; /*	default :   $breadcrumbs[0] = array(   							'link'=>$website.'/user/dashboard.php',							'title'=>$_lang['main']['customer_nav_menu']['dashboard']							);							break;*/ 							 	} 	$breadcrumbs[] = array(						'link'=>$website.'/user/tbl_menu.php',						'title'=>$_lang['tbl_menu']['listing_title']);	$breadcrumbs[] = array(					 	'link'=>$url,						'title'=>'"'.$mnu_deatils[MENU_NAME].'"-'. $_lang['tbl_sub_menu']['listing_title']);							if($tbl_sub_menuinfo){	$breadcrumbs[] = array( 					'link'=>$url.'&mode='.$mode.'&submnu_id='.$submnu_id.'&is_preview='.$is_preview ,					'title'=>$tbl_sub_menuinfo['submnu_name'].getModeSubTitle($mode));	} 										  }else{	$template='index.tpl';} include_once('footer.php');?>