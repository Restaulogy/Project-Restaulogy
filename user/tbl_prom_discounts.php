<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once(dirname(dirname(__FILE__)).'/modules/business_listing/classes/pds_list_promotions.class.php');include_once('header.php');$active_page = 'tbl_prom_discounts';$prmdisc_promotion= get_input('prmdisc_promotion',$_SESSION[SES_PROMOTION]); if($sesslife==true && is_gt_zero_num($prmdisc_promotion)){	$_SESSION[SES_PROMOTION] = $prmdisc_promotion;$prmdisc_condition= get_input('prmdisc_condition');$prmdisc_bogo_qty= get_input('prmdisc_bogo_qty');$prmdisc_bogo_sbmnu= get_input('prmdisc_bogo_sbmnu');$prmdisc_bogo_sbmnu_dish= get_input('prmdisc_bogo_sbmnu_dish');$prmdisc_disc_amt_type= get_input('prmdisc_disc_amt_type');$prmdisc_disc_amt= get_input('prmdisc_disc_amt');$prmdisc_start_date= get_input('prmdisc_start_date');$prmdisc_end_date= get_input('prmdisc_end_date');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'prmdisc_id');$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/tbl_prom_discounts.php?prmdisc_promotion='.$prmdisc_promotion;$navigationURL = $url.'&'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$prmdisc_id= get_input('prmdisc_id');if(is_gt_zero_num($prmdisc_id)==false){	$prmdisc_id  = tbl_prom_discounts::getPromDiscountByPromotion($prmdisc_promotion);}if(is_gt_zero_num($prmdisc_id)==false){  $mode = MODE_CREATE;}else{	$mode = MODE_UPDATE;}  $isSuccess = '';$objtbl_prom_discounts= new tbl_prom_discounts();//..Get the conditions available for this promotion //$lst_coditions = tbl_prom_cond_details::readArray(array('isActive'=>1,'prmcon_promotion'=>$prmdisc_promotion)); $lst_coditions = tbl_prom_conditions::readArray(array('isActive'=>1,PRMCON_PROMOTION=>$prmdisc_promotion ));//..now this will be always one$particular_condition=0;if(is_not_empty($lst_coditions)){		$_rec_cond=array_shift($lst_coditions); 		$particular_condition=$_rec_cond['prmcon_id'];}//..get list of selected items$sel_prom_discounts= get_input('sel_prom_discounts');$lst_sel_ids='';if(is_not_empty($sel_prom_discounts)){		$lst_sel_ids=implode(',', array_keys($sel_prom_discounts));} if(is_not_empty($action)){	switch($action){		case ACTION_CREATE:		 			$isSuccess = $objtbl_prom_discounts->create($prmdisc_promotion, $prmdisc_condition, $prmdisc_bogo_qty, $prmdisc_bogo_sbmnu, $prmdisc_bogo_sbmnu_dish, $prmdisc_disc_amt_type, $prmdisc_disc_amt);			break;		case ACTION_UPDATE: 			$isSuccess = $objtbl_prom_discounts->update($prmdisc_id, $prmdisc_promotion, $prmdisc_condition, $prmdisc_bogo_qty, $prmdisc_bogo_sbmnu, $prmdisc_bogo_sbmnu_dish, $prmdisc_disc_amt_type, $prmdisc_disc_amt,'','');			break;		case ACTION_DELETE: 			if(is_not_empty($lst_sel_ids)){				$isSuccess = $objtbl_prom_discounts->delete(array(PRMDISC_ID=>$lst_sel_ids));			}else{				$isSuccess = OPERATION_FAIL;			} 			//$isSuccess = $objtbl_prom_discounts->delete(array(PRMDISC_ID=>$prmdisc_id));			break;		case ACTION_ACTIVATE: 			$isSuccess = $objtbl_prom_discounts->activate($prmdisc_id);			break;		case ACTION_DEACTIVATE: 			$isSuccess = $objtbl_prom_discounts->deactivate($prmdisc_id);			break;	}//..switch}//..if	if(is_not_empty($isSuccess)){		if(is_gt_zero_num($isSuccess)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_prom_discounts'][$action]['SUCCESS_MSG'].'</div>';		}elseif($isSuccess == OPERATION_FAIL){			$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_prom_discounts'][$action]['FAILURE_MSG'].'</div>';		}elseif($isSuccess == OPERATION_DUPLICATE){			$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_prom_discounts'][$action]['DUPLICATE_MSG'].'</div>';		}			}//..if	$result_found=0;	$tbl_prom_discountslist = $objtbl_prom_discounts->readArray(array(PRMDISC_PROMOTION=>$prmdisc_promotion,OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);		//print_r($tbl_prom_discountslist);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_prom_discountslist', $tbl_prom_discountslist);	$smarty->assign('result_found',$result_found);	//$template = 'tbl_prom_discounts/tbl_prom_discounts.tpl';	$template = 'tbl_prom_discounts/grid.tpl'; 	if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($prmdisc_id)){			$tbl_prom_discountsinfo= $objtbl_prom_discounts->GetInfo($prmdisc_id);							$smarty->assign('tbl_prom_discountsinfo',$tbl_prom_discountsinfo);			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}						$template = 'tbl_prom_discounts/view.tpl';		}elseif($mode == MODE_CREATE){			$template = 'tbl_prom_discounts/create.tpl';		}}	$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page);	$smarty->assign('amount_types',GetAmountTypes());	$lst_sub_mnu = tbl_sub_menu::readArray(array('isActive'=>1,MENU_RESTAURENT=>$_SESSION[SES_RESTAURANT])); 	$smarty->assign('lst_sub_mnu',$lst_sub_mnu);	//..Get the listing of active promotions	$lst_promotion = pds_list_promotions::GetPromotions();	$smarty->assign('lst_promotion',$lst_promotion);		$smarty->assign('lst_coditions',$lst_coditions);	$smarty->assign('particular_condition',$particular_condition);		//..promotion deatils	$prom_detail = pds_list_promotions::GetPromotionDetail($prmdisc_promotion);		$smarty->assign('prom_detail',$prom_detail);	 	$breadcrumbs[] = array('link'=>$website.'/modules/business_listing/promotionslisting.php?show_type=PR', 'title'=>$_lang['lbl_coupons']);	if(is_not_empty($prom_detail)){		$breadcrumbs[] = array('link'=>$website.'/modules/business_listing/promotion.php?edit=1&id='.$prmdisc_promotion, 'title'=>$prom_detail['title']);	}	$breadcrumbs[] = array('link'=>$website.'/user/tbl_prom_discounts.php?prmdisc_promotion='.$prmdisc_promotion, 'title'=>$_lang[TBL_PROM_DISCOUNTS]['title']);		}else{	if(is_gt_zero_num($prmdisc_promotion)==FALSE){		$_SESSION[SES_FLASH_MSG] = '<div class="error">Please select/create the basic promotion to view discounted item</div>';		$template ='tbl_prom_discounts/no-promotion.tpl';		biz_script_forward($_SERVER['HTTP_REFERER']);	}else{		$template='index.tpl';	}	} include_once('footer.php');?>