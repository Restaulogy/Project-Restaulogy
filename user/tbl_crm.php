<?phpinclude_once(dirname(dirname(__FILE__)).'/init.php');include_once('header.php');$active_page = 'tbl_crm';$crm_id= get_input('crm_id');$crm_cust_id= get_input('crm_cust_id');$crm_cust_email= get_input('crm_cust_email');$crm_cust_phone= get_input('crm_cust_phone');$crm_cust_type= get_input('crm_cust_type');$crm_is_subsribed= get_input('crm_is_subsribed');$crm_start_date= get_input('crm_start_date');$crm_end_date= get_input('crm_end_date');$order_id = get_input('order_id',0);$payment_choice = get_input('payment_choice');$action = strtoupper(get_input(ACTION_TITLE));$mode = strtoupper(get_input(MODE_TITLE));$offset = get_input(OFFSET_TITLE,OFFSET_VALUE);$limit =  get_input(LIMIT_TITLE,LIMIT_VALUE);$sort_on = get_input(SORT_ON,'crm_id'); if((in_array($Global_member[MEMBER_ROLE_ID], array(ROLE_MANAGER,ROLE_ADMIN,ROLE_OWNER,ROLE_DEV))) || (is_gt_zero_num($order_id) && isCustomer())){	$sort_by=$new_sort='';biz_set_sorting_var($sort_by,$new_sort);$url = $website.'/user/tbl_crm.php';$navigationURL = $url.'?'.SORT_ON.'='.$sort_on.'&'.SORT_BY.'='.$sort_by;$isSuccess = '';//..get list of selected items$sel_tbl_crm= get_input('sel_tbl_crm');$lst_sel_ids='';if(is_not_empty($sel_tbl_crm)){		$lst_sel_ids=implode(',', array_keys($sel_tbl_crm));}  $objtbl_crm= new tbl_crm(); if(is_not_empty($action)){	switch($action){		case ACTION_CREATE: 			$isSuccess = $objtbl_crm->create($crm_cust_id, $crm_cust_email, $crm_cust_type, $crm_is_subsribed, $crm_cust_phone);			break;		case ACTION_UPDATE: 			$isSuccess = $objtbl_crm->update($crm_id, $crm_cust_id, $crm_cust_email, $crm_cust_type, $crm_is_subsribed, $crm_cust_phone);			break;		case ACTION_DELETE: 			$isSuccess = $objtbl_crm->delete(array(CRM_ID=>$crm_id));			break;		case ACTION_ACTIVATE:			if(is_not_empty($lst_sel_ids)) 				$isSuccess = $objtbl_crm->activate($lst_sel_ids);			break;		case ACTION_DEACTIVATE: 			if(is_not_empty($lst_sel_ids))				$isSuccess = $objtbl_crm->deactivate($lst_sel_ids);			break;	}//..switch}//..ifif(is_not_empty($isSuccess)){	if(is_gt_zero_num($isSuccess)){		$_SESSION[SES_FLASH_MSG] = '<div class="success">'.$_lang['tbl_crm'][$action]['SUCCESS_MSG'].'</div>';	}elseif($isSuccess == OPERATION_FAIL){		$_SESSION[SES_FLASH_MSG] = '<div class="error">'.$_lang['tbl_crm'][$action]['FAILURE_MSG'].'</div>';	}elseif($isSuccess == OPERATION_DUPLICATE){		$_SESSION[SES_FLASH_MSG] = '<div class="info">'.$_lang['tbl_crm'][$action]['DUPLICATE_MSG'].'</div>';	}}//..if		if(is_gt_zero_num($order_id)){ 		if(tbl_orders::emailOrderReceipt($order_id,$crm_cust_email,$payment_choice)){			$_SESSION[SES_FLASH_MSG] = '<div class="success">Order receipt is emailed to you. Please, Check your mailbox.</div>';		}else{			$_SESSION[SES_FLASH_MSG] = '<div class="error">Problem during sending email.</div>';		} 		biz_script_forward($website.'/user/tbl_orders.php?order_id='.$order_id.'&'.MODE_TITLE.'='.MODE_VIEW);	}	$result_found=0;	$tbl_crmlist = $objtbl_crm->readArray(array('exclude_banned'=>1,CRM_RESTAURANT=>$_SESSION[SES_RESTAURANT],OFFSET_TITLE=>$offset,LIMIT_TITLE=>$limit,SORT_BY=>$sort_by,SORT_ON=>$sort_on),$result_found,1);	$allpageCount = 0;	$currentPage = 0;	$smarty->assign('pagination',biz_pagination(array('url'=>$navigationURL,LIMIT_TITLE=>$limit,OFFSET_TITLE=>$offset,'count'=>$result_found),$allpageCount,$currentPage));	$smarty->assign('allpageCount',$allpageCount);	$smarty->assign('currentPage',$currentPage);	$smarty->assign('tbl_crmlist', $tbl_crmlist);	$smarty->assign('result_found',$result_found);	$template = 'tbl_crm/tbl_crm.tpl'; 	$breadcrumbs[] = array(				 	'link'=>$website.'/user/pref_mng_cntrols.php',					'title'=>$_lang['main']['pref_mng_cntrls']); 	$breadcrumbs[] = array(				 	'link'=>$website.'/user/tbl_crm.php',					'title'=>$_lang['tbl_crm']['title']);						if (is_not_empty($mode)){		if(($mode == MODE_VIEW || $mode==MODE_UPDATE) && is_gt_zero_num($crm_id)){			$tbl_crminfo= $objtbl_crm->GetInfo($crm_id);			$smarty->assign('tbl_crminfo',$tbl_crminfo);			if($mode==MODE_UPDATE){				$smarty->assign('isUpdate',1);			}				$template = 'tbl_crm/view.tpl'; 		}elseif($mode == MODE_CREATE){				$template = 'tbl_crm/create.tpl'; 		}	}		$smarty->assign('page_url', $url);	$smarty->assign('navigationURL',$navigationURL);	$smarty->assign('new_sort',$new_sort);	$smarty->assign('active_page',$active_page); }else{	$template='index.tpl';} include_once('footer.php');?>